define(function(require,exports,module){var Async=require("utils/Async"),CommandManager=require("command/CommandManager"),Commands=require("command/Commands"),Dialogs=require("widgets/Dialogs"),DefaultDialogs=require("widgets/DefaultDialogs"),MainViewManager=require("view/MainViewManager"),FileSystem=require("filesystem/FileSystem"),FileUtils=require("file/FileUtils"),ProjectManager=require("project/ProjectManager"),Strings=require("strings"),StringUtils=require("utils/StringUtils");function isValidDrop(items){var i,len=items.length;for(i=0;i<len;i++)if("file"===items[i].kind){var entry;if(items[i].webkitGetAsEntry().isFile)return!0;if(1===len)return!0}return!1}function stopURIListPropagation(files,event){var types=event.dataTransfer.types;files&&files.length||!types||types.forEach(function(value){if("text/uri-list"===value)return event.stopPropagation(),void event.preventDefault()})}function openDroppedFiles(paths){var errorFiles=[],ERR_MULTIPLE_ITEMS_WITH_DIR={};return Async.doInParallel(paths,function(path,idx){var result=new $.Deferred;return FileSystem.resolve(path,function(err,item){if(!err&&item.isFile){if(idx<paths.length-1&&-1!==MainViewManager.findInWorkingSet(MainViewManager.ALL_PANES,path))return void result.resolve();CommandManager.execute(Commands.CMD_ADD_TO_WORKINGSET_AND_OPEN,{fullPath:path,silent:!0}).done(function(){result.resolve()}).fail(function(openErr){errorFiles.push({path:path,error:openErr}),result.reject()})}else!err&&item.isDirectory&&1===paths.length?ProjectManager.openProject(path).done(function(){result.resolve()}).fail(function(){result.reject()}):(errorFiles.push({path:path,error:err||ERR_MULTIPLE_ITEMS_WITH_DIR}),result.reject())}),result.promise()},!1).fail(function(){function errorToString(err){return err===ERR_MULTIPLE_ITEMS_WITH_DIR?Strings.ERROR_MIXED_DRAGDROP:FileUtils.getFileErrorString(err)}if(errorFiles.length>0){var message=Strings.ERROR_OPENING_FILES;message+="<ul class='dialog-list'>",errorFiles.forEach(function(info){message+="<li><span class='dialog-filename'>"+StringUtils.breakableUrl(ProjectManager.makeProjectRelativeIfPossible(info.path))+"</span> - "+errorToString(info.error)+"</li>"}),message+="</ul>",Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,Strings.ERROR_OPENING_FILE_TITLE,message)}})}function attachHandlers(){function handleDragOver(event){var files=(event=event.originalEvent||event).dataTransfer.files;if(stopURIListPropagation(files,event),files&&files.length){event.stopPropagation(),event.preventDefault();var dropEffect="none";0===$(".modal.instance").length&&isValidDrop(event.dataTransfer.items)&&(dropEffect="copy"),event.dataTransfer.dropEffect=dropEffect}}function handleDrop(event){var files=(event=event.originalEvent||event).dataTransfer.files;stopURIListPropagation(files,event),files&&files.length&&(event.stopPropagation(),event.preventDefault(),brackets.app.getDroppedFiles(function(err,paths){err||openDroppedFiles(paths)}))}$(window.document.body).on("dragover",handleDragOver).on("drop",handleDrop),window.document.body.addEventListener("dragover",function(event){$(event.target).closest(".CodeMirror").length&&handleDragOver(event)},!0),window.document.body.addEventListener("drop",function(event){$(event.target).closest(".CodeMirror").length&&handleDrop(event)},!0)}CommandManager.register(Strings.CMD_OPEN_DROPPED_FILES,Commands.FILE_OPEN_DROPPED_FILES,openDroppedFiles),exports.attachHandlers=attachHandlers,exports.isValidDrop=isValidDrop,exports.openDroppedFiles=openDroppedFiles});
//# sourceMappingURL=DragAndDrop.js.map
