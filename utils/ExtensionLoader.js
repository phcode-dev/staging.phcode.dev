define(function(require,exports,module){require("utils/Global");var _=require("thirdparty/lodash"),EventDispatcher=require("utils/EventDispatcher"),FileSystem=require("filesystem/FileSystem"),FileUtils=require("file/FileUtils"),Async=require("utils/Async"),ExtensionUtils=require("utils/ExtensionUtils"),UrlParams=require("utils/UrlParams").UrlParams,PathUtils=require("thirdparty/path-utils/path-utils"),EXTENSION_LOAD_TIMOUT_SECONDS=60,INIT_EXTENSION_TIMEOUT,_init=!1,_extensions={},_initExtensionTimeout=1e3*EXTENSION_LOAD_TIMOUT_SECONDS,srcPath=FileUtils.getNativeBracketsDirectoryPath(),contexts={},pathLib=Phoenix.VFS.path;srcPath=srcPath.replace(/\/test$/,"/src");var globalPaths=brackets._getGlobalRequireJSConfig().paths;function getDefaultExtensionPath(){return pathLib.normalize("/extensions/default")}function getExtensionPath(){return pathLib.normalize(brackets.app.getApplicationSupportDirectory()+"/extensions")}function getDevExtensionPath(){return getExtensionPath()+"/dev"}function getUserExtensionPath(){return brackets.app.getApplicationSupportDirectory?getExtensionPath()+"/user":null}function getRequireContextForExtension(name){return contexts[name]}function _getInitExtensionTimeout(){return _initExtensionTimeout}function _setInitExtensionTimeout(value){_initExtensionTimeout=value}function _mergeConfigFromURL(baseConfig){var deferred=new $.Deferred,extensionConfigFile=baseConfig.baseUrl+"/requirejs-config.json";return $.get(extensionConfigFile).done(function(extensionConfig){extensionConfig||(extensionConfig={});try{extensionConfig.paths||(extensionConfig.paths={}),_.extend(extensionConfig.paths,baseConfig.paths),_.extend(extensionConfig,_.omit(baseConfig,"paths")),deferred.resolve(extensionConfig)}catch(err){deferred.reject("failed to parse requirejs-config.json")}}).fail(function(){deferred.resolve(baseConfig)}),deferred.promise()}function _mergeConfig(baseConfig){if(baseConfig.baseUrl.startsWith("http://")||baseConfig.baseUrl.startsWith("https://"))return _mergeConfigFromURL(baseConfig);var deferred=new $.Deferred,extensionConfigFile=FileSystem.getFileForPath(baseConfig.baseUrl+"/requirejs-config.json");return FileUtils.readAsText(extensionConfigFile).done(function(text){try{var extensionConfig=JSON.parse(text);extensionConfig.paths||(extensionConfig.paths={}),_.extend(extensionConfig.paths,baseConfig.paths),_.extend(extensionConfig,_.omit(baseConfig,"paths")),deferred.resolve(extensionConfig)}catch(err){deferred.reject("failed to parse requirejs-config.json")}}).fail(function(){deferred.resolve(baseConfig)}),deferred.promise()}function loadExtensionModule(name,config,entryPoint){var extensionConfig;return _mergeConfig({context:name,baseUrl:config.baseUrl,paths:globalPaths,locale:brackets.getLocale(),waitSeconds:EXTENSION_LOAD_TIMOUT_SECONDS}).then(function(mergedConfig){var extensionRequire=brackets.libRequire.config(mergedConfig),extensionRequireDeferred=new $.Deferred;return contexts[name]=extensionRequire,extensionRequire([entryPoint],extensionRequireDeferred.resolve,extensionRequireDeferred.reject),extensionRequireDeferred.promise()}).then(function(module){var initPromise;if(_extensions[name]=module,module&&module.initExtension&&"function"==typeof module.initExtension){try{initPromise=Async.withTimeout(module.initExtension(),_getInitExtensionTimeout())}catch(err){return console.error("[Extension] Error -- error thrown during initExtension for "+name+": "+err),(new $.Deferred).reject(err).promise()}if(initPromise)return initPromise.fail(function(err){err===Async.ERROR_TIMEOUT?console.error("[Extension] Error -- timeout during initExtension for "+name):console.error("[Extension] Error -- failed initExtension for "+name+(err?": "+err:""))}),initPromise}},function errback(err){var additionalInfo=String(err);"scripterror"===err.requireType&&err.originalError&&(additionalInfo="Module does not exist: "+err.originalError.target.src),console.error("[Extension] failed to load "+config.baseUrl+" - "+additionalInfo),"define"===err.requireType&&console.log(err.stack)})}function loadExtension(name,config,entryPoint){var promise=new $.Deferred;return ExtensionUtils.loadMetadata(config.baseUrl,name).always(promise.resolve),promise.then(function(metadata){if(!metadata||!metadata.theme)return metadata.disabled?(new $.Deferred).reject("disabled").promise():loadExtensionModule(name,config,entryPoint)}).then(function(){exports.trigger("load",config.baseUrl)},function(err){"disabled"===err?exports.trigger("disabled",config.baseUrl):exports.trigger("loadFailed",config.baseUrl)})}function _testExtensionByURL(name,config,entryPoint){var result=new $.Deferred;try{var extensionRequire;brackets.libRequire.config({context:name,baseUrl:config.baseUrl,paths:$.extend({},config.paths,globalPaths),waitSeconds:EXTENSION_LOAD_TIMOUT_SECONDS})([entryPoint],function(){console.log("Test extension loaded: ",name),result.resolve()},function(err){console.log("Unit tests not found for:",name,err),result.reject()})}catch(e){console.error("Test extension load failed: ",name,e),result.resolve()}return result.promise()}function testExtension(name,config,entryPoint){var result=new $.Deferred,extensionPath=config.baseUrl+"/"+entryPoint+".js";return extensionPath.startsWith("http://")||extensionPath.startsWith("https://")?_testExtensionByURL(name,config,entryPoint):(FileSystem.resolve(extensionPath,function(err,entry){var extensionRequire;!err&&entry.isFile?brackets.libRequire.config({context:name,baseUrl:config.baseUrl,paths:$.extend({},config.paths,globalPaths)})([entryPoint],function(){result.resolve()}):result.reject()}),result.promise())}function _loadAll(directory,config,entryPoint,processExtension){var result=new $.Deferred;return FileSystem.getDirectoryForPath(directory).getContents(function(err,contents){if(err)console.error("[Extension] Error -- could not read native directory: "+directory),result.reject();else{var i,extensions=[];for(i=0;i<contents.length;i++)contents[i].isDirectory&&extensions.push(contents[i].name);if(0===extensions.length)return void result.resolve();Async.doInParallel(extensions,function(item){var extConfig={baseUrl:window.fsServerUrl+config.baseUrl+"/"+item,paths:config.paths};return console.log("Loading Extension from virtual fs: ",extConfig),processExtension(item,extConfig,entryPoint)}).always(function(){result.resolve()})}}),result.promise()}function loadAllDefaultExtensions(){const extensionPath=getDefaultExtensionPath(),href=window.location.href,baseUrl=href.substring(0,href.lastIndexOf("/")),extensionsToLoadURL=baseUrl+extensionPath+"/DefaultExtensions.json";var result=new $.Deferred;return $.get(extensionsToLoadURL).done(function(extensionNames){Async.doInParallel(extensionNames,function(extensionName){var extConfig;return console.log("loading default extension: ",extensionName),loadExtension(extensionName,{baseUrl:baseUrl+extensionPath+"/"+extensionName},"main")}).always(function(){result.resolve()})}).fail(function(err){console.error("[Extension] Error -- could not read default extension list from"+extensionsToLoadURL),result.reject()}),result.promise()}function loadAllExtensionsInNativeDirectory(directory){return _loadAll(directory,{baseUrl:directory},"main",loadExtension)}function testAllExtensionsInNativeDirectory(directory){var result=new $.Deferred,virtualServerURL=window.fsServerUrl,extensionsDir=getExtensionPath()+"/"+directory,config={baseUrl:virtualServerURL+extensionsDir};return config.paths={perf:virtualServerURL+"/test/perf",spec:virtualServerURL+"/test/spec"},FileSystem.getDirectoryForPath(extensionsDir).getContents(function(err,contents){if(err)console.error("[Extension Load Test] Error -- could not read native directory: "+directory),result.reject();else{var i,extensions=[];for(i=0;i<contents.length;i++)contents[i].isDirectory&&extensions.push(contents[i].name);if(0===extensions.length)return void result.resolve();Async.doInParallel(extensions,function(extensionName){let loadResult=new $.Deferred;var extConfig={basePath:"extensions/default",baseUrl:config.baseUrl+"/"+extensionName,paths:config.paths};return console.log("Loading Extension Test from virtual fs: ",extConfig),_testExtensionByURL(extensionName,extConfig,"unittests").always(function(){console.log("lc",extensionName),loadResult.resolve()}),loadResult.promise()}).always(function(){result.resolve()})}}),result.promise()}function testAllDefaultExtensions(){const extensionPath=getDefaultExtensionPath(),bracketsPath=FileUtils.getNativeBracketsDirectoryPath(),href=window.location.href,baseUrl=href.substring(0,href.lastIndexOf("/")),srcBaseUrl=new URL(baseUrl+"/../src").href,extensionsToLoadURL=srcBaseUrl+extensionPath+"/DefaultExtensions.json";var result=new $.Deferred;return $.get(extensionsToLoadURL).done(function(extensionNames){for(let extensionName of extensionNames){var extConfig;console.log("Testing default extension: ",extensionName),_testExtensionByURL(extensionName,{basePath:"extensions/default",baseUrl:new URL(srcBaseUrl+extensionPath+"/"+extensionName).href,paths:{perf:bracketsPath+"/perf",spec:bracketsPath+"/spec"}},"unittests")}result.resolve()}).fail(function(err){console.error("[Extension Load Test] Error -- could not read default extension list from"+extensionsToLoadURL),result.reject()}),result.promise()}function init(paths){var params=new UrlParams;if(_init)return(new $.Deferred).resolve().promise();paths||(params.parse(),paths="true"!==params.get("reloadWithoutUserExts")?[getUserExtensionPath(),getDevExtensionPath(),"default"]:[]);var extensionPath=getUserExtensionPath();FileSystem.getDirectoryForPath(extensionPath).create(),FileSystem.getDirectoryForPath(getDevExtensionPath()).create();var disabledExtensionPath=extensionPath.replace(/\/user$/,"/disabled");FileSystem.getDirectoryForPath(disabledExtensionPath).create();var promise=Async.doInParallel(paths,function(extPath){return"default"===extPath?loadAllDefaultExtensions():loadAllExtensionsInNativeDirectory(extPath)},!1);return promise.always(function(){_init=!0}),promise}Object.keys(globalPaths).forEach(function(key){globalPaths[key]=PathUtils.makePathAbsolute(srcPath+"/"+globalPaths[key])}),EventDispatcher.makeEventDispatcher(exports),exports._setInitExtensionTimeout=_setInitExtensionTimeout,exports._getInitExtensionTimeout=_getInitExtensionTimeout,exports.init=init,exports.getDefaultExtensionPath=getDefaultExtensionPath,exports.getUserExtensionPath=getUserExtensionPath,exports.getRequireContextForExtension=getRequireContextForExtension,exports.loadExtension=loadExtension,exports.testExtension=testExtension,exports.loadAllExtensionsInNativeDirectory=loadAllExtensionsInNativeDirectory,exports.testAllExtensionsInNativeDirectory=testAllExtensionsInNativeDirectory,exports.testAllDefaultExtensions=testAllDefaultExtensions});
//# sourceMappingURL=ExtensionLoader.js.map
