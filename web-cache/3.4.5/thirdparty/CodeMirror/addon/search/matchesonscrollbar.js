!function(mod){"object"==typeof exports&&"object"==typeof module?mod(require("../../lib/codemirror"),require("./searchcursor"),require("../scroll/annotatescrollbar")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../scroll/annotatescrollbar"],mod):mod(CodeMirror)}(function(CodeMirror){"use strict";function SearchAnnotation(cm,query,caseFold,options){this.cm=cm,this.options=options;var annotateOptions={listenForChanges:!1};for(var prop in options)annotateOptions[prop]=options[prop];annotateOptions.className||(annotateOptions.className="CodeMirror-search-match"),this.annotation=cm.annotateScrollbar(annotateOptions),this.query=query,this.caseFold=caseFold,this.gap={from:cm.firstLine(),to:cm.lastLine()+1},this.matches=[],this.update=null,this.findMatches(),this.annotation.update(this.matches);var self=this;cm.on("change",this.changeHandler=function(_cm,change){self.onChange(change)})}CodeMirror.defineExtension("showMatchesOnScrollbar",function(query,caseFold,options){return"string"==typeof options&&(options={className:options}),options||(options={}),new SearchAnnotation(this,query,caseFold,options)});var MAX_MATCHES=1e3;function offsetLine(line,changeStart,sizeChange){return line<=changeStart?line:Math.max(changeStart,line+sizeChange)}SearchAnnotation.prototype.findMatches=function(){if(this.gap){for(var i=0;i<this.matches.length;i++){var match;if((match=this.matches[i]).from.line>=this.gap.to)break;match.to.line>=this.gap.from&&this.matches.splice(i--,1)}for(var cursor=this.cm.getSearchCursor(this.query,CodeMirror.Pos(this.gap.from,0),{caseFold:this.caseFold,multiline:this.options.multiline}),maxMatches=this.options&&this.options.maxMatches||1e3;cursor.findNext();){var match;if((match={from:cursor.from(),to:cursor.to()}).from.line>=this.gap.to)break;if(this.matches.splice(i++,0,match),this.matches.length>maxMatches)break}this.gap=null}},SearchAnnotation.prototype.onChange=function(change){var startLine=change.from.line,endLine=CodeMirror.changeEnd(change).line,sizeChange=endLine-change.to.line;if(this.gap?(this.gap.from=Math.min(offsetLine(this.gap.from,startLine,sizeChange),change.from.line),this.gap.to=Math.max(offsetLine(this.gap.to,startLine,sizeChange),change.from.line)):this.gap={from:change.from.line,to:endLine+1},sizeChange)for(var i=0;i<this.matches.length;i++){var match=this.matches[i],newFrom=offsetLine(match.from.line,startLine,sizeChange);newFrom!=match.from.line&&(match.from=CodeMirror.Pos(newFrom,match.from.ch));var newTo=offsetLine(match.to.line,startLine,sizeChange);newTo!=match.to.line&&(match.to=CodeMirror.Pos(newTo,match.to.ch))}clearTimeout(this.update);var self=this;this.update=setTimeout(function(){self.updateAfterChange()},250)},SearchAnnotation.prototype.updateAfterChange=function(){this.findMatches(),this.annotation.update(this.matches)},SearchAnnotation.prototype.clear=function(){this.cm.off("change",this.changeHandler),this.annotation.clear()}});
//# sourceMappingURL=matchesonscrollbar.js.map
