var MAX_DISPLAY_LENGTH=200,MAX_TOTAL_RESULTS=1e5,MAX_RESULTS_IN_A_FILE=MAX_TOTAL_RESULTS,MAX_RESULTS_TO_RETURN=120,results={},numMatches=0,numFiles=0,evaluatedMatches,foundMaximum=!1,exceedsMaximum=!1,savedSearchObject=null,lastSearchedIndex=0,collapseResults=!1;function offsetToLineNum(textOrLines,offset){if(Array.isArray(textOrLines)){var lines=textOrLines,total=0,line;for(line=0;line<lines.length;line++){if(!(total<offset))return total===offset?line:line-1;total+=lines[line].length+1}return offset<=total?line-1:void 0}return textOrLines.substr(0,offset).split("\n").length-1}function getSearchMatches(contents,queryExpr){if(contents){if(foundMaximum||-1===contents.search(queryExpr))return[];for(var match,lineNum,line,ch,totalMatchLength,matchedLines,numMatchedLines,lastLineLength,endCh,padding,leftPadding,rightPadding,highlightOffset,highlightEndCh,lines=contents.split("\n"),matches=[];null!==(match=queryExpr.exec(contents));){if(line=lines[lineNum=offsetToLineNum(lines,match.index)],ch=match.index-contents.lastIndexOf("\n",match.index)-1,numMatchedLines=(matchedLines=match[0].split("\n")).length,totalMatchLength=match[0].length,lastLineLength=matchedLines[matchedLines.length-1].length,endCh=1===numMatchedLines?ch+totalMatchLength:lastLineLength,highlightOffset=0,(highlightEndCh=1===numMatchedLines?endCh:line.length)<=MAX_DISPLAY_LENGTH?line=line.substr(0,Math.min(MAX_DISPLAY_LENGTH,line.length)):totalMatchLength>MAX_DISPLAY_LENGTH?(line=line.substr(ch,ch+MAX_DISPLAY_LENGTH),highlightOffset=ch):(padding=MAX_DISPLAY_LENGTH-totalMatchLength,rightPadding=Math.floor(Math.min(padding/2,line.length-highlightEndCh)),highlightOffset=ch-(leftPadding=Math.ceil(padding-rightPadding)),line=line.substring(highlightOffset,highlightEndCh+rightPadding)),matches.push({start:{line:lineNum,ch:ch},end:{line:lineNum+numMatchedLines-1,ch:endCh},highlightOffset:highlightOffset,startOffset:match.index,endOffset:match.index+totalMatchLength,line:line,result:match,isChecked:!0}),matches.length>MAX_RESULTS_IN_A_FILE){queryExpr.lastIndex=0;break}0===totalMatchLength&&queryExpr.lastIndex++}return matches}}function setResults(fullpath,resultInfo,maxResultsToReturn){results[fullpath]&&(numMatches-=results[fullpath].matches.length,delete results[fullpath]),!foundMaximum&&resultInfo&&resultInfo.matches&&resultInfo.matches.length&&(resultInfo.collapsed=collapseResults,results[fullpath]=resultInfo,numMatches+=resultInfo.matches.length,evaluatedMatches+=resultInfo.matches.length,(numMatches>=(maxResultsToReturn=maxResultsToReturn||MAX_RESULTS_TO_RETURN)||evaluatedMatches>MAX_TOTAL_RESULTS)&&(foundMaximum=!0))}function doSearchInOneFile(filepath,text,queryExpr,maxResultsToReturn){var matches;setResults(filepath,{matches:getSearchMatches(text,queryExpr)},maxResultsToReturn)}async function doSearchInFiles(fileList,queryExpr,startFileIndex,maxResultsToReturn){var i;if(0!==fileList.length){for(i=startFileIndex=startFileIndex||0;i<fileList.length&&!foundMaximum;i++){let contents=await getFileContentsForFile(fileList[i]);doSearchInOneFile(fileList[i],contents,queryExpr,maxResultsToReturn)}lastSearchedIndex=i}else console.log("no files found")}function regexEscape(str){return str.replace(/([.?*+\^$\[\]\\(){}|\-])/g,"\\$1")}function parseQueryInfo(queryInfo){var queryExpr;if(!queryInfo||!queryInfo.query)return{empty:!0};var flags="gm";if(queryInfo.isCaseSensitive||(flags+="i"),queryInfo.isRegexp)try{queryExpr=new RegExp(queryInfo.query,flags)}catch(e){return{valid:!1,error:e.message}}else queryExpr=new RegExp(regexEscape(queryInfo.query),flags);return{valid:!0,queryExpr:queryExpr}}function countNumMatches(contents,queryExpr){if(!contents)return 0;var matches=contents.match(queryExpr);return matches?matches.length:0}async function getNumMatches(fileList,queryExpr){let i,matches=0;for(i=0;i<fileList.length;i++){let contents,temp=countNumMatches(await getFileContentsForFile(fileList[i]),queryExpr);if(temp&&(numFiles++,matches+=temp),matches>MAX_TOTAL_RESULTS){exceedsMaximum=!0;break}}return matches}async function doSearch(searchObject,nextPages){if(savedSearchObject=searchObject,!files)return console.log("file indexer: search was called before indexing or there are no files in project!"),{results:{},foundMaximum:!1,exceedsMaximum:!1};results={},numMatches=0,numFiles=0,foundMaximum=!1,nextPages||(exceedsMaximum=!1,evaluatedMatches=0);var queryObject=parseQueryInfo(searchObject.queryInfo);searchObject.files&&(files=searchObject.files),searchObject.getAllResults&&(searchObject.maxResultsToReturn=MAX_TOTAL_RESULTS),await doSearchInFiles(files,queryObject.queryExpr,searchObject.startFileIndex,searchObject.maxResultsToReturn),crawlComplete&&!nextPages&&(numMatches=await getNumMatches(files,queryObject.queryExpr));var send_object={results:results,foundMaximum:foundMaximum,exceedsMaximum:exceedsMaximum};return nextPages||(send_object.numMatches=numMatches,send_object.numFiles=numFiles),searchObject.getAllResults&&(send_object.allResultsAvailable=!0),send_object}async function getNextPage(){var send_object;return savedSearchObject?(savedSearchObject.startFileIndex=lastSearchedIndex,doSearch(savedSearchObject,!0)):{results:{},numMatches:0,foundMaximum:foundMaximum,exceedsMaximum:exceedsMaximum}}async function getAllResults(){var send_object;return savedSearchObject?(savedSearchObject.startFileIndex=0,savedSearchObject.getAllResults=!0,doSearch(savedSearchObject)):{results:{},numMatches:0,foundMaximum:foundMaximum,exceedsMaximum:exceedsMaximum}}function setCollapseResults(collapse){collapseResults=collapse}WorkerComm.setExecHandler("doSearch",doSearch),WorkerComm.setExecHandler("nextPage",getNextPage),WorkerComm.setExecHandler("getAllResults",getAllResults),WorkerComm.setExecHandler("collapseResults",setCollapseResults);
//# sourceMappingURL=search.js.map
