const t=t=>!0===t||!1===t,e=t=>!!t&&"object"==typeof t&&!Array.isArray(t),s=t=>"number"==typeof t&&Number.isFinite(t)&&!Number.isNaN(t),n=t=>"string"==typeof t,r=t=>n(t)&&t.length>0,a=t=>Array.isArray(t)&&t.every(t=>r(t)||t instanceof RegExp),i=t=>e(t)&&"string"==typeof t.id&&"string"==typeof t.traceId&&"function"==typeof t.isValid;class o{constructor(t){this.attributes=t}set(t,e){("string"==typeof e||"boolean"==typeof e||s(e))&&this.attributes.set(t,e)}remove(t){this.attributes.delete(t)}toJson(){return Array.from(this.attributes).map(([t,e])=>(function(t,e){switch(typeof e){case"number":if(Number.isNaN(e)||!Number.isFinite(e))return;return"bugsnag.sampling.p"!==t&&Number.isInteger(e)?{key:t,value:{intValue:`${e}`}}:{key:t,value:{doubleValue:e}};case"boolean":return{key:t,value:{boolValue:e}};case"string":return{key:t,value:{stringValue:e}};default:return}})(t,e))}}class u extends o{constructor(t,e,s,n){const r=new Map([["deployment.environment",t],["telemetry.sdk.name",s],["telemetry.sdk.version",n]]);e.length>0&&r.set("service.version",e),super(r)}}const c=1e6,l={appVersion:{defaultValue:"",message:"should be a string",validate:r},endpoint:{defaultValue:"https://otlp.bugsnag.com/v1/traces",message:"should be a string",validate:r},apiKey:{defaultValue:"",message:"should be a 32 character hexadecimal string",validate:t=>n(t)&&/^[a-f0-9]{32}$/.test(t)},logger:{defaultValue:{debug(t){console.debug(t)},info(t){console.info(t)},warn(t){console.warn(t)},error(t){console.error(t)}},message:"should be a Logger object",validate:t=>e(t)&&"function"==typeof t.debug&&"function"==typeof t.info&&"function"==typeof t.warn&&"function"==typeof t.error},releaseStage:{defaultValue:"production",message:"should be a string",validate:r},enabledReleaseStages:{defaultValue:null,message:"should be an array of strings",validate:t=>null===t||(t=>Array.isArray(t)&&t.every(r))(t)},samplingProbability:{defaultValue:1,message:"should be a number between 0 and 1",validate:t=>s(t)&&t>=0&&t<=1},plugins:{defaultValue:[],message:"should be an array of plugin objects",validate:function(t){return Array.isArray(t)&&t.every(t=>(function(t){return e(t)&&"function"==typeof t.configure})(t))}}};class d{constructor(t,e,s,n,r,a){this.batch=[],this.timeout=null,this.delivery=t,this.configuration=e,this.retryQueue=s,this.sampler=n,this.probabilityManager=r,this.encoder=a,this.flush=this.flush.bind(this)}stop(){null!==this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}start(){this.stop(),this.timeout=setTimeout(this.flush,this.configuration.batchInactivityTimeoutMs)}add(t){this.configuration.enabledReleaseStages&&!this.configuration.enabledReleaseStages.includes(this.configuration.releaseStage)||(this.batch.push(t),this.batch.length>=this.configuration.maximumBatchSize?this.flush():this.start())}async flush(){this.stop();const t=this.prepareBatch();if(!t)return;const e=await this.encoder.encode(t),s=Date.now();try{const t=await this.delivery.send(e);switch(void 0!==t.samplingProbability&&this.probabilityManager.setProbability(t.samplingProbability),t.state){case"success":this.retryQueue.flush();break;case"failure-discard":this.configuration.logger.warn("delivery failed");break;case"failure-retryable":this.configuration.logger.info("delivery failed, adding to retry queue"),this.retryQueue.add(e,s);break;default:t.state}}catch(t){this.configuration.logger.warn("delivery failed")}}prepareBatch(){if(0===this.batch.length)return;const t=[],e=this.sampler.spanProbability;for(const s of this.batch)s.samplingProbability.raw>e.raw&&(s.samplingProbability=e),this.sampler.sample(s)&&t.push(s);return this.batch=[],0!==t.length?t:void 0}}class h{constructor(){this.events=[]}add(t,e){this.events.push({name:t,time:e})}toJson(t){return this.events.map(({name:e,time:s})=>({name:e,timeUnixNano:t.toUnixTimestampNanoseconds(s)}))}}class g{constructor(t,e,s,n,r,a){this.kind=3,this.events=new h,this.id=t,this.traceId=e,this.parentSpanId=a,this.name=s,this.startTime=n,this.attributes=r,this.samplingRate=function(t){let e=0;for(let s=0;s<t.length/8;s++){const n=8*s;e=(e^Number.parseInt(t.slice(n,n+8),16))>>>0}return e}(this.traceId)}addEvent(t,e){this.events.add(t,e)}setAttribute(t,e){this.attributes.set(t,e)}end(t,e){this.endTime=t;let s=e;return this.attributes.set("bugsnag.sampling.p",s.raw),{id:this.id,name:this.name,kind:this.kind,traceId:this.traceId,startTime:this.startTime,attributes:this.attributes,events:this.events,samplingRate:this.samplingRate,endTime:t,get samplingProbability(){return s},set samplingProbability(t){s=t,this.attributes.set("bugsnag.sampling.p",s.raw)},parentSpanId:this.parentSpanId}}isValid(){return void 0===this.endTime}}const p={startTime:{message:"should be a number or Date",getDefaultValue:()=>{},validate:function(t){return s(t)||t instanceof Date}},parentContext:{message:"should be a SpanContext",getDefaultValue:()=>{},validate:t=>null===t||i(t)},makeCurrentContext:{message:"should be true|false",getDefaultValue:()=>{},validate:t},isFirstClass:{message:"should be true|false",getDefaultValue:()=>{},validate:t}};class f{constructor(t,e,s){this.clock=t,this.configuration=e,this.resourceAttributeSource=s}async encode(t){const e=await this.resourceAttributeSource(this.configuration),s=Array(t.length);for(let e=0;e<t.length;++e)s[e]=(n=t[e],r=this.clock,{name:n.name,kind:n.kind,spanId:n.id,traceId:n.traceId,parentSpanId:n.parentSpanId,startTimeUnixNano:r.toUnixTimestampNanoseconds(n.startTime),endTimeUnixNano:r.toUnixTimestampNanoseconds(n.endTime),attributes:n.attributes.toJson(),events:n.events.toJson(r)});var n,r;return{body:{resourceSpans:[{resource:{attributes:e.toJson()},scopeSpans:[{spans:s}]}]},headers:{"Bugsnag-Api-Key":this.configuration.apiKey,"Content-Type":"application/json","Bugsnag-Span-Sampling":this.generateSamplingHeader(t)}}}generateSamplingHeader(t){if(0===t.length)return"1:0";const e=Object.create(null);for(const s of t){const t=e[s.samplingProbability.raw]||0;e[s.samplingProbability.raw]=t+1}const s=Object.keys(e),n=Array(s.length);for(let t=0;t<s.length;++t){const r=s[t];n[t]=`${r}:${e[r]}`}return n.join(";")}}const b=new Set([402,407,408,429]);class m{constructor(t,e){this.delivery=t,this.payload={body:{resourceSpans:[]},headers:{"Bugsnag-Api-Key":e,"Content-Type":"application/json","Bugsnag-Span-Sampling":"1.0:0"}}}async getNewProbability(){for(;;){const t=await this.delivery.send(this.payload);if(void 0!==t.samplingProbability)return t.samplingProbability;await this.timeBetweenRetries()}}timeBetweenRetries(){return new Promise(t=>{setTimeout(t,3e4)})}}const y=864e5;class v{static async create(t,e,s){const n=await t.load("bugsnag-sampling-probability");let r,a;return void 0===n?(e.probability=1,r=0,a=0):n.time<Date.now()-y?(e.probability=n.value,r=n.time,a=0):(e.probability=n.value,r=n.time,a=y-(Date.now()-r)),new v(t,e,s,a,r)}constructor(t,e,s,n,r){this.timeout=void 0,this.persistence=t,this.sampler=e,this.probabilityFetcher=s,this.lastProbabilityTime=r,this.fetchNewProbabilityIn(n)}setProbability(t){return this.lastProbabilityTime=Date.now(),this.sampler.probability=t,this.fetchNewProbabilityIn(y),this.persistence.save("bugsnag-sampling-probability",{value:t,time:this.lastProbabilityTime})}fetchNewProbabilityIn(t){clearTimeout(this.timeout);const e=this.lastProbabilityTime;this.timeout=setTimeout(async()=>{const t=await this.probabilityFetcher.getNewProbability();e===this.lastProbabilityTime&&this.setProbability(t)},t)}}class w{constructor(){this.spans=[]}add(t){this.spans.push(t)}}function S(t){return Math.floor(4294967295*t)}class k{constructor(t){this._probability=t,this.scaledProbability=S(t)}get probability(){return this._probability}set probability(t){this._probability=t,this.scaledProbability=S(t)}get spanProbability(){return{raw:this._probability,scaled:this.scaledProbability}}sample(t){return t.samplingRate<=t.samplingProbability.scaled}}class T{constructor(t,e=[]){this.isInForeground=!0,this.onBackgroundStateChange=(t=>{this.isInForeground="in-foreground"===t,this.contextStack.length=0}),this.contextStack=e,t.onStateChange(this.onBackgroundStateChange)}*[Symbol.iterator](){for(let t=this.contextStack.length-1;t>=0;--t)yield this.contextStack[t]}push(t){t.isValid()&&this.isInForeground&&this.contextStack.push(t)}pop(t){var e,s;((e=t)===(s=this.current)||void 0!==e&&void 0!==s&&e.id===s.id&&e.traceId===s.traceId)&&this.contextStack.pop(),this.removeClosedContexts()}get first(){return this.removeClosedContexts(),this.contextStack.length>0?this.contextStack[0]:void 0}get current(){return this.removeClosedContexts(),this.contextStack.length>0?this.contextStack[this.contextStack.length-1]:void 0}removeClosedContexts(){for(;this.contextStack.length>0&&!1===this.contextStack[this.contextStack.length-1].isValid();)this.contextStack.pop()}}function C(t,e){return s(e)?e:e instanceof Date?t.convert(e):t.now()}class A{constructor(t,e,s,n,r,a,i,o){this.openSpans=new WeakSet,this.isInForeground=!0,this.onBackgroundStateChange=(t=>{this.isInForeground="in-foreground"===t,this.openSpans=new WeakSet}),this.processor=t,this.sampler=e,this.idGenerator=s,this.spanAttributesSource=n,this.clock=r,this.logger=i,this.spanContextStorage=o,a.onStateChange(this.onBackgroundStateChange)}startSpan(t,e){const s=C(this.clock,e.startTime),n=this.idGenerator.generate(64),r=i(e.parentContext)||null===e.parentContext?e.parentContext:this.spanContextStorage.current,a=r?r.id:void 0,u=r?r.traceId:this.idGenerator.generate(128),c=new o(new Map);"boolean"==typeof e.isFirstClass&&c.set("bugsnag.span.first_class",e.isFirstClass);const l=new g(n,u,t,s,c,a);return this.isInForeground&&(this.openSpans.add(l),!1!==e.makeCurrentContext&&this.spanContextStorage.push(l)),l}configure(t,e){this.processor=t,this.logger=e}endSpan(t,e){if(!this.openSpans.delete(t))return void(t.isValid()||this.logger.warn("Attempted to end a Span which has already ended."));if(-1===e)return;this.spanAttributesSource.requestAttributes(t);const s=t.end(e,this.sampler.spanProbability);this.spanContextStorage.pop(t),this.sampler.sample(s)&&this.processor.add(s)}toPublicApi(t){return{get id(){return t.id},get traceId(){return t.traceId},isValid:()=>t.isValid(),end:e=>{const s=C(this.clock,e);this.endSpan(t,s)}}}validateSpanOptions(t,s,n=p){let r="";const a={};if("string"!=typeof t&&(r+="\n  - name should be a string, got "+typeof t,t=String(t)),void 0===s||e(s)){const t=s||{};for(const e of Object.keys(n))Object.prototype.hasOwnProperty.call(t,e)&&void 0!==t[e]?n[e].validate(t[e])?a[e]=t[e]:(r+=`\n  - ${e} ${n[e].message}, got ${typeof t[e]}`,a[e]=n[e].getDefaultValue(t[e])):a[e]=n[e].getDefaultValue(t[e])}else r+="\n  - options is not an object";return r.length>0&&this.logger.warn(`Invalid span options${r}`),{name:t,options:a}}}class P{constructor(){this.persistedItems=new Map}async load(t){return this.persistedItems.get(t)}async save(t,e){this.persistedItems.set(t,e)}}function x(t,n){switch(t){case"bugsnag-sampling-probability":{const t=JSON.parse(n);return e(r=t)&&s(r.value)&&s(r.time)?t:void 0}case"bugsnag-anonymous-id":return function(t){return"string"==typeof t&&/^c[a-z0-9]{20,32}$/.test(t)}(n)?n:void 0}var r}class I{constructor(t,e){this.delivery=t,this.retryQueueMaxSize=e,this.requestQueue=Promise.resolve(),this.payloads=[]}add(t,e){this.payloads.push({payload:t,time:e});let s=this.payloads.reduce((t,{payload:e})=>t+R(e),0);for(;s>this.retryQueueMaxSize;){const t=this.payloads.shift();if(!t)break;s-=R(t.payload)}}async flush(){if(0===this.payloads.length)return;const t=this.payloads;this.payloads=[],this.requestQueue=this.requestQueue.then(async()=>{for(const{payload:e,time:s}of t)if(!(Date.now()>=s+864e5))try{const{state:t}=await this.delivery.send(e);switch(t){case"success":case"failure-discard":break;case"failure-retryable":this.add(e,s)}}catch(t){}}),await this.requestQueue}}function R(t){let e=0;for(let s=0;s<t.body.resourceSpans.length;++s){const n=t.body.resourceSpans[s].scopeSpans;for(let t=0;t<n.length;++t)e+=n[t].spans.length}return e}function E(t){const e=t.get("Bugsnag-Sampling-Probability");if("string"!=typeof e)return;const s=Number.parseFloat(e);return Number.isNaN(s)||s<0||s>1?void 0:s}function L(t){return t}function V(t){return"function"==typeof t}class F{constructor(){this.callbacks=[]}onStart(t){this.callbacks.push(t)}start(t){const e=[];for(const s of this.callbacks){const n=s(t);n&&e.push(n)}return t=>{for(const s of e)s(t)}}}function O(t,e){if(0===t.indexOf("https://")||0===t.indexOf("http://"))return t;try{const s=new URL(t,e).href;return!t.endsWith("/")&&s.endsWith("/")?s.slice(0,-1):s}catch(e){return t}}function U(t,e,s,n){const r=function(t){return!(!t||"object"!=typeof t||t instanceof URL)}(e),a=r?e.url:String(e),i=!!s&&s.method||r&&e.method||"GET";return{url:O(a,n),method:i,startTime:t,type:"fetch"}}const B={referrer:!0,title:!0,url:!0};function N(t){return Object.assign(Object.assign({},B),t)}function q(t){const s=["undefined","boolean"],n=Object.keys(B);return e(t)&&n.every(e=>s.includes(typeof t[e]))}const j=t=>t.pathname||"/",D=()=>(class{constructor(t=j){this.resolveRoute=t}listenForRouteChanges(t){}}),_=(t,e)=>(class{constructor(t=j){this.resolveRoute=t}listenForRouteChanges(s){addEventListener("popstate",n=>{const r=new URL(e.href),a=s(r,"popstate");t(t=>{a.end(t)})});const n=history.pushState;history.pushState=function(...e){const r=e[2];if(r){const e=new URL(O(r.toString(),document.baseURI)),n=s(e,"pushState");t(t=>{n.end(t)})}n.apply(this,e)}}});class M{constructor(t,e,s,n,r,a,i){this.wasBackgrounded=!1,this.document=t,this.location=e,this.spanFactory=s,this.webVitals=n,this.onSettle=r,this.performance=i,a.onStateChange(t=>{this.wasBackgrounded||"in-background"!==t||(this.wasBackgrounded=!0)})}configure(t){if(!t.autoInstrumentFullPageLoads||this.wasBackgrounded)return;const e=this.spanFactory.startSpan("[FullPageLoad]",{startTime:0,parentContext:null}),s=N(t.sendPageAttributes),n=new URL(this.location.href);this.onSettle(r=>{if(this.wasBackgrounded)return;const a=t.routingProvider.resolveRoute(n)||j(n);e.name+=a,((t,e,s,n)=>{function r(e,r,a){if(function(t,e){return void 0===t||void 0===e||0===t&&0===e}(r,a))return;const i=t.startSpan(`[PageLoadPhase/${e}]${s}`,{startTime:r,parentContext:n,makeCurrentContext:!1});i.setAttribute("bugsnag.span.category","page_load_phase"),i.setAttribute("bugsnag.phase",e),t.endSpan(i,a)}const a=e.getEntriesByType("navigation"),i=Array.isArray(a)&&a[0];if(i){r("Unload",i.unloadEventStart,i.unloadEventEnd),r("Redirect",i.redirectStart,i.redirectEnd),r("LoadFromCache",i.fetchStart,i.domainLookupStart),r("DNSLookup",i.domainLookupStart,i.domainLookupEnd);const t=i.secureConnectionStart||i.connectEnd;r("TCPHandshake",i.connectStart,t),r("TLS",i.secureConnectionStart,i.connectEnd),r("HTTPRequest",i.requestStart,i.responseStart),r("HTTPResponse",i.responseStart,i.responseEnd),r("DomContentLoadedEvent",i.domContentLoadedEventStart,i.domContentLoadedEventEnd),r("LoadEvent",i.loadEventStart,i.loadEventEnd)}})(this.spanFactory,this.performance,a,e),e.setAttribute("bugsnag.span.category","full_page_load"),e.setAttribute("bugsnag.browser.page.route",a),s.referrer&&e.setAttribute("bugsnag.browser.page.referrer",this.document.referrer),s.title&&e.setAttribute("bugsnag.browser.page.title",this.document.title),s.url&&e.setAttribute("bugsnag.browser.page.url",n.toString()),this.webVitals.attachTo(e),this.spanFactory.endSpan(e,r)})}}const $=["http://","https://","/","./","../"];class Q{constructor(t,e,s){this.spanFactory=t,this.fetchTracker=e,this.xhrTracker=s,this.configEndpoint="",this.networkRequestCallback=L,this.logger={debug:console.debug,warn:console.warn,info:console.info,error:console.error},this.trackRequest=(t=>{if(!this.shouldTrackRequest(t))return;const e=this.networkRequestCallback({url:t.url,type:t.type});if(!e)return;if("string"!=typeof e.url)return void this.logger.warn("expected url to be a string following network request callback, got "+typeof e.url);const s=this.spanFactory.startSpan(`[HTTP]/${t.method.toUpperCase()}`,{startTime:t.startTime,makeCurrentContext:!1});return s.setAttribute("bugsnag.span.category","network"),s.setAttribute("http.method",t.method),s.setAttribute("http.url",e.url),t=>{"success"===t.state&&(s.setAttribute("http.status_code",t.status),this.spanFactory.endSpan(s,t.endTime))}})}configure(t){this.logger=t.logger,t.autoInstrumentNetworkRequests&&(this.configEndpoint=t.endpoint,this.xhrTracker.onStart(this.trackRequest),this.fetchTracker.onStart(this.trackRequest),this.networkRequestCallback=t.networkRequestCallback)}shouldTrackRequest(t){return t.url!==this.configEndpoint&&$.some(e=>t.url.startsWith(e))}}function z(t){switch(t){case"":return;case"http/1.0":return"1.0";case"http/1.1":return"1.1";case"h2":case"h2c":return"2.0";case"h3":return"3.0";case"spdy/1":case"spdy/2":case"spdy/3":return"SPDY";default:return t}}class K{constructor(t,e,s){this.spanFactory=t,this.spanContextStorage=e,this.PerformanceObserverClass=s}configure(t){if(!((e=this.PerformanceObserverClass)&&Array.isArray(e.supportedEntryTypes)&&e.supportedEntryTypes.includes("resource")))return;var e;const s=new this.PerformanceObserverClass(e=>{const s=e.getEntries();for(const e of s){if("fetch"===e.initiatorType||"xmlhttprequest"===e.initiatorType)continue;const s=this.spanContextStorage.first;if(s){const n=t.networkRequestCallback({url:e.name,type:e.initiatorType});if(!n)return;if("string"!=typeof n.url)return void t.logger.warn("expected url to be a string following network request callback, got "+typeof n.url);let r="";try{const t=new URL(n.url);t.search="",r=t.href}catch(e){return void t.logger.warn(`Unable to parse URL returned from networkRequestCallback: ${n.url}`)}const a=this.spanFactory.startSpan(`[ResourceLoad]${r}`,{parentContext:s,startTime:e.startTime,makeCurrentContext:!1});a.setAttribute("bugsnag.span.category","resource_load"),a.setAttribute("http.url",n.url);const i=z(e.nextHopProtocol);i&&a.setAttribute("http.flavor",i),e.encodedBodySize&&e.decodedBodySize&&(a.setAttribute("http.response_content_length",e.encodedBodySize),a.setAttribute("http.response_content_length_uncompressed",e.decodedBodySize)),e.responseStatus&&a.setAttribute("http.status_code",e.responseStatus),this.spanFactory.endSpan(a,e.responseEnd)}}});try{s.observe({type:"resource",buffered:!0})}catch(e){t.logger.warn("Unable to get previous resource loads as buffered observer not supported, only showing resource loads from this point on"),s.observe({entryTypes:["resource"]})}}}const{startTime:H,parentContext:J,makeCurrentContext:W}=p,G={startTime:H,parentContext:J,makeCurrentContext:W,trigger:{getDefaultValue:t=>String(t),message:"should be a string",validate:n}};class X{constructor(t,e,s){this.spanFactory=t,this.location=e,this.document=s}configure(t){if(!t.autoInstrumentRouteChanges)return;const s=new URL(this.location.href);let n=t.routingProvider.resolveRoute(s)||j(s);const r=N(t.sendPageAttributes);t.routingProvider.listenForRouteChanges((s,a,i)=>{let o;if(s instanceof URL)o=s;else try{const t=String(s);o=new URL(t)}catch(e){return t.logger.warn("Invalid span options\n  - url should be a URL"),{id:"",traceId:"",isValid:()=>!1,end:()=>{}}}const u=Object.assign(Object.assign({},i),{trigger:a}),c=this.spanFactory.validateSpanOptions("[RouteChange]",u,G),l=t.routingProvider.resolveRoute(o)||j(o);c.name+=l;const d=this.spanFactory.startSpan(c.name,c.options);return d.setAttribute("bugsnag.span.category","route_change"),d.setAttribute("bugsnag.browser.page.route",l),d.setAttribute("bugsnag.browser.page.previous_route",n),d.setAttribute("bugsnag.browser.page.route_change.trigger",c.options.trigger),r.url&&d.setAttribute("bugsnag.browser.page.url",s.toString()),n=l,{id:d.id,traceId:d.traceId,isValid:d.isValid,end:s=>{const a=e(s)?s:{endTime:s};if(r.title&&d.setAttribute("bugsnag.browser.page.title",this.document.title),a.url){const e=function(t){return"string"==typeof t?new URL(t):t}(a.url),s=t.routingProvider.resolveRoute(e)||j(e);d.name=`[RouteChange]${s}`,d.setAttribute("bugsnag.browser.page.route",s),n=s,r.url&&d.setAttribute("bugsnag.browser.page.url",e.toString())}this.spanFactory.toPublicApi(d).end(a.endTime)}}})}}const Y=3e5;function Z(t,e){return Math.abs(Date.now()-(t+e.now()))>Y?Date.now()-e.now():t}const tt=t=>e(t)&&"function"==typeof t.resolveRoute&&"function"==typeof t.listenForRouteChanges;function et(t){const e=t.toString(16);return 1===e.length?"0"+e:e}const st={generate(t){const e=new Uint8Array(t/8),s=window.crypto.getRandomValues(e);return Array.from(s,et).join("")}};class nt{constructor(t){this.settled=!1,this.callbacks=new Set,this.clock=t}subscribe(t){this.callbacks.add(t),this.isSettled()&&t(this.clock.now())}unsubscribe(t){this.callbacks.delete(t)}isSettled(){return this.settled}settle(t){this.settled=!0;for(const e of this.callbacks)e(t)}}class rt extends nt{constructor(t,e){super(t),this.timeout=void 0,new MutationObserver(()=>{this.restart()}).observe(e,{subtree:!0,childList:!0,characterData:!0}),this.restart()}restart(){clearTimeout(this.timeout),this.settled=!1;const t=this.clock.now();this.timeout=setTimeout(()=>{this.settle(t)},100)}}class at extends nt{constructor(t,e,s,n){super(t),"complete"===n.readyState?setTimeout(()=>{this.settleUsingPerformance(s)},0):e("load",()=>{setTimeout(()=>{this.settleUsingPerformance(s)},0)})}settleUsingPerformance(t){const e=this.clock.now(),s="function"==typeof t.getEntriesByType?t.getEntriesByType("navigation")[0]:void 0;let n=0;!function(t){return!!t&&"navigation"===t.entryType}(s)?t.timing&&(n=t.timing.loadEventEnd-t.timing.navigationStart):n=s.loadEventEnd,(n<=0||n>e)&&(n=e),this.settle(n)}}class it extends nt{constructor(t,e){super(t),this.timeout=void 0,this.urlsToIgnore=[],this.outstandingRequests=0,this.settled=!0,e.onStart(this.onRequestStart.bind(this))}setUrlsToIgnore(t){this.urlsToIgnore=t}onRequestStart(t){if(!this.shouldIgnoreUrl(t.url))return clearTimeout(this.timeout),this.settled=!1,++this.outstandingRequests,t=>{if(0==--this.outstandingRequests){const t=this.clock.now();this.timeout=setTimeout(()=>{this.settle(t)},100)}}}shouldIgnoreUrl(t){return this.urlsToIgnore.some(e=>e.test(t))}}class ot extends nt{constructor(t,e){super(t),this.settlers=e;for(const t of e)t.subscribe(t=>{this.settlersAreSettled()?this.settle(t):this.settled=!1})}isSettled(){return super.isSettled()&&this.settlersAreSettled()}settlersAreSettled(){for(const t of this.settlers)if(!t.isSettled())return!1;return!0}}class ut{constructor(t){this.storage=t}async load(t){try{const e=this.storage.getItem(t);if(e)return x(t,e)}catch(t){}}async save(t,e){try{this.storage.setItem(t,function(t,e){switch(t){case"bugsnag-sampling-probability":return JSON.stringify(e);case"bugsnag-anonymous-id":return e;default:return t}}(t,e))}catch(t){}}}function ct(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var lt=function(t,e){var s="000000000"+t;return s.substr(s.length-e)},dt=lt,ht="object"==typeof window?window:self,gt=0;for(var pt in ht)Object.hasOwnProperty.call(ht,pt)&&gt++;var ft=dt(((navigator.mimeTypes?navigator.mimeTypes.length:0)+navigator.userAgent.length).toString(36)+gt.toString(36),4),bt=function(){return ft},mt=lt,yt=0,vt=4,wt=36,St=Math.pow(wt,vt);function kt(){return mt((Math.random()*St<<0).toString(wt),vt)}function Tt(){return"c"+(new Date).getTime().toString(wt)+mt((yt=yt<St?yt:0,++yt-1).toString(wt),vt)+bt()+(kt()+kt())}Tt.fingerprint=bt;const Ct=ct(Tt);class At{constructor(t,e,s){if(this.performance=t,this.clock=e,this.observers=[],s&&Array.isArray(s.supportedEntryTypes)){const t=s.supportedEntryTypes;t.includes("largest-contentful-paint")&&this.observeLargestContentfulPaint(s),t.includes("layout-shift")&&this.observeLayoutShift(s)}}attachTo(t){const e=this.firstContentfulPaint();e&&t.addEvent("fcp",e);const s=this.timeToFirstByte();s&&t.addEvent("ttfb",s);const n=this.firstInputDelay();n&&(t.addEvent("fid_start",n.start),t.addEvent("fid_end",n.end)),this.cumulativeLayoutShift&&t.setAttribute("bugsnag.metrics.cls",this.cumulativeLayoutShift),this.largestContentfulPaint&&t.addEvent("lcp",this.largestContentfulPaint);for(const t of this.observers)t.disconnect()}firstContentfulPaint(){const t=this.performance.getEntriesByName("first-contentful-paint","paint"),e=Array.isArray(t)&&t[0];if(e)return e.startTime}timeToFirstByte(){const t=this.performance.getEntriesByType("navigation"),e=Array.isArray(t)&&t[0];let s;if((s=e?e.responseStart:this.performance.timing.responseStart-this.performance.timing.navigationStart)>0&&s<=this.clock.now())return s}firstInputDelay(){const t=this.performance.getEntriesByType("first-input"),e=Array.isArray(t)&&t[0];if(e)return{start:e.startTime,end:e.processingStart}}observeLargestContentfulPaint(t){const e=new t(t=>{const e=t.getEntries();e.length>0&&(this.largestContentfulPaint=e[e.length-1].startTime)});e.observe({type:"largest-contentful-paint",buffered:!0}),this.observers.push(e)}observeLayoutShift(t){let e;const s=new t(t=>{for(const s of t.getEntries())s.hadRecentInput||(e&&s.startTime-e.previousStartTime<1e3&&s.startTime-e.firstStartTime<5e3?(e.value+=s.value,e.previousStartTime=s.startTime):e={value:s.value,firstStartTime:s.startTime,previousStartTime:s.startTime});e&&(void 0===this.cumulativeLayoutShift||e.value>this.cumulativeLayoutShift)&&(this.cumulativeLayoutShift=e.value)});s.observe({type:"layout-shift",buffered:!0}),this.observers.push(s)}}let Pt,xt,It;if("undefined"==typeof window||"undefined"==typeof document)Pt=function(){const t=()=>{};return t.configure=(()=>{}),t}(),xt=D(),It=function(){const t=()=>{};return{start:t,startSpan:()=>({id:"",traceId:"",end:t,isValid:()=>!1}),currentSpanContext:void 0}}();else{const s=function(t){const e=[];let s="hidden"===t.document.visibilityState?"in-background":"in-foreground";const n={onStateChange(t){e.push(t),"in-background"===s&&t(s)}},r=t=>{if(s!==t){s=t;for(const t of e)t(s)}};return t.document.addEventListener("visibilitychange",function(){const e="hidden"===t.document.visibilityState?"in-background":"in-foreground";r(e)}),t.addEventListener("pagehide",function(){r("in-background")}),t.addEventListener("pageshow",function(){r("in-foreground")}),n}(window),r=(t=>{const e={url:{name:"bugsnag.browser.page.url",getValue:()=>t.location.href,permitted:!1},title:{name:"bugsnag.browser.page.title",getValue:()=>t.title,permitted:!1}};return{configure(t){e.title.permitted=t.sendPageAttributes.title||!1,e.url.permitted=t.sendPageAttributes.url||!1},requestAttributes(t){for(const s of Object.values(e))s.permitted&&t.setAttribute(s.name,s.getValue())}}})(document),i=function(t,e){let s=Z(void 0===t.timeOrigin?t.timing.navigationStart:t.timeOrigin,t);return e.onStateChange(e=>{"in-foreground"===e&&(s=Z(s,t))}),{now:()=>t.now(),date:()=>new Date(s+t.now()),convert:t=>t.getTime()-s,toUnixTimestampNanoseconds:t=>{return(e=s+t,Math.round(e*c)).toString();var e}}}(performance,s),o=function(t){try{if(t.localStorage)return new ut(t.localStorage)}catch(t){}return new P}(window),h=function(t,e){let s,n;return function(r){const a=new u(r.releaseStage,r.appVersion,"bugsnag.performance.browser","2.3.0");if(a.set("browser.user_agent",t.userAgent),t.userAgentData&&(a.set("browser.platform",t.userAgentData.platform),a.set("browser.mobile",t.userAgentData.mobile)),r.generateAnonymousId){if(s||(s=e.load("bugsnag-anonymous-id").then(t=>{const s=t||Ct();return t||e.save("bugsnag-anonymous-id",s),n=s})),!n)return s.then(t=>(a.set("device.id",t),a));a.set("device.id",n)}return Promise.resolve(a)}}(navigator,o),g=function(t,e){const s=new F,n=t.fetch;return t.fetch=function(r,a){const i=U(e.now(),r,a,t.document&&t.document.baseURI),o=s.start(i);return n.call(this,r,a).then(t=>(o({status:t.status,endTime:e.now(),state:"success"}),t)).catch(t=>{throw o({error:t,endTime:e.now(),state:"error"}),t})},s}(window,i),p=function(t,e,s){const n=new F,r=new WeakMap,a=new WeakMap,i=t.prototype.open;t.prototype.open=function(t,e,...n){r.set(this,{method:t,url:O(String(e),s&&s.baseURI)}),i.call(this,t,e,...n)};const o=t.prototype.send;return t.prototype.send=function(s){const i=r.get(this);if(i){const s=a.get(this);s&&this.removeEventListener("readystatechange",s);const r=n.start({type:"xmlhttprequest",method:i.method,url:i.url,startTime:e.now()}),o=s=>{if(this.readyState===t.DONE&&r){const t=this.status>0?{endTime:e.now(),status:this.status,state:"success"}:{endTime:e.now(),state:"error"};r(t)}};this.addEventListener("readystatechange",o),a.set(this,o)}o.call(this,s)},n}(XMLHttpRequest,i,document),y=new At(performance,i,window.PerformanceObserver);xt=_(Pt=function(t,e,s,n,r){const a=new rt(t,e.document),i=new it(t,s),o=new it(t,n),u=new at(t,e.addEventListener,r,e.document),c=new ot(t,[a,u,i,o]);function l(e){const s=t=>{clearTimeout(n),c.unsubscribe(s),e(t)},n=setTimeout(()=>{const n=t.now();c.unsubscribe(s),e(n)},6e4),r=c.isSettled()?100:0,a=t.now();setTimeout(()=>{c.isSettled()?s(a):c.subscribe(s)},r)}return l.configure=function(t){const e=t.settleIgnoreUrls.map(t=>"string"==typeof t?RegExp(t):t).concat(RegExp(t.endpoint));i.setUrlsToIgnore(e),o.setUrlsToIgnore(e)},l}(i,window,g,p,performance),window.location),It=function(t){const s=new w;let r=s;const a=t.spanContextStorage||new T(t.backgroundingListener);let i=t.schema.logger.defaultValue;const o=new k(1),u=new A(r,o,t.idGenerator,t.spanAttributesSource,t.clock,t.backgroundingListener,i,a),c=t.plugins(u,a);return Object.assign({start:a=>{const l=function(t,s){if("string"==typeof t&&(t={apiKey:t}),!e(t)||!n(t.apiKey)||0===t.apiKey.length)throw new Error("No Bugsnag API Key set");let r="";const a={};for(const e of Object.keys(s))Object.prototype.hasOwnProperty.call(t,e)?s[e].validate(t[e])?a[e]=t[e]:(r+=`\n  - ${e} ${s[e].message}, got ${typeof t[e]}`,a[e]=s[e].defaultValue):a[e]=s[e].defaultValue;return a.apiKey=t.apiKey,a.maximumBatchSize=t.maximumBatchSize||100,a.batchInactivityTimeoutMs=t.batchInactivityTimeoutMs||3e4,r.length>0&&a.logger.warn(`Invalid configuration${r}`),a}(a,t.schema),h=t.deliveryFactory(l.endpoint);t.spanAttributesSource.configure(l),v.create(t.persistence,o,new m(h,l.apiKey)).then(e=>{r=new d(h,l,t.retryQueueFactory(h,l.retryQueueMaxSize),o,e,new f(t.clock,l,t.resourceAttributesSource));for(const t of s.spans)r.add(t);t.backgroundingListener.onStateChange(t=>{r.flush()}),i=l.logger,u.configure(r,i)});for(const t of l.plugins)c.push(t);for(const t of c)t.configure(l,u)},startSpan:(t,e)=>{const s=u.validateSpanOptions(t,e),n=u.startSpan(s.name,s.options);return n.setAttribute("bugsnag.span.category","custom"),u.toPublicApi(n)},getPlugin:t=>{for(const e of c)if(e instanceof t)return e},get currentSpanContext(){return a.current}},t.platformExtensions&&t.platformExtensions(u,a))}({backgroundingListener:s,clock:i,resourceAttributesSource:h,spanAttributesSource:r,deliveryFactory:function(t,e,s){let n=!1;return s&&s.onStateChange(t=>{n="in-background"===t}),function(s){return{async send(r){const a=JSON.stringify(r.body);r.headers["Bugsnag-Sent-At"]=e.date().toISOString();try{const e=await t(s,{method:"POST",keepalive:n,body:a,headers:r.headers});return{state:(i=e.status,i>=200&&i<300?"success":i>=400&&i<500&&!b.has(i)?"failure-discard":"failure-retryable"),samplingProbability:E(e.headers)}}catch(t){return a.length>1e6?{state:"failure-discard"}:{state:"failure-retryable"}}var i}}}}(window.fetch,i,s),idGenerator:st,schema:(Rt=window.location.hostname,Et=new xt,Object.assign(Object.assign({},l),{releaseStage:Object.assign(Object.assign({},l.releaseStage),{defaultValue:"localhost"===Rt?"development":"production"}),autoInstrumentFullPageLoads:{defaultValue:!0,message:"should be true|false",validate:t},autoInstrumentNetworkRequests:{defaultValue:!0,message:"should be true|false",validate:t},autoInstrumentRouteChanges:{defaultValue:!0,message:"should be true|false",validate:t},generateAnonymousId:{defaultValue:!0,message:"should be true|false",validate:t},routingProvider:{defaultValue:Et,message:"should be a routing provider",validate:tt},settleIgnoreUrls:{defaultValue:[],message:"should be an array of string|RegExp",validate:a},networkRequestCallback:{defaultValue:L,message:"should be a function",validate:V},sendPageAttributes:{defaultValue:B,message:"should be an object",validate:q}})),plugins:(t,e)=>[Pt,new M(document,window.location,t,y,Pt,s,performance),new K(t,e,window.PerformanceObserver),new Q(t,g,p),new X(t,window.location,document)],persistence:o,retryQueueFactory:(t,e)=>new I(t,e)})}var Rt,Et;const Lt=It;export{xt as DefaultRoutingProvider,Lt as default,Pt as onSettle};
//# sourceMappingURL=bugsnag-performance.min.js.map
