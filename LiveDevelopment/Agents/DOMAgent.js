define(function DOMAgent(require,exports,module){var Inspector=require("LiveDevelopment/Inspector/Inspector"),EventDispatcher=require("utils/EventDispatcher"),EditAgent=require("LiveDevelopment/Agents/EditAgent"),DOMNode=require("LiveDevelopment/Agents/DOMNode"),DOMHelpers=require("LiveDevelopment/Agents/DOMHelpers"),_load,_idToNode,_pendingRequests;function nodeBeforeLocation(location){var node;return exports.root.each(function each(n){if(!n.location||location<n.location)return!0;(!node||node.location<n.location)&&(node=n)}),node}function allNodesAtLocation(location){var nodes=[];return exports.root.each(function each(n){n.type===DOMNode.TYPE_ELEMENT&&n.isAtLocation(location)&&nodes.push(n)}),nodes}function nodeAtLocation(location){return exports.root.find(function each(n){return n.isAtLocation(location,!1)})}function nodeWithId(nodeId){return _idToNode[nodeId]}function removeNode(node){node.nodeId&&delete _idToNode[node.nodeId]}function addNode(node){node.nodeId&&(_idToNode[node.nodeId]=node)}function requestChildNodes(node){_pendingRequests>=0&&_pendingRequests++,Inspector.DOM.requestChildNodes(node.nodeId)}function _cleanURL(url){var index=url.search(/[#\?]/);return index>=0&&(url=url.substr(0,index)),url}function _mapDocumentToSource(source){var node=exports.root;DOMHelpers.eachNode(source,function each(payload){if(!node)return!0;if(payload.closing){var parent=node.findParentForNextNodeMatchingPayload(payload);if(!parent)return console.warn("Matching Parent not at "+payload.sourceOffset+" ("+payload.nodeName+")");parent.closeLocation=payload.sourceOffset,parent.closeLength=payload.sourceLength}else{var next=node.findNextNodeMatchingPayload(payload);if(!next)return console.warn("Skipping Source Node at "+payload.sourceOffset);(node=next).location=payload.sourceOffset,node.length=payload.sourceLength,payload.closed&&(node.closed=payload.closed)}})}function _onFinishedLoadingDOM(){var request=new XMLHttpRequest;request.open("GET",exports.url),request.onload=function onLoad(){if(request.status>=200&&request.status<300||304===request.status||0===request.status)_mapDocumentToSource(request.response),_load.resolve();else{var msg="Received status "+request.status+" from XMLHttpRequest while attempting to load source file at "+exports.url;_load.reject(msg,{message:msg})}},request.onerror=function onError(){var msg="Could not load source file at "+exports.url;_load.reject(msg,{message:msg})},request.send(null)}function _onLoadEventFired(event,res){Inspector.DOM.getDocument(function onGetDocument(res){exports.trigger("getDocument",res),_idToNode={},_pendingRequests=0,exports.root=new DOMNode(exports,res.root)})}function _onFrameNavigated(event,res){res.frame.parentId||(exports.url=_cleanURL(res.frame.url))}function _onDocumentUpdated(event,res){}function _onSetChildNodes(event,res){var node;nodeWithId(res.parentId).setChildrenPayload(res.nodes),_pendingRequests>0&&0==--_pendingRequests&&_onFinishedLoadingDOM()}function _onChildNodeCountUpdated(event,res){res.nodeId>0&&Inspector.DOM.requestChildNodes(res.nodeId)}function _onChildNodeInserted(event,res){if(res.node.nodeId>0){var parent=nodeWithId(res.parentNodeId),previousNode=nodeWithId(res.previousNodeId),node=new DOMNode(exports,res.node);parent.insertChildAfter(node,previousNode)}}function _onChildNodeRemoved(event,res){var node;res.nodeId>0&&nodeWithId(res.nodeId).remove()}function applyChange(from,to,text){var delta=from-to+text.length,node=nodeAtLocation(from);if(node)if(3===node.type){var value=node.value.substr(0,from-node.location);value+=text,value+=node.value.substr(to-node.location),node.value=value,EditAgent.isEditing||Inspector.DOM.setNodeValue(node.nodeId,node.value)}else console.warn("Changing non-text nodes not supported.");else/^\s*$/.test(text)||(console.warn("Inserting nodes not supported."),node=nodeBeforeLocation(from));node&&(node.length+=delta,exports.root.each(function each(n){n.location>node.location&&(n.location+=delta),void 0!==n.closeLocation&&n.closeLocation>node.location&&(n.closeLocation+=delta)}))}function enable(){return Inspector.DOM.enable()}function disable(){return Inspector.DOM.disable()}function load(){return _load=new $.Deferred,Inspector.Page.on("frameNavigated.DOMAgent",_onFrameNavigated).on("loadEventFired.DOMAgent",_onLoadEventFired),Inspector.DOM.on("documentUpdated.DOMAgent",_onDocumentUpdated).on("setChildNodes.DOMAgent",_onSetChildNodes).on("childNodeCountUpdated.DOMAgent",_onChildNodeCountUpdated).on("childNodeInserted.DOMAgent",_onChildNodeInserted).on("childNodeRemoved.DOMAgent",_onChildNodeRemoved),_load.promise()}function unload(){Inspector.Page.off(".DOMAgent"),Inspector.DOM.off(".DOMAgent")}EventDispatcher.makeEventDispatcher(exports),exports.enable=enable,exports.disable=disable,exports.nodeBeforeLocation=nodeBeforeLocation,exports.allNodesAtLocation=allNodesAtLocation,exports.nodeAtLocation=nodeAtLocation,exports.nodeWithId=nodeWithId,exports.removeNode=removeNode,exports.addNode=addNode,exports.requestChildNodes=requestChildNodes,exports.applyChange=applyChange,exports.load=load,exports.unload=unload});
//# sourceMappingURL=DOMAgent.js.map
