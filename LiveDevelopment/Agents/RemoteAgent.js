define(function RemoteAgent(require,exports,module){var LiveDevelopment=require("LiveDevelopment/LiveDevelopment"),EventDispatcher=require("utils/EventDispatcher"),Inspector=require("LiveDevelopment/Inspector/Inspector"),RemoteFunctions=require("text!LiveDevelopment/Agents/RemoteFunctions.js"),PreferencesManager=require("preferences/PreferencesManager"),_load,_objectId,_intervalId;function _onAttributeModified(event,res){var matches=/^data-ld-(.*)/.exec(res.name);matches&&exports.trigger(matches[1],res)}function _call(objectId,method,varargs){console.assert(objectId,"Attempted to call remote method without objectId set.");var args=Array.prototype.slice.call(arguments,2),callback,deferred=new $.Deferred;return"function"==typeof args[args.length-1]&&(callback=args.pop()),args=args.map(function(arg){return arg&&arg.nodeId?arg.resolve():arg}),$.when.apply(void 0,args).done(function onResolvedAllNodes(){var params=[];args.forEach(function(arg){arg.objectId?params.push({objectId:arg.objectId}):params.push({value:arg})}),Inspector.Runtime.callFunctionOn(objectId,method,params,void 0,callback).then(deferred.resolve,deferred.reject)}),deferred.promise()}function call(method,varargs){var argsArray=[_objectId,"_LD."+method];return arguments.length>1&&(argsArray=argsArray.concat(Array.prototype.slice.call(arguments,1))),_call.apply(null,argsArray)}function _stopKeepAliveInterval(){_intervalId&&(window.clearInterval(_intervalId),_intervalId=null)}function _startKeepAliveInterval(){_stopKeepAliveInterval(),_intervalId=window.setInterval(function(){call("keepAlive")},1e3)}function _onFrameNavigated(event,res){if(!res.frame.parentId){_stopKeepAliveInterval();var command="window._LD="+RemoteFunctions+"("+JSON.stringify(LiveDevelopment.config)+","+PreferencesManager.get("livedev.wsPort")+");";Inspector.Runtime.evaluate(command,function onEvaluate(response){response.error||response.wasThrown?_load.reject(response.error):(_objectId=response.result.objectId,_load.resolve(),_startKeepAliveInterval())})}}function load(){return _load=new $.Deferred,Inspector.Page.on("frameNavigated.RemoteAgent",_onFrameNavigated),Inspector.Page.on("frameStartedLoading.RemoteAgent",_stopKeepAliveInterval),Inspector.DOM.on("attributeModified.RemoteAgent",_onAttributeModified),_load.promise()}function unload(){Inspector.Page.off(".RemoteAgent"),Inspector.DOM.off(".RemoteAgent"),_stopKeepAliveInterval()}EventDispatcher.makeEventDispatcher(exports),exports.call=call,exports.load=load,exports.unload=unload});
//# sourceMappingURL=RemoteAgent.js.map
