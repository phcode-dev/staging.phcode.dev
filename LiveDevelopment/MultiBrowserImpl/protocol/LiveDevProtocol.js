define(function(require,exports,module){var EventDispatcher=require("utils/EventDispatcher"),LiveDevProtocolRemote=require("text!LiveDevelopment/MultiBrowserImpl/protocol/remote/LiveDevProtocolRemote.js"),DocumentObserver=require("text!LiveDevelopment/MultiBrowserImpl/protocol/remote/DocumentObserver.js"),RemoteFunctions=require("text!LiveDevelopment/Agents/RemoteFunctions.js"),EditorManager=require("editor/EditorManager"),LiveDevMultiBrowser=require("LiveDevelopment/LiveDevMultiBrowser"),HTMLInstrumentation=require("language/HTMLInstrumentation"),_connections={},_transport=null,_nextMsgId=1,_responseDeferreds={};function getConnectionIds(){return Object.keys(_connections)}function _receive(clientId,msgStr){var msg=JSON.parse(msgStr),event=msg.method||"event",deferred;if(msg.id)(deferred=_responseDeferreds[msg.id])&&(delete _responseDeferreds[msg.id],msg.error?deferred.reject(msg):deferred.resolve(msg));else if(msg.tagId){var editor=EditorManager.getActiveEditor(),position=HTMLInstrumentation.getPositionFromTagId(editor,parseInt(msg.tagId,10));position&&editor.setCursorPos(position.line,position.ch,!0)}else msg.clientId=clientId,exports.trigger(event,msg)}function _send(msg,clients){var id=_nextMsgId++,result=new $.Deferred;return clients=clients||getConnectionIds(),msg.id=id,_responseDeferreds[id]=result,_transport.send(clients,JSON.stringify(msg)),result.promise()}function _connect(clientId,url){_connections[clientId]=!0,exports.trigger("ConnectionConnect",{clientId:clientId,url:url})}function _close(clientId){delete _connections[clientId],exports.trigger("ConnectionClose",{clientId:clientId})}function setTransport(transport){_transport&&_transport.off(".livedev"),(_transport=transport).on("connect.livedev",function(event,msg){_connect(msg[0],msg[1])}).on("message.livedev",function(event,msg){_receive(msg[0],msg[1])}).on("close.livedev",function(event,msg){_close(msg[0])}),_transport.start()}function getRemoteFunctionsScript(){var script="";return script+=DocumentObserver,"<script>\n"+(script+="window._LD=("+RemoteFunctions+"("+JSON.stringify(LiveDevMultiBrowser.config)+"))")+"<\/script>\n"}function getRemoteScript(){var transportScript=_transport.getRemoteScript()||"",remoteFunctionsScript=getRemoteFunctionsScript()||"";return transportScript+"<script>\n"+LiveDevProtocolRemote+"<\/script>\n"+remoteFunctionsScript}function evaluate(script,clients){return _send({method:"Runtime.evaluate",params:{expression:script}},clients)}function setStylesheetText(url,text,clients){return _send({method:"CSS.setStylesheetText",params:{url:url,text:text}})}function getStylesheetText(url,clients){return _send({method:"CSS.getStylesheetText",params:{url:url}},clients)}function reload(ignoreCache,clients){return _send({method:"Page.reload",params:{ignoreCache:!0}},clients)}function navigate(url,clients){return _send({method:"Page.navigate",params:{url:url}},clients)}function close(clientId){_transport.close(clientId)}function closeAllConnections(){getConnectionIds().forEach(function(clientId){close(clientId)}),_connections={}}EventDispatcher.makeEventDispatcher(exports),exports.setTransport=setTransport,exports.getRemoteScript=getRemoteScript,exports.evaluate=evaluate,exports.setStylesheetText=setStylesheetText,exports.getStylesheetText=getStylesheetText,exports.reload=reload,exports.navigate=navigate,exports.close=close,exports.getConnectionIds=getConnectionIds,exports.closeAllConnections=closeAllConnections});
//# sourceMappingURL=LiveDevProtocol.js.map
