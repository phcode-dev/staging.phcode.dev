define(function(require,exports,module){const EventDispatcher=require("utils/EventDispatcher"),Metrics=require("utils/Metrics"),METRIC_SEND_INTERVAL_MS=1e3;let transportMessagesCount=0,transportMessagesSizeB=0;setInterval(()=>{transportMessagesCount>0&&(Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"transport","msgCount",transportMessagesCount),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"transport","msgSizeB",transportMessagesSizeB),transportMessagesCount=0,transportMessagesSizeB=0)},1e3);const ServiceWorkerTransportRemote=require("text!LiveDevelopment/BrowserScripts/ServiceWorkerTransportRemote.js"),BROADCAST_CHANNEL_ID=`${Math.round(1e12*Math.random())}_livePreview`;let _broadcastChannel=new BroadcastChannel(BROADCAST_CHANNEL_ID);function getRemoteScript(){return"<script>\n"+`window.LIVE_PREVIEW_BROADCAST_CHANNEL_ID = "${BROADCAST_CHANNEL_ID}";\n`+`window.LIVE_PREVIEW_DEBIG_ENABLED = ${window.loggingOptions.logLivePreview};\n`+ServiceWorkerTransportRemote+"<\/script>\n"}EventDispatcher.makeEventDispatcher(exports),exports.getRemoteScript=getRemoteScript,exports.start=function(){addEventListener("beforeunload",function(){_broadcastChannel.postMessage({type:"PHOENIX_CLOSE"})}),_broadcastChannel.onmessage=(event=>{window.loggingOptions.livePreview.log("Live Preview: Phoenix received event from Browser preview tab/iframe: ",event.data);const type=event.data.type;switch(type){case"BROWSER_CONNECT":exports.trigger("connect",[event.data.clientID,event.data.url]);break;case"BROWSER_MESSAGE":const message=event.data.message||"";exports.trigger("message",[event.data.clientID,message]),transportMessagesSizeB+=message.length;break;case"BROWSER_CLOSE":exports.trigger("close",[event.data.clientID]);break;default:console.error("ServiceWorkerTransport received unknown message from Browser preview:",event)}transportMessagesCount++})},exports.close=function(){},exports.send=function(...args){_broadcastChannel.postMessage({type:"MESSAGE_FROM_PHOENIX",args:args})}});
//# sourceMappingURL=ServiceWorkerTransport.js.map
