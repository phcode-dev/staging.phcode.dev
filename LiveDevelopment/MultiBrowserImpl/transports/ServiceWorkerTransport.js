define(function(require,exports,module){const EventDispatcher=require("utils/EventDispatcher"),Metrics=require("utils/Metrics"),METRIC_SEND_INTERVAL_MS=1e3;let transportMessagesRecvCount=0,transportMessagesSendCount=0,transportMessagesRecvSizeB=0,transportMessagesSendSizeB=0;setInterval(()=>{transportMessagesRecvCount>0&&(Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"message","sendCount",transportMessagesSendCount),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"message","recvCount",transportMessagesRecvCount),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"message","sentBytes",transportMessagesSendSizeB),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"message","recvBytes",transportMessagesRecvSizeB),transportMessagesRecvCount=0,transportMessagesSendCount=0,transportMessagesRecvSizeB=0,transportMessagesSendSizeB=0)},1e3);const ServiceWorkerTransportRemote=require("text!LiveDevelopment/BrowserScripts/ServiceWorkerTransportRemote.js"),BROADCAST_CHANNEL_ID=`${Math.round(1e12*Math.random())}_livePreview`;let _broadcastChannel=new BroadcastChannel(BROADCAST_CHANNEL_ID);function getRemoteScript(){return"<script>\n"+`window.LIVE_PREVIEW_BROADCAST_CHANNEL_ID = "${BROADCAST_CHANNEL_ID}";\n`+`window.LIVE_PREVIEW_DEBIG_ENABLED = ${window.loggingOptions.logLivePreview};\n`+ServiceWorkerTransportRemote+"<\/script>\n"}EventDispatcher.makeEventDispatcher(exports),exports.getRemoteScript=getRemoteScript,exports.start=function(){addEventListener("beforeunload",function(){_broadcastChannel.postMessage({type:"PHOENIX_CLOSE"})}),_broadcastChannel.onmessage=(event=>{window.loggingOptions.livePreview.log("Live Preview: Phoenix received event from Browser preview tab/iframe: ",event.data);const type=event.data.type;switch(type){case"BROWSER_CONNECT":exports.trigger("connect",[event.data.clientID,event.data.url]);break;case"BROWSER_MESSAGE":const message=event.data.message||"";exports.trigger("message",[event.data.clientID,message]),transportMessagesRecvSizeB+=message.length;break;case"BROWSER_CLOSE":exports.trigger("close",[event.data.clientID]);break;default:console.error("ServiceWorkerTransport received unknown message from Browser preview:",event)}transportMessagesRecvCount++})},exports.close=function(){},exports.send=function(clientIDs,message){message=message||"",_broadcastChannel.postMessage({type:"MESSAGE_FROM_PHOENIX",clientIDs:clientIDs,message:message}),transportMessagesSendCount++,transportMessagesSendSizeB+=message.length}});
//# sourceMappingURL=ServiceWorkerTransport.js.map
