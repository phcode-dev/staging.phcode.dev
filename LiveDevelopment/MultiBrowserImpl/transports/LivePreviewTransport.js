define(function(require,exports,module){const LiveDevProtocol=require("LiveDevelopment/MultiBrowserImpl/protocol/LiveDevProtocol"),EventDispatcher=require("utils/EventDispatcher"),Metrics=require("utils/Metrics"),METRIC_SEND_INTERVAL_MS=1e3;let transportMessagesRecvCount=0,transportMessagesSendCount=0,transportMessagesRecvSizeB=0,transportMessagesSendSizeB=0;setInterval(()=>{transportMessagesRecvCount>0&&(Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"message","sendCount",transportMessagesSendCount),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"message","recvCount",transportMessagesRecvCount),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"message","sentBytes",transportMessagesSendSizeB),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"message","recvBytes",transportMessagesRecvSizeB),transportMessagesRecvCount=0,transportMessagesSendCount=0,transportMessagesRecvSizeB=0,transportMessagesSendSizeB=0)},1e3);const LivePreviewTransportRemote=require("text!LiveDevelopment/BrowserScripts/LivePreviewTransportRemote.js");let _transportBridge;function getRemoteScript(){const replaceString="const TRANSPORT_CONFIG={};";if(!LivePreviewTransportRemote.includes(replaceString))throw new Error("Live preview transport is expected to have replaceable template string: //REPLACE_ME_WITH_LIVE_PREVIEW_TRANSPORT_CONFIG_AND_SCRIPT_DYNAMIC");let transportScript=_transportBridge&&_transportBridge.getRemoteTransportScript&&_transportBridge.getRemoteTransportScript()||"";return transportScript="const TRANSPORT_CONFIG={};"+`TRANSPORT_CONFIG.PHOENIX_INSTANCE_ID = "${Phoenix.PHOENIX_INSTANCE_ID}";\n`+`TRANSPORT_CONFIG.LIVE_DEV_REMOTE_WORKER_SCRIPTS_FILE_NAME = "${LiveDevProtocol.LIVE_DEV_REMOTE_WORKER_SCRIPTS_FILE_NAME}";\n`+`TRANSPORT_CONFIG.LIVE_PREVIEW_DEBUG_ENABLED = ${logger.loggingOptions.logLivePreview};\n`+transportScript,LivePreviewTransportRemote.replace(replaceString,transportScript)+"\n"}function start(){addEventListener("beforeunload",function(){_transportBridge&&_transportBridge.messageToLivePreviewTabs({type:"PHOENIX_CLOSE"})})}function close(){}function send(clientIDs,message){message=message||"",_transportBridge&&_transportBridge.messageToLivePreviewTabs({type:"MESSAGE_FROM_PHOENIX",clientIDs:clientIDs,message:message}),transportMessagesSendCount++,transportMessagesSendSizeB+=message.length}function _browserConnect(_ev,event){window.logger.livePreview.log("Live Preview: Phoenix received event from Browser preview tab/iframe: ",event.data),exports.trigger("connect",[event.data.message.clientID,event.data.message.url]),transportMessagesRecvCount++}function _browserClose(_ev,event){window.logger.livePreview.log("Live Preview: Phoenix received event from Browser preview tab/iframe: ",event.data),exports.trigger("close",[event.data.message.clientID]),transportMessagesRecvCount++}function _browserMessage(_ev,event){window.logger.livePreview.log("Live Preview: Phoenix received event from Browser preview tab/iframe: ",event.data);const message=event.data.message.message||"";exports.trigger("message",[event.data.message.clientID,message]),transportMessagesRecvSizeB+=message.length,transportMessagesRecvCount++}function setLivePreviewTransportBridge(transportBridge){_transportBridge=transportBridge,transportBridge.off("BROWSER_CONNECT.transport"),transportBridge.on("BROWSER_CONNECT.transport",_browserConnect),transportBridge.off("BROWSER_CLOSE.transport"),transportBridge.on("BROWSER_CLOSE.transport",_browserClose),transportBridge.off("BROWSER_MESSAGE.transport"),transportBridge.on("BROWSER_MESSAGE.transport",_browserMessage)}EventDispatcher.makeEventDispatcher(exports),exports.getRemoteScript=getRemoteScript,exports.setLivePreviewTransportBridge=setLivePreviewTransportBridge,exports.start=start,exports.close=close,exports.send=send});
//# sourceMappingURL=LivePreviewTransport.js.map
