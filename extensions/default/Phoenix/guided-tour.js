define(function(require,exports,module){const NotificationUI=brackets.getModule("widgets/NotificationUI"),LiveDevelopment=brackets.getModule("LiveDevelopment/main"),ExtensionInterface=brackets.getModule("utils/ExtensionInterface"),WorkspaceManager=brackets.getModule("view/WorkspaceManager"),MainViewManager=brackets.getModule("view/MainViewManager"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),Strings=brackets.getModule("strings"),Menus=brackets.getModule("command/Menus"),StringUtils=brackets.getModule("utils/StringUtils"),KeyBindingManager=brackets.getModule("command/KeyBindingManager"),Metrics=brackets.getModule("utils/Metrics"),Dialogs=brackets.getModule("widgets/Dialogs"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),SurveyTemplate=require("text!html/survey-template.html"),NOTIFICATION_BACKOFF=1e4,GUIDED_TOUR_LOCAL_STORAGE_KEY="guidedTourActions",GITHUB_STARS_POPUP_TIME=12e4,POWER_USER_SURVEY_TIME=18e4,GENERAL_SURVEY_TIME=6e5,TWO_WEEKS_IN_DAYS=14,USAGE_COUNTS_KEY="healthDataUsage",userAlreadyDidAction=localStorage.getItem(GUIDED_TOUR_LOCAL_STORAGE_KEY)?JSON.parse(localStorage.getItem(GUIDED_TOUR_LOCAL_STORAGE_KEY)):{version:1,clickedNewProjectIcon:!1,beautifyCodeShown:!1,generalSurveyShownVersion:0};let currentlyShowingNotification;function _shouldContinueCommandTracking(){return!userAlreadyDidAction.clickedNewProjectIcon}function _startCommandTracking(){function commandTracker(_event,commandID){let write=!1;switch(commandID){case Commands.FILE_NEW_PROJECT:userAlreadyDidAction.clickedNewProjectIcon=!0,write=!0}write&&localStorage.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction)),_shouldContinueCommandTracking()||CommandManager.off(CommandManager.EVENT_BEFORE_EXECUTE_COMMAND,commandTracker)}_shouldContinueCommandTracking()&&CommandManager.on(CommandManager.EVENT_BEFORE_EXECUTE_COMMAND,commandTracker)}function _showBeautifyNotification(){if(userAlreadyDidAction.beautifyCodeShown)return;let editorContextMenu=Menus.getContextMenu(Menus.ContextMenuIds.EDITOR_MENU);function _showNotification(){currentlyShowingNotification||setTimeout(()=>{let keyboardShortcut=KeyBindingManager.getKeyBindings(Commands.EDIT_BEAUTIFY_CODE);keyboardShortcut=keyboardShortcut&&keyboardShortcut[0]?keyboardShortcut[0].displayKey:"-",userAlreadyDidAction.beautifyCodeShown=!0,localStorage.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction)),Metrics.countEvent(Metrics.EVENT_TYPE.UI,"guide","beautify"),(currentlyShowingNotification=NotificationUI.createFromTemplate(StringUtils.format(Strings.BEAUTIFY_CODE_NOTIFICATION,keyboardShortcut),"editor-context-menu-edit.beautifyCode",{allowedPlacements:["left","right"],autoCloseTimeS:15,dismissOnClick:!0})).done(()=>{currentlyShowingNotification=null}),editorContextMenu.off(Menus.EVENT_BEFORE_CONTEXT_MENU_OPEN,_showNotification)},500)}editorContextMenu.on(Menus.EVENT_BEFORE_CONTEXT_MENU_OPEN,_showNotification)}function _showNewProjectNotification(){function _showNotification(){currentlyShowingNotification||(Metrics.countEvent(Metrics.EVENT_TYPE.UI,"guide","newProj"),(currentlyShowingNotification=NotificationUI.createFromTemplate(Strings.NEW_PROJECT_NOTIFICATION,"newProject",{allowedPlacements:["top","bottom"],autoCloseTimeS:15,dismissOnClick:!0})).done(()=>{currentlyShowingNotification=null}),MainViewManager.off(MainViewManager.EVENT_CURRENT_FILE_CHANGE,_showNotification))}userAlreadyDidAction.clickedNewProjectIcon||MainViewManager.on(MainViewManager.EVENT_CURRENT_FILE_CHANGE,_showNotification)}function _showPopoutLivePreviewNotification(){ExtensionInterface.waitAndGetExtensionInterface(ExtensionInterface._DEFAULT_EXTENSIONS_INTERFACE_NAMES.PHOENIX_LIVE_PREVIEW).then(livePreviewExtension=>{function _showNotification(){let notificationKey="livePreviewPopoutShown",version="v1",popoutMessageShown;"v1"!==localStorage.getItem(notificationKey)?currentlyShowingNotification||(WorkspaceManager.isPanelVisible(livePreviewExtension.LIVE_PREVIEW_PANEL_ID)&&(Metrics.countEvent(Metrics.EVENT_TYPE.UI,"guide","lp_popout"),(currentlyShowingNotification=NotificationUI.createFromTemplate(Strings.GUIDED_LIVE_PREVIEW_POPOUT,"livePreviewPopoutButton",{allowedPlacements:["bottom"],autoCloseTimeS:15,dismissOnClick:!0})).done(()=>{currentlyShowingNotification=null}),localStorage.setItem(notificationKey,"v1")),LiveDevelopment.off(LiveDevelopment.EVENT_LIVE_PREVIEW_CLICKED,_showNotification)):LiveDevelopment.off(LiveDevelopment.EVENT_LIVE_PREVIEW_CLICKED,_showNotification)}LiveDevelopment.on(LiveDevelopment.EVENT_LIVE_PREVIEW_CLICKED,_showNotification)})}function _showLivePreviewNotification(){const livePreviewNotificationKey="newProjectNotificationShown",livePreviewNotificationShown=localStorage.getItem(livePreviewNotificationKey);livePreviewNotificationShown||(currentlyShowingNotification?setTimeout(_showLivePreviewNotification,NOTIFICATION_BACKOFF):(currentlyShowingNotification=NotificationUI.createFromTemplate(Strings.GUIDED_LIVE_PREVIEW,"main-toolbar",{allowedPlacements:["left"],autoCloseTimeS:15,dismissOnClick:!0}),localStorage.setItem(livePreviewNotificationKey,"true"),currentlyShowingNotification.done(()=>{currentlyShowingNotification=null})))}function _openStarsPopup(){let html=`${Strings.GITHUB_STARS_POPUP}\n                        <div style="display: flex;justify-content: space-around;margin-top: 6px;">\n                            <a class="github-button"\n                             href="https://github.com/phcode-dev/phoenix"\n                             data-color-scheme="no-preference: dark; light: dark; dark: dark;"\n                             data-icon="octicon-star"\n                             data-size="large"\n                             data-show-count="true"\n                             title="Star phcode.dev on GitHub"\n                             aria-label="Star phcode-dev/phoenix on GitHub">Star</a>\n                           <script async defer src="https://buttons.github.io/buttons.js"><\/script>\n                        </div>\n                       ${Strings.GITHUB_STARS_POPUP_TWITTER}\n                       <div style="display: flex;justify-content: space-around;margin-top: 6px;">\n                            <a href="https://twitter.com/intent/tweet?screen_name=phcodedev&ref_src=twsrc%5Etfw"\n                             class="twitter-mention-button"\n                             data-size="large"\n                             data-related="BracketsCont,brackets"\n                             data-show-count="false">Tweet to @phcodedev</a>\n                             <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"><\/script>\n                       </div>\n                    </div>`;NotificationUI.createToastFromTemplate(Strings.ENJOYING_APP,html,{dismissOnClick:!1})}function _showRequestStarsPopup(){let lastShownDate=userAlreadyDidAction.lastShownGithubStarsDate,nextShowDate=new Date(lastShownDate);nextShowDate.setDate(nextShowDate.getDate()+TWO_WEEKS_IN_DAYS);let currentDate=new Date;(!lastShownDate||currentDate>=nextShowDate)&&setTimeout(()=>{Metrics.countEvent(Metrics.EVENT_TYPE.USER,"notify","star",1),_openStarsPopup(),userAlreadyDidAction.lastShownGithubStarsDate=Date.now(),localStorage.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction))},GITHUB_STARS_POPUP_TIME)}function _showGeneralSurvey(){setTimeout(()=>{let surveyVersion=5;var templateVars={Strings:Strings,surveyURL:"https://s.surveyplanet.com/6208d1eccd51c561fc8e59ca"};5!==userAlreadyDidAction.generalSurveyShownVersion&&(Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","generalShown",1),Dialogs.showModalDialogUsingTemplate(Mustache.render(SurveyTemplate,templateVars)),userAlreadyDidAction.generalSurveyShownVersion=5,localStorage.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction)))},GENERAL_SURVEY_TIME)}function _isPowerUser(){let usageData=PreferencesManager.getViewState(USAGE_COUNTS_KEY)||{},dateKeys=Object.keys(usageData),dateBefore14Days=new Date,totalUsageMinutes=0,totalUsageDays=0;dateBefore14Days.setDate(dateBefore14Days.getDate()-14);for(let dateKey of dateKeys){let date;new Date(dateKey)>=dateBefore14Days&&(totalUsageDays++,totalUsageMinutes+=usageData[dateKey])}return totalUsageDays>=3||totalUsageMinutes/60>=8}function _openPowerUserSurvey(){Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","powerShown",1);const templateVars={Strings:Strings,surveyURL:"https://s.surveyplanet.com/2dgk0hbn"};Dialogs.showModalDialogUsingTemplate(Mustache.render(SurveyTemplate,templateVars))}function _showPowerUserSurvey(){if(_isPowerUser()){Metrics.countEvent(Metrics.EVENT_TYPE.USER,"power","user",1);let lastShownDate=userAlreadyDidAction.lastShownPowerSurveyDate,nextShowDate=new Date(lastShownDate),currentDate;if(nextShowDate.setDate(nextShowDate.getDate()+TWO_WEEKS_IN_DAYS),new Date<nextShowDate)return;setTimeout(()=>{Metrics.countEvent(Metrics.EVENT_TYPE.USER,"notify","powerSurvey",1);let $content=$(Strings.POWER_USER_POPUP_TEXT);$content.find("a").click(_openPowerUserSurvey),NotificationUI.createToastFromTemplate(Strings.POWER_USER_POPUP_TITLE,$content),userAlreadyDidAction.lastShownPowerSurveyDate=Date.now(),localStorage.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction))},POWER_USER_SURVEY_TIME)}}let tourStarted=!1;exports.startTourIfNeeded=function(){tourStarted||(tourStarted=!0,_showLivePreviewNotification(),_showPopoutLivePreviewNotification(),_showNewProjectNotification(),_startCommandTracking(),_showBeautifyNotification(),_showRequestStarsPopup(),_showGeneralSurvey(),_showPowerUserSurvey())}});
//# sourceMappingURL=guided-tour.js.map
