{"version":3,"sources":["extensions/default/Phoenix/serverSync.js"],"names":["define","require","exports","module","ProjectManager","brackets","getModule","DocumentManager","EditorManager","ExtensionUtils","Dialogs","Strings","StringUtils","DefaultDialogs","Metrics","syncRoot","$icon","userContext","publishURL","USER_CONTEXT","ongoingSyncCount","syncEnabled","projectSyncStarted","projectSyncCompleted","tab","previewURL","previewInProgress","_setupUserContext","localStorage","getItem","Math","round","random","toString","setItem","_getProjectPreviewURL","projectName","getProjectRoot","name","_uploadFile","filePath","blob","resolve","reject","console","log","uploadFormData","FormData","projectRoot","path","dirname","relativePath","relative","fileName","basename","append","$","ajax","url","type","data","cache","contentType","processData","success","r","error","_readAndUploadFile","file","Promise","fullPath","read","encoding","window","fs","BYTE_ARRAY_ENCODING","err","content","stat","Blob","_uploadFiles","fileList","doneCB","allPromises","push","all","then","_startSync","doneCb","_setSyncInProgress","newSyncRoot","newSyncPath","getAllFiles","files","length","showModalDialog","DIALOG_ID_ERROR","CANNOT_PUBLISH_LARGE_PROJECT","CANNOT_PUBLISH_LARGE_PROJECT_MESSAGE","_setSyncComplete","_projectOpened","allChangedFiles","async","_collectFiles","dirEntry","getContents","fsEntries","fsEntry","isDirectory","contentFiles","_projectFileChanged","target","entry","added","removed","attr","class","title","PUBLISH_SYNC_IN_PROGRESS","PUBLISH_VIEW_PAGE","_showPublishConsentDialogue","publishMessage","format","PUBLISH_CONSENT_MESSAGE","DIALOG_ID_INFO","SHARE_WEBSITE","className","DIALOG_BTN_CLASS_NORMAL","id","DIALOG_BTN_CANCEL","text","CANCEL","DIALOG_BTN_CLASS_PRIMARY","DIALOG_BTN_OK","PUBLISH","done","_loadPreview","_isPreviewableFile","pathSplit","split","extension","includes","toLowerCase","projectRootUrl","currentDocument","getCurrentDocument","currentFile","getSelectedItem","closed","open","location","_addToolbarIcon","syncButtonID","href","PUBLISH_PAGE","appendTo","on","countEvent","EVENT_TYPE","SHARING","uniqueFilesToUpload","Set","setInterval","init","EVENT_PROJECT_OPEN","EVENT_PROJECT_FILE_CHANGED","loadStyleSheet"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/*global fs, Phoenix, path*/\n/*eslint no-console: 0*/\n/*eslint strict: [\"error\", \"global\"]*/\n/* jshint ignore:start */\n\ndefine(function (require, exports, module) {\n\n    const ProjectManager          = brackets.getModule(\"project/ProjectManager\"),\n        DocumentManager     = brackets.getModule(\"document/DocumentManager\"),\n        EditorManager       = brackets.getModule(\"editor/EditorManager\"),\n        ExtensionUtils      = brackets.getModule(\"utils/ExtensionUtils\"),\n        Dialogs             = brackets.getModule(\"widgets/Dialogs\"),\n        Strings             = brackets.getModule(\"strings\"),\n        StringUtils         = brackets.getModule(\"utils/StringUtils\"),\n        DefaultDialogs      = brackets.getModule(\"widgets/DefaultDialogs\"),\n        Metrics             = brackets.getModule(\"utils/Metrics\");\n\n    let syncRoot = \"\";\n    let $icon;\n    let userContext = \"\";\n    let publishURL = \"https://phcode.site\";\n    const USER_CONTEXT = \"publish.userContext\";\n    let ongoingSyncCount = 0;\n    let syncEnabled = false;\n    let projectSyncStarted = false;\n    let projectSyncCompleted = false;\n    let tab = null;\n    let previewURL;\n    let previewInProgress = false;\n\n    function _setupUserContext() {\n        userContext = localStorage.getItem(USER_CONTEXT);\n        if(!userContext){\n            userContext = \"p-\" + Math.round( Math.random()*10000000000000).toString(16);\n            localStorage.setItem(USER_CONTEXT, userContext);\n        }\n    }\n\n    function _getProjectPreviewURL() {\n        let projectName = ProjectManager.getProjectRoot().name;\n        return `${publishURL}/p/${userContext}/${projectName}`;\n    }\n\n    function _uploadFile(filePath, blob, resolve, reject) {\n        console.log('Uploading file for preview: ', filePath);\n        let uploadFormData = new FormData();\n        let projectRoot = path.dirname(syncRoot);\n        let relativePath = path.relative(projectRoot, filePath);\n        let fileName = path.basename(filePath);\n        uploadFormData.append(\"path\", `${userContext}/${path.dirname(relativePath)}`);\n        uploadFormData.append(\"files\", blob, fileName);\n        $.ajax({\n            url: publishURL + '/upload',\n            type: \"POST\",\n            data: uploadFormData,\n            cache: false,\n            contentType: false,\n            processData: false,\n            success: function(r) {\n                resolve();\n            },\n            error: function(r) {\n                reject();\n            }\n        });\n    }\n\n    function _readAndUploadFile(file) {\n        return new Promise((resolve, reject)=>{\n            if(file.fullPath === '/fs/app/state.json'){\n                // somehow we get these changes as project file changes too. don't sync state file\n                resolve();\n                return;\n            }\n            file.read({encoding: window.fs.BYTE_ARRAY_ENCODING}, function (err, content, encoding, stat) {\n                if (err){\n                    reject(err);\n                    return;\n                }\n                let blob = new Blob([content], {type:\"application/octet-stream\"});\n                _uploadFile(file.fullPath, blob, resolve, reject);\n            });\n        });\n    }\n\n    function _uploadFiles(fileList, doneCB) {\n        let allPromises = [];\n        for(let file of fileList){\n            allPromises.push(_readAndUploadFile(file));\n        }\n        Promise.all(allPromises).then(()=>{\n            doneCB();\n        });\n    }\n\n    function _startSync(doneCb) {\n        if(!syncEnabled){\n            return;\n        }\n        projectSyncStarted = true;\n        projectSyncCompleted = false;\n        _setSyncInProgress();\n        let newSyncRoot = ProjectManager.getProjectRoot();\n        let newSyncPath = newSyncRoot.fullPath;\n        if(newSyncPath !== syncRoot){\n            syncRoot = newSyncPath;\n            ProjectManager.getAllFiles().then((files)=>{\n                if(files.length > 500){\n                    Dialogs.showModalDialog(\n                        DefaultDialogs.DIALOG_ID_ERROR,\n                        Strings.CANNOT_PUBLISH_LARGE_PROJECT,\n                        Strings.CANNOT_PUBLISH_LARGE_PROJECT_MESSAGE\n                    );\n                    _setSyncComplete();\n                    if(doneCb){\n                        doneCb();\n                    }\n                    return;\n                }\n                _uploadFiles(files, ()=>{\n                    projectSyncCompleted = true;\n                    if(doneCb){\n                        doneCb();\n                    }\n                    _setSyncComplete();\n                });\n            });\n        }\n    }\n\n    function _projectOpened() {\n        syncEnabled = false;\n        projectSyncStarted = false;\n        projectSyncCompleted = false;\n        previewURL = null;\n    }\n\n    let allChangedFiles = [];\n    async function _collectFiles(dirEntry) {\n        return new Promise((resolve, reject)=>{\n            dirEntry.getContents(async (err,fsEntries)=>{\n                if(err){\n                    reject(err);\n                }\n                for(let fsEntry of fsEntries){\n                    if(fsEntry.isDirectory){\n                        let contentFiles = await _collectFiles(fsEntry);\n                        allChangedFiles.push(...contentFiles);\n                    } else {\n                        allChangedFiles.push(fsEntry);\n                    }\n                }\n            });\n            resolve(allChangedFiles);\n        });\n    }\n\n    async function _projectFileChanged(target, entry, added, removed) {\n        if(!syncEnabled){\n            return;\n        }\n        if(entry){\n            if(entry.isDirectory){\n                await _collectFiles(entry);\n            } else {\n                allChangedFiles.push(entry);\n            }\n        }\n    }\n\n    function _setSyncInProgress() {\n        ongoingSyncCount = ongoingSyncCount+1;\n        $icon.attr({\n            class: \"syncing\",\n            title: Strings.PUBLISH_SYNC_IN_PROGRESS\n        });\n    }\n\n    function _setSyncComplete() {\n        ongoingSyncCount = ongoingSyncCount-1;\n        if(ongoingSyncCount ===0){\n            $icon.attr({\n                class: \"preview\",\n                title: Strings.PUBLISH_VIEW_PAGE\n            });\n        }\n    }\n\n    function _showPublishConsentDialogue() {\n        if(projectSyncStarted){\n            return;\n        }\n        let publishMessage = StringUtils.format(Strings.PUBLISH_CONSENT_MESSAGE,\n            `<a href=\"${_getProjectPreviewURL()}\">${_getProjectPreviewURL()}</a>`);\n        Dialogs.showModalDialog(\n            DefaultDialogs.DIALOG_ID_INFO,\n            Strings.SHARE_WEBSITE,\n            publishMessage,\n            [\n                {\n                    className: Dialogs.DIALOG_BTN_CLASS_NORMAL,\n                    id: Dialogs.DIALOG_BTN_CANCEL,\n                    text: Strings.CANCEL\n                },\n                {\n                    className: Dialogs.DIALOG_BTN_CLASS_PRIMARY,\n                    id: Dialogs.DIALOG_BTN_OK,\n                    text: Strings.PUBLISH\n                }\n            ]\n        )\n            .done(function (id) {\n                if (id === Dialogs.DIALOG_BTN_OK) {\n                    syncEnabled = true;\n                    _startSync(()=>{\n                        previewInProgress = true;\n                        _loadPreview();\n                    });\n                }\n            });\n    }\n\n    function _isPreviewableFile(filePath) {\n        let pathSplit = filePath.split('.');\n        let extension = pathSplit && pathSplit.length>1 ? pathSplit[pathSplit.length-1] : null;\n        if(['html', 'htm', 'jpg', 'jpeg', 'png', 'svg', 'pdf', 'xml'].includes(extension.toLowerCase())){\n            return true;\n        }\n        return false;\n    }\n\n    function _loadPreview() {\n        if(!previewInProgress){\n            return;\n        }\n        let projectRootUrl = _getProjectPreviewURL();\n        let currentDocument = DocumentManager.getCurrentDocument();\n        let currentFile = currentDocument? currentDocument.file : ProjectManager.getSelectedItem();\n        if(currentFile){\n            let fullPath = currentFile.fullPath;\n            let projectRoot = ProjectManager.getProjectRoot().fullPath;\n            let relativePath = path.relative(projectRoot, fullPath);\n            if(_isPreviewableFile(relativePath)){\n                previewURL = `${projectRootUrl}/${relativePath}`;\n            }\n        }\n\n        if(!previewURL){\n            previewURL = projectRootUrl;\n        }\n        if(!tab || tab.closed){\n            tab = open(previewURL);\n        }\n        else {\n            tab.location = previewURL;\n        }\n    }\n\n    function _addToolbarIcon() {\n        const syncButtonID = \"sync-button\";\n        $icon = $(\"<a>\")\n            .attr({\n                id: syncButtonID,\n                href: \"#\",\n                class: \"preview\",\n                title: Strings.PUBLISH_PAGE\n            })\n            .appendTo($(\"#main-toolbar .buttons\"));\n        $icon.on('click', ()=>{\n            Metrics.countEvent(Metrics.EVENT_TYPE.SHARING, \"shareIcon\", \"clicked\");\n            if(projectSyncCompleted){\n                previewInProgress = true;\n                _setSyncInProgress();\n                let uniqueFilesToUpload = [...new Set(allChangedFiles)];\n                allChangedFiles = [];\n                _uploadFiles(uniqueFilesToUpload, ()=>{\n                    _setSyncComplete();\n                    _loadPreview();\n                });\n            }\n            _showPublishConsentDialogue();\n        });\n    }\n\n    setInterval(()=>{\n        // periodically check if the preview tab is manually closed by user. We do this by light polling as\n        // we cannot attach an onTabClosed event to the tab.\n        if(previewInProgress && (!tab || tab.closed)){\n            previewInProgress = false;\n        }\n    }, 500);\n\n    exports.init = function () {\n        _addToolbarIcon();\n        _setupUserContext();\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN, _projectOpened);\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED, _projectFileChanged);\n        EditorManager.on(\"activeEditorChange\", _loadPreview);\n    };\n\n    ExtensionUtils.loadStyleSheet(module, \"styles.css\");\n});\n"],"file":"serverSync.js"}