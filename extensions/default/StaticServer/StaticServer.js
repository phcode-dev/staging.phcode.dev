define(function(require,exports,module){const BaseServer=brackets.getModule("LiveDevelopment/Servers/BaseServer").BaseServer,LiveDevelopmentUtils=brackets.getModule("LiveDevelopment/LiveDevelopmentUtils"),FileUtils=brackets.getModule("file/FileUtils"),_serverBroadcastChannel=new BroadcastChannel("virtual_server_broadcast");function StaticServer(config){config.baseUrl=FileUtils.stripTrailingSlash(window.fsServerUrl),this._sendInstrumentedContent=this._sendInstrumentedContent.bind(this),BaseServer.call(this,config)}StaticServer.prototype=Object.create(BaseServer.prototype),StaticServer.prototype.constructor=StaticServer,StaticServer.prototype.pathToUrl=function(path){const baseUrl=this.getBaseUrl(),relativePath=this._pathResolver(path);return relativePath!==path?`${baseUrl}${encodeURI(path)}`:null},StaticServer.prototype.urlToPath=function(url){let path,baseUrl="";return""!==(baseUrl=this.getBaseUrl())&&0===url.indexOf(baseUrl)?(path=url.replace(baseUrl,""),decodeURI(path)):null},StaticServer.prototype.canServe=function(localPath){return localPath!==this._pathResolver(localPath)&&(!!localPath.match(/\/$/)||LiveDevelopmentUtils.isStaticHtmlFileExt(localPath))},StaticServer.prototype._updateInstrumentedURLSInWorker=function(){let paths=Object.keys(this._liveDocuments);console.log("Static server _updateInstrumentedURLSInWorker: ",this._root,paths),window.messageSW({type:"setInstrumentedURLs",root:this._root,paths:paths}).then(status=>{console.log("Static server received msg from Service worker: setInstrumentedURLs done: ",status)}).catch(err=>{console.error("Static server received msg from Service worker: Error while setInstrumentedURLs",err)})},StaticServer.prototype.readyToServe=function(){return $.Deferred().resolve().promise()},StaticServer.prototype.add=function(liveDocument){liveDocument.setInstrumentationEnabled&&liveDocument.setInstrumentationEnabled(!0),BaseServer.prototype.add.call(this,liveDocument),this._updateInstrumentedURLSInWorker()},StaticServer.prototype.remove=function(liveDocument){BaseServer.prototype.remove.call(this,liveDocument),this._updateInstrumentedURLSInWorker()},StaticServer.prototype.clear=function(){BaseServer.prototype.clear.call(this),this._updateInstrumentedURLSInWorker()},StaticServer.prototype._send=function(location,response){this._nodeDomain.exec("writeFilteredResponse",location.root,location.pathname,response)},StaticServer.prototype._sendInstrumentedContent=function(data){if(data.phoenixInstanceID&&data.phoenixInstanceID!==Phoenix.PHOENIX_INSTANCE_ID)return;let path=this._documentKey(data.path),requestID=data.requestID,liveDocument=this._liveDocuments[path],response={};liveDocument&&liveDocument.getResponseData&&(response=liveDocument.getResponseData(),_serverBroadcastChannel.postMessage({type:"REQUEST_RESPONSE",requestID:requestID,path:path,contents:response.body}))},StaticServer.prototype.start=function(){const self=this;_serverBroadcastChannel.onmessage=(event=>{"getInstrumentedContent"===event.data.type&&self._sendInstrumentedContent(event.data)})},StaticServer.prototype.stop=function(){_serverBroadcastChannel.onmessage=void 0},module.exports=StaticServer});
//# sourceMappingURL=StaticServer.js.map
