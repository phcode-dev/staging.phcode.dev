define(function(require,exports,module){var CommandManager=brackets.getModule("command/CommandManager"),EditorManager=brackets.getModule("editor/EditorManager"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),WorkspaceManager=brackets.getModule("view/WorkspaceManager"),KeyBindingManager=brackets.getModule("command/KeyBindingManager"),ModalBar=brackets.getModule("widgets/ModalBar").ModalBar,Mustache=brackets.getModule("thirdparty/mustache/mustache"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),AppInit=brackets.getModule("utils/AppInit"),NativeApp=brackets.getModule("utils/NativeApp"),DocumentManager=brackets.getModule("document/DocumentManager"),FileUtils=brackets.getModule("file/FileUtils"),MainViewManager=brackets.getModule("view/MainViewManager"),PopUpManager=brackets.getModule("widgets/PopUpManager"),_=brackets.getModule("thirdparty/lodash"),Handler=require("handler"),KeyboardPrefs=JSON.parse(require("text!keyboard.json")),Strings=require("strings"),panelHTML=require("text!templates/panel.html"),previewHTML=require("text!templates/preview.html"),settingsHTML=require("text!templates/settings.html"),_markdownBarTemplate=require("text!templates/markdown-bar.html"),prefs=PreferencesManager.getExtensionPrefs("markdownbar"),marked=require("lib/marked"),toolBar=null,barShouldShow=!1,cmdToolbar=null,$icon,$iframe,$panel,$settingsToggle,$settings,currentDoc,currentEditor,panel,toggleCmd,visible=!1,realVisibility=!1,_prefs=PreferencesManager.getExtensionPrefs("markdown-preview");function _handleLinkClick(e){for(var node=e.target,url;node;){if("A"===node.tagName){(url=node.getAttribute("href"))&&!url.match(/^#/)&&NativeApp.openURLInDefaultBrowser(url),e.preventDefault();break}node=node.parentElement}_hideSettings()}function _calcScrollPos(){var scrollInfo=currentEditor._codeMirror.getScrollInfo(),scrollPercentage=scrollInfo.top/(scrollInfo.height-scrollInfo.clientHeight),scrollTop=($iframe[0].contentDocument.body.scrollHeight-$iframe[0].clientHeight)*scrollPercentage;return Math.round(scrollTop)}function _editorScroll(){if(_prefs.get("syncScroll")&&$iframe){var scrollTop=_calcScrollPos();$iframe[0].contentDocument.body.scrollTop=scrollTop}}function _loadDoc(doc,isReload){if(doc&&visible&&$iframe){var docText=doc.getText(),scrollPos=0,bodyText="",yamlRegEx,yamlMatch=/^-{3}([\w\W]+?)(-{3})/.exec(docText);if(yamlMatch&&(docText=docText.substr(yamlMatch[0].length)),isReload?scrollPos=$iframe.contents()[0].body.scrollTop:_prefs.get("syncScroll")&&(scrollPos=_calcScrollPos()),bodyText=(bodyText=(bodyText=marked(docText)).replace(/(href=\"([^\"]*)\")/g,'$1 title="$2"')).replace(/src="\/\//g,'src="http://'),isReload)$iframe[0].contentDocument.body.innerHTML=bodyText;else{var baseUrl=window.location.protocol+"//"+FileUtils.getDirectoryPath(doc.file.fullPath),htmlSource=_.template(previewHTML)({baseUrl:baseUrl,themeUrl:require.toUrl("./themes/"+_prefs.get("theme")+".css"),scrollTop:scrollPos,bodyText:bodyText});$iframe.attr("srcdoc",htmlSource),$iframe.off("load"),$iframe.load(function(){$iframe[0].contentDocument.body.addEventListener("click",_handleLinkClick,!0),isReload||_editorScroll()})}}}function _documentChange(e){_loadDoc(e.target,!0)}function _updateSettings(){var useGFM=_prefs.get("useGFM");marked.setOptions({breaks:useGFM,gfm:useGFM}),_loadDoc(currentDoc)}function _documentClicked(e){$settings.is(e.target)||$settingsToggle.is(e.target)||0!==$settings.has(e.target).length||_hideSettings()}function _hideSettings(){$settings&&($settings.remove(),$settings=null,$(window.document).off("mousedown",_documentClicked))}function _showSettings(e){_hideSettings(),($settings=$(settingsHTML).css({right:12,top:$settingsToggle.position().top+$settingsToggle.outerHeight()+12}).appendTo($panel)).find("#markdown-preview-format").prop("selectedIndex",_prefs.get("useGFM")?1:0).change(function(e){_prefs.set("useGFM",1===e.target.selectedIndex),_updateSettings()}),$settings.find("#markdown-preview-theme").val(_prefs.get("theme")).change(function(e){_prefs.set("theme",e.target.value),_updateSettings()});var $syncScroll=$settings.find("#markdown-preview-sync-scroll");$syncScroll.change(function(e){_prefs.set("syncScroll",e.target.checked),_editorScroll()}),_prefs.get("syncScroll")&&$syncScroll.attr("checked",!0),PopUpManager.addPopUp($settings,_hideSettings,!0),$(window.document).on("mousedown",_documentClicked)}function _setPanelVisibility(isVisible){isVisible!==realVisibility&&(realVisibility=isVisible,isVisible?(_loadDoc(DocumentManager.getCurrentDocument()),$icon.toggleClass("active"),panel.show()):($icon.toggleClass("active"),panel.hide()))}function _currentDocChangedHandler(){var doc=DocumentManager.getCurrentDocument(),ext=doc?FileUtils.getFileExtension(doc.file.fullPath).toLowerCase():"";currentDoc&&(currentDoc.off("change",_documentChange),currentDoc=null),currentEditor&&(currentEditor.off("scroll",_editorScroll),currentEditor=null),doc&&/md|markdown|litcoffee|txt/.test(ext)?((currentDoc=doc).on("change",_documentChange),(currentEditor=EditorManager.getCurrentFullEditor()).on("scroll",_editorScroll),$icon.css({display:"block"}),_setPanelVisibility(visible),toggleCmd.setEnabled(!0),_loadDoc(doc)):($icon.css({display:"none"}),toggleCmd.setEnabled(!1),_setPanelVisibility(!1))}function _toggleVisibility(){_setPanelVisibility(visible=!visible),toggleCmd.setChecked(visible)}function registerCallbacks(toolBar){var root=toolBar.getRoot();root.on("click","#markdown-heading1",function(){Handler.h1()}),root.on("click","#markdown-heading2",function(){Handler.h2()}),root.on("click","#markdown-heading3",function(){Handler.h3()}),root.on("click","#markdown-heading4",function(){Handler.h4()}),root.on("click","#markdown-heading5",function(){Handler.h5()}),root.on("click","#markdown-heading6",function(){Handler.h6()}),root.on("click","#markdown-bold",function(){Handler.bold()}),root.on("click","#markdown-italic",function(){Handler.italic()}),root.on("click","#markdown-strikethrough",function(){Handler.strikethrough()}),root.on("click","#markdown-code",function(){Handler.code()}),root.on("click","#markdown-bullet",function(){Handler.bullet()}),root.on("click","#markdown-numbered",function(){Handler.numbered()}),root.on("click","#markdown-quote",function(){Handler.quote()}),root.on("click","#markdown-codeblock",function(){Handler.codeblock()}),root.on("click","#markdown-image",function(){Handler.image()}),root.on("click","#markdown-link",function(){Handler.link()}),root.on("click","#markdown-paragraph",function(){Handler.paragraph()}),root.on("click","#markdown-reflow",function(){Handler.reflow()})}function showBar(){if(!toolBar){var templateVars={Strings:Strings};registerCallbacks(toolBar=new ModalBar(Mustache.render(_markdownBarTemplate,templateVars),!1,!1)),cmdToolbar.setChecked(!0)}}function closeBar(){toolBar&&(toolBar.close(),toolBar=null,cmdToolbar.setChecked(!1))}function toggleBar(){toolBar?(barShouldShow=!1,closeBar()):(barShouldShow=!0,showBar())}function activeEditorChangeHandler(event,activeEditor,previousEditor){var mode=null;activeEditor&&activeEditor.document&&(mode=activeEditor._getModeFromDocument()),"gfm"===mode||"markdown"===mode?(cmdToolbar.setEnabled(!0),barShouldShow&&showBar()):(cmdToolbar.setEnabled(!1),closeBar())}_prefs.definePreference("useGFM","boolean",!1),_prefs.definePreference("theme","string","clean"),_prefs.definePreference("syncScroll","boolean",!0),prefs.definePreference("maxLength","number",80,{description:Strings.DESCRIPTION_MAX_LINE_LENGTH});var BAR_COMMAND_ID="alanhohn.togglemarkdownbar",H1_COMMAND_ID="alanhohn.markdownheading1",H2_COMMAND_ID="alanhohn.markdownheading2",H3_COMMAND_ID="alanhohn.markdownheading3",H4_COMMAND_ID="alanhohn.markdownheading4",BOLD_COMMAND_ID="alanhohn.markdownbold",ITALIC_COMMAND_ID="alanhohn.markdownitalic",STRIKE_COMMAND_ID="alanhohn.markdownstrike",CODE_COMMAND_ID="alanhohn.markdowncode",BULLET_COMMAND_ID="alanhohn.markdownbullet",NUMBERED_COMMAND_ID="alanhohn.markdownnumbered",QUOTE_COMMAND_ID="alanhohn.markdownquote",CODEBLOCK_COMMAND_ID="alanhohn.markdowncodeblock",PARAGRAPH_COMMAND_ID="alanhohn.markdownparagraph",REFLOW_COMMAND_ID="alanhohn.markdownreflow";function _createPanel(){$panel=$(panelHTML),$iframe=$panel.find("#panel-markdown-preview-frame");let minSize=window.innerWidth/3;panel=WorkspaceManager.createPluginPanel("markdown-preview-panel",$panel,minSize,$icon),WorkspaceManager.recomputeLayout(!1),$settingsToggle=$("#markdown-settings-toggle").click(function(e){$settings?_hideSettings():_showSettings(e)})}cmdToolbar=CommandManager.register(Strings.MENU_TOOLBAR,BAR_COMMAND_ID,toggleBar),CommandManager.register(Strings.HINT_H1,H1_COMMAND_ID,Handler.h1),CommandManager.register(Strings.HINT_H2,H2_COMMAND_ID,Handler.h2),CommandManager.register(Strings.HINT_H3,H3_COMMAND_ID,Handler.h3),CommandManager.register(Strings.HINT_H4,H4_COMMAND_ID,Handler.h4),CommandManager.register(Strings.HINT_BOLD,BOLD_COMMAND_ID,Handler.bold),CommandManager.register(Strings.HINT_ITALIC,ITALIC_COMMAND_ID,Handler.italic),CommandManager.register(Strings.HINT_STRIKE,STRIKE_COMMAND_ID,Handler.strikethrough),CommandManager.register(Strings.HINT_CODE,CODE_COMMAND_ID,Handler.code),CommandManager.register(Strings.HINT_BULLET,BULLET_COMMAND_ID,Handler.bullet),CommandManager.register(Strings.HINT_NUMBERED,NUMBERED_COMMAND_ID,Handler.numbered),CommandManager.register(Strings.HINT_QUOTE,QUOTE_COMMAND_ID,Handler.quote),CommandManager.register(Strings.HINT_CODEBLOCK,CODEBLOCK_COMMAND_ID,Handler.codeblock),CommandManager.register(Strings.HINT_PARAGRAPH,PARAGRAPH_COMMAND_ID,Handler.paragraph),CommandManager.register(Strings.HINT_REFLOW,REFLOW_COMMAND_ID,Handler.reflow),KeyBindingManager.addBinding(H1_COMMAND_ID,KeyboardPrefs.heading1),KeyBindingManager.addBinding(H2_COMMAND_ID,KeyboardPrefs.heading2),KeyBindingManager.addBinding(H3_COMMAND_ID,KeyboardPrefs.heading3),KeyBindingManager.addBinding(H4_COMMAND_ID,KeyboardPrefs.heading4),KeyBindingManager.addBinding(BOLD_COMMAND_ID,KeyboardPrefs.bold),KeyBindingManager.addBinding(ITALIC_COMMAND_ID,KeyboardPrefs.italic),KeyBindingManager.addBinding(STRIKE_COMMAND_ID,KeyboardPrefs.strikethrough),KeyBindingManager.addBinding(CODE_COMMAND_ID,KeyboardPrefs.code),KeyBindingManager.addBinding(BULLET_COMMAND_ID,KeyboardPrefs.bullet),KeyBindingManager.addBinding(NUMBERED_COMMAND_ID,KeyboardPrefs.numbered),KeyBindingManager.addBinding(QUOTE_COMMAND_ID,KeyboardPrefs.quote),KeyBindingManager.addBinding(CODEBLOCK_COMMAND_ID,KeyboardPrefs.codeblock),KeyBindingManager.addBinding(PARAGRAPH_COMMAND_ID,KeyboardPrefs.paragraph),KeyBindingManager.addBinding(REFLOW_COMMAND_ID,KeyboardPrefs.reflow),ExtensionUtils.loadStyleSheet(module,"styles/styles.css"),ExtensionUtils.loadStyleSheet(module,"styles/octicons.css"),barShouldShow=!0,activeEditorChangeHandler(null,EditorManager.getActiveEditor(),null),EditorManager.on("activeEditorChange",activeEditorChangeHandler),_documentChange=_.debounce(_documentChange,30),_editorScroll=_.debounce(_editorScroll,1),ExtensionUtils.loadStyleSheet(module,"styles/MarkdownPreview.css"),$icon=$("<a>").attr({id:"markdown-preview-icon",href:"#"}).css({display:"none"}).click(_toggleVisibility).appendTo($("#main-toolbar .buttons")),MainViewManager.on("currentFileChange",_currentDocChangedHandler),(toggleCmd=CommandManager.register("Markdown Preview","toggleMarkdownPreview",_toggleVisibility)).setChecked(realVisibility),toggleCmd.setEnabled(realVisibility),AppInit.appReady(function(){_createPanel(),_currentDocChangedHandler()})});
//# sourceMappingURL=main.js.map
