define(function(require,exports,module){var _=brackets.getModule("thirdparty/lodash"),Commands=brackets.getModule("command/Commands"),CommandManager=brackets.getModule("command/CommandManager"),Menus=brackets.getModule("command/Menus"),FileSystem=brackets.getModule("filesystem/FileSystem"),FileUtils=brackets.getModule("file/FileUtils"),PerfUtils=brackets.getModule("utils/PerfUtils"),StringUtils=brackets.getModule("utils/StringUtils"),Dialogs=brackets.getModule("widgets/Dialogs"),Strings=brackets.getModule("strings"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),LocalizationUtils=brackets.getModule("utils/LocalizationUtils"),MainViewManager=brackets.getModule("view/MainViewManager"),WorkingSetView=brackets.getModule("project/WorkingSetView"),ExtensionManager=brackets.getModule("extensibility/ExtensionManager"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Locales=brackets.getModule("nls/strings"),ProjectManager=brackets.getModule("project/ProjectManager"),PerfDialogTemplate=require("text!htmlContent/perf-dialog.html"),LanguageDialogTemplate=require("text!htmlContent/language-dialog.html"),KeyboardPrefs=JSON.parse(require("text!keyboard.json")),DEFAULT_PREFERENCES_FILENAME="defaultPreferences.json",SUPPORTED_PREFERENCE_TYPES=["number","boolean","string","array","object"],recomputeDefaultPrefs=!0,defaultPreferencesFullPath=path.normalize(brackets.app.getApplicationSupportDirectory()+"/defaultPreferences.json"),DEBUG_MENU="debug-menu",DEBUG_REFRESH_WINDOW="debug.refreshWindow",DEBUG_RUN_UNIT_TESTS="debug.runUnitTests",DEBUG_SHOW_PERF_DATA="debug.showPerfData",DEBUG_RELOAD_WITHOUT_USER_EXTS="debug.reloadWithoutUserExts",DEBUG_NEW_BRACKETS_WINDOW="debug.newBracketsWindow",DEBUG_SWITCH_LANGUAGE="debug.switchLanguage",DEBUG_ENABLE_LOGGING="debug.enableLogging",DEBUG_OPEN_VFS="debug.openVFS",DEBUG_OPEN_VIRTUAL_SERVER="debug.openVirtualServer",DEBUG_OPEN_PREFERENCES_IN_SPLIT_VIEW="debug.openPrefsInSplitView",prefs=PreferencesManager.getExtensionPrefs("preferencesView");prefs.definePreference("openPrefsInSplitView","boolean",!0,{description:Strings.DESCRIPTION_OPEN_PREFS_IN_SPLIT_VIEW}),prefs.definePreference("openUserPrefsInSecondPane","boolean",!0,{description:Strings.DESCRIPTION_OPEN_USER_PREFS_IN_SECOND_PANE});var _testWindow=null;function _runUnitTests(spec){let queryString=spec?"?spec="+spec:"?suite=unit",testBaseURL="../test/SpecRunner.html";"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(testBaseURL="test/SpecRunner.html"),_testWindow&&!_testWindow.closed?_testWindow.location.search!==queryString?_testWindow.location.href=testBaseURL+queryString:_testWindow.location.reload(!0):(_testWindow=window.open(testBaseURL+queryString)).location.reload(!0)}function handleReload(){CommandManager.execute(Commands.APP_RELOAD)}function handleReloadWithoutUserExts(){CommandManager.execute(Commands.APP_RELOAD_WITHOUT_EXTS)}function handleNewBracketsWindow(){window.open(window.location.href)}function handleShowPerfData(){var templateVars={delimitedPerfData:PerfUtils.getDelimitedPerfData(),perfData:[]},getValue=function(entry){if(Array.isArray(entry)){var i,e,avg,sum=0,min=Number.MAX_VALUE,max=0;for(i=0;i<entry.length;i++)e=entry[i],min=Math.min(min,e),sum+=e,max=Math.max(max,e);return avg=Math.round(10*sum/entry.length)/10,String(min)+"/"+String(avg)+"("+entry.length+")/"+String(max)+"/"+String(e)}return entry},perfData=PerfUtils.getData();_.forEach(perfData,function(value,testName){templateVars.perfData.push({testName:StringUtils.breakableUrl(testName),value:getValue(value)})});var template=Mustache.render(PerfDialogTemplate,templateVars);Dialogs.showModalDialogUsingTemplate(template),$("#brackets-perf-raw-data").click(function(){$(this).focus().select()})}function handleSwitchLanguage(){const supportedLocales=Object.keys(Locales);var $dialog,$submit,$select,locale,curLocale=brackets.isLocaleDefault()?null:brackets.getLocale(),languages=[],setLanguage=function(event){locale=$select.val(),$submit.prop("disabled",locale===(curLocale||""))};for(let supportedLocale of supportedLocales){var match=supportedLocale.match(/^([a-z]{2})(-[a-z]{2})?$/);if(match){var language=supportedLocale,label=match[1];match[2]&&(label+=match[2].toUpperCase()),languages.push({label:LocalizationUtils.getLocalizedLabel(label),language:language})}}languages.push({label:LocalizationUtils.getLocalizedLabel("en"),language:"en"}),languages.sort(function(lang1,lang2){return lang1.label.localeCompare(lang2.label)}),languages.unshift({label:Strings.LANGUAGE_SYSTEM_DEFAULT,language:null});var template=Mustache.render(LanguageDialogTemplate,{languages:languages,Strings:Strings});Dialogs.showModalDialogUsingTemplate(template).done(function(id){id===Dialogs.DIALOG_BTN_OK&&locale!==curLocale&&(brackets.setLocale(locale),CommandManager.execute(Commands.APP_RELOAD))}),$dialog=$(".switch-language.instance"),$submit=$dialog.find(".dialog-button[data-button-id='"+Dialogs.DIALOG_BTN_OK+"']"),($select=$dialog.find("select")).on("change",setLanguage).val(curLocale)}function _openPrefFilesInSplitView(prefsPath,defaultPrefsPath,deferredPromise){var currScheme=MainViewManager.getLayoutScheme(),file=FileSystem.getFileForPath(prefsPath),defaultPrefsFile=FileSystem.getFileForPath(defaultPrefsPath),DEFAULT_PREFS_PANE="first-pane",USER_PREFS_PANE="second-pane";function _openFiles(){1===currScheme.rows&&1===currScheme.columns&&MainViewManager.setLayoutScheme(1,2),CommandManager.execute(Commands.FILE_OPEN,{fullPath:defaultPrefsPath,paneId:DEFAULT_PREFS_PANE,options:{isReadOnly:!0}}).done(function(){MainViewManager.findInWorkingSet(DEFAULT_PREFS_PANE,prefsPath)>=0&&(MainViewManager._moveView(DEFAULT_PREFS_PANE,USER_PREFS_PANE,file,0,!0),WorkingSetView.refresh(!0)),CommandManager.execute(Commands.FILE_OPEN,{fullPath:prefsPath,paneId:USER_PREFS_PANE}).done(function(){deferredPromise.resolve()}).fail(function(){deferredPromise.reject()})}).fail(function(){deferredPromise.reject()})}prefs.get("openUserPrefsInSecondPane")||(DEFAULT_PREFS_PANE="second-pane",USER_PREFS_PANE="first-pane");var resultObj=MainViewManager.findInAllWorkingSets(defaultPrefsPath);resultObj&&resultObj.length>0?CommandManager.execute(Commands.FILE_CLOSE,{file:defaultPrefsFile,paneId:resultObj[0].paneId}).done(function(){_openFiles()}).fail(function(){deferredPromise.reject()}):_openFiles()}function _isSupportedPrefType(prefType){return SUPPORTED_PREFERENCE_TYPES.indexOf(prefType)>=0}function _getPrefType(prefItem){var finalPrefType="undefined";if(prefItem){var _prefType=prefItem.type;if(void 0!==_prefType&&(finalPrefType=prefItem.type.toLowerCase(),void 0!==prefItem.initial))if(Array.isArray(prefItem.initial))_prefType="array";else{var _initialType=typeof prefItem.initial;_prefType!==(_initialType=_initialType.toLowerCase())&&(_prefType=_initialType)}if(_prefType)_isSupportedPrefType(finalPrefType=_prefType)||(finalPrefType="undefined");else if(Array.isArray(prefItem))finalPrefType="array";else if(void 0!==prefItem.initial||void 0!==prefItem.keys){var _prefVar;_prefVar=void 0!==prefItem.initial?prefItem.initial:prefItem.keys,Array.isArray(_prefVar)&&(finalPrefType="array")}else finalPrefType=typeof prefItem}return _isSupportedPrefType(finalPrefType)||(finalPrefType="undefined"),finalPrefType}function _isValidPref(pref){return!(!pref||pref.excludeFromHints||"undefined"===_getPrefType(pref))}function _getChildPrefs(prefItem){var finalObj={},keysFound=!1;if(!prefItem)return{};function _populateKeys(allKeys){var prop;if("object"==typeof allKeys)for(prop in keysFound=!0,allKeys)allKeys.hasOwnProperty(prop)&&(finalObj[prop]=allKeys[prop])}return _populateKeys(prefItem.initial),_populateKeys(prefItem.keys),keysFound||_populateKeys(prefItem),finalObj}function _formatBasicPref(prefItem,prefName,tabIndentStr){if(!prefItem||"string"!=typeof prefName||"object"===_getPrefType(prefItem))return"";var prefDescription=prefItem.description||"",prefDefault=prefItem.initial,prefFormatText=tabIndentStr+"\t// {0}\n"+tabIndentStr+'\t"{1}": {2}',prefItemType=_getPrefType(prefItem);return void 0!==prefDefault||prefItem.description||"number"!==prefItemType&&"boolean"!==prefItemType&&"string"!==prefItemType||(prefDefault=prefItem),void 0===prefDefault&&(prefDefault="number"===prefItemType?0:"boolean"!==prefItemType&&""),void 0!==prefDescription&&0!==prefDescription.length||(prefDescription=Array.isArray(prefDefault)?"":Strings.DEFAULT_PREFERENCES_JSON_DEFAULT+": "+prefDefault),"array"===prefItemType?prefDefault="[]":(0===prefDefault.length||"boolean"!==prefItemType&&"number"!==prefItemType)&&(prefDefault='"'+prefDefault+'"'),StringUtils.format(prefFormatText,prefDescription,prefName,prefDefault)}function _formatPref(prefName,prefItem,indentLevel){if(!prefItem||indentLevel<0||!prefName||!prefName.length)return"";var iLevel,prefItemKeys,entireText="",prefItemDesc=prefItem.description||"",prefItemType=_getPrefType(prefItem),hasKeys=!1,tabIndents="",numKeys=0;for(iLevel=0;iLevel<indentLevel;iLevel++)tabIndents+="\t";return"object"===_getPrefType(prefItem)&&(prefItemKeys=_getChildPrefs(prefItem),Object.keys(prefItemKeys).length>0&&(hasKeys=!0)),"object"!==prefItemType&&!1===hasKeys?_formatBasicPref(prefItem,prefName,tabIndents):(tabIndents+="\t",prefItemDesc&&prefItemDesc.length>0&&(entireText=tabIndents+"// "+prefItemDesc+"\n"),entireText+=tabIndents+'"'+prefName+'": {',prefItemKeys&&(numKeys=Object.keys(prefItemKeys).length),numKeys<=0?entireText+="}":(entireText+="\n",Object.keys(prefItemKeys).sort().forEach(function(property){if(prefItemKeys.hasOwnProperty(property)){var pref=prefItemKeys[property];if(_isValidPref(pref)){var formattedText="";(formattedText="object"===_getPrefType(pref)?_formatPref(property,pref,indentLevel+1):_formatBasicPref(pref,property,tabIndents)).length>0&&(entireText+=formattedText+",\n\n")}}}),entireText=entireText.length>0?entireText.slice(0,-3)+"\n"+tabIndents+"}":"{}"))}function _getDefaultPreferencesString(){var allPrefs=PreferencesManager.getAllPreferences(),headerComment=Strings.DEFAULT_PREFERENCES_JSON_HEADER_COMMENT+"\n\n{\n",entireText="";return Object.keys(allPrefs).sort().forEach(function(property){if(allPrefs.hasOwnProperty(property)){var pref=allPrefs[property];_isValidPref(pref)&&(entireText+=_formatPref(property,pref,0)+",\n\n")}}),entireText=entireText.length>0?headerComment+entireText.slice(0,-3)+"\n}\n":headerComment+"}\n"}function _loadDefaultPrefs(prefsPath,deferredPromise){var defaultPrefsPath=defaultPreferencesFullPath,file=FileSystem.getFileForPath(defaultPrefsPath);function _executeDefaultOpenPrefsCommand(){CommandManager.execute(Commands.FILE_OPEN_PREFERENCES).done(function(){deferredPromise.resolve()}).fail(function(){deferredPromise.reject()})}file.exists(function(err,doesExist){if(doesExist)if(recomputeDefaultPrefs){var prefsString=_getDefaultPreferencesString();recomputeDefaultPrefs=!1,file.unlink(function(err){err?(console.error("Unable to delete the existing default preferences file! error code:"+err),_executeDefaultOpenPrefsCommand()):FileUtils.writeText(file,prefsString,!0).done(function(){recomputeDefaultPrefs=!1,_openPrefFilesInSplitView(prefsPath,defaultPrefsPath,deferredPromise)}).fail(function(error){console.error("Unable to write to default preferences file! error code:"+error),_executeDefaultOpenPrefsCommand()})})}else _openPrefFilesInSplitView(prefsPath,defaultPrefsPath,deferredPromise);else{var _prefsString=_getDefaultPreferencesString();FileUtils.writeText(file,_prefsString,!0).done(function(){recomputeDefaultPrefs=!1,_openPrefFilesInSplitView(prefsPath,defaultPrefsPath,deferredPromise)}).fail(function(error){console.error("Unable to write to default preferences file! error code:"+error),_executeDefaultOpenPrefsCommand()})}})}function handleOpenPrefsInSplitView(){var fullPath=PreferencesManager.getUserPrefFile(),file=FileSystem.getFileForPath(fullPath),splitViewPrefOn=prefs.get("openPrefsInSplitView"),result=new $.Deferred;return splitViewPrefOn?(file.exists(function(err,doesExist){doesExist?_loadDefaultPrefs(fullPath,result):FileUtils.writeText(file,"",!0).done(function(){_loadDefaultPrefs(fullPath,result)}).fail(function(){result.reject()})}),result.promise()):CommandManager.execute(Commands.FILE_OPEN_PREFERENCES)}function _updateLogToConsoleMenuItemChecked(){const isLogging=window.setupLogging();CommandManager.get(DEBUG_ENABLE_LOGGING).setChecked(isLogging)}function _handleLogging(){let logToConsolePref=localStorage.getItem("logToConsole")||"false";logToConsolePref="true"===logToConsolePref.toLowerCase()?"false":"true",localStorage.setItem("logToConsole",logToConsolePref),_updateLogToConsoleMenuItemChecked()}function _openVFS(){ProjectManager.openProject("/")}function _openVirtualServer(){window.open(window.fsServerUrl)}ExtensionManager.on("statusChange",function(id){recomputeDefaultPrefs=!0}),CommandManager.register(Strings.CMD_REFRESH_WINDOW,DEBUG_REFRESH_WINDOW,handleReload),CommandManager.register(Strings.CMD_RELOAD_WITHOUT_USER_EXTS,"debug.reloadWithoutUserExts",handleReloadWithoutUserExts),CommandManager.register(Strings.CMD_NEW_BRACKETS_WINDOW,"debug.newBracketsWindow",handleNewBracketsWindow),CommandManager.register(Strings.CMD_RUN_UNIT_TESTS,"debug.runUnitTests",_runUnitTests),CommandManager.register(Strings.CMD_SHOW_PERF_DATA,"debug.showPerfData",handleShowPerfData),CommandManager.register(Strings.CMD_SWITCH_LANGUAGE,DEBUG_SWITCH_LANGUAGE,handleSwitchLanguage),CommandManager.register(Strings.CMD_ENABLE_LOGGING,DEBUG_ENABLE_LOGGING,_handleLogging),CommandManager.register(Strings.CMD_OPEN_VFS,DEBUG_OPEN_VFS,_openVFS),CommandManager.register(Strings.CMD_OPEN_VIRTUAL_SERVER,"debug.openVirtualServer",_openVirtualServer),CommandManager.register(Strings.CMD_OPEN_PREFERENCES,"debug.openPrefsInSplitView",handleOpenPrefsInSplitView);var menu=Menus.addMenu(Strings.DEBUG_MENU,DEBUG_MENU,Menus.BEFORE,Menus.AppMenuBar.HELP_MENU);menu.addMenuItem(DEBUG_REFRESH_WINDOW,KeyboardPrefs.refreshWindow),menu.addMenuItem("debug.reloadWithoutUserExts",KeyboardPrefs.reloadWithoutUserExts),menu.addMenuItem("debug.newBracketsWindow"),menu.addMenuDivider(),menu.addMenuItem(DEBUG_SWITCH_LANGUAGE),menu.addMenuDivider(),menu.addMenuItem("debug.runUnitTests"),menu.addMenuItem("debug.showPerfData"),menu.addMenuDivider(),menu.addMenuItem(DEBUG_ENABLE_LOGGING),menu.addMenuItem(DEBUG_OPEN_VFS),menu.addMenuItem("debug.openVirtualServer"),menu.addMenuDivider(),menu.addMenuItem("debug.openPrefsInSplitView"),menu.addMenuItem(Commands.FILE_OPEN_KEYMAP),_updateLogToConsoleMenuItemChecked(),exports._runUnitTests=_runUnitTests});
//# sourceMappingURL=main.js.map
