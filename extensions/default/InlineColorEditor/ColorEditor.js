define(function(require,exports,module){var KeyEvent=brackets.getModule("utils/KeyEvent"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),StringUtils=brackets.getModule("utils/StringUtils"),Strings=brackets.getModule("strings"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),tinycolor=require("thirdparty/tinycolor-min"),ColorEditorTemplate=require("text!ColorEditorTemplate.html"),STEP_MULTIPLIER=5;function ensureHexFormat(str){return/^0x/.test(str)?str.replace("0x","#"):str}function as0xString(color){return color.toHexString().replace("#","0x")}function _0xColorToHex(color,convertToStr){var hexColor=tinycolor(color.replace("0x","#"));return hexColor._format="0x",convertToStr?hexColor.toString():hexColor}function checkSetFormat(color,convertToStr){return/^0x/.test(color)?_0xColorToHex(color,convertToStr):convertToStr?tinycolor(color).toString():tinycolor(color)}function ColorEditor($parent,color,callback,swatches){this.$element=$(Mustache.render(ColorEditorTemplate,Strings)),$parent.append(this.$element),this._callback=callback,this._handleKeydown=this._handleKeydown.bind(this),this._handleOpacityKeydown=this._handleOpacityKeydown.bind(this),this._handleHslKeydown=this._handleHslKeydown.bind(this),this._handleHueKeydown=this._handleHueKeydown.bind(this),this._handleSelectionKeydown=this._handleSelectionKeydown.bind(this),this._handleOpacityDrag=this._handleOpacityDrag.bind(this),this._handleHueDrag=this._handleHueDrag.bind(this),this._handleSelectionFieldDrag=this._handleSelectionFieldDrag.bind(this),this._originalColor=color,this._color=checkSetFormat(color),this._redoColor=null,this._isUpperCase=PreferencesManager.get("uppercaseColors"),PreferencesManager.on("change","uppercaseColors",function(){this._isUpperCase=PreferencesManager.get("uppercaseColors")}.bind(this)),this.$colorValue=this.$element.find(".color-value"),this.$buttonList=this.$element.find("ul.button-bar"),this.$rgbaButton=this.$element.find(".rgba"),this.$hexButton=this.$element.find(".hex"),this.$hslButton=this.$element.find(".hsla"),this.$0xButton=this.$element.find(".0x"),this.$currentColor=this.$element.find(".current-color"),this.$originalColor=this.$element.find(".original-color"),this.$selection=this.$element.find(".color-selection-field"),this.$selectionBase=this.$element.find(".color-selection-field .selector-base"),this.$hueBase=this.$element.find(".hue-slider .selector-base"),this.$opacityGradient=this.$element.find(".opacity-gradient"),this.$hueSlider=this.$element.find(".hue-slider"),this.$hueSelector=this.$element.find(".hue-slider .selector-base"),this.$opacitySlider=this.$element.find(".opacity-slider"),this.$opacitySelector=this.$element.find(".opacity-slider .selector-base"),this.$swatches=this.$element.find(".swatches"),this._addSwatches(swatches),this._addListeners(),this.$originalColor.css("background-color",checkSetFormat(this._originalColor)),this._commitColor(color)}function _getNewOffset(pos,zeroPos,maxOffset){var offset=pos-zeroPos;return offset=Math.min(maxOffset,Math.max(0,offset))}ColorEditor.prototype._color=null,ColorEditor.prototype._hsv=tinycolor("rgba(0,0,0,1)").toHsv(),ColorEditor.prototype._redoColor=null,ColorEditor.prototype._originalColor=null,ColorEditor.prototype.getRootElement=function(){return this.$element},ColorEditor.prototype._addListeners=function(){this._bindColorFormatToRadioButton("rgba"),this._bindColorFormatToRadioButton("hex"),this._bindColorFormatToRadioButton("hsla"),this._bindColorFormatToRadioButton("0x"),this._bindInputHandlers(),this._bindOriginalColorButton(),this._registerDragHandler(this.$selection,this._handleSelectionFieldDrag),this._registerDragHandler(this.$hueSlider,this._handleHueDrag),this._registerDragHandler(this.$opacitySlider,this._handleOpacityDrag),this._bindKeyHandler(this.$selectionBase,this._handleSelectionKeydown),this._bindKeyHandler(this.$hueBase,this._handleHueKeydown),this._bindKeyHandler(this.$opacitySelector,this._handleOpacityKeydown),this._bindKeyHandler(this.$hslButton,this._handleHslKeydown),this._bindKeyHandler(this.$element,this._handleKeydown)},ColorEditor.prototype._synchronize=function(){var colorValue=this.getColor().getOriginalInput(),colorObject=checkSetFormat(colorValue),hueColor="hsl("+this._hsv.h+", 100%, 50%)";this._updateColorTypeRadioButtons(colorObject.getFormat()),this.$colorValue.val(colorValue),this.$currentColor.css("background-color",checkSetFormat(colorValue,!0)),this.$selection.css("background-color",hueColor),this.$hueBase.css("background-color",hueColor),this.$selectionBase.css("background-color",colorObject.toHexString()),this.$opacityGradient.css("background-image","linear-gradient("+hueColor+", transparent)"),this.$hueSelector.css("bottom",this._hsv.h/360*100+"%"),this.$opacitySelector.css("bottom",100*this._hsv.a+"%"),isNaN(this._hsv.s)||(this._hsv.s=100*this._hsv.s+"%"),isNaN(this._hsv.v)||(this._hsv.v=100*this._hsv.v+"%"),this.$selectionBase.css({left:this._hsv.s,bottom:this._hsv.v})},ColorEditor.prototype.focus=function(){return!this.$selectionBase.is(":focus")&&(this.$selectionBase.focus(),!0)},ColorEditor.prototype.destroy=function(){PreferencesManager.off("change","uppercaseColors")},ColorEditor.prototype.getColor=function(){return this._color},ColorEditor.prototype._updateColorTypeRadioButtons=function(format){switch(this.$buttonList.find("li").removeClass("selected"),format){case"rgb":this.$buttonList.find(".rgba").parent().addClass("selected");break;case"hex":case"name":this.$buttonList.find(".hex").parent().addClass("selected");break;case"hsl":this.$buttonList.find(".hsla").parent().addClass("selected");break;case"0x":this.$buttonList.find(".0x").parent().addClass("selected")}},ColorEditor.prototype._bindColorFormatToRadioButton=function(buttonClass,propertyName,value){var handler,self=this;handler=function(event){var newFormat=$(event.currentTarget).html().toLowerCase().replace("%","p"),newColor=self.getColor().toString(),colorObject=checkSetFormat(newColor);switch(newFormat){case"hsla":newColor=colorObject.toHslString();break;case"rgba":newColor=colorObject.toRgbString();break;case"prgba":newColor=colorObject.toPercentageRgbString();break;case"hex":newColor=colorObject.toHexString(),self._hsv.a=1;break;case"0x":newColor=as0xString(colorObject),self._hsv.a=1,self._format="0x"}newColor=self._isUpperCase?newColor.toUpperCase():newColor,self._commitColor(newColor,!1)},this.$element.find("."+buttonClass).click(handler)},ColorEditor.prototype._bindOriginalColorButton=function(){var self=this;this.$originalColor.click(function(event){self._commitColor(self._originalColor,!0)})},ColorEditor.prototype._convertToNormalRGB=function(color){var matches=color.match(/^rgb.*?([0-9]+)\%.*?([0-9]+)\%.*?([0-9]+)\%/i),i,percentStr,value;if(matches)for(i=0;i<3;i++)percentStr=matches[i+1],value=Math.round(255*Number(percentStr)/100),isNaN(value)||(color=color.replace(percentStr+"%",value));return color},ColorEditor.prototype._normalizeColorString=function(color){var normalizedColor=color;return color.match(/^#[0-9a-fA-F]{6}/)?tinycolor(color).toString():(color.match(/^(rgb|hsl)/i)&&(normalizedColor=(normalizedColor=(normalizedColor=normalizedColor.replace(/,\s*/g,", ")).replace(/\(\s+/,"(")).replace(/\s+\)/,")")),normalizedColor)},ColorEditor.prototype._handleTextFieldInput=function(losingFocus){var newColor=$.trim(this.$colorValue.val()),newColorObj=checkSetFormat(newColor),newColorOk=newColorObj.isValid();newColorOk&&(newColorOk=newColorObj.toString()===this._normalizeColorString(ensureHexFormat(newColor))),losingFocus&&!newColorOk&&(newColor=this.getColor().toString()),(losingFocus||newColorOk)&&this._commitColor(newColor,!0)},ColorEditor.prototype._bindInputHandlers=function(){var self=this;this.$colorValue.bind("input",function(event){self._handleTextFieldInput(!1)}),this.$colorValue.bind("change",function(event){self._handleTextFieldInput(!0)})},ColorEditor.prototype._addSwatches=function(swatches){var self=this;swatches.forEach(function(swatch){var swatchValue=checkSetFormat(swatch.value,!0),stringFormat=swatch.count>1?Strings.COLOR_EDITOR_USED_COLOR_TIP_PLURAL:Strings.COLOR_EDITOR_USED_COLOR_TIP_SINGULAR,usedColorTip=StringUtils.format(stringFormat,swatch.value,swatch.count);self.$swatches.append("<li tabindex='0'><div class='swatch-bg'><div class='swatch' style='background-color: "+swatchValue+";' title='"+usedColorTip+"'></div></div> <span class='value' title='"+usedColorTip+"'>"+swatch.value+"</span></li>")}),this.$swatches.find("li").keydown(function(event){if(event.keyCode===KeyEvent.DOM_VK_RETURN||event.keyCode===KeyEvent.DOM_VK_ENTER||event.keyCode===KeyEvent.DOM_VK_SPACE)self._commitColor($(event.currentTarget).find(".value").html());else if(event.keyCode===KeyEvent.DOM_VK_TAB&&!event.shiftKey&&0===$(this).next("li").length)return self.$selectionBase.focus(),!1}),this.$swatches.find("li").click(function(event){self._commitColor($(event.currentTarget).find(".value").html())})},ColorEditor.prototype.isValidColor=function(colorVal){return tinycolor(colorVal).isValid()},ColorEditor.prototype.setColorAsHsv=function(hsv){var colorVal,newColor,oldFormat=tinycolor(this.getColor()).getFormat();switch($.extend(this._hsv,hsv),newColor=tinycolor(this._hsv),oldFormat){case"hsl":colorVal=newColor.toHslString();break;case"rgb":colorVal=newColor.toRgbString();break;case"prgb":colorVal=newColor.toPercentageRgbString();break;case"hex":case"name":colorVal=this._hsv.a<1?newColor.toRgbString():newColor.toHexString();break;case"0x":colorVal=as0xString(newColor)}colorVal=this._isUpperCase?colorVal.toUpperCase():colorVal,this._commitColor(colorVal,!1)},ColorEditor.prototype._commitColor=function(colorVal,resetHsv){void 0===resetHsv&&(resetHsv=!0),this._callback(colorVal);var colorObj=checkSetFormat(colorVal);colorObj._originalInput=colorVal,this._color=colorObj,resetHsv&&(this._hsv=this._color.toHsv()),this._redoColor=null,this._synchronize()},ColorEditor.prototype.setColorFromString=function(colorVal){this._commitColor(colorVal,!0)},ColorEditor.prototype._handleSelectionFieldDrag=function(event){var height=this.$selection.height(),width=this.$selection.width(),xOffset=_getNewOffset(event.clientX,this.$selection.offset().left,width),yOffset=_getNewOffset(event.clientY,this.$selection.offset().top,height),hsv={};hsv.s=xOffset/width,hsv.v=1-yOffset/height,this.setColorAsHsv(hsv,!1),this.$selection.find(".selector-base").is(":focus")||this.$selection.find(".selector-base").focus()},ColorEditor.prototype._handleHueDrag=function(event){var height=this.$hueSlider.height(),offset=_getNewOffset(event.clientY,this.$hueSlider.offset().top,height),hsv={};hsv.h=360*(1-offset/height),this.setColorAsHsv(hsv,!1),this.$hueSlider.find(".selector-base").is(":focus")||this.$hueSlider.find(".selector-base").focus()},ColorEditor.prototype._handleOpacityDrag=function(event){var height=this.$opacitySlider.height(),offset=_getNewOffset(event.clientY,this.$opacitySlider.offset().top,height),hsv={};hsv.a=1-offset/height,this.setColorAsHsv(hsv,!1),this.$opacitySlider.find(".selector-base").is(":focus")||this.$opacitySlider.find(".selector-base").focus()},ColorEditor.prototype._registerDragHandler=function($element,handler){var mouseupHandler=function(event){$(window).unbind("mousemove",handler),$(window).unbind("mouseup",mouseupHandler)};$element.mousedown(function(event){$(window).bind("mousemove",handler),$(window).bind("mouseup",mouseupHandler)}),$element.mousedown(handler)},ColorEditor.prototype.undo=function(){this._originalColor.toString()!==this._color.toString()&&(this._commitColor(this._originalColor,!0),this._redoColor=this._color.toString())},ColorEditor.prototype.redo=function(){this._redoColor&&(this._commitColor(this._redoColor,!0),this._redoColor=null)},ColorEditor.prototype._handleKeydown=function(event){var hasCtrl;if("win"===brackets.platform?event.ctrlKey:event.metaKey)switch(event.keyCode){case KeyEvent.DOM_VK_Z:return event.shiftKey?this.redo():this.undo(),!1;case KeyEvent.DOM_VK_Y:return this.redo(),!1}else if(event.keyCode===KeyEvent.DOM_VK_LEFT||event.keyCode===KeyEvent.DOM_VK_RIGHT||event.keyCode===KeyEvent.DOM_VK_UP||event.keyCode===KeyEvent.DOM_VK_DOWN){var preventDefault=!1,$target=$(event.target);if($target.is("input:not([type])")||$target.is("input[type=text]")?$target[0].selectionStart===$target[0].selectionEnd&&(event.keyCode===KeyEvent.DOM_VK_LEFT&&0===$target[0].selectionStart||event.keyCode===KeyEvent.DOM_VK_RIGHT&&$target[0].selectionEnd===$target.val().length)&&(preventDefault=!0):preventDefault=!0,preventDefault)return event.stopPropagation(),!1}},ColorEditor.prototype._handleHslKeydown=function(event){if(event.keyCode===KeyEvent.DOM_VK_TAB&&!event.shiftKey&&0===this.$swatches.children().length)return this.$selectionBase.focus(),!1},ColorEditor.prototype._handleSelectionKeydown=function(event){var hsv={},step=1.5,xOffset,yOffset,adjustedOffset;switch(event.keyCode){case KeyEvent.DOM_VK_LEFT:case KeyEvent.DOM_VK_RIGHT:return step=event.shiftKey?5*step:step,xOffset=Number($.trim(this.$selectionBase[0].style.left.replace("%",""))),adjustedOffset=event.keyCode===KeyEvent.DOM_VK_LEFT?xOffset-step:xOffset+step,xOffset=Math.min(100,Math.max(0,adjustedOffset)),hsv.s=xOffset/100,this.setColorAsHsv(hsv,!1),!1;case KeyEvent.DOM_VK_DOWN:case KeyEvent.DOM_VK_UP:return step=event.shiftKey?5*step:step,yOffset=Number($.trim(this.$selectionBase[0].style.bottom.replace("%",""))),adjustedOffset=event.keyCode===KeyEvent.DOM_VK_DOWN?yOffset-step:yOffset+step,yOffset=Math.min(100,Math.max(0,adjustedOffset)),hsv.v=yOffset/100,this.setColorAsHsv(hsv,!1),!1;case KeyEvent.DOM_VK_TAB:if(event.shiftKey)return 0===this.$swatches.children().length?this.$hslButton.focus():this.$swatches.find("li:last").focus(),!1}},ColorEditor.prototype._handleHueKeydown=function(event){var hsv={},hue=Number(this._hsv.h),step=3.6;switch(event.keyCode){case KeyEvent.DOM_VK_DOWN:return step=event.shiftKey?5*step:step,hsv.h=hue-step<=0?360-step:hue-step,this.setColorAsHsv(hsv,!1),!1;case KeyEvent.DOM_VK_UP:return step=event.shiftKey?5*step:step,hsv.h=hue+step>=360?step:hue+step,this.setColorAsHsv(hsv,!1),!1}},ColorEditor.prototype._handleOpacityKeydown=function(event){var alpha=this._hsv.a,hsv={},step=.01;switch(event.keyCode){case KeyEvent.DOM_VK_DOWN:return step=event.shiftKey?5*step:step,alpha>0&&(hsv.a=alpha-step<=0?0:alpha-step,this.setColorAsHsv(hsv)),!1;case KeyEvent.DOM_VK_UP:return step=event.shiftKey?5*step:step,alpha<100&&(hsv.a=alpha+step>=1?1:alpha+step,this.setColorAsHsv(hsv)),!1}},ColorEditor.prototype._bindKeyHandler=function($element,handler){$element.bind("keydown",handler)},$(window.document).on("mousedown",".color-selection-field, .slider, .large-swatch",function(e){e.preventDefault()}),exports.ColorEditor=ColorEditor});
//# sourceMappingURL=ColorEditor.js.map
