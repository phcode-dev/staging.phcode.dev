define(function(require,exports,module){const BaseServer=brackets.getModule("LiveDevelopment/Servers/BaseServer").BaseServer,LiveDevelopmentUtils=brackets.getModule("LiveDevelopment/LiveDevelopmentUtils"),LiveDevelopment=brackets.getModule("LiveDevelopment/main"),LiveDevServerManager=brackets.getModule("LiveDevelopment/LiveDevServerManager"),LiveDevProtocol=brackets.getModule("LiveDevelopment/MultiBrowserImpl/protocol/LiveDevProtocol"),marked=brackets.getModule("thirdparty/marked.min"),DocumentManager=brackets.getModule("document/DocumentManager"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),FileSystem=brackets.getModule("filesystem/FileSystem"),EventDispatcher=brackets.getModule("utils/EventDispatcher"),EventManager=brackets.getModule("utils/EventManager"),ProjectManager=brackets.getModule("project/ProjectManager"),Strings=brackets.getModule("strings"),markdownHTMLTemplate=require("text!markdown.html"),redirectionHTMLTemplate=require("text!redirectPage.html"),utils=require("utils");EventDispatcher.makeEventDispatcher(exports);const PHCODE_LIVE_PREVIEW_QUERY_PARAM="phcodeLivePreview";let _staticServerInstance,$livepreviewServerIframe;marked.setOptions({renderer:new marked.Renderer,pedantic:!1,gfm:!0,breaks:!1,sanitize:!1,smartLists:!0,smartypants:!1,xhtml:!1});const EVENT_GET_PHOENIX_INSTANCE_ID="GET_PHOENIX_INSTANCE_ID";function StaticServer(config){config.baseUrl=LiveDevServerManager.getStaticServerBaseURLs().projectBaseURL,this._sendInstrumentedContent=this._sendInstrumentedContent.bind(this),BaseServer.call(this,config)}function _sendMarkdown(fullPath,requestID){DocumentManager.getDocumentForPath(fullPath).done(function(doc){let text=doc.getText(),markdownHtml,templateVars={markdownContent:marked.parse(text),BOOTSTRAP_LIB_CSS:`${window.parent.Phoenix.baseURL}thirdparty/bootstrap/bootstrap.min.css`,HIGHLIGHT_JS_CSS:`${window.parent.Phoenix.baseURL}thirdparty/highlight.js/styles/github.min.css`,HIGHLIGHT_JS:`${window.parent.Phoenix.baseURL}thirdparty/highlight.js/highlight.min.js`,GFM_CSS:`${window.parent.Phoenix.baseURL}thirdparty/gfm.min.css`},html=Mustache.render(markdownHTMLTemplate,templateVars);messageToLivePreviewTabs({type:"REQUEST_RESPONSE",requestID:requestID,fullPath:fullPath,contents:html,headers:{"Content-Type":"text/html"}})}).fail(function(err){console.error(`Markdown rendering failed for ${fullPath}: `,err)})}function _getExtension(filePath){let pathSplit=(filePath=filePath||"").split(".");return pathSplit&&pathSplit.length>1?pathSplit[pathSplit.length-1]:""}function _isMarkdownFile(filePath){let extension=_getExtension(filePath);return["md","markdown"].includes(extension.toLowerCase())}function _getRedirectionPage(redirectURL){let url=new URL(redirectURL);url.searchParams.delete(PHCODE_LIVE_PREVIEW_QUERY_PARAM);let templateVars={redirectURL:utils.getPageLoaderURL(url.href)};return Mustache.render(redirectionHTMLTemplate,templateVars)}function getContent(eventData){if(window.logger.livePreview.log("Static server: ",eventData,Phoenix.PHOENIX_INSTANCE_ID),"GET_CONTENT"===eventData.eventName&&eventData.message.phoenixInstanceID===Phoenix.PHOENIX_INSTANCE_ID){if(_isMarkdownFile(eventData.message.path))return void _sendMarkdown(eventData.message.path,eventData.message.requestID);_staticServerInstance&&_staticServerInstance._sendInstrumentedContent(eventData.message)}}StaticServer.prototype=Object.create(BaseServer.prototype),StaticServer.prototype.constructor=StaticServer,StaticServer.prototype.pathToUrl=function(path){const baseUrl=this.getBaseUrl(),relativePath=this._pathResolver(path);return relativePath!==path?`${baseUrl}${encodeURI(path)}`:null},StaticServer.prototype.urlToPath=function(url){let path,baseUrl="";return""!==(baseUrl=this.getBaseUrl())&&0===url.indexOf(baseUrl)?(path=url.replace(baseUrl,""),decodeURI(path)):null},StaticServer.prototype.canServe=function(localPath){return localPath!==this._pathResolver(localPath)&&(!!localPath.match(/\/$/)||LiveDevelopmentUtils.isStaticHtmlFileExt(localPath))},StaticServer.prototype.readyToServe=function(){return $.Deferred().resolve().promise()},StaticServer.prototype.addVirtualContentAtPath=function(path,docText){BaseServer.prototype.addVirtualContentAtPath.call(this,path,docText)},StaticServer.prototype.add=function(liveDocument){liveDocument.setInstrumentationEnabled&&liveDocument.setInstrumentationEnabled(!0),BaseServer.prototype.add.call(this,liveDocument)},StaticServer.prototype.remove=function(liveDocument){BaseServer.prototype.remove.call(this,liveDocument)},StaticServer.prototype.removeVirtualContentAtPath=function(path){BaseServer.prototype.removeVirtualContentAtPath.call(this,path)},StaticServer.prototype.clear=function(){BaseServer.prototype.clear.call(this)},StaticServer.prototype._send=function(location,response){this._nodeDomain.exec("writeFilteredResponse",location.root,location.pathname,response)},StaticServer.prototype._sendInstrumentedContent=function(data){if(data.phoenixInstanceID&&data.phoenixInstanceID!==Phoenix.PHOENIX_INSTANCE_ID)return;let path=this._documentKey(data.path),requestID=data.requestID,liveDocument=this._liveDocuments[path],virtualDocument=this._virtualServingDocuments[path],contents;if(!ProjectManager.isWithinProject(data.path))return console.error("Security issue prevented: Live preview tried to access non project resource!!!",path),void messageToLivePreviewTabs({type:"REQUEST_RESPONSE",requestID:requestID,path:path,contents:Strings.DESCRIPTION_LIVEDEV_SECURITY});let url=new URL(data.url),isLivePreviewPopoutPage=!1;if(url.searchParams.get(PHCODE_LIVE_PREVIEW_QUERY_PARAM)&&(isLivePreviewPopoutPage=!0),virtualDocument)contents=virtualDocument;else if(liveDocument&&liveDocument.getResponseData)contents=liveDocument.getResponseData().body,isLivePreviewPopoutPage&&-1===contents.indexOf(LiveDevProtocol.getRemoteScript())&&(console.log("serving stale live preview with navigable url",url),contents=_getRedirectionPage(url));else{const file=FileSystem.getFileForPath(data.path);let doc=DocumentManager.getOpenDocumentForPath(file.fullPath);if(!doc)return void fs.readFile(data.path,fs.BYTE_ARRAY_ENCODING,function(error,binContent){error&&(contents=null),messageToLivePreviewTabs({type:"REQUEST_RESPONSE",requestID:requestID,path:path,contents:contents=binContent})});contents=doc.getText(),isLivePreviewPopoutPage&&(console.log("serving stale live preview with navigable url",url),contents=_getRedirectionPage(url))}messageToLivePreviewTabs({type:"REQUEST_RESPONSE",requestID:requestID,path:path,contents:contents})};let serverStarted=!1;StaticServer.prototype.start=function(){if(_staticServerInstance=this,!serverStarted&&!Phoenix.browser.isTauri){$livepreviewServerIframe=$("#live-preview-server-iframe");let url=LiveDevServerManager.getStaticServerBaseURLs().baseURL+`?parentOrigin=${location.origin}`;$livepreviewServerIframe.attr("src",url),serverStarted=!0}},StaticServer.prototype.stop=function(){_staticServerInstance=void 0},EventManager.registerEventHandler("ph-liveServer",exports),exports.on("REPORT_ERROR",function(_ev,event){logger.reportError(new Error(event.data.message))}),exports.on("GET_CONTENT",function(_ev,event){window.logger.livePreview.log(event.data),getContent(event.data)}),exports.on("GET_PHOENIX_INSTANCE_ID",function(_ev){messageToLivePreviewTabs({type:"PHOENIX_INSTANCE_ID",PHOENIX_INSTANCE_ID:Phoenix.PHOENIX_INSTANCE_ID})});const livePreviewTabs=new Map;exports.on("TAB_ONLINE",function(_ev,event){livePreviewTabs.set(event.data.message.clientID,{lastSeen:new Date,URL:event.data.message.URL})});const TAB_HEARTBEAT_TIMEOUT=5e3;function messageToLivePreviewTabs(message){if(!message.type)throw new Error("Missing type attribute to send live preview message to tabs");$livepreviewServerIframe&&$livepreviewServerIframe[0].contentWindow.postMessage(message,"*")}setInterval(()=>{let endTime=new Date;for(let tab of livePreviewTabs.keys()){let timeDiff;endTime-livePreviewTabs.get(tab).lastSeen>5e3&&(livePreviewTabs.delete(tab),exports.trigger("BROWSER_CLOSE",{data:{message:{clientID:tab}}}))}},1e3),LiveDevelopment.setLivePreviewTransportBridge(exports),exports.StaticServer=StaticServer,exports.messageToLivePreviewTabs=messageToLivePreviewTabs,exports.livePreviewTabs=livePreviewTabs,exports.PHCODE_LIVE_PREVIEW_QUERY_PARAM=PHCODE_LIVE_PREVIEW_QUERY_PARAM});
//# sourceMappingURL=StaticServer.js.map
