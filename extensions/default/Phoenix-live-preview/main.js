define(function(require,exports,module){const ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),Menus=brackets.getModule("command/Menus"),WorkspaceManager=brackets.getModule("view/WorkspaceManager"),AppInit=brackets.getModule("utils/AppInit"),ProjectManager=brackets.getModule("project/ProjectManager"),MainViewManager=brackets.getModule("view/MainViewManager"),DocumentManager=brackets.getModule("document/DocumentManager"),Strings=brackets.getModule("strings"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Metrics=brackets.getModule("utils/Metrics"),NotificationUI=brackets.getModule("widgets/NotificationUI"),marked=require("thirdparty/marked.min"),utils=require("utils"),LIVE_PREVIEW_PANEL_ID="live-preview-panel";marked.setOptions({renderer:new marked.Renderer,pedantic:!1,gfm:!0,breaks:!1,sanitize:!1,smartLists:!0,smartypants:!1,xhtml:!1});let panelHTML=require("text!panel.html"),markdownHTMLTemplate=require("text!markdown.html"),$icon,$iframe,$panel,$pinUrlBtn,$livePreviewPopBtn,$reloadBtn;ExtensionUtils.loadStyleSheet(module,"live-preview.css");let panel,urlPinned,tab=null;function _setPanelVisibility(isVisible){isVisible?($icon.toggleClass("active"),panel.show(),_loadPreview(!0)):($icon.toggleClass("active"),panel.hide())}function _toggleVisibility(){let visible;_setPanelVisibility(!panel.isVisible())}function _togglePinUrl(){let pinStatus=$pinUrlBtn.hasClass("pin-icon");pinStatus?$pinUrlBtn.removeClass("pin-icon").addClass("unpin-icon"):$pinUrlBtn.removeClass("unpin-icon").addClass("pin-icon"),urlPinned=!pinStatus,_loadPreview()}function _popoutLivePreview(){tab&&!tab.closed||(tab=open()),_loadPreview(!0)}function _setTitle(fileName){let message=Strings.LIVE_DEV_SELECT_FILE_TO_PREVIEW;fileName&&(message=`${fileName} - ${Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC}`),document.getElementById("panel-live-preview-title").textContent=`${message}`}async function _createExtensionPanel(){let templateVars={Strings:Strings,livePreview:Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC,clickToReload:Strings.LIVE_DEV_CLICK_TO_RELOAD_PAGE,clickToPopout:Strings.LIVE_DEV_CLICK_POPOUT,clickToPinUnpin:Strings.LIVE_DEV_CLICK_TO_PIN_UNPIN};const PANEL_MIN_SIZE=50,INITIAL_PANEL_SIZE=document.body.clientWidth/2.5;($icon=$("#toolbar-go-live")).click(_toggleVisibility),$panel=$(Mustache.render(panelHTML,templateVars)),$iframe=$panel.find("#panel-live-preview-frame"),$pinUrlBtn=$panel.find("#pinURLButton"),$reloadBtn=$panel.find("#reloadButton"),$livePreviewPopBtn=$panel.find("#livePreviewPopoutButton"),$iframe[0].onload=function(){$iframe.attr("srcdoc",null)},panel=WorkspaceManager.createPluginPanel(LIVE_PREVIEW_PANEL_ID,$panel,50,$icon,INITIAL_PANEL_SIZE),WorkspaceManager.recomputeLayout(!1),$pinUrlBtn.click(_togglePinUrl),$livePreviewPopBtn.click(_popoutLivePreview),$reloadBtn.click(()=>{_loadPreview(!0)})}function _renderMarkdown(fullPath){DocumentManager.getDocumentForPath(fullPath).done(function(doc){let text=doc.getText(),markdownHtml,templateVars={markdownContent:marked.parse(text),BOOTSTRAP_LIB_CSS:`${window.parent.Phoenix.baseURL}thirdparty/bootstrap/bootstrap.min.css`,HIGHLIGHT_JS_CSS:`${window.parent.Phoenix.baseURL}thirdparty/highlight.js/styles/github.min.css`,HIGHLIGHT_JS:`${window.parent.Phoenix.baseURL}thirdparty/highlight.js/highlight.min.js`,GFM_CSS:`${window.parent.Phoenix.baseURL}thirdparty/gfm.min.css`},html=Mustache.render(markdownHTMLTemplate,templateVars);$iframe.attr("srcdoc",html),tab&&!tab.closed&&(tab.location="about:blank",setTimeout(()=>{tab.window.document.write(html)},10))}).fail(function(err){console.error(`Markdown rendering failed for ${fullPath}: `,err)})}function _renderPreview(previewDetails,newSrc){let fullPath=previewDetails.fullPath;previewDetails.isMarkdownFile?($iframe.attr("src","about:blank"),_renderMarkdown(fullPath),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"render","markdown")):($iframe.attr("srcdoc",null),$iframe.attr("src",newSrc),tab&&!tab.closed&&(tab.location=newSrc),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"render",utils.getExtension(fullPath)))}let savedScrollPositions={};function _saveScrollPositionsIfPossible(){let currentSrc=$iframe.src||utils.getNoPreviewURL();try{let scrollX=$iframe[0].contentWindow.scrollX,scrollY=$iframe[0].contentWindow.scrollY;return savedScrollPositions[currentSrc]={scrollX:scrollX,scrollY:scrollY},{scrollX:scrollX,scrollY:scrollY,currentSrc:currentSrc}}catch(e){return{scrollX:0,scrollY:0,currentSrc:currentSrc}}}async function _loadPreview(force){if(panel.isVisible()||tab&&!tab.closed){let saved=_saveScrollPositionsIfPossible(),previewDetails=await utils.getPreviewDetails(),newSrc=saved.currentSrc;!urlPinned&&previewDetails.URL&&(newSrc=encodeURI(previewDetails.URL),_setTitle(previewDetails.filePath)),$iframe[0].onload=function(){if(saved.currentSrc===newSrc)$iframe[0].contentWindow.scrollTo(saved.scrollX,saved.scrollY);else{let savedPositions=savedScrollPositions[newSrc];savedPositions&&$iframe[0].contentWindow.scrollTo(savedPositions.scrollX,savedPositions.scrollY)}},saved.currentSrc===newSrc&&!0!==force||($iframe.src=newSrc,_renderPreview(previewDetails,newSrc))}}function _projectFileChanges(evt,changedFile){changedFile&&changedFile.isFile&&changedFile.fullPath&&"/fs/app/state.json"!==changedFile.fullPath&&(_loadPreview(!0),_showPopoutNotificationIfNeeded(changedFile.fullPath))}function _projectOpened(){urlPinned&&_togglePinUrl(),$iframe[0].src=utils.getNoPreviewURL(),tab&&!tab.closed&&(tab.location=utils.getNoPreviewURL()),panel.isVisible()&&_loadPreview(!0)}function _showPopoutNotificationIfNeeded(path){let notificationKey="livePreviewPopoutShown",popoutMessageShown;!localStorage.getItem(notificationKey)&&WorkspaceManager.isPanelVisible(LIVE_PREVIEW_PANEL_ID)&&(path.endsWith(".html")||path.endsWith(".htm"))&&(NotificationUI.createFromTemplate(Strings.GUIDED_LIVE_PREVIEW_POPOUT,"livePreviewPopoutButton",{allowedPlacements:["bottom"],autoCloseTimeS:15,dismissOnClick:!0}),localStorage.setItem(notificationKey,"true"))}AppInit.appReady(function(){let fileMenu;_createExtensionPanel(),ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN,_loadPreview),ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED,_projectFileChanges),MainViewManager.on("currentFileChange",_loadPreview),ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN,_projectOpened),CommandManager.register(Strings.CMD_LIVE_FILE_PREVIEW,Commands.FILE_LIVE_FILE_PREVIEW,function(){_toggleVisibility()}),Menus.getMenu(Menus.AppMenuBar.FILE_MENU).addMenuItem(Commands.FILE_LIVE_FILE_PREVIEW,""),setTimeout(async()=>{let previewDetails;(await utils.getPreviewDetails()).filePath&&_setPanelVisibility(!0)},1e3)})});
//# sourceMappingURL=main.js.map
