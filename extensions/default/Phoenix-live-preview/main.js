define(function(require,exports,module){const ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),EditorManager=brackets.getModule("editor/EditorManager"),ExtensionInterface=brackets.getModule("utils/ExtensionInterface"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),Menus=brackets.getModule("command/Menus"),WorkspaceManager=brackets.getModule("view/WorkspaceManager"),AppInit=brackets.getModule("utils/AppInit"),ProjectManager=brackets.getModule("project/ProjectManager"),MainViewManager=brackets.getModule("view/MainViewManager"),Strings=brackets.getModule("strings"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Metrics=brackets.getModule("utils/Metrics"),LiveDevelopment=brackets.getModule("LiveDevelopment/main"),utils=require("utils"),LIVE_PREVIEW_PANEL_ID="live-preview-panel",NAVIGATOR_REDIRECT_PAGE="REDIRECT_PAGE",LIVE_PREVIEW_NAVIGATOR_CHANNEL_ID=`${Phoenix.PHOENIX_INSTANCE_ID}-nav-live-preview`,_livePreviewNavigationChannel=new BroadcastChannel(LIVE_PREVIEW_NAVIGATOR_CHANNEL_ID),livePreviewTabs=new Map;let $icon,$iframe,$panel,$pinUrlBtn,$highlightBtn,$livePreviewPopBtn,$reloadBtn;window.livePreviewTabs=livePreviewTabs,ExtensionInterface.registerExtensionInterface(ExtensionInterface._DEFAULT_EXTENSIONS_INTERFACE_NAMES.PHOENIX_LIVE_PREVIEW,exports),_livePreviewNavigationChannel.onmessage=(event=>{const type=event.data.type;switch(type){case"TAB_ONLINE":livePreviewTabs.set(event.data.clientID,{lastSeen:new Date,URL:event.data.URL});break;default:console.error("Live Preview Navigation Channel: received unknown message:",event)}});const TAB_HEARTBEAT_TIMEOUT=5e3;setInterval(()=>{let endTime=new Date;for(let tab of livePreviewTabs.keys()){let timeDiff;endTime-livePreviewTabs.get(tab).lastSeen>5e3&&livePreviewTabs.delete(tab)}0===livePreviewTabs.size&&_startOrStopLivePreviewIfRequired()},1e3);let panelHTML=require("text!panel.html");ExtensionUtils.loadStyleSheet(module,"live-preview.css");let panel,urlPinned,currentLivePreviewURL="";function _setPanelVisibility(isVisible){isVisible?($icon.toggleClass("active"),panel.show(),_loadPreview(!0)):($icon.toggleClass("active"),$iframe.attr("src","about:blank"),panel.hide())}function _startOrStopLivePreviewIfRequired(explicitClickOnLPIcon){let visible=panel&&panel.isVisible();visible&&LiveDevelopment.isInactive()?LiveDevelopment.openLivePreview():visible&&explicitClickOnLPIcon?(LiveDevelopment.closeLivePreview(),LiveDevelopment.openLivePreview()):visible||0!==livePreviewTabs.size||LiveDevelopment.closeLivePreview()}function _toggleVisibilityOnClick(){let visible;_setPanelVisibility(!panel.isVisible()),_startOrStopLivePreviewIfRequired(!0)}function _togglePinUrl(){let pinStatus=$pinUrlBtn.hasClass("pin-icon");pinStatus?$pinUrlBtn.removeClass("pin-icon").addClass("unpin-icon"):$pinUrlBtn.removeClass("unpin-icon").addClass("pin-icon"),urlPinned=!pinStatus,LiveDevelopment.setLivePreviewPinned(urlPinned),_loadPreview(),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"pinURLBtn","click")}function _updateLiveHighlightToggleStatus(){let isHighlightEnabled;CommandManager.get(Commands.FILE_LIVE_HIGHLIGHT).getChecked()?$highlightBtn.removeClass("pointer-icon").addClass("pointer-fill-icon"):$highlightBtn.removeClass("pointer-fill-icon").addClass("pointer-icon")}function _toggleLiveHighlights(){CommandManager.execute(Commands.FILE_LIVE_HIGHLIGHT),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"HighlightBtn","click")}function _stripURL(url){return url.includes("?")&&(url=url.split("?")[0]),url.includes("#")&&(url=url.split("#")[0]),url}function _getTabNavigationURL(url){let details,openURL=url;return LiveDevelopment.getLivePreviewDetails().URL!==url&&(openURL=`${_stripURL(location.href)}LiveDevelopment/pageLoader.html?`+`broadcastChannel=${LIVE_PREVIEW_NAVIGATOR_CHANNEL_ID}&URL=${encodeURIComponent(url)}`),openURL}function _redirectAllTabs(newURL){const openURL=_getTabNavigationURL(newURL);_livePreviewNavigationChannel.postMessage({type:NAVIGATOR_REDIRECT_PAGE,URL:openURL})}function _popoutLivePreview(){const openURL=_getTabNavigationURL(currentLivePreviewURL);open(openURL,"livePreview","noopener,noreferrer"),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"popoutBtn","click"),_loadPreview(!0)}function _setTitle(fileName){let message=Strings.LIVE_DEV_SELECT_FILE_TO_PREVIEW,tooltip=message;fileName&&(message=`${fileName} - ${Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC}`,tooltip=`${Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC} - ${fileName}`),document.getElementById("panel-live-preview-title").textContent=message,document.getElementById("live-preview-plugin-toolbar").title=tooltip}async function _createExtensionPanel(){let templateVars={Strings:Strings,livePreview:Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC,clickToReload:Strings.LIVE_DEV_CLICK_TO_RELOAD_PAGE,toggleLiveHighlight:Strings.LIVE_DEV_TOGGLE_LIVE_HIGHLIGHT,clickToPopout:Strings.LIVE_DEV_CLICK_POPOUT,clickToPinUnpin:Strings.LIVE_DEV_CLICK_TO_PIN_UNPIN};const PANEL_MIN_SIZE=50,INITIAL_PANEL_SIZE=document.body.clientWidth/2.5;($icon=$("#toolbar-go-live")).click(_toggleVisibilityOnClick),$panel=$(Mustache.render(panelHTML,templateVars)),$iframe=$panel.find("#panel-live-preview-frame"),$pinUrlBtn=$panel.find("#pinURLButton"),$highlightBtn=$panel.find("#highlightLPButton"),$reloadBtn=$panel.find("#reloadLivePreviewButton"),$livePreviewPopBtn=$panel.find("#livePreviewPopoutButton"),$iframe[0].onload=function(){$iframe.attr("srcdoc",null)},panel=WorkspaceManager.createPluginPanel(LIVE_PREVIEW_PANEL_ID,$panel,50,$icon,INITIAL_PANEL_SIZE),WorkspaceManager.recomputeLayout(!1),_updateLiveHighlightToggleStatus(),$pinUrlBtn.click(_togglePinUrl),$highlightBtn.click(_toggleLiveHighlights),$livePreviewPopBtn.click(_popoutLivePreview),$reloadBtn.click(()=>{LiveDevelopment.closeLivePreview(),LiveDevelopment.openLivePreview(),_loadPreview(!0),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"reloadBtn","click")})}function _renderMarkdown(fullPath,newSrc){currentLivePreviewURL=newSrc,console.log("Markdown Static server _updateInstrumentedURLSInWorker: ",[fullPath],newSrc),window.messageSW({type:"setInstrumentedURLs",root:"",paths:[fullPath]}).then(status=>{console.log("Markdown server received msg from Service worker: setInstrumentedURLs done: ",status),panel.isVisible()&&($iframe.attr("srcdoc",null),$iframe.attr("src",newSrc)),_redirectAllTabs(newSrc)}).catch(err=>{console.error(`Markdown error while from sw rendering failed for ${fullPath}: `,err)})}function _renderPreview(previewDetails,newSrc){let fullPath=previewDetails.fullPath;previewDetails.isMarkdownFile?(_renderMarkdown(fullPath,newSrc),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"render","markdown")):(currentLivePreviewURL=newSrc,panel.isVisible()&&($iframe.attr("srcdoc",null),$iframe.attr("src",newSrc)),_redirectAllTabs(newSrc),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"render",utils.getExtension(fullPath)))}let savedScrollPositions={};function _saveScrollPositionsIfPossible(){let currentSrc=$iframe.src||utils.getNoPreviewURL();try{let scrollX=$iframe[0].contentWindow.scrollX,scrollY=$iframe[0].contentWindow.scrollY;return savedScrollPositions[currentSrc]={scrollX:scrollX,scrollY:scrollY},{scrollX:scrollX,scrollY:scrollY,currentSrc:currentSrc}}catch(e){return{scrollX:0,scrollY:0,currentSrc:currentSrc}}}async function _loadPreview(force){if(panel.isVisible()||livePreviewTabs.size>0){let saved=_saveScrollPositionsIfPossible(),previewDetails=await utils.getPreviewDetails(),newSrc=saved.currentSrc;!urlPinned&&previewDetails.URL&&(newSrc=encodeURI(previewDetails.URL),_setTitle(previewDetails.filePath)),$iframe[0].onload=function(){if($iframe[0].contentDocument)if($iframe[0].contentDocument.savePageCtrlSDisabledByPhoenix=!0,$iframe[0].contentDocument.addEventListener("keydown",function(e){"s"===e.key&&(navigator.platform.match("Mac")?e.metaKey:e.ctrlKey)&&e.preventDefault()},!1),saved.currentSrc===newSrc)$iframe[0].contentWindow.scrollTo(saved.scrollX,saved.scrollY);else{let savedPositions=savedScrollPositions[newSrc];savedPositions&&$iframe[0].contentWindow.scrollTo(savedPositions.scrollX,savedPositions.scrollY)}},saved.currentSrc===newSrc&&!0!==force||($iframe.src=newSrc,_renderPreview(previewDetails,newSrc))}}async function _projectFileChanges(evt,changedFile){if(changedFile&&utils.isPreviewableFile(changedFile.fullPath)){const previewDetails=await utils.getPreviewDetails();LiveDevelopment.isActive()&&previewDetails.isHTMLFile||_loadPreview(!0)}}let livePreviewEnabledOnProjectSwitch=!1;async function _projectOpened(){urlPinned&&_togglePinUrl(),$iframe[0].src=utils.getNoPreviewURL(),panel.isVisible()&&_loadPreview(!0)}function _projectClosed(){LiveDevelopment.closeLivePreview(),livePreviewEnabledOnProjectSwitch=!1}function _activeDocChanged(){LiveDevelopment.isActive()||livePreviewEnabledOnProjectSwitch||!(panel.isVisible()||livePreviewTabs.size>0)||(LiveDevelopment.closeLivePreview(),LiveDevelopment.openLivePreview(),livePreviewEnabledOnProjectSwitch=!0)}async function _openLivePreviewURL(_event,previewDetails){_loadPreview(!0);const currentPreviewDetails=await utils.getPreviewDetails();currentPreviewDetails.isHTMLFile&&currentPreviewDetails.fullPath!==previewDetails.fullPath&&console.error("Live preview URLs differ between phoenix live preview extension and core live preview",currentPreviewDetails,previewDetails)}function _currentFileChanged(_event,newFile){newFile&&utils.isPreviewableFile(newFile.fullPath)&&_loadPreview()}AppInit.appReady(function(){let fileMenu;_createExtensionPanel(),ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED,_projectFileChanges),MainViewManager.on("currentFileChange",_currentFileChanged),ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN,_projectOpened),ProjectManager.on(ProjectManager.EVENT_PROJECT_CLOSE,_projectClosed),EditorManager.on("activeEditorChange",_activeDocChanged),CommandManager.register(Strings.CMD_LIVE_FILE_PREVIEW,Commands.FILE_LIVE_FILE_PREVIEW,function(){_toggleVisibilityOnClick()}),Menus.getMenu(Menus.AppMenuBar.FILE_MENU).addMenuItem(Commands.FILE_LIVE_FILE_PREVIEW,""),setTimeout(async()=>{let previewDetails;LiveDevelopment.openLivePreview(),(await utils.getPreviewDetails()).filePath&&_setPanelVisibility(!0)},1e3),LiveDevelopment.on(LiveDevelopment.EVENT_OPEN_PREVIEW_URL,_openLivePreviewURL),LiveDevelopment.on(LiveDevelopment.EVENT_LIVE_HIGHLIGHT_PREF_CHANGED,_updateLiveHighlightToggleStatus)}),exports.LIVE_PREVIEW_PANEL_ID=LIVE_PREVIEW_PANEL_ID});
//# sourceMappingURL=main.js.map
