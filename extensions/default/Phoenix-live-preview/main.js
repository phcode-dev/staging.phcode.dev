define(function(require,exports,module){const ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),EditorManager=brackets.getModule("editor/EditorManager"),ExtensionInterface=brackets.getModule("utils/ExtensionInterface"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),Menus=brackets.getModule("command/Menus"),WorkspaceManager=brackets.getModule("view/WorkspaceManager"),AppInit=brackets.getModule("utils/AppInit"),ProjectManager=brackets.getModule("project/ProjectManager"),MainViewManager=brackets.getModule("view/MainViewManager"),Strings=brackets.getModule("strings"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Metrics=brackets.getModule("utils/Metrics"),LiveDevelopment=brackets.getModule("LiveDevelopment/main"),LiveDevServerManager=brackets.getModule("LiveDevelopment/LiveDevServerManager"),NativeApp=brackets.getModule("utils/NativeApp"),StaticServer=require("StaticServer"),utils=require("utils"),LIVE_PREVIEW_PANEL_ID="live-preview-panel",IFRAME_EVENT_SERVER_READY="SERVER_READY";let serverReady=!1;const LIVE_PREVIEW_IFRAME_HTML='\n    <iframe id="panel-live-preview-frame" title="Live Preview" style="border: none"\n             width="100%" height="100%" seamless="true"\n             src=\'about:blank\'\n             sandbox="allow-same-origin allow-scripts allow-forms allow-modals allow-pointer-lock">\n    </iframe>\n    ';function _createStaticServer(){var config={pathResolver:ProjectManager.makeProjectRelativeIfPossible,root:ProjectManager.getProjectRoot().fullPath};return new StaticServer.StaticServer(config)}let $icon,$iframe,$panel,$pinUrlBtn,$highlightBtn,$livePreviewPopBtn,$reloadBtn;ExtensionInterface.registerExtensionInterface(ExtensionInterface._DEFAULT_EXTENSIONS_INTERFACE_NAMES.PHOENIX_LIVE_PREVIEW,exports);let panelHTML=require("text!panel.html");ExtensionUtils.loadStyleSheet(module,"live-preview.css");let panel,urlPinned,currentLivePreviewURL="";function _blankIframe(){let newIframe=$(LIVE_PREVIEW_IFRAME_HTML);newIframe.insertAfter($iframe),$iframe.remove(),$iframe=newIframe}function _setPanelVisibility(isVisible){isVisible?($icon.toggleClass("active"),panel.show(),_loadPreview(!0)):($icon.toggleClass("active"),_blankIframe(),panel.hide())}function _startOrStopLivePreviewIfRequired(explicitClickOnLPIcon){let visible=panel&&panel.isVisible();visible&&LiveDevelopment.isInactive()?LiveDevelopment.openLivePreview():visible&&explicitClickOnLPIcon?(LiveDevelopment.closeLivePreview(),LiveDevelopment.openLivePreview()):visible||!LiveDevelopment.isActive()||StaticServer.hasActiveLivePreviews()||LiveDevelopment.closeLivePreview()}function _toggleVisibilityOnClick(){let visible;_setPanelVisibility(!panel.isVisible()),_startOrStopLivePreviewIfRequired(!0)}function _togglePinUrl(){let pinStatus=$pinUrlBtn.hasClass("pin-icon");pinStatus?$pinUrlBtn.removeClass("pin-icon").addClass("unpin-icon"):$pinUrlBtn.removeClass("unpin-icon").addClass("pin-icon"),urlPinned=!pinStatus,LiveDevelopment.setLivePreviewPinned(urlPinned),_loadPreview(!0),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"pinURLBtn","click")}function _updateLiveHighlightToggleStatus(){let isHighlightEnabled;CommandManager.get(Commands.FILE_LIVE_HIGHLIGHT).getChecked()?$highlightBtn.removeClass("pointer-icon").addClass("pointer-fill-icon"):$highlightBtn.removeClass("pointer-fill-icon").addClass("pointer-icon")}function _toggleLiveHighlights(){CommandManager.execute(Commands.FILE_LIVE_HIGHLIGHT),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"HighlightBtn","click")}function _popoutLivePreview(){const openURL=StaticServer.getTabPopoutURL(currentLivePreviewURL);NativeApp.openURLInDefaultBrowser(openURL,"livePreview"),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"popoutBtn","click"),_loadPreview(!0),_setPanelVisibility(!1)}function _setTitle(fileName){let message=Strings.LIVE_DEV_SELECT_FILE_TO_PREVIEW,tooltip=message;fileName&&(message=`${fileName} - ${Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC}`,tooltip=`${Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC} - ${fileName}`),document.getElementById("panel-live-preview-title").textContent=message,document.getElementById("live-preview-plugin-toolbar").title=tooltip}async function _createExtensionPanel(){let templateVars={Strings:Strings,livePreview:Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC,clickToReload:Strings.LIVE_DEV_CLICK_TO_RELOAD_PAGE,toggleLiveHighlight:Strings.LIVE_DEV_TOGGLE_LIVE_HIGHLIGHT,clickToPopout:Strings.LIVE_DEV_CLICK_POPOUT,clickToPinUnpin:Strings.LIVE_DEV_CLICK_TO_PIN_UNPIN};const PANEL_MIN_SIZE=50,INITIAL_PANEL_SIZE=document.body.clientWidth/2.5;($icon=$("#toolbar-go-live")).click(_toggleVisibilityOnClick),$panel=$(Mustache.render(panelHTML,templateVars)),$iframe=$panel.find("#panel-live-preview-frame"),$pinUrlBtn=$panel.find("#pinURLButton"),$highlightBtn=$panel.find("#highlightLPButton"),$reloadBtn=$panel.find("#reloadLivePreviewButton"),$livePreviewPopBtn=$panel.find("#livePreviewPopoutButton"),$iframe[0].onload=function(){$iframe.attr("srcdoc",null)};const popoutSupported=Phoenix.browser.isTauri||Phoenix.browser.desktop.isChromeBased||Phoenix.browser.desktop.isFirefox;popoutSupported||$livePreviewPopBtn.addClass("forced-hidden"),panel=WorkspaceManager.createPluginPanel(LIVE_PREVIEW_PANEL_ID,$panel,50,$icon,INITIAL_PANEL_SIZE),WorkspaceManager.recomputeLayout(!1),_updateLiveHighlightToggleStatus(),$pinUrlBtn.click(_togglePinUrl),$highlightBtn.click(_toggleLiveHighlights),$livePreviewPopBtn.click(_popoutLivePreview),$reloadBtn.click(()=>{LiveDevelopment.closeLivePreview(),LiveDevelopment.openLivePreview(),_loadPreview(!0),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"reloadBtn","click")})}async function _loadPreview(force){const isPreviewLoadable=serverReady&&(panel.isVisible()||StaticServer.hasActiveLivePreviews());if(!isPreviewLoadable)return;let previewDetails=await utils.getPreviewDetails();if(urlPinned&&!force)return;let newSrc=encodeURI(previewDetails.URL);if(_setTitle(previewDetails.filePath),currentLivePreviewURL=newSrc,panel.isVisible()){let newIframe=$(LIVE_PREVIEW_IFRAME_HTML);newIframe.insertAfter($iframe),$iframe.remove(),($iframe=newIframe).attr("src",newSrc)}Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"render",utils.getExtension(previewDetails.fullPath)),StaticServer.redirectAllTabs(newSrc)}async function _projectFileChanges(evt,changedFile){if(changedFile&&utils.isPreviewableFile(changedFile.fullPath)){const previewDetails=await utils.getPreviewDetails();LiveDevelopment.isActive()&&previewDetails.isHTMLFile||_loadPreview(!0)}}let livePreviewEnabledOnProjectSwitch=!1;async function _projectOpened(_evt){urlPinned&&_togglePinUrl(),$iframe.attr("src",utils.getNoPreviewURL()),panel.isVisible()&&_loadPreview(!0)}function _projectClosed(){LiveDevelopment.closeLivePreview(),livePreviewEnabledOnProjectSwitch=!1}function _activeDocChanged(){LiveDevelopment.isActive()||livePreviewEnabledOnProjectSwitch||!panel.isVisible()&&!StaticServer.hasActiveLivePreviews()||(LiveDevelopment.closeLivePreview(),LiveDevelopment.openLivePreview(),livePreviewEnabledOnProjectSwitch=!0)}async function _openLivePreviewURL(_event,previewDetails){_loadPreview(!0);const currentPreviewDetails=await utils.getPreviewDetails();currentPreviewDetails.isHTMLFile&&currentPreviewDetails.fullPath!==previewDetails.fullPath&&console.error("Live preview URLs differ between phoenix live preview extension and core live preview",currentPreviewDetails,previewDetails)}function _currentFileChanged(_event,newFile){newFile&&utils.isPreviewableFile(newFile.fullPath)&&_loadPreview()}AppInit.appReady(function(){_createExtensionPanel(),LiveDevServerManager.registerServer({create:_createStaticServer},5),ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED,_projectFileChanges),MainViewManager.on("currentFileChange",_currentFileChanged),ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN,_projectOpened),ProjectManager.on(ProjectManager.EVENT_PROJECT_CLOSE,_projectClosed),EditorManager.on("activeEditorChange",_activeDocChanged),CommandManager.register(Strings.CMD_LIVE_FILE_PREVIEW,Commands.FILE_LIVE_FILE_PREVIEW,function(){_toggleVisibilityOnClick()});let fileMenu=Menus.getMenu(Menus.AppMenuBar.FILE_MENU);fileMenu.addMenuItem(Commands.FILE_LIVE_FILE_PREVIEW,"",Menus.AFTER,Commands.FILE_EXTENSION_MANAGER),fileMenu.addMenuDivider(Menus.BEFORE,Commands.FILE_LIVE_FILE_PREVIEW),setTimeout(async()=>{let previewDetails;LiveDevelopment.openLivePreview(),(await utils.getPreviewDetails()).filePath&&_setPanelVisibility(!0)},1e3),LiveDevelopment.on(LiveDevelopment.EVENT_OPEN_PREVIEW_URL,_openLivePreviewURL),LiveDevelopment.on(LiveDevelopment.EVENT_LIVE_HIGHLIGHT_PREF_CHANGED,_updateLiveHighlightToggleStatus),LiveDevelopment.on(LiveDevelopment.EVENT_LIVE_PREVIEW_RELOAD,()=>{_loadPreview(!0)}),StaticServer.on("SERVER_READY",function(_evt,event){serverReady=!0,_loadPreview(!0)});let consecutiveEmptyClientsCount=0;setInterval(()=>{StaticServer.hasActiveLivePreviews()?consecutiveEmptyClientsCount=0:consecutiveEmptyClientsCount++,consecutiveEmptyClientsCount>5&&_startOrStopLivePreviewIfRequired()},1e3)}),exports.LIVE_PREVIEW_PANEL_ID=LIVE_PREVIEW_PANEL_ID});
//# sourceMappingURL=main.js.map
