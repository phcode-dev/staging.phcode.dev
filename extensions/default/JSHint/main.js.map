{"version":3,"sources":["extensions/default/JSHint/main.js"],"names":["define","require","exports","module","CodeInspection","brackets","getModule","AppInit","PreferencesManager","Strings","ProjectManager","FileSystem","IndexingWorker","loadScriptInWorker","uri","prefs","getExtensionPrefs","projectSpecificOptions","jsHintConfigFileErrorMessage","_getLinterConfigFileErrorMsg","pos","line","ch","message","type","Type","ERROR","async","lintOneFile","text","_fullPath","Promise","resolve","errors","replace","options","get","execPeer","then","jsHintErrors","lintResult","length","map","lintError","character","reason","code","definePreference","esversion","browser","node","jquery","rhino","jasmine","devel","description","DESCRIPTION_JSHINT_OPTIONS","on","requestRun","JSHINT_NAME","CONFIG_FILE_NAME","removeComments","str","_readConfig","dir","configFileName","reject","file","getFileForPath","read","err","content","config","JSON","parse","e","console","log","fullPath","getProjectRelativePath","extends","extendFile","parentPath","name","baseConfigResult","mergedConfig","$","extend","globals","catch","_reloadOptions","getProjectRoot","_isFileInArray","fileToCheck","fileArray","_projectFileChanged","_evt","entry","added","removed","configFilePath","appReady","EVENT_PROJECT_FILE_CHANGED","EVENT_PROJECT_OPEN","register","scanFileAsync"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n * Original work Copyright (c) 2012 - 2021 Adobe Systems Incorporated. All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n// Parts of this file is adapted from https://github.com/cfjedimaster/brackets-jshint\n\n/**\n * Provides JSLint results via the core linting extension point\n */\ndefine(function (require, exports, module) {\n\n    // Load dependent modules\n    var CodeInspection     = brackets.getModule(\"language/CodeInspection\"),\n        AppInit            = brackets.getModule(\"utils/AppInit\"),\n        PreferencesManager = brackets.getModule(\"preferences/PreferencesManager\"),\n        Strings            = brackets.getModule(\"strings\"),\n        ProjectManager     = brackets.getModule(\"project/ProjectManager\"),\n        FileSystem         = brackets.getModule(\"filesystem/FileSystem\"),\n        IndexingWorker     = brackets.getModule(\"worker/IndexingWorker\");\n\n    IndexingWorker.loadScriptInWorker(`${module.uri}/../worker/jshint-helper.js`);\n\n    let prefs = PreferencesManager.getExtensionPrefs(\"jshint\"),\n        projectSpecificOptions = null,\n        jsHintConfigFileErrorMessage = null;\n\n    prefs.definePreference(\"options\", \"object\", {\n        \"esversion\": 11,\n        \"browser\": true,\n        \"node\": true,\n        \"jquery\": true,\n        \"rhino\": false, // false here means read-only global property\n        \"jasmine\": true,\n        \"devel\": false\n    }, {\n        description: Strings.DESCRIPTION_JSHINT_OPTIONS\n    }).on(\"change\", function () {\n        CodeInspection.requestRun(Strings.JSHINT_NAME);\n    });\n\n    function _getLinterConfigFileErrorMsg() {\n        return [{\n            // JSLint returns 1-based line/col numbers\n            pos: { line: -1, ch: 0 },\n            message: jsHintConfigFileErrorMessage,\n            type: CodeInspection.Type.ERROR\n        }];\n    }\n\n    /**\n     * Run JSLint on the current document. Reports results to the main UI. Displays\n     * a gold star when no errors are found.\n     */\n    async function lintOneFile(text, _fullPath) {\n        return new Promise((resolve)=>{\n            if(jsHintConfigFileErrorMessage){\n                resolve({ errors: _getLinterConfigFileErrorMsg() });\n                return;\n            }\n            // If a line contains only whitespace (here spaces or tabs), remove the whitespace\n            text = text.replace(/^[ \\t]+$/gm, \"\");\n\n            let options = projectSpecificOptions || prefs.get(\"options\");\n\n            IndexingWorker.execPeer(\"jsHint\", {\n                text,\n                options\n            }).then(jsHintErrors =>{\n                if (!jsHintErrors.lintResult && jsHintErrors.errors.length) {\n                    let errors = jsHintErrors.errors;\n\n                    errors = errors.map(function (lintError) {\n                        return {\n                            // JSLint returns 1-based line/col numbers\n                            pos: { line: lintError.line - 1, ch: lintError.character - 1 },\n                            message: `${lintError.reason} jshint (${lintError.code})`,\n                            type: CodeInspection.Type.ERROR\n                        };\n                    });\n\n                    resolve({ errors: errors });\n                }\n                resolve();\n            });\n        });\n    }\n\n    /**\n     * @private\n     * @type {string}\n     */\n    const CONFIG_FILE_NAME = \".jshintrc\";\n\n    /**\n     * Removes JavaScript comments from a string by replacing\n     * everything between block comments and everything after\n     * single-line comments in a non-greedy way.\n     *\n     * English version of the regex:\n     *   match '/*'\n     *   then match zero or more instances of any character (incl. \\n)\n     *   except for instances of '* /' (without a space, obv.)\n     *   then match '* /' (again, without a space)\n     *\n     * @param {string} str a string with potential JavaScript comments.\n     * @returns {string} a string without JavaScript comments.\n     */\n    function removeComments(str) {\n        str = str || \"\";\n\n        str = str.replace(/\\/\\*(?:(?!\\*\\/)[\\s\\S])*\\*\\//g, \"\");\n        str = str.replace(/\\/\\/[^\\n\\r]*/g, \"\"); // Everything after '//'\n\n        return str;\n    }\n\n    /**\n     * Reads configuration file in the specified directory. Returns a promise for configuration object.\n     *\n     * @param {string} dir absolute path to a directory.\n     * @param {string} configFileName name of the configuration file (optional)\n     *\n     * @returns {Promise} a promise to return configuration object.\n     */\n    function _readConfig(dir, configFileName) {\n        return new Promise((resolve, reject)=>{\n            configFileName = configFileName || CONFIG_FILE_NAME;\n            let file = FileSystem.getFileForPath(dir + configFileName);\n            file.read(function (err, content) {\n                if (err) {\n                    resolve(null); // no config file is a valid case. we just resolve with null\n                    return;\n                }\n                let config;\n                try {\n                    config = JSON.parse(removeComments(content));\n                } catch (e) {\n                    console.log(\"JSHint: error parsing \" + file.fullPath);\n                    // just log and return as this is an expected failure for us while the user edits code\n                    reject(\"Error parsing JSHint config file:    \"\n                        + ProjectManager.getProjectRelativePath(file.fullPath));\n                    return;\n                }\n                // Load any base config defined by \"extends\".\n                // The same functionality as in\n                // jslints -> cli.js -> loadConfig -> if (config['extends'])...\n                // https://jshint.com/docs/cli/ > Special Options\n                if (config.extends) {\n                    let extendFile = FileSystem.getFileForPath(dir + config.extends);\n                    _readConfig(extendFile.parentPath, extendFile.name).then(baseConfigResult=>{\n                        delete config.extends;\n                        let mergedConfig = $.extend({}, baseConfigResult, config);\n                        if (config.globals) {\n                            delete config.globals;\n                        }\n                        resolve(mergedConfig);\n                    }).catch(()=>{\n                        reject(\"Error parsing JSHint config file:    \"\n                            + ProjectManager.getProjectRelativePath(extendFile.name));\n                    });\n                }\n                else {\n                    resolve(config);\n                }\n            });\n        });\n    }\n\n    function _reloadOptions() {\n        projectSpecificOptions = null;\n        _readConfig(ProjectManager.getProjectRoot().fullPath, CONFIG_FILE_NAME).then((config)=>{\n            projectSpecificOptions = config;\n            CodeInspection.requestRun(Strings.JSHINT_NAME);\n            jsHintConfigFileErrorMessage = null;\n        }).catch((err)=>{\n            jsHintConfigFileErrorMessage = err;\n            CodeInspection.requestRun(Strings.JSHINT_NAME);\n        });\n    }\n\n    function _isFileInArray(fileToCheck, fileArray){\n        if(!fileArray){\n            return false;\n        }\n        for(let file of fileArray){\n            if(file.fullPath === fileToCheck.fullPath){\n                return true;\n            }\n        }\n        return false;\n    }\n\n    function _projectFileChanged(_evt, entry, added, removed) {\n        let configFilePath = FileSystem.getFileForPath(ProjectManager.getProjectRoot().fullPath + CONFIG_FILE_NAME);\n        if(entry.fullPath === configFilePath.fullPath\n            || _isFileInArray(configFilePath, added)){\n            _reloadOptions();\n        } else if(_isFileInArray(configFilePath, removed)){\n            projectSpecificOptions = null;\n        }\n    }\n\n    AppInit.appReady(function () {\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED, _projectFileChanged);\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN, _reloadOptions);\n        _reloadOptions();\n    });\n\n    // Register for JS files\n    CodeInspection.register(\"javascript\", {\n        name: Strings.JSHINT_NAME,\n        scanFileAsync: lintOneFile\n    });\n});\n"],"file":"main.js"}