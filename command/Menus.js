define(function(require,exports,module){var _=require("thirdparty/lodash"),Commands=require("command/Commands"),EventDispatcher=require("utils/EventDispatcher"),KeyBindingManager=require("command/KeyBindingManager"),StringUtils=require("utils/StringUtils"),CommandManager=require("command/CommandManager"),PopUpManager=require("widgets/PopUpManager"),ViewUtils=require("utils/ViewUtils"),DeprecationWarning=require("utils/DeprecationWarning");require("utils/Global");var AppMenuBar={FILE_MENU:"file-menu",EDIT_MENU:"edit-menu",FIND_MENU:"find-menu",VIEW_MENU:"view-menu",NAVIGATE_MENU:"navigate-menu",HELP_MENU:"help-menu"},ContextMenuIds={EDITOR_MENU:"editor-context-menu",INLINE_EDITOR_MENU:"inline-editor-context-menu",PROJECT_MENU:"project-context-menu",WORKING_SET_CONTEXT_MENU:"workingset-context-menu",WORKING_SET_CONFIG_MENU:"workingset-configuration-menu",SPLITVIEW_MENU:"splitview-menu"},MenuSection={FILE_OPEN_CLOSE_COMMANDS:{sectionMarker:Commands.FILE_NEW},FILE_SAVE_COMMANDS:{sectionMarker:Commands.FILE_SAVE},FILE_LIVE:{sectionMarker:Commands.FILE_LIVE_FILE_PREVIEW},FILE_EXTENSION_MANAGER:{sectionMarker:Commands.FILE_EXTENSION_MANAGER},EDIT_UNDO_REDO_COMMANDS:{sectionMarker:Commands.EDIT_UNDO},EDIT_TEXT_COMMANDS:{sectionMarker:Commands.EDIT_CUT},EDIT_SELECTION_COMMANDS:{sectionMarker:Commands.EDIT_SELECT_ALL},EDIT_MODIFY_SELECTION:{sectionMarker:Commands.EDIT_INDENT},EDIT_COMMENT_SELECTION:{sectionMarker:Commands.EDIT_LINE_COMMENT},EDIT_CODE_HINTS_COMMANDS:{sectionMarker:Commands.SHOW_CODE_HINTS},EDIT_TOGGLE_OPTIONS:{sectionMarker:Commands.TOGGLE_CLOSE_BRACKETS},FIND_FIND_COMMANDS:{sectionMarker:Commands.CMD_FIND},FIND_FIND_IN_COMMANDS:{sectionMarker:Commands.CMD_FIND_IN_FILES},FIND_REPLACE_COMMANDS:{sectionMarker:Commands.CMD_REPLACE},VIEW_HIDESHOW_COMMANDS:{sectionMarker:Commands.VIEW_HIDE_SIDEBAR},VIEW_FONTSIZE_COMMANDS:{sectionMarker:Commands.VIEW_INCREASE_FONT_SIZE},VIEW_TOGGLE_OPTIONS:{sectionMarker:Commands.TOGGLE_ACTIVE_LINE},NAVIGATE_GOTO_COMMANDS:{sectionMarker:Commands.NAVIGATE_QUICK_OPEN},NAVIGATE_DOCUMENTS_COMMANDS:{sectionMarker:Commands.NAVIGATE_NEXT_DOC},NAVIGATE_OS_COMMANDS:{sectionMarker:Commands.NAVIGATE_SHOW_IN_FILE_TREE},NAVIGATE_QUICK_EDIT_COMMANDS:{sectionMarker:Commands.TOGGLE_QUICK_EDIT},NAVIGATE_QUICK_DOCS_COMMANDS:{sectionMarker:Commands.TOGGLE_QUICK_DOCS}},BEFORE="before",AFTER="after",FIRST="first",LAST="last",FIRST_IN_SECTION="firstInSection",LAST_IN_SECTION="lastInSection",DIVIDER="---",SUBMENU="SUBMENU",NO_ERROR=0,ERR_UNKNOWN=1,ERR_INVALID_PARAMS=2,ERR_NOT_FOUND=3,menuMap={},contextMenuMap={},menuItemMap={};function getMenu(id){return menuMap[id]}function getAllMenus(){return menuMap}function getContextMenu(id){return contextMenuMap[id]}function removeMenuItemEventListeners(menuItem){menuItem._command.off("enabledStateChange",menuItem._enabledChanged).off("checkedStateChange",menuItem._checkedChanged).off("nameChange",menuItem._nameChanged).off("keyBindingAdded",menuItem._keyBindingAdded).off("keyBindingRemoved",menuItem._keyBindingRemoved)}function getMenuItem(id){return menuItemMap[id]}function _getHTMLMenu(id){return $("#"+StringUtils.jQueryIdEscape(id)).get(0)}function _getHTMLMenuItem(id){return $("#"+StringUtils.jQueryIdEscape(id)).get(0)}function _addKeyBindingToMenuItem($menuItem,key,displayKey){var $shortcut=$menuItem.find(".menu-shortcut");0===$shortcut.length&&($shortcut=$("<span class='menu-shortcut' />"),$menuItem.append($shortcut)),$shortcut.data("key",key),$shortcut.text(KeyBindingManager.formatKeyDescriptor(displayKey))}function _addExistingKeyBinding(menuItem){var bindings=KeyBindingManager.getKeyBindings(menuItem.getCommand().getID()),binding=null;return bindings.length>0&&(binding=bindings[bindings.length-1],_addKeyBindingToMenuItem($(_getHTMLMenuItem(menuItem.id)),binding.key,binding.displayKey)),binding}var _menuDividerIDCount=1;function _getNextMenuItemDividerID(){return"brackets-menuDivider-"+_menuDividerIDCount++}function _insertInList($list,$element,position,$relativeElement){var inserted=!1;position&&(position===FIRST_IN_SECTION?position=BEFORE:position===LAST_IN_SECTION&&(position=AFTER),position===FIRST?($list.prepend($element),inserted=!0):$relativeElement&&$relativeElement.length>0&&(position===AFTER?($relativeElement.after($element),inserted=!0):position===BEFORE&&($relativeElement.before($element),inserted=!0))),inserted||$list.append($element)}function MenuItem(id,command){this.id=id,this.isDivider=command===DIVIDER,this.isNative=!1,this.isDivider||command===SUBMENU||(this._enabledChanged=this._enabledChanged.bind(this),this._checkedChanged=this._checkedChanged.bind(this),this._nameChanged=this._nameChanged.bind(this),this._keyBindingAdded=this._keyBindingAdded.bind(this),this._keyBindingRemoved=this._keyBindingRemoved.bind(this),this._command=command,this._command.on("enabledStateChange",this._enabledChanged).on("checkedStateChange",this._checkedChanged).on("nameChange",this._nameChanged).on("keyBindingAdded",this._keyBindingAdded).on("keyBindingRemoved",this._keyBindingRemoved))}function Menu(id){this.id=id}function closeAll(){$(".dropdown").removeClass("open")}function addMenu(name,id,position,relativeID){name=_.escape(name);var $menubar=$("#titlebar .nav"),menu;if(!name||!id)return console.error("call to addMenu() is missing required parameters"),null;if(menuMap[id])return console.log("Menu added with same name and id of existing Menu: "+id),null;menu=new Menu(id),menuMap[id]=menu;var $toggle=$("<a href='#' class='dropdown-toggle' data-toggle='dropdown'>"+name+"</a>"),$popUp=$("<ul class='dropdown-menu'></ul>"),$newMenu,$relativeElement;return _insertInList($menubar,$("<li class='dropdown' id='"+id+"'></li>").append($toggle).append($popUp),position,relativeID&&$(_getHTMLMenu(relativeID))),PopUpManager.addPopUp($popUp,closeAll,!1),menu}function removeMenu(id){var menu,commandID="";id?menuMap[id]?(menu=getMenu(id),_.forEach(menuItemMap,function(value,key){_.startsWith(key,id)&&(value.isDivider?menu.removeMenuDivider(key):(commandID=value.getCommand(),menu.removeMenuItem(commandID)))}),$(_getHTMLMenu(id)).remove(),delete menuMap[id]):console.error("removeMenu(): menu id not found: %s",id):console.error("removeMenu(): missing required parameter: id")}function ContextMenu(id){Menu.apply(this,arguments);var $newMenu=$("<li class='dropdown context-menu' id='"+StringUtils.jQueryIdEscape(id)+"'></li>"),$popUp=$("<ul class='dropdown-menu'></ul>"),$toggle=$("<a href='#' class='dropdown-toggle' data-toggle='dropdown'></a>").hide();$newMenu.append($toggle).append($popUp),$("#context-menu-bar > ul").append($newMenu);var self=this;PopUpManager.addPopUp($popUp,function(){self.close()},!1),PopUpManager.listenToContextMenu(this)}function registerContextMenu(id){if(!id)return console.error("call to registerContextMenu() is missing required parameters"),null;if(contextMenuMap[id])return console.log("Context Menu added with same name and id of existing Context Menu: "+id),null;var cmenu=new ContextMenu(id);return contextMenuMap[id]=cmenu,cmenu}Menu.prototype._getMenuItemId=function(commandId){return this.id+"-"+commandId},Menu.prototype._getMenuItemForCommand=function(command){if(!command)return null;var foundMenuItem=menuItemMap[this._getMenuItemId(command.getID())];return foundMenuItem?$(_getHTMLMenuItem(foundMenuItem.id)).closest("li"):null},Menu.prototype._getRelativeMenuItem=function(relativeID,position){var $relativeElement;if(relativeID){if(position===FIRST_IN_SECTION||position===LAST_IN_SECTION){if(!relativeID.hasOwnProperty("sectionMarker"))return console.error("Bad Parameter in _getRelativeMenuItem(): relativeID must be a MenuSection when position refers to a menu section"),null;var $sectionMarker=this._getMenuItemForCommand(CommandManager.get(relativeID.sectionMarker));if(!$sectionMarker)return console.error("_getRelativeMenuItem(): MenuSection "+relativeID.sectionMarker+" not found in Menu "+this.id),null;var $listElem=$sectionMarker;for($relativeElement=$listElem;0!==($listElem=position===FIRST_IN_SECTION?$listElem.prev():$listElem.next()).length&&!($listElem.find(".divider").length>0);)$relativeElement=$listElem}else{if(relativeID.hasOwnProperty("sectionMarker"))return console.error("Bad Parameter in _getRelativeMenuItem(): if relativeID is a MenuSection, position must be FIRST_IN_SECTION or LAST_IN_SECTION"),null;var command=CommandManager.get(relativeID);if(command&&($relativeElement=this._getMenuItemForCommand(command)),!$relativeElement)return console.error("_getRelativeMenuItem(): MenuItem with Command id "+relativeID+" not found in Menu "+this.id),null}return $relativeElement}return position&&position!==FIRST&&position!==LAST?(console.error("Bad Parameter in _getRelativeMenuItem(): relative position specified with no relativeID"),null):$relativeElement},Menu.prototype.removeMenuItem=function(command){var menuItemID,commandID;if(command){if("string"==typeof command){var commandObj;if(!CommandManager.get(command))return void console.error("removeMenuItem(): command not found: "+command);commandID=command}else commandID=command.getID();var menuItem;removeMenuItemEventListeners(getMenuItem(menuItemID=this._getMenuItemId(commandID))),$(_getHTMLMenuItem(menuItemID)).parent().remove(),delete menuItemMap[menuItemID]}else console.error("removeMenuItem(): missing required parameters: command")},Menu.prototype.removeMenuDivider=function(menuItemID){var menuItem,$HTMLMenuItem;menuItemID?(menuItem=getMenuItem(menuItemID))?menuItem.isDivider?($HTMLMenuItem=$(_getHTMLMenuItem(menuItemID)).parent())?($HTMLMenuItem.remove(),menuItemMap[menuItemID]?delete menuItemMap[menuItemID]:console.error("removeMenuDivider(): menu divider not found in menuItemMap: %s",menuItemID)):console.error("removeMenuDivider(): HTML menu divider not found: %s",menuItemID):console.error("removeMenuDivider(): parameter menuItemID: %s is not a menu divider",menuItemID):console.error("removeMenuDivider(): parameter menuItemID: %s is not a valid menu item id",menuItemID):console.error("removeMenuDivider(): missing required parameters: menuItemID")},Menu.prototype.addMenuItem=function(command,keyBindings,position,relativeID){var menuID=this.id,id,$menuItem,menuItem,name,commandID;if(!command)return console.error("addMenuItem(): missing required parameters: command"),null;if("string"==typeof command)if(command===DIVIDER)name=DIVIDER,commandID=_getNextMenuItemDividerID();else{if(commandID=command,!(command=CommandManager.get(commandID)))return console.error("addMenuItem(): commandID not found: "+commandID),null;name=command.getName()}else commandID=command.getID(),name=command.getName();if(id=this._getMenuItemId(commandID),menuItemMap[id])return console.log("MenuItem added with same id of existing MenuItem: "+id),null;if(menuItem=new MenuItem(id,command),menuItemMap[id]=menuItem,name===DIVIDER)$menuItem=$("<li><hr class='divider' id='"+id+"' /></li>");else{($menuItem=$("<li><a href='#' id='"+id+"'> <span class='menu-name'></span></a></li>")).on("click",function(){menuItem._command.execute()});var self=this;$menuItem.on("mouseenter",function(){self.closeSubMenu()})}var $relativeElement=this._getRelativeMenuItem(relativeID,position);return _insertInList($("li#"+StringUtils.jQueryIdEscape(this.id)+" > ul.dropdown-menu"),$menuItem,position,$relativeElement),menuItem.isDivider?menuItem.dividerId=commandID:(keyBindings&&(Array.isArray(keyBindings)||(keyBindings=[keyBindings])),KeyBindingManager.addBinding(commandID,keyBindings),_addExistingKeyBinding(menuItem),menuItem._checkedChanged(),menuItem._enabledChanged(),menuItem._nameChanged()),menuItem},Menu.prototype.addMenuDivider=function(position,relativeID){return this.addMenuItem(DIVIDER,"",position,relativeID)},Menu.prototype.addSubMenu=function(name,id,position,relativeID){if(!name||!id)return console.error("addSubMenu(): missing required parameters: name and id"),null;if(contextMenuMap[id])return console.log("Context menu added with id of existing Context Menu: "+id),null;var menu=new ContextMenu(id);contextMenuMap[id]=menu;var menuItemID=this.id+"-"+id;if(menuItemMap[menuItemID])return console.log("MenuItem added with same id of existing MenuItem: "+id),null;var menuItem=new MenuItem(menuItemID,SUBMENU);menuItemMap[menuItemID]=menuItem,menu.parentMenuItem=menuItem;var $menuItem=$("<li><a href='#' id='"+menuItemID+"'> <span class='menu-name'>"+name+"</span><span style='float: right'>&rtrif;</span></a></li>"),self=this;$menuItem.on("mouseenter",function(e){self.openSubMenu&&self.openSubMenu.id===menu.id||(self.closeSubMenu(),self.openSubMenu=menu,menu.open())});var $relativeElement=this._getRelativeMenuItem(relativeID,position);return _insertInList($("li#"+StringUtils.jQueryIdEscape(this.id)+" > ul.dropdown-menu"),$menuItem,position,$relativeElement),menu},Menu.prototype.removeSubMenu=function(subMenuID){var subMenu,parentMenuItem,commandID="";subMenuID?(subMenu=getContextMenu(subMenuID))&&subMenu.parentMenuItem?(parentMenuItem=subMenu.parentMenuItem,menuItemMap[parentMenuItem.id]?(_.forEach(menuItemMap,function(value,key){_.startsWith(key,subMenuID)&&(value.isDivider?subMenu.removeMenuDivider(key):(commandID=value.getCommand(),subMenu.removeMenuItem(commandID)))}),$(_getHTMLMenuItem(parentMenuItem.id)).parent().remove(),$(_getHTMLMenu(subMenuID)).remove(),delete menuItemMap[parentMenuItem.id],delete contextMenuMap[subMenuID]):console.error("removeSubMenu(): parent menuItem not found in menuItemMap: %s",parentMenuItem.id)):console.error("removeSubMenu(): parameter subMenuID: %s is not a valid submenu id",subMenuID):console.error("removeSubMenu(): missing required parameters: subMenuID")},Menu.prototype.closeSubMenu=function(){this.openSubMenu&&(this.openSubMenu.close(),this.openSubMenu=null)},MenuItem.prototype.getCommand=function(){return this._command},MenuItem.prototype.getParentMenu=function(){var parent=$(_getHTMLMenuItem(this.id)).parents(".dropdown").get(0);return parent?getMenu(parent.id):null},MenuItem.prototype._checkedChanged=function(){var checked=!!this._command.getChecked();if(this.isNative){var enabled=!!this._command.getEnabled();brackets.app.setMenuItemState(this._command.getID(),enabled,checked,function(err){err&&console.log("Error setting menu item state: "+err)})}else ViewUtils.toggleClass($(_getHTMLMenuItem(this.id)),"checked",checked)},MenuItem.prototype._enabledChanged=function(){if(this.isNative){var enabled=!!this._command.getEnabled(),checked=!!this._command.getChecked();brackets.app.setMenuItemState(this._command.getID(),enabled,checked,function(err){err&&console.log("Error setting menu item state: "+err)})}else ViewUtils.toggleClass($(_getHTMLMenuItem(this.id)),"disabled",!this._command.getEnabled())},MenuItem.prototype._nameChanged=function(){this.isNative?brackets.app.setMenuTitle(this._command.getID(),this._command.getName(),function(err){err&&console.log("Error setting menu title: "+err)}):$(_getHTMLMenuItem(this.id)).find(".menu-name").text(this._command.getName())},MenuItem.prototype._keyBindingAdded=function(event,keyBinding){if(this.isNative){var shortcutKey=keyBinding.displayKey||keyBinding.key;brackets.app.setMenuItemShortcut(this._command.getID(),shortcutKey,KeyBindingManager.formatKeyDescriptor(shortcutKey),function(err){err&&console.error("Error setting menu item shortcut key "+shortcutKey+" : "+err)})}else _addKeyBindingToMenuItem($(_getHTMLMenuItem(this.id)),keyBinding.key,keyBinding.displayKey)},MenuItem.prototype._keyBindingRemoved=function(event,keyBinding){if(this.isNative)brackets.app.setMenuItemShortcut(this._command.getID(),"","",function(err){err&&console.error("Error setting menu item shortcut: "+err)});else{var $shortcut=$(_getHTMLMenuItem(this.id)).find(".menu-shortcut");$shortcut.length>0&&$shortcut.data("key")===keyBinding.key&&null===_addExistingKeyBinding(this)&&$shortcut.empty()}},ContextMenu.prototype=Object.create(Menu.prototype),ContextMenu.prototype.constructor=ContextMenu,ContextMenu.prototype.parentClass=Menu.prototype,EventDispatcher.makeEventDispatcher(ContextMenu.prototype),ContextMenu.prototype.open=function(mouseOrLocation){if(this.parentMenuItem||mouseOrLocation&&mouseOrLocation.hasOwnProperty("pageX")&&mouseOrLocation.hasOwnProperty("pageY")){var $window=$(window),escapedId=StringUtils.jQueryIdEscape(this.id),$menuAnchor=$("#"+escapedId),$menuWindow=$("#"+escapedId+" > ul"),posTop,posLeft;if(!($menuWindow.children().length<=0)){if(this.parentMenuItem){this.trigger("beforeSubMenuOpen");var $parentMenuItem=$(_getHTMLMenuItem(this.parentMenuItem.id)),elementRect={top:posTop=$parentMenuItem.offset().top,left:posLeft=$parentMenuItem.offset().left+$parentMenuItem.outerWidth(),height:$menuWindow.height()+25,width:$menuWindow.width()},clip;(clip=ViewUtils.getElementClipSize($window,elementRect)).bottom>0&&(posTop=Math.max(0,posTop+$parentMenuItem.height()-$menuWindow.height())),posTop-=30,posLeft+=3,clip.right>0&&(posLeft=Math.max(0,posLeft-$parentMenuItem.outerWidth()-$menuWindow.outerWidth()))}else{this.trigger("beforeContextMenuOpen"),closeAll();var elementRect={top:posTop=mouseOrLocation.pageY,left:posLeft=mouseOrLocation.pageX,height:$menuWindow.height()+25,width:$menuWindow.width()},clip;(clip=ViewUtils.getElementClipSize($window,elementRect)).bottom>0&&(posTop=Math.max(0,posTop-clip.bottom)),posTop-=30,posLeft+=5,clip.right>0&&(posLeft=Math.max(0,posLeft-clip.right))}$menuAnchor.addClass("open").css({left:posLeft,top:posTop})}}else console.error("ContextMenu open(): missing required parameter")},ContextMenu.prototype.close=function(){this.parentMenuItem?this.trigger("beforeSubMenuClose"):this.trigger("beforeContextMenuClose"),this.closeSubMenu(),$("#"+StringUtils.jQueryIdEscape(this.id)).removeClass("open")},ContextMenu.prototype.isOpen=function(){return $("#"+StringUtils.jQueryIdEscape(this.id)).hasClass("open")},ContextMenu.assignContextMenuToSelector=function(selector,cmenu){$(selector).on("click",function(e){var buttonOffset,buttonHeight;e.stopPropagation(),cmenu.isOpen()?cmenu.close():(buttonOffset=$(this).offset(),buttonHeight=$(this).outerHeight(),cmenu.open({pageX:buttonOffset.left,pageY:buttonOffset.top+buttonHeight}))})},DeprecationWarning.deprecateConstant(ContextMenuIds,"WORKING_SET_MENU","WORKING_SET_CONTEXT_MENU"),DeprecationWarning.deprecateConstant(ContextMenuIds,"WORKING_SET_SETTINGS_MENU","WORKING_SET_CONFIG_MENU"),exports.AppMenuBar=AppMenuBar,exports.ContextMenuIds=ContextMenuIds,exports.MenuSection=MenuSection,exports.BEFORE=BEFORE,exports.AFTER=AFTER,exports.LAST=LAST,exports.FIRST=FIRST,exports.FIRST_IN_SECTION=FIRST_IN_SECTION,exports.LAST_IN_SECTION=LAST_IN_SECTION,exports.DIVIDER=DIVIDER,exports.getMenu=getMenu,exports.getAllMenus=getAllMenus,exports.getMenuItem=getMenuItem,exports.getContextMenu=getContextMenu,exports.addMenu=addMenu,exports.removeMenu=removeMenu,exports.registerContextMenu=registerContextMenu,exports.closeAll=closeAll,exports.Menu=Menu,exports.MenuItem=MenuItem,exports.ContextMenu=ContextMenu});
//# sourceMappingURL=Menus.js.map
