{"version":3,"sources":["phoenix/init_vfs.js"],"names":["extensionDIR","appSupportDIR","tauriAssetServeDir","tauriAssetServeBaseURL","documentsDIR","tempDIR","userProjectsDir","_setupVFS","fsLib","pathLib","Phoenix","VFS","getRootDir","getMountDir","getTauriDir","getAppSupportDir","getExtensionDir","getUserExtensionDir","getDevExtensionDir","getDevTempExtensionDir","getTempDir","getTauriAssetServeDir","getUserDocumentsDirectory","getUserProjectsDirectory","_getVirtualDocumentsDirectory","getDefaultProjectDir","ensureTrailingSlash","path","endsWith","getTauriVirtualPath","fs","isLocalDiscPath","fullPath","startsWith","ensureExistsDir","cb","exists","mkdirs","err","code","getPathForVirtualServingURL","fullURL","browser","isTauri","assetRelativePath","decodeURIComponent","replace","window","fsServerUrl","getVirtualServingURLForPath","platformPath","getTauriPlatformPath","__TAURI__","tauri","convertFileSrc","slice","ensureExistsDirAsync","async","Promise","resolve","reject","stat","stats","existsAsync","_SAMPLE_HTML","_tryCreateDefaultProject","projectDir","logger","reportError","indexFile","normalize","writeFile","setupAppSupportAndExtensionsDir","_tauriBootVars","appLocalDir","catch","console","error","all","setupDocumentsDir","documentDir","appName","appname","log","setupTempDir","tempDir","_createAppDirs","_tauriBootVarsPromise","CORE_LIB_GUARD_INTERVAL","_FS_ERROR_MESSAGE","initVFS","alert","Error","savedfs","savedPath","setInterval","_phoenixfsAppDirsCreatePromise"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n * Acknowledgements: https://github.com/bpedro/node-fs\n *\n * This program is free software: you can redistribute it and/or modify it under\n * the terms of the GNU Affero General Public License as published by the Free\n * Software Foundation, either version 3 of the License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * See the GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License along\n * with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n// jshint ignore: start\n/*global fs, Phoenix, logger*/\n/*eslint no-console: 0*/\n/*eslint strict: [\"error\", \"global\"]*/\n\n/** Setup virtual file system. This happens before any code of phoenix is loaded.\n * The virtual file system is rooted at /\n * Application support folder that stores app data is /app/\n * Local user storage space is mounted at path /local/\n * Trash storage space is mounted at path /trash/\n *\n * This module should be functionally as light weight as possible with minimal deps as it is a shell component.\n * **/\n\nlet extensionDIR,\n    appSupportDIR,\n    tauriAssetServeDir,\n    tauriAssetServeBaseURL,\n    documentsDIR,\n    tempDIR,\n    userProjectsDir;\n\nfunction _setupVFS(fsLib, pathLib){\n    Phoenix.VFS = {\n        getRootDir: () => '/fs/',\n        getMountDir: () => '/mnt/',\n        getTauriDir: () => '/tauri/',\n        getAppSupportDir: () => appSupportDIR,\n        getExtensionDir: () => extensionDIR,\n        getUserExtensionDir: () => `${extensionDIR}user`,\n        getDevExtensionDir: () => `${extensionDIR}dev`,\n        getDevTempExtensionDir: () => `${extensionDIR}devTemp`,\n        getTempDir: () => tempDIR,\n        getTauriAssetServeDir: () => tauriAssetServeDir,\n        getUserDocumentsDirectory: () => documentsDIR,\n        getUserProjectsDirectory: () => userProjectsDir,\n        _getVirtualDocumentsDirectory: () => '/fs/local/',\n        getDefaultProjectDir: () => `${userProjectsDir}default project/`,\n        ensureTrailingSlash: function (path) {\n            if(!path.endsWith(\"/\")) {\n                return `${path}/`;\n            }\n            return path;\n        },\n        /**\n         * Gets the tauri virtual path given a platform path.\n         * @throws Error If the system path cannot be converted to virtualPath\n         */\n        getTauriVirtualPath: fs.getTauriVirtualPath,\n        /**\n         * Check if a given full path is located in the users local machine drive. For eg. fs access paths are accounted\n         * as local disc path, as well as tauri fs paths.\n         * @param fullPath\n         */\n        isLocalDiscPath: function (fullPath) {\n            if(fullPath &&\n                (fullPath.startsWith(Phoenix.VFS.getTauriDir()) || fullPath.startsWith(Phoenix.VFS.getMountDir()) )){\n                return true;\n            }\n            return false;\n        },\n        ensureExistsDir: function (path, cb) {\n            Phoenix.VFS.exists(path, (exists) =>{\n                // We have to do the exists check explicitly here instead of only using fs.mkdir call check EEXIST code\n                // as trying to call mkdir on `/mnt/someFolder` will throw an error even if the mount point exists.\n                // mount points can only be created by the mount call.\n                if(exists){\n                    cb();\n                    return;\n                }\n                Phoenix.fs.mkdirs(path, 0o755, true, function(err) {\n                    if (err && err.code !== 'EEXIST') {\n                        cb(err);\n                    }\n                    cb();\n                });\n            });\n        },\n        /**\n         * Converts a phoenix virtual serving url to absolute path in file system or null\n         * http://localhost:8000/src/phoenix/vfs/fs/app/extensions/user/themesforbrackets/requirejs-config.json\n         * to /fs/app/extensions/user/themesforbrackets/requirejs-config.json\n         * @param fullURL\n         * @returns {string|null}\n         */\n        getPathForVirtualServingURL: function (fullURL) {\n            if(Phoenix.browser.isTauri) {\n                if(fullURL.startsWith(tauriAssetServeBaseURL)){\n                    const assetRelativePath = decodeURIComponent(fullURL.replace(tauriAssetServeBaseURL, \"\"))\n                        .replace(/\\\\/g, \"/\"); // replace windows path forward slashes \\ to /\n                    return `${tauriAssetServeDir}${assetRelativePath}`;\n                }\n                return null;\n            }\n            if(window.fsServerUrl && fullURL.startsWith(window.fsServerUrl)){\n                return fullURL.replace(window.fsServerUrl, \"/\");\n            }\n            return null;\n        },\n        getVirtualServingURLForPath: function (fullPath) {\n            if(Phoenix.browser.isTauri) {\n                if(fullPath.startsWith(tauriAssetServeDir)){\n                    const platformPath = fs.getTauriPlatformPath(fullPath)\n                        .replace(/\\\\/g, \"/\"); // windows style paths to unix style c:\\x\\y to c:/x/y\n                    return decodeURIComponent(window.__TAURI__.tauri.convertFileSrc(platformPath));\n                }\n                return null;\n            }\n            return window.fsServerUrl.slice(0, -1) + fullPath;\n        },\n        ensureExistsDirAsync: async function (path) {\n            return new Promise((resolve, reject)=>{\n                Phoenix.VFS.ensureExistsDir(path, (err) =>{\n                    if(err){\n                        reject(err);\n                    } else {\n                        resolve();\n                    }\n                });\n            });\n        },\n        exists: function (path, cb) {\n            fs.stat(path, function (err, stats){\n                if (stats && !err) {\n                    cb(true);\n                } else {\n                    cb(false);\n                }\n            });\n        },\n        existsAsync: async function (path) {\n            return new Promise((resolve)=>{\n                Phoenix.VFS.exists(path, (exists) =>{\n                    resolve(exists);\n                });\n            });\n        },\n        fs: fsLib,\n        path: pathLib\n    };\n    Phoenix.fs = fsLib;\n    Phoenix.path = pathLib;\n\n    return Phoenix.VFS;\n}\n\nconst _SAMPLE_HTML = `<!DOCTYPE html>\n<html>\n    <head>\n        <title>Phoenix Editor for the web</title>\n    </head>\n \n    <body>\n        <h1>Welcome to Phoenix</h1>\n        <p> Modern, Open-source, IDE For The Web.</p>\n    </body>\n</html>`;\n\n// always resolves even if error\nfunction _tryCreateDefaultProject() {\n    // Create phoenix app dirs\n    // Create Phoenix default project if it doesnt exist\n    return new Promise((resolve)=>{\n        let projectDir = Phoenix.VFS.getDefaultProjectDir();\n        Phoenix.VFS.exists(projectDir, (exists)=>{\n            if(!exists){\n                Phoenix.VFS.ensureExistsDir(projectDir, (err)=>{\n                    if(err){\n                        logger.reportError(err, \"Error creating default project\");\n                    }\n                    let indexFile = Phoenix.VFS.path.normalize(`${projectDir}/index.html`);\n                    Phoenix.VFS.fs.writeFile(indexFile, _SAMPLE_HTML, 'utf8', ()=>{});\n                    resolve();\n                });\n                return;\n            }\n            resolve();\n        });\n    });\n}\n\nasync function setupAppSupportAndExtensionsDir() {\n    if(Phoenix.browser.isTauri) {\n        appSupportDIR = fs.getTauriVirtualPath(window._tauriBootVars.appLocalDir);\n        if(!appSupportDIR.endsWith(\"/\")){\n            appSupportDIR = `${appSupportDIR}/`;\n        }\n        tauriAssetServeDir = `${appSupportDIR}assets/`;\n        tauriAssetServeBaseURL = decodeURIComponent(window.__TAURI__.tauri.convertFileSrc(\n            fs.getTauriPlatformPath(tauriAssetServeDir)))\n            .replace(/\\\\/g, \"/\"); // windows style paths to unix style c:\\x\\y to c:/x/y\n        extensionDIR = `${tauriAssetServeDir}extensions/`;\n        // in tauri, the /fs/ folder is not a requirement for boot, so we won't fait for it.\n        // also this creates wired indexed db lock bugs in tauri where the boot leads to a blank screen.\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getRootDir())\n            .catch(console.error);\n    } else {\n        appSupportDIR = '/fs/app/';\n        extensionDIR = `${appSupportDIR}extensions/`;\n        await Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getRootDir());\n    }\n    await Promise.all([\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getAppSupportDir()),\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getExtensionDir()),\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getUserExtensionDir()),\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getDevExtensionDir()),\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getDevTempExtensionDir())\n    ]);\n}\n\nasync function setupDocumentsDir() {\n    if(Phoenix.browser.isTauri) {\n        documentsDIR = fs.getTauriVirtualPath(window._tauriBootVars.documentDir);\n        if(!documentsDIR.endsWith(\"/\")){\n            documentsDIR = `${documentsDIR}/`;\n        }\n        const appName = window._tauriBootVars.appname;\n        userProjectsDir = `${documentsDIR}${appName}/`;\n    } else {\n        documentsDIR = Phoenix.VFS._getVirtualDocumentsDirectory();\n        userProjectsDir = documentsDIR;\n    }\n    await Phoenix.VFS.ensureExistsDirAsync(documentsDIR);\n    await _tryCreateDefaultProject();\n    console.log(\"Documents dir setup done\");\n}\n\nasync function setupTempDir() {\n    if(Phoenix.browser.isTauri) {\n        tempDIR = fs.getTauriVirtualPath(window._tauriBootVars.tempDir);\n        if(!tempDIR.endsWith(\"/\")){\n            tempDIR = `${tempDIR}/`;\n        }\n        const appName = window._tauriBootVars.appname;\n        tempDIR = `${tempDIR}${appName}/`;\n    } else {\n        tempDIR = '/temp/';\n    }\n    await Phoenix.VFS.ensureExistsDirAsync(tempDIR);\n    console.log(\"Temp dir setup done\");\n}\n\nconst _createAppDirs = async function () {\n    console.log(\"Waiting for tauri boot variables...\");\n    if(window._tauriBootVarsPromise) {\n        await window._tauriBootVarsPromise;\n    }\n    console.log(\"Creating appdirs...\");\n    // Create phoenix app dirs\n    await Promise.all([\n        setupAppSupportAndExtensionsDir(),\n        setupDocumentsDir(),\n        setupTempDir()\n    ]);\n    console.log(\"Appdirs created...\");\n};\n\n\nconst CORE_LIB_GUARD_INTERVAL = 5000;\nconst _FS_ERROR_MESSAGE = 'Oops. Phoenix could not be started due to missing file system library.';\nexport default function initVFS() {\n    if(!window.fs || !window.path || !window.Phoenix){\n        window.alert(_FS_ERROR_MESSAGE);\n        throw new Error(_FS_ERROR_MESSAGE);\n    }\n    const savedfs = window.fs, savedPath = window.path;\n    setInterval(()=>{\n        if(window.fs !== savedfs){\n            console.error(\"window.fs overwrite detected!! Some extension may have corrupted this.\" +\n                \" attempting to revert to original lib.\");\n            window.fs=savedfs;\n        }\n        if(window.path !== savedPath){\n            console.error(\"window.path overwrite detected!! Some extension may have corrupted this.\" +\n                \" attempting to revert to original lib.\");\n            window.path=savedPath;\n        }\n\n    }, CORE_LIB_GUARD_INTERVAL);\n\n    _setupVFS(window.fs, window.path);\n    window._phoenixfsAppDirsCreatePromise = _createAppDirs();\n}\n\n"],"file":"init_vfs.js"}