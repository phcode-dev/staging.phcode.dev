{"version":3,"sources":["phoenix/init_vfs.js"],"names":["EXTENSION_DIR","_setupVFS","fsLib","pathLib","Phoenix","VFS","getRootDir","getMountDir","getAppSupportDir","getExtensionDir","getUserExtensionDir","getDevExtensionDir","getLocalDir","getTempDir","getTrashDir","getDefaultProjectDir","getUserDocumentsDirectory","ensureExistsDir","path","cb","exists","fs","mkdirs","err","code","getPathForVirtualServingURL","fullPath","window","fsServerUrl","startsWith","replace","ensureExistsDirAsync","async","Promise","resolve","reject","stat","stats","existsAsync","getFsEncoding","_getFsEncoding","encoding","encodingStr","toLowerCase","_SAMPLE_HTML","_tryCreateDefaultProject","projectDir","logger","reportError","indexFile","normalize","writeFile","_createAppDirs","all","_FS_ERROR_MESSAGE","initVFS","alert","Error","_phoenixfsAppDirsCreatePromise"],"mappings":"AAiCA,MAAMA,cAAgB,sBAEtB,SAASC,UAAUC,MAAOC,SA6EtB,OA5EAC,QAAQC,IAAM,CACVC,WAAY,IAAM,OAClBC,YAAa,IAAM,QACnBC,iBAAkB,IAAM,WACxBC,gBAAiB,IAAMT,cACvBU,oBAAqB,OAASV,oBAC9BW,mBAAoB,OAASX,mBAC7BY,YAAa,IAAM,aACnBC,WAAY,IAAM,SAClBC,YAAa,IAAM,aACnBC,qBAAsB,IAAM,6BAC5BC,0BAA2B,IAAM,uBACjCC,gBAAiB,SAAUC,KAAMC,IAC7Bf,QAAQC,IAAIe,OAAOF,KAAOE,SAInBA,OACCD,KAGJE,GAAGC,OAAOJ,KAAM,KAAK,EAAM,SAASK,KAC5BA,KAAoB,WAAbA,IAAIC,MACXL,GAAGI,KAEPJ,UAWZM,4BAA6B,SAAUC,UACnC,OAAGC,OAAOC,aAAeF,SAASG,WAAWF,OAAOC,aACzCF,SAASI,QAAQH,OAAOC,YAAa,KAEzC,MAEXG,qBAAsBC,eAAgBd,MAClC,OAAO,IAAIe,QAAQ,CAACC,QAASC,UACzB/B,QAAQC,IAAIY,gBAAgBC,KAAOK,MAC5BA,IACCY,OAAOZ,KAEPW,eAKhBd,OAAQ,SAAUF,KAAMC,IACpBE,GAAGe,KAAKlB,KAAM,SAAUK,IAAKc,OAErBlB,MADAkB,OAAUd,SAOtBe,YAAaN,eAAgBd,MACzB,OAAO,IAAIe,QAASC,UAChB9B,QAAQC,IAAIe,OAAOF,KAAOE,SACtBc,QAAQd,aAIpBC,GAAInB,MACJgB,KAAMf,QACNoC,cAAeC,gBAEnBpC,QAAQiB,GAAKnB,MACbE,QAAQc,KAAOf,QAERC,QAAQC,IAGnB,MAAMmC,eAAiB,SAAUC,UAC7B,MAAMC,YAAcD,SAASE,cAC7B,OAAQD,aACR,IAAK,OACL,IAAK,QACD,MAAO,OACX,IAAK,QACD,MAAO,QACX,IAAK,MACD,MAAO,MACX,IAAK,OACL,IAAK,QACD,MAAO,OACX,IAAK,UACL,IAAK,WACD,MAAO,UACX,IAAK,SACD,MAAO,SACX,IAAK,SACD,MAAO,SACX,IAAK,YACD,MAAO,YAEX,OAAOD,UAGLG,aAAe,uOAarB,SAASC,2BAGL,OAAO,IAAIZ,QAASC,UAChB,IAAIY,WAAa1C,QAAQC,IAAIU,uBAC7BX,QAAQC,IAAIe,OAAO0B,WAAa1B,SACxBA,OAWJc,UAVI9B,QAAQC,IAAIY,gBAAgB6B,WAAavB,MAClCA,KACCwB,OAAOC,YAAYzB,IAAK,kCAE5B,IAAI0B,UAAY7C,QAAQC,IAAIa,KAAKgC,aAAaJ,yBAC9C1C,QAAQC,IAAIgB,GAAG8B,UAAUF,UAAWL,aAAc,QAClDV,gBASpB,MAAMkB,eAAiB,WAEnB,OAAOnB,QAAQoB,IAAI,CACfjD,QAAQC,IAAI0B,qBAAqB3B,QAAQC,IAAIC,cAC7CF,QAAQC,IAAI0B,qBAAqB3B,QAAQC,IAAIG,oBAC7CJ,QAAQC,IAAI0B,qBAAqB3B,QAAQC,IAAIO,eAC7CR,QAAQC,IAAI0B,qBAAqB3B,QAAQC,IAAIS,eAC7CV,QAAQC,IAAI0B,qBAAqB3B,QAAQC,IAAIQ,cAC7CT,QAAQC,IAAI0B,qBAAqB3B,QAAQC,IAAII,mBAC7CL,QAAQC,IAAI0B,qBAAqB3B,QAAQC,IAAII,kBAAkB,QAC/DL,QAAQC,IAAI0B,qBAAqB3B,QAAQC,IAAII,kBAAkB,OAC/DoC,8BAKFS,kBAAoB,wFACX,SAASC,UACpB,IAAI5B,OAAON,KAAOM,OAAOT,OAASS,OAAOvB,QAErC,MADAuB,OAAO6B,MAAMF,mBACP,IAAIG,MAAMH,mBAGpBrD,UAAU0B,OAAON,GAAIM,OAAOT,MAC5BS,OAAO+B,+BAAiCN","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n * Acknowledgements: https://github.com/bpedro/node-fs\n *\n * This program is free software: you can redistribute it and/or modify it under\n * the terms of the GNU Affero General Public License as published by the Free\n * Software Foundation, either version 3 of the License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * See the GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License along\n * with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n// jshint ignore: start\n/*global fs, Phoenix, logger*/\n/*eslint no-console: 0*/\n/*eslint strict: [\"error\", \"global\"]*/\n\n/** Setup virtual file system. This happens before any code of phoenix is loaded.\n * The virtual file system is rooted at /\n * Application support folder that stores app data is /app/\n * Local user storage space is mounted at path /local/\n * Trash storage space is mounted at path /trash/\n *\n * This module should be functionally as light weight as possible with minimal deps as it is a shell component.\n * **/\n\nconst EXTENSION_DIR = '/fs/app/extensions/';\n\nfunction _setupVFS(fsLib, pathLib){\n    Phoenix.VFS = {\n        getRootDir: () => '/fs/',\n        getMountDir: () => '/mnt/',\n        getAppSupportDir: () => '/fs/app/',\n        getExtensionDir: () => EXTENSION_DIR,\n        getUserExtensionDir: () => `${EXTENSION_DIR}user`,\n        getDevExtensionDir: () => `${EXTENSION_DIR}dev`,\n        getLocalDir: () => '/fs/local/',\n        getTempDir: () => '/temp/',\n        getTrashDir: () => '/fs/trash/',\n        getDefaultProjectDir: () => '/fs/local/default project/',\n        getUserDocumentsDirectory: () => '/fs/local/Documents/',\n        ensureExistsDir: function (path, cb) {\n            Phoenix.VFS.exists(path, (exists) =>{\n                // We have to do the exists check explicitly here instead of only using fs.mkdir call check EEXIST code\n                // as trying to call mkdir on `/mnt/someFolder` will throw an error even if the mount point exists.\n                // mount points can only be created by the mount call.\n                if(exists){\n                    cb();\n                    return;\n                }\n                fs.mkdirs(path, 777, true, function(err) {\n                    if (err && err.code !== 'EEXIST') {\n                        cb(err);\n                    }\n                    cb();\n                });\n            });\n        },\n        /**\n         * Converts a phoenix virtual serving url to absolute path in file system or null\n         * http://localhost:8000/src/phoenix/vfs/fs/app/extensions/user/themesforbrackets/requirejs-config.json\n         * to /fs/app/extensions/user/themesforbrackets/requirejs-config.json\n         * @param fullPath\n         * @returns {string|null}\n         */\n        getPathForVirtualServingURL: function (fullPath) {\n            if(window.fsServerUrl && fullPath.startsWith(window.fsServerUrl)){\n                return fullPath.replace(window.fsServerUrl, \"/\");\n            }\n            return null;\n        },\n        ensureExistsDirAsync: async function (path) {\n            return new Promise((resolve, reject)=>{\n                Phoenix.VFS.ensureExistsDir(path, (err) =>{\n                    if(err){\n                        reject(err);\n                    } else {\n                        resolve();\n                    }\n                });\n            });\n        },\n        exists: function (path, cb) {\n            fs.stat(path, function (err, stats){\n                if (stats && !err) {\n                    cb(true);\n                } else {\n                    cb(false);\n                }\n            });\n        },\n        existsAsync: async function (path) {\n            return new Promise((resolve)=>{\n                Phoenix.VFS.exists(path, (exists) =>{\n                    resolve(exists);\n                });\n            });\n        },\n        fs: fsLib,\n        path: pathLib,\n        getFsEncoding: _getFsEncoding\n    };\n    Phoenix.fs = fsLib;\n    Phoenix.path = pathLib;\n\n    return Phoenix.VFS;\n}\n\nconst _getFsEncoding = function (encoding){\n    const encodingStr = encoding.toLowerCase();\n    switch (encodingStr){\n    case \"utf8\":\n    case \"utf-8\":\n        return \"utf8\";\n    case \"ascii\":\n        return \"ascii\";\n    case \"hex\":\n        return \"hex\";\n    case \"ucs2\":\n    case \"ucs-2\":\n        return \"ucs2\";\n    case \"utf16le\":\n    case \"utf-16le\":\n        return \"utf16le\";\n    case \"binary\":\n        return \"binary\";\n    case \"latin1\":\n        return \"latin1\";\n    case \"ISO8859-1\":\n        return \"ISO8859-1\";\n    }\n    return encoding;\n};\n\nconst _SAMPLE_HTML = `<!DOCTYPE html>\n<html>\n    <head>\n        <title>Phoenix Editor for the web</title>\n    </head>\n \n    <body>\n        <h1>Welcome to Phoenix</h1>\n        <p> Modern, Open-source, IDE For The Web.</p>\n    </body>\n</html>`;\n\n// always resolves even if error\nfunction _tryCreateDefaultProject() {\n    // Create phoenix app dirs\n    // Create Phoenix default project if it doesnt exist\n    return new Promise((resolve)=>{\n        let projectDir = Phoenix.VFS.getDefaultProjectDir();\n        Phoenix.VFS.exists(projectDir, (exists)=>{\n            if(!exists){\n                Phoenix.VFS.ensureExistsDir(projectDir, (err)=>{\n                    if(err){\n                        logger.reportError(err, \"Error creating default project\");\n                    }\n                    let indexFile = Phoenix.VFS.path.normalize(`${projectDir}/index.html`);\n                    Phoenix.VFS.fs.writeFile(indexFile, _SAMPLE_HTML, 'utf8');\n                    resolve();\n                });\n                return;\n            }\n            resolve();\n        });\n    });\n}\n\nconst _createAppDirs = function () {\n    // Create phoenix app dirs\n    return Promise.all([\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getRootDir()),\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getAppSupportDir()),\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getLocalDir()),\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getTrashDir()),\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getTempDir()),\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getExtensionDir()),\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getExtensionDir()+\"user\"),\n        Phoenix.VFS.ensureExistsDirAsync(Phoenix.VFS.getExtensionDir()+\"dev\"),\n        _tryCreateDefaultProject()\n    ]);\n};\n\n\nconst _FS_ERROR_MESSAGE = 'Oops. Phoenix could not be started due to missing file system library.';\nexport default function initVFS() {\n    if(!window.fs || !window.path || !window.Phoenix){\n        window.alert(_FS_ERROR_MESSAGE);\n        throw new Error(_FS_ERROR_MESSAGE);\n    }\n\n    _setupVFS(window.fs, window.path);\n    window._phoenixfsAppDirsCreatePromise = _createAppDirs();\n}\n\n"],"file":"init_vfs.js"}