!function(root,mod){"object"==typeof exports&&"object"==typeof module?mod(exports,require("acorn"),require("acorn-loose"),require("acorn-walk"),require("./def"),require("./signal")):"function"==typeof define&&define.amd?define(["exports","acorn/dist/acorn","acorn-loose/dist/acorn-loose","acorn-walk/dist/walk","./def","./signal"],mod):mod(root.tern||(root.tern={}),acorn,acorn.loose,acorn.walk,tern.def,tern.signal)}(this,function(exports,acorn,acorn_loose,walk,def,signal){"use strict";var toString=exports.toString=function(type,maxDepth,parent){return!type||type==parent||maxDepth&&maxDepth<-3?"?":type.toString(maxDepth,parent)},ANull=exports.ANull=signal.mixin({addType:function(){},propagate:function(){},getProp:function(){return ANull},forAllProps:function(){},hasType:function(){return!1},isEmpty:function(){return!0},getFunctionType:function(){},getObjType:function(){},getSymbolType:function(){},getType:function(){},gatherProperties:function(){},propagatesTo:function(){},typeHint:function(){},propHint:function(){},toString:function(){return"?"}});function extend(proto,props){var obj=Object.create(proto);if(props)for(var prop in props)obj[prop]=props[prop];return obj}var WG_DEFAULT=100,WG_NEW_INSTANCE=90,WG_MADEUP_PROTO=10,WG_MULTI_MEMBER=6,WG_CATCH_ERROR=6,WG_PHANTOM_OBJ=1,WG_GLOBAL_THIS=90,WG_SPECULATIVE_THIS=2,WG_SPECULATIVE_PROTO_THIS=4,AVal=exports.AVal=function(){this.types=[],this.forward=null,this.maxWeight=0};function similarAVal(a,b,depth){var typeA=a.getType(!1),typeB=b.getType(!1);return!typeA||!typeB||similarType(typeA,typeB,depth)}function similarType(a,b,depth){if(!a||depth>=5)return b;if(!a||a==b)return a;if(!b)return a;if(a.constructor!=b.constructor)return!1;if(a.constructor!=Arr){if(a.constructor==Obj){var propsA=0,propsB=0,same=0;for(var prop in a.props)propsA++,prop in b.props&&similarAVal(a.props[prop],b.props[prop],depth+1)&&same++;for(var prop in b.props)propsB++;return!(propsA&&propsB&&same<Math.max(propsA,propsB)/2)&&(propsA>propsB?a:b)}return a.constructor==Fn&&(!!(a.args.length==b.args.length&&a.args.every(function(tp,i){return similarAVal(tp,b.args[i],depth+1)})&&similarAVal(a.retval,b.retval,depth+1)&&similarAVal(a.self,b.self,depth+1))&&a)}var innerA=a.getProp("<i>").getType(!1);if(!innerA)return b;var innerB=b.getProp("<i>").getType(!1);return!innerB||similarType(innerA,innerB,depth+1)?b:void 0}AVal.prototype=extend(ANull,{addType:function(type,weight){if(weight=weight||100,this.maxWeight<weight){if(this.maxWeight=weight,1==this.types.length&&this.types[0]==type)return;this.types.length=0}else if(this.maxWeight>weight||this.types.indexOf(type)>-1)return;this.signal("addType",type),this.types.push(type);var forward=this.forward;forward&&withWorklist(function(add){for(var i=0;i<forward.length;++i)add(type,forward[i],weight)})},propagate:function(target,weight){if(!(target==ANull||target instanceof Type&&this.forward&&this.forward.length>2)){weight&&100!=weight&&(target=new Muffle(target,weight)),(this.forward||(this.forward=[])).push(target);var types=this.types;types.length&&withWorklist(function(add){for(var i=0;i<types.length;++i)add(types[i],target,weight)})}},getProp:function(prop){if(ignoredProp(prop))return ANull;var found=(this.props||(this.props=Object.create(null)))[prop];return found||(found=this.props[prop]=new AVal,this.propagate(new GetProp(prop,found))),found},forAllProps:function(c){this.propagate(new ForAllProps(c))},hasType:function(type){return this.types.indexOf(type)>-1},isEmpty:function(){return 0===this.types.length},getFunctionType:function(){for(var i=this.types.length-1;i>=0;--i)if(this.types[i]instanceof Fn)return this.types[i]},getObjType:function(){for(var seen=null,i=this.types.length-1;i>=0;--i){var type=this.types[i];if(type instanceof Obj){if(type.name)return type;seen||(seen=type)}}return seen},getSymbolType:function(){for(var i=this.types.length-1;i>=0;--i)if(this.types[i]instanceof Sym)return this.types[i]},getType:function(guess){return 0===this.types.length&&!1!==guess?this.makeupType():1===this.types.length?this.types[0]:canonicalType(this.types)},toString:function(maxDepth,parent){if(0==this.types.length)return toString(this.makeupType(),maxDepth,parent);if(1==this.types.length)return toString(this.types[0],maxDepth,parent);var simplified=simplifyTypes(this.types);return simplified.length>2?"?":simplified.map(function(tp){return toString(tp,maxDepth,parent)}).join("|")},makeupPropType:function(obj){var propName=this.propertyName,protoProp=obj.proto&&obj.proto.hasProp(propName);if(protoProp){var fromProto=protoProp.getType();if(fromProto)return fromProto}if("<i>"!=propName){var computedProp=obj.hasProp("<i>");if(computedProp)return computedProp.getType()}else if(obj.props["<i>"]!=this)for(var prop in obj.props){var val=obj.props[prop];if(!val.isEmpty())return val.getType()}},makeupType:function(){var computed=this.propertyOf&&this.makeupPropType(this.propertyOf);if(computed)return computed;if(!this.forward)return null;for(var i=this.forward.length-1;i>=0;--i){var hint=this.forward[i].typeHint();if(hint&&!hint.isEmpty())return guessing=!0,hint}for(var props=Object.create(null),foundProp=null,i=0;i<this.forward.length;++i){var prop;(prop=this.forward[i].propHint())&&"length"!=prop&&"<i>"!=prop&&"âœ–"!=prop&&prop!=cx.completingProperty&&(props[prop]=!0,foundProp=prop)}if(!foundProp)return null;var objs=objsWithProp(foundProp);if(objs){var matches=[];search:for(var i=0;i<objs.length;++i){var obj=objs[i];for(var prop in props)if(!obj.hasProp(prop))continue search;obj.hasCtor&&(obj=getInstance(obj)),matches.push(obj)}var canon=canonicalType(matches);if(canon)return guessing=!0,canon}},typeHint:function(){return this.types.length?this.getType():null},propagatesTo:function(){return this},gatherProperties:function(f,depth){for(var i=0;i<this.types.length;++i)this.types[i].gatherProperties(f,depth)},guessProperties:function(f){if(this.forward)for(var i=0;i<this.forward.length;++i){var prop=this.forward[i].propHint();prop&&f(prop,null,0)}var guessed=this.makeupType();guessed&&guessed.gatherProperties(f)}});var simplifyTypes=exports.simplifyTypes=function(types){var found=[];outer:for(var i=0;i<types.length;++i){for(var tp=types[i],j=0;j<found.length;j++){var similar=similarType(tp,found[j],0);if(similar){found[j]=similar;continue outer}}found.push(tp)}return found};function canonicalType(types){for(var arrays=0,fns=0,objs=0,prim=null,i=0;i<types.length;++i){var tp;if((tp=types[i])instanceof Arr)++arrays;else if(tp instanceof Fn)++fns;else if(tp instanceof Obj)++objs;else if(tp instanceof Prim){if(prim&&tp.name!=prim.name)return null;prim=tp}}var kinds;if((arrays&&1)+(fns&&1)+(objs&&1)+(prim&&1)>1)return null;if(prim)return prim;for(var maxScore=0,maxTp=null,i=0;i<types.length;++i){var tp=types[i],score=0;if(arrays)score=tp.getProp("<i>").isEmpty()?1:2;else if(fns){score=1;for(var j=0;j<tp.args.length;++j)tp.args[j].isEmpty()||++score;tp.retval.isEmpty()||++score}else objs&&(score=tp.name?100:2);score>=maxScore&&(maxScore=score,maxTp=tp)}return maxTp}var constraint=exports.constraint=function(methods){var ctor=function(){this.origin=cx.curOrigin,this.construct.apply(this,arguments)};for(var m in ctor.prototype=Object.create(ANull),methods)methods.hasOwnProperty(m)&&(ctor.prototype[m]=methods[m]);return ctor},GetProp=constraint({construct:function(prop,target){this.prop=prop,this.target=target},addType:function(type,weight){type.getProp&&type.getProp(this.prop).propagate(this.target,weight)},propHint:function(){return this.prop},propagatesTo:function(){if("<i>"==this.prop||!/[^\w_]/.test(this.prop))return{target:this.target,pathExt:"."+this.prop}}}),DefProp=exports.PropHasSubset=exports.DefProp=constraint({construct:function(prop,type,originNode){this.prop=prop,this.type=type,this.originNode=originNode},addType:function(type,weight){if(type instanceof Obj){var prop=type.defProp(this.prop,this.originNode);prop.origin||(prop.origin=this.origin),this.type.propagate(prop,weight)}},propHint:function(){return this.prop}}),ForAllProps=constraint({construct:function(c){this.c=c},addType:function(type){type instanceof Obj&&type.forAllProps(this.c)}});function withDisabledComputing(fn,body){cx.disabledComputing={fn:fn,prev:cx.disabledComputing};var result=body();return cx.disabledComputing=cx.disabledComputing.prev,result}var IsCallee=exports.IsCallee=constraint({construct:function(self,args,argNodes,retval){this.self=self,this.args=args,this.argNodes=argNodes,this.retval=retval,this.disabled=cx.disabledComputing},addType:function(fn,weight){if(fn instanceof Fn){for(var i=0;i<this.args.length;++i)i<fn.args.length&&this.args[i].propagate(fn.args[i],weight),fn.arguments&&this.args[i].propagate(fn.arguments,weight);fn.isArrowFn()||this.self.propagate(fn.self,this.self==cx.topScope?90:weight);var compute=fn.computeRet,result=fn.retval;if(compute)for(var d=this.disabled;d;d=d.prev)(d.fn==fn||fn.originNode&&d.fn.originNode==fn.originNode)&&(compute=null);if(compute){var old=cx.disabledComputing;cx.disabledComputing=this.disabled,result=compute(this.self,this.args,this.argNodes),cx.disabledComputing=old}if(fn.async&&!fn.generator){var tp=result.getType();if(!tp||tp.constructor!=Obj||"Promise"!=tp.name){var defs=cx.definitions.ecmascript,rtnval=defs&&new Obj(defs["Promise.prototype"]);rtnval&&(rtnval.getType().propagate(new DefProp(":t",result)),result=rtnval)}}maybeIterator(fn,result).propagate(this.retval,weight)}},typeHint:function(){for(var names=[],i=0;i<this.args.length;++i)names.push("?");return new Fn(null,this.self,this.args,names,ANull)},propagatesTo:function(){return{target:this.retval,pathExt:".!ret"}}}),HasMethodCall=constraint({construct:function(propName,args,argNodes,retval){this.propName=propName,this.args=args,this.argNodes=argNodes,this.retval=retval,this.disabled=cx.disabledComputing},addType:function(obj,weight){var callee=new IsCallee(obj,this.args,this.argNodes,this.retval);callee.disabled=this.disabled,obj.getProp(this.propName).propagate(callee,weight)},propHint:function(){return this.propName}}),IsCtor=exports.IsCtor=constraint({construct:function(target,noReuse){this.target=target,this.noReuse=noReuse},addType:function(f,weight){f instanceof Fn&&(cx.parent&&!cx.parent.options.reuseInstances&&(this.noReuse=!0),f.getProp("prototype").propagate(new IsProto(!this.noReuse&&f,this.target),weight))}}),getInstance=exports.getInstance=function(obj,ctor){if(!1===ctor)return new Obj(obj);ctor||(ctor=obj.hasCtor),obj.instances||(obj.instances=[]);for(var i=0;i<obj.instances.length;++i){var cur=obj.instances[i];if(cur.ctor==ctor)return cur.instance}var instance=new Obj(obj,ctor&&ctor.name);return instance.origin=obj.origin,obj.instances.push({ctor:ctor,instance:instance}),instance},IsProto=exports.IsProto=constraint({construct:function(ctor,target){this.ctor=ctor,this.target=target},addType:function(o,_weight){o instanceof Obj&&((this.count=(this.count||0)+1)>8||(o==cx.protos.Array?this.target.addType(new Arr):this.target.addType(getInstance(o,this.ctor))))}}),FnPrototype=constraint({construct:function(fn){this.fn=fn},addType:function(o,_weight){if(o instanceof Obj&&!o.hasCtor){o.hasCtor=this.fn;var adder=new SpeculativeThis(o,this.fn);adder.addType(this.fn),o.forAllProps(function(_prop,val,local){local&&val.propagate(adder)})}}}),IsAdded=constraint({construct:function(other,target){this.other=other,this.target=target},addType:function(type,weight){type==cx.str?this.target.addType(cx.str,weight):type==cx.num&&this.other.hasType(cx.num)&&this.target.addType(cx.num,weight)},typeHint:function(){return this.other}}),IfObj=exports.IfObj=constraint({construct:function(target){this.target=target},addType:function(t,weight){t instanceof Obj&&this.target.addType(t,weight)},propagatesTo:function(){return this.target}}),SpeculativeThis=constraint({construct:function(obj,ctor){this.obj=obj,this.ctor=ctor},addType:function(tp){tp instanceof Fn&&tp.self&&tp.self.addType(getInstance(this.obj,this.ctor),4)}}),HasProto=constraint({construct:function(obj){this.obj=obj},addType:function(tp){tp instanceof Obj&&this.obj.proto==cx.protos.Object&&this.obj.replaceProto(tp)}}),Muffle=constraint({construct:function(inner,weight){this.inner=inner,this.weight=weight},addType:function(tp,weight){this.inner.addType(tp,Math.min(weight,this.weight))},propagatesTo:function(){return this.inner.propagatesTo()},typeHint:function(){return this.inner.typeHint()},propHint:function(){return this.inner.propHint()}}),Type=exports.Type=function(){};Type.prototype=extend(ANull,{constructor:Type,propagate:function(c,w){c.addType(this,w)},hasType:function(other){return other==this},isEmpty:function(){return!1},typeHint:function(){return this},getType:function(){return this}});var Prim=exports.Prim=function(proto,name){this.name=name,this.proto=proto};function isInteger(str){var c0=str.charCodeAt(0);return c0>=48&&c0<=57&&!/\D/.test(str)}Prim.prototype=extend(Type.prototype,{constructor:Prim,toString:function(){return this.name},getProp:function(prop){return this.proto.hasProp(prop)||ANull},gatherProperties:function(f,depth){this.proto&&this.proto.gatherProperties(f,depth)}});var Obj=exports.Obj=function(proto,name){if(this.props||(this.props=Object.create(null)),this.proto=!0===proto?cx.protos.Object:proto,proto&&proto!=cx.protos.Object&&!name&&proto.name&&!(this instanceof Fn)){var match=/^(.*)\.prototype$/.exec(this.proto.name);match&&(name=match[1])}this.name=name,this.maybeProps=null,this.origin=cx.curOrigin};Obj.prototype=extend(Type.prototype,{constructor:Obj,toString:function(maxDepth){if(null==maxDepth&&(maxDepth=0),maxDepth<=0&&this.name)return this.name;var props=[],etc=!1;for(var prop in this.props)if("<i>"!=prop){if(props.length>5){etc=!0;break}maxDepth?props.push(prop+": "+toString(this.props[prop],maxDepth-1,this)):props.push(prop)}return props.sort(),etc&&props.push("..."),"{"+props.join(", ")+"}"},hasProp:function(prop,searchProto){isInteger(prop)&&(prop=this.normalizeIntegerProp(prop));var found=this.props[prop];if(!1!==searchProto)for(var p=this.proto;p&&!found;p=p.proto)found=p.props[prop];return found},defProp:function(prop,originNode){var found=this.hasProp(prop,!1);if(found)return originNode&&!found.originNode&&(found.originNode=originNode),found;if(ignoredProp(prop))return ANull;isInteger(prop)&&(prop=this.normalizeIntegerProp(prop));var av=this.maybeProps&&this.maybeProps[prop];return av?(delete this.maybeProps[prop],this.maybeUnregProtoPropHandler()):((av=new AVal).propertyOf=this,av.propertyName=prop),this.props[prop]=av,av.originNode=originNode,av.origin=cx.curOrigin,this.broadcastProp(prop,av,!0),av},getProp:function(prop){var found=this.hasProp(prop,!0)||this.maybeProps&&this.maybeProps[prop];if(found)return found;if(ignoredProp(prop))return ANull;isInteger(prop)&&(prop=this.normalizeIntegerProp(prop));var av=this.ensureMaybeProps()[prop]=new AVal;return av.propertyOf=this,av.propertyName=prop,av},normalizeIntegerProp:function(_){return"<i>"},broadcastProp:function(prop,val,local){if(local&&(this.signal("addProp",prop,val),this instanceof Scope||registerProp(prop,this)),this.onNewProp)for(var i=0;i<this.onNewProp.length;++i){var h=this.onNewProp[i];h.onProtoProp?h.onProtoProp(prop,val,local):h(prop,val,local)}},onProtoProp:function(prop,val,_local){var maybe=this.maybeProps&&this.maybeProps[prop];maybe&&(delete this.maybeProps[prop],this.maybeUnregProtoPropHandler(),this.proto.getProp(prop).propagate(maybe)),this.broadcastProp(prop,val,!1)},replaceProto:function(proto){for(var o=proto;o;o=o.proto)if(o==this)return;this.proto&&this.maybeProps&&this.proto.unregPropHandler(this),this.proto=proto,this.maybeProps&&this.proto.forAllProps(this)},ensureMaybeProps:function(){return this.maybeProps||(this.proto&&this.proto.forAllProps(this),this.maybeProps=Object.create(null)),this.maybeProps},removeProp:function(prop){var av=this.props[prop];delete this.props[prop],this.ensureMaybeProps()[prop]=av,av.types.length=0},forAllProps:function(c){this.onNewProp||(this.onNewProp=[],this.proto&&this.proto.forAllProps(this)),this.onNewProp.push(c);for(var o=this;o;o=o.proto)for(var prop in o.props)c.onProtoProp?c.onProtoProp(prop,o.props[prop],o==this):c(prop,o.props[prop],o==this)},maybeUnregProtoPropHandler:function(){if(this.maybeProps){for(var _n in this.maybeProps)return;this.maybeProps=null}!this.proto||this.onNewProp&&this.onNewProp.length||this.proto.unregPropHandler(this)},unregPropHandler:function(handler){for(var i=0;i<this.onNewProp.length;++i)if(this.onNewProp[i]==handler){this.onNewProp.splice(i,1);break}this.maybeUnregProtoPropHandler()},gatherProperties:function(f,depth){for(var prop in this.props)"<i>"!=prop&&":"!=prop.charAt(0)&&f(prop,this,depth);this.proto&&this.proto.gatherProperties(f,depth+1)},getObjType:function(){return this}});var geckoIterators="undefined"!=typeof StopIteration;function ignoredProp(name){return"__proto__"==name||"âœ–"==name||geckoIterators&&"__iterator__"==name}var Fn=exports.Fn=function(name,self,args,argNames,retval,generator,async){Obj.call(this,cx.protos.Function,name),this.self=self,this.args=args,this.argNames=argNames,this.retval=retval,this.generator=generator,this.async=async};Fn.prototype=extend(Obj.prototype,{constructor:Fn,toString:function(maxDepth){null==maxDepth&&(maxDepth=0);for(var str=this.generator?"fn*(":"fn(",i=0;i<this.args.length;++i){i&&(str+=", ");var name=this.argNames[i];name&&"?"!=name&&(str+=name+": "),str+=maxDepth>-3?toString(this.args[i],maxDepth-1,this):"?"}return str+=")",this.retval.isEmpty()||(str+=" -> "+(maxDepth>-3?toString(this.retval,maxDepth-1,this):"?")),str},getProp:function(prop){if("prototype"==prop){var known=this.hasProp(prop,!1);if(!known){known=this.defProp(prop);var proto=new Obj(!0,this.name&&this.name+".prototype");proto.origin=this.origin,known.addType(proto,10)}return known}return Obj.prototype.getProp.call(this,prop)},defProp:function(prop,originNode){if("prototype"==prop){var found=this.hasProp(prop,!1);return found||((found=Obj.prototype.defProp.call(this,prop,originNode)).origin=this.origin,found.propagate(new FnPrototype(this)),found)}return Obj.prototype.defProp.call(this,prop,originNode)},getFunctionType:function(){return this},isArrowFn:function(){return this.originNode&&"ArrowFunctionExpression"==this.originNode.type}});var Arr=exports.Arr=function(contentType){Obj.call(this,cx.protos.Array);var content=this.defProp("<i>");if(Array.isArray(contentType)){this.tuple=contentType.length;for(var i=0;i<contentType.length;i++){var prop=this.defProp(String(i));contentType[i].propagate(prop),prop.propagate(content)}}else contentType&&(this.tuple=0,contentType.propagate(content))};Arr.prototype=extend(Obj.prototype,{constructor:Arr,toString:function(maxDepth){if(null==maxDepth&&(maxDepth=0),maxDepth<=-3)return"[?]";var content="";if(this.tuple){for(var similar,i=0;i in this.props;i++){var type=toString(this.getProp(String(i)),maxDepth-1,this);similar=null==similar?type:similar==type&&type,content+=(content?", ":"")+type}similar&&(content=similar)}else content=toString(this.getProp("<i>"),maxDepth-1,this);return"["+content+"]"},normalizeIntegerProp:function(prop){return+prop<this.tuple?prop:"<i>"}});var Sym=exports.Sym=function(name,originNode){Prim.call(this,cx.protos.Symbol,"Symbol"),this.symName=name,this.originNode=originNode};function registerProp(prop,obj){var data;(cx.props[prop]||(cx.props[prop]=[])).push(obj)}function objsWithProp(prop){return cx.props[prop]}Sym.prototype=extend(Prim.prototype,{constructor:Sym,asPropName:function(){return":"+this.symName},getSymbolType:function(){return this}}),exports.getSymbol=function(name,originNode){var cleanName=name.replace(/[^\w$\.]/g,"_"),known=cx.symbols[cleanName];return known?(originNode&&!known.originNode&&(known.originNode=originNode),known):cx.symbols[cleanName]=new Sym(cleanName,originNode)},exports.Context=function(defs,parent){this.parent=parent,this.props=Object.create(null),this.protos=Object.create(null),this.origins=[],this.curOrigin="ecmascript",this.paths=Object.create(null),this.definitions=Object.create(null),this.purgeGen=0,this.workList=null,this.disabledComputing=null,this.curSuperCtor=this.curSuper=null,this.symbols=Object.create(null),exports.withContext(this,function(){if(cx.protos.Object=new Obj(null,"Object.prototype"),cx.topScope=new Scope,cx.topScope.name="<top>",cx.protos.Array=new Obj(!0,"Array.prototype"),cx.protos.Function=new Fn("Function.prototype",ANull,[],[],ANull),cx.protos.Function.proto=cx.protos.Object,cx.protos.RegExp=new Obj(!0,"RegExp.prototype"),cx.protos.String=new Obj(!0,"String.prototype"),cx.protos.Number=new Obj(!0,"Number.prototype"),cx.protos.Boolean=new Obj(!0,"Boolean.prototype"),cx.protos.Symbol=new Obj(!0,"Symbol.prototype"),cx.str=new Prim(cx.protos.String,"string"),cx.bool=new Prim(cx.protos.Boolean,"bool"),cx.num=new Prim(cx.protos.Number,"number"),cx.curOrigin=null,defs)for(var i=0;i<defs.length;++i)def.load(defs[i])})},exports.Context.prototype.startAnalysis=function(){this.disabledComputing=this.workList=this.curSuperCtor=this.curSuper=null};var cx=null,timeout;exports.cx=function(){return cx},exports.withContext=function(context,f){var old=cx;cx=context;try{return f()}finally{cx=old}},exports.TimedOut=function(){this.message="Timed out",this.stack=(new Error).stack},exports.TimedOut.prototype=Object.create(Error.prototype),exports.TimedOut.prototype.name="infer.TimedOut",exports.withTimeout=function(ms,f){var end=+new Date+ms,oldEnd=timeout;if(oldEnd&&oldEnd<end)return f();timeout=end;try{return f()}finally{timeout=oldEnd}},exports.addOrigin=function(origin){cx.origins.indexOf(origin)<0&&cx.origins.push(origin)};var baseMaxWorkDepth=20,reduceMaxWorkDepth=1e-4;function withWorklist(f){if(cx.workList)return f(cx.workList);for(var list=[],depth=0,add,ret=f(cx.workList=function(type,target,weight){depth<baseMaxWorkDepth-reduceMaxWorkDepth*list.length&&list.push(type,target,weight,depth)}),i=0;i<list.length;i+=4){if(timeout&&+new Date>=timeout)throw new exports.TimedOut;depth=list[i+3]+1,list[i+1].addType(list[i],list[i+2])}return cx.workList=null,ret}function withSuper(ctor,obj,f){var oldCtor=cx.curSuperCtor,oldObj=cx.curSuper;cx.curSuperCtor=ctor,cx.curSuper=obj;var result=f();return cx.curSuperCtor=oldCtor,cx.curSuper=oldObj,result}var Scope=exports.Scope=function(prev,originNode,isBlock,isCatch){Obj.call(this,prev||!0),this.prev=prev,this.originNode=originNode,this.isBlock=!!isBlock,this.isCatch=!!isCatch};function functionScope(scope,arrow){for(;scope.isBlock||scope.isCatch||!1===arrow&&scope.fnType&&scope.fnType.isArrowFn();)scope=scope.prev;return scope}function maybeInstantiate(scope,score){var fn=functionScope(scope).fnType;fn&&(fn.instantiateScore=(fn.instantiateScore||0)+score)}Scope.prototype=extend(Obj.prototype,{constructor:Scope,defVar:function(name,originNode){for(var s=this;;s=s.proto){var found=s.props[name];if(found)return found;if(!s.prev)return s.defProp(name,originNode)}}});var NotSmaller={};function nodeSmallerThan(node,n){try{return walk.simple(node,{Expression:function(){if(--n<=0)throw NotSmaller}}),!0}catch(e){if(e==NotSmaller)return!1;throw e}}function maybeTagAsInstantiated(node,fn){var score=fn.instantiateScore;if(!cx.disabledComputing&&score&&fn.args.length&&nodeSmallerThan(node,5*score))return maybeInstantiate(functionScope(fn.originNode.scope.prev),score/2),setFunctionInstantiated(node,fn),!0;fn.instantiateScore=null}function setFunctionInstantiated(node,fn){for(var refScope=node.scope,i=0;i<fn.args.length;++i)fn.args[i]=new AVal;fn.self=new AVal,fn.computeRet=function(self,args){return withDisabledComputing(fn,function(){var oldOrigin=cx.curOrigin;cx.curOrigin=fn.origin;var scope=node.scope?node.scope:refScope,scopeCopy=new Scope(scope.prev,scope.originNode);for(var v in scope.props)for(var local=scopeCopy.defProp(v,scope.props[v].originNode),i=0;i<args.length;++i)fn.argNames[i]==v&&i<args.length&&args[i].propagate(local);for(var argNames=fn.argNames.length!=args.length?fn.argNames.slice(0,args.length):fn.argNames;argNames.length<args.length;)argNames.push("?");if(scopeCopy.fnType=new Fn(fn.name,self,args,argNames,ANull,fn.generator,fn.async),scopeCopy.fnType.originNode=fn.originNode,fn.arguments){var argset=scopeCopy.fnType.arguments=new AVal;scopeCopy.defProp("arguments").addType(new Arr(argset));for(var i=0;i<args.length;++i)args[i].propagate(argset)}return node.scope=scopeCopy,walk.recursive(node.body,scopeCopy,null,scopeGatherer),walk.recursive(node.body,scopeCopy,null,inferWrapper),cx.curOrigin=oldOrigin,scopeCopy.fnType.retval})}}function maybeTagAsGeneric(fn){var target=fn.retval;if(target!=ANull&&!fn.isArrowFn()){var targetInner,asArray;!target.isEmpty()&&(targetInner=target.getType())instanceof Arr&&(target=asArray=targetInner.getProp("<i>"));for(var foundPath=explore(fn.self,"!this",0),i=0;!foundPath&&i<fn.args.length;++i)foundPath=explore(fn.args[i],"!"+i,0);if(foundPath){asArray&&(foundPath="["+foundPath+"]");var p,parsed=new def.TypeParser(foundPath).parseType(!0);return fn.computeRet=parsed.apply?parsed:function(){return parsed},fn.computeRetSource=foundPath,!0}}function explore(aval,path,depth){if(!(depth>3)&&aval.forward)for(var i=0;i<aval.forward.length;++i){var prop=aval.forward[i].propagatesTo();if(prop){var newPath=path,dest;if(prop instanceof AVal)dest=prop;else{if(!(prop.target instanceof AVal))continue;newPath+=prop.pathExt,dest=prop.target}if(dest==target)return newPath;var found=explore(dest,newPath,depth+1);if(found)return found}}}}function addVar(scope,nameNode){return scope.defProp(nameNode.name,nameNode)}function patternName(node){return"Identifier"==node.type?node.name:"AssignmentPattern"==node.type?patternName(node.left):"ObjectPattern"==node.type?"{"+node.properties.map(function(e){return patternName("RestElement"===e.type?e:e.value)}).join(", ")+"}":"ArrayPattern"==node.type?"["+node.elements.map(function(e){return e?patternName(e):""}).join(", ")+"]":"RestElement"==node.type?"..."+patternName(node.argument):"_"}function isBlockScopedDecl(node){return"VariableDeclaration"==node.type&&"var"!=node.kind||"FunctionDeclaration"==node.type||"ClassDeclaration"==node.type}function patternScopes(inner,outer){return{inner:inner,outer:outer||inner}}var scopeGatherer=exports.scopeGatherer=walk.make({VariablePattern:function(node,scopes){scopes.inner&&addVar(scopes.inner,node)},AssignmentPattern:function(node,scopes,c){c(node.left,scopes,"Pattern"),c(node.right,scopes.outer,"Expression")},AssignmentExpression:function(node,scope,c){"MemberExpression"==node.left.type?c(node.left,scope,"Expression"):c(node.left,patternScopes(!1,scope),"Pattern"),c(node.right,scope,"Expression")},MemberPattern:function(node,scope,c){c(node,scope.outer)},Function:function(node,scope,c){for(var inner=node.scope=new Scope(scope,node),argVals=[],argNames=[],i=0,decl;i<node.params.length;++i){var param=node.params[i];if(argNames.push(patternName(param)),"Identifier"==param.type)argVals.push(addVar(inner,param));else{var arg=new AVal;argVals.push(arg),arg.originNode=param,c(param,patternScopes(inner),"Pattern")}}(inner.fnType=new Fn(node.id&&node.id.name,new AVal,argVals,argNames,ANull,node.generator,node.async),inner.fnType.originNode=node,node.id)&&addVar("FunctionDeclaration"==node.type?scope:inner,node.id);c(node.body,inner,node.expression?"Expression":"Statement")},BlockStatement:function(node,scope,c){!node.scope&&node.body.some(isBlockScopedDecl)&&(scope=node.scope=new Scope(scope,node,!0)),walk.base.BlockStatement(node,scope,c)},CatchClause:function(node,scope,c){if(node.param)if(scope=node.scope=new Scope(scope,node,!1,!0),"Identifier"==node.param.type){var v=addVar(scope,node.param);c(node.body,scope,"Statement");var ecma=cx.definitions.ecmascript;ecma&&v.isEmpty()&&getInstance(ecma["Error.prototype"]).propagate(v,6)}else c(node.param,patternScopes(scope),"Pattern")},VariableDeclaration:function(node,scope,c){for(var targetScope="var"==node.kind?functionScope(scope):scope,i=0;i<node.declarations.length;++i){var decl=node.declarations[i];c(decl.id,patternScopes(targetScope,scope),"Pattern"),decl.init&&c(decl.init,scope,"Expression")}},ClassDeclaration:function(node,scope,c){node.id&&addVar(scope,node.id),node.superClass&&c(node.superClass,scope,"Expression");for(var i=0;i<node.body.body.length;i++)c(node.body.body[i],scope)},ForInStatement:function(node,scope,c){!node.scope&&isBlockScopedDecl(node.left)&&(scope=node.scope=new Scope(scope,node,!0)),walk.base.ForInStatement(node,scope,c)},ForStatement:function(node,scope,c){!node.scope&&node.init&&isBlockScopedDecl(node.init)&&(scope=node.scope=new Scope(scope,node,!0)),walk.base.ForStatement(node,scope,c)},ImportDeclaration:function(node,scope){for(var i=0;i<node.specifiers.length;i++)addVar(scope,node.specifiers[i].local)}});function rmScope(node){node.scope&&(node.scope=null)}scopeGatherer.ForOfStatement=scopeGatherer.ForInStatement;var scopeClearer={BlockStatement:rmScope,Function:rmScope,CatchClause:rmScope,ForInStateMent:rmScope,ForStatement:rmScope};exports.clearScopes=function(ast){walk.simple(ast,scopeClearer)};var propName=exports.propName=function(node,inferInScope){var key=node.property||node.key;if(!node.computed&&"Identifier"==key.type)return key.name;if("Literal"==key.type){if("string"==typeof key.value)return key.value;if("number"==typeof key.value)return String(key.value)}if(inferInScope){var symName=symbolName(infer(key,inferInScope));if(symName)return node.propName=symName}else if(node.propName)return node.propName;return"<i>"};function symbolName(val){var sym=val.getSymbolType();if(sym)return sym.asPropName()}function unopResultType(op){switch(op){case"+":case"-":case"~":return cx.num;case"!":return cx.bool;case"typeof":return cx.str;case"void":case"delete":return ANull}}function binopIsBoolean(op){switch(op){case"==":case"!=":case"===":case"!==":case"<":case">":case">=":case"<=":case"in":case"instanceof":return!0}}function literalType(node){if(node.regex)return getInstance(cx.protos.RegExp);switch(typeof node.value){case"boolean":return cx.bool;case"number":return cx.num;case"string":return cx.str;case"object":case"function":return node.value?getInstance(cx.protos.RegExp):ANull}}function join(a,b){if(a==b||b==ANull)return a;if(a==ANull)return b;var joined=new AVal;return a.propagate(joined),b.propagate(joined),joined}function connectParams(node,scope){for(var i=0;i<node.params.length;i++){var param=node.params[i];"Identifier"!=param.type&&connectPattern(param,scope,node.scope.fnType.args[i])}}function ensureVar(node,scope){return scope.hasProp(node.name)||cx.topScope.defProp(node.name,node)}var inferPatternVisitor=exports.inferPatternVisitor={Identifier:function(node,scope,source){source.propagate(ensureVar(node,scope))},MemberExpression:function(node,scope,source){var obj=infer(node.object,scope),pName=propName(node,scope);obj.propagate(new DefProp(pName,source,node.property))},RestElement:function(node,scope,source){connectPattern(node.argument,scope,new Arr(source))},ObjectPattern:function(node,scope,source){for(var i=0;i<node.properties.length;++i){var prop=node.properties[i];"RestElement"!=prop.type&&connectPattern(prop.value,scope,source.getProp(propName(prop)))}},ArrayPattern:function(node,scope,source){for(var i=0;i<node.elements.length;i++)node.elements[i]&&connectPattern(node.elements[i],scope,source.getProp(String(i)))},AssignmentPattern:function(node,scope,source){connectPattern(node.left,scope,join(source,infer(node.right,scope)))}};function connectPattern(node,scope,source){var connecter=inferPatternVisitor[node.type];connecter&&connecter(node,scope,source)}function getThis(scope){var fnScope=functionScope(scope);return fnScope.fnType?fnScope.fnType.self:fnScope}function maybeAddPhantomObj(obj){obj.isEmpty()&&obj.propertyOf&&(obj.propertyOf.getProp(obj.propertyName).addType(new Obj,WG_PHANTOM_OBJ),maybeAddPhantomObj(obj.propertyOf))}function inferClass(node,scope,name){!name&&node.id&&(name=node.id.name);var sup=cx.protos.Object,supCtor,delayed;if(node.superClass)if("Literal"==node.superClass.type&&null==node.superClass.value)sup=null;else{var supVal=infer(node.superClass,scope),supProto;(supCtor=supVal.getFunctionType())&&(supProto=supCtor.getProp("prototype").getObjType())?sup=supProto:(supCtor=supVal,delayed=supVal.getProp("prototype"))}var proto=new Obj(sup,name&&name+".prototype");return delayed&&delayed.propagate(new HasProto(proto)),withSuper(supCtor,delayed||sup,function(){for(var ctor,body=node.body.body,i=0;i<body.length;i++)"constructor"==body[i].kind&&(ctor=body[i].value);var fn=node.objType=ctor?infer(ctor,scope):new Fn(name,ANull,[],null,ANull);fn.originNode=node.id||ctor||node;var inst=getInstance(proto,fn);fn.self.addType(inst),fn.defProp("prototype",node).addType(proto);for(var i=0;i<body.length;i++){var method=body[i],target;if("constructor"!=method.kind){var pName=propName(method,scope);"<i>"==pName||"set"==method.kind?target=ANull:((target=(method.static?fn:proto).defProp(pName,method.key)).initializer=!0,"get"==method.kind&&(target=new IsCallee(inst,[],null,target))),infer(method.value,scope,target);var methodFn=target.getFunctionType();methodFn&&methodFn.self.addType(inst)}}return fn})}function arrayLiteralType(elements,scope,inner){var tuple=elements.length>1&&elements.length<6;if(tuple){for(var homogenous=!0,litType,i=0;i<elements.length;i++){var elt=elements[i];elt?"Literal"!=elt.type||litType&&litType!=typeof elt.value?homogenous=!1:litType=typeof elt.value:tuple=!1}homogenous&&(tuple=!1)}if(tuple){for(var types=[],i=0;i<elements.length;++i)types.push(inner(elements[i],scope));return new Arr(types)}if(elements.length<2)return new Arr(elements[0]&&inner(elements[0],scope));for(var eltVal=new AVal,i=0;i<elements.length;i++)elements[i]&&inner(elements[i],scope).propagate(eltVal);return new Arr(eltVal)}function ret(f){return function(node,scope,out,name){var r=f(node,scope,name);return out&&r.propagate(out),r}}function fill(f){return function(node,scope,out,name){return out||(out=new AVal),f(node,scope,out,name),out}}var inferExprVisitor=exports.inferExprVisitor={ArrayExpression:ret(function(node,scope){return arrayLiteralType(node.elements,scope,infer)}),ObjectExpression:ret(function(node,scope,name){for(var proto=cx.protos.Object,waitForProto,i=0;i<node.properties.length;++i){var prop=node.properties[i];if("SpreadElement"!=prop.type&&"__proto__"==prop.key.name)if("Literal"==prop.value.type&&null==prop.value.value)proto=null;else{var protoVal=infer(prop.value,scope),known=protoVal.getObjType();known?proto=known:waitForProto=protoVal}}var obj=node.objType=new Obj(proto,name);return waitForProto&&waitForProto.propagate(new HasProto(obj)),obj.originNode=node,withSuper(null,waitForProto||proto,function(){for(var i=0;i<node.properties.length;++i){var prop=node.properties[i],key=prop.key;if("SpreadElement"!=prop.type&&!ignoredProp(prop.key.name)){var name=propName(prop,scope),target;if("<i>"==name||"set"==prop.kind)target=ANull;else{var val=target=obj.defProp(name,key);val.initializer=!0,"get"==prop.kind&&(target=new IsCallee(obj,[],null,val))}infer(prop.value,scope,target,name),"FunctionExpression"==prop.value.type&&prop.value.scope.fnType.self.addType(obj,2)}}}),obj}),FunctionExpression:ret(function(node,scope,name){var inner=node.scope,fn=inner.fnType;return name&&!fn.name&&(fn.name=name),connectParams(node,inner),node.expression?infer(node.body,inner,inner.fnType.retval=new AVal):walk.recursive(node.body,inner,null,inferWrapper,"Statement"),"ArrowFunctionExpression"==node.type&&getThis(scope).propagate(fn.self),maybeTagAsInstantiated(node,fn)||maybeTagAsGeneric(fn),node.id&&inner.getProp(node.id.name).addType(fn),fn}),ClassExpression:ret(inferClass),SequenceExpression:ret(function(node,scope){for(var i=0,l=node.expressions.length-1;i<l;++i)infer(node.expressions[i],scope,ANull);return infer(node.expressions[l],scope)}),UnaryExpression:ret(function(node,scope){return infer(node.argument,scope,ANull),unopResultType(node.operator)}),UpdateExpression:ret(function(node,scope){return infer(node.argument,scope,ANull),cx.num}),BinaryExpression:ret(function(node,scope){if("+"==node.operator){var lhs=infer(node.left,scope),rhs=infer(node.right,scope);if(lhs.hasType(cx.str)||rhs.hasType(cx.str))return cx.str;if(lhs.hasType(cx.num)&&rhs.hasType(cx.num))return cx.num;var result=new AVal;return lhs.propagate(new IsAdded(rhs,result)),rhs.propagate(new IsAdded(lhs,result)),result}return infer(node.left,scope,ANull),infer(node.right,scope,ANull),binopIsBoolean(node.operator)?cx.bool:cx.num}),AssignmentExpression:ret(function(node,scope,name){var rhs,pName;if("MemberExpression"==node.left.type?(pName=propName(node.left,scope),name||(name="Identifier"==node.left.object.type?node.left.object.name+"."+pName:pName)):name||"Identifier"!=node.left.type||(name=node.left.name),node.operator&&"="!=node.operator&&"+="!=node.operator?(infer(node.right,scope,ANull),rhs=cx.num):rhs=infer(node.right,scope,null,name),"MemberExpression"==node.left.type){var obj=infer(node.left.object,scope);if("prototype"==pName&&maybeInstantiate(scope,20),"<i>"==pName){var v=node.left.property.name,local=scope.props[v],over=local&&local.iteratesOver;if(over){maybeInstantiate(scope,20);var fromRight="MemberExpression"==node.right.type&&node.right.computed&&node.right.property.name==v;return over.forAllProps(function(prop,val,local){local&&"prototype"!=prop&&"<i>"!=prop&&obj.propagate(new DefProp(prop,fromRight?val:ANull))}),rhs}}obj.propagate(new DefProp(pName,rhs,node.left.property)),maybeAddPhantomObj(obj),"FunctionExpression"==node.right.type&&obj.propagate(node.right.scope.fnType.self,2)}else connectPattern(node.left,scope,rhs);return rhs}),LogicalExpression:fill(function(node,scope,out){infer(node.left,scope,out),infer(node.right,scope,out)}),ConditionalExpression:fill(function(node,scope,out){infer(node.test,scope,ANull),infer(node.consequent,scope,out),infer(node.alternate,scope,out)}),NewExpression:fill(function(node,scope,out,name){"Identifier"==node.callee.type&&node.callee.name in scope.props&&maybeInstantiate(scope,20);for(var i=0,args=[];i<node.arguments.length;++i)args.push(infer(node.arguments[i],scope));var callee=infer(node.callee,scope),self=new AVal;callee.propagate(new IsCtor(self,name&&/\.prototype$/.test(name))),self.propagate(out,90),callee.propagate(new IsCallee(self,args,node.arguments,new IfObj(out)))}),CallExpression:fill(function(node,scope,out){for(var i=0,args=[];i<node.arguments.length;++i)args.push(infer(node.arguments[i],scope));var outerFn=functionScope(scope).fnType;if("MemberExpression"==node.callee.type){var self=infer(node.callee.object,scope),pName=propName(node.callee,scope);outerFn&&("call"==pName||"apply"==pName)&&outerFn.args.indexOf(self)>-1&&maybeInstantiate(scope,30),self.propagate(new HasMethodCall(pName,args,node.arguments,out))}else if("Super"==node.callee.type&&cx.curSuperCtor)node.callee.superType=cx.curSuperCtor,cx.curSuperCtor.propagate(new IsCallee(getThis(scope),args,node.arguments,out)),getThis(scope).propagate(out,90);else{var callee=infer(node.callee,scope);outerFn&&outerFn.args.indexOf(callee)>-1&&maybeInstantiate(scope,30);var knownFn=callee.getFunctionType();knownFn&&knownFn.instantiateScore&&outerFn&&maybeInstantiate(scope,knownFn.instantiateScore/5),callee.propagate(new IsCallee(cx.topScope,args,node.arguments,out))}}),AwaitExpression:fill(function(node,scope,out,name){var arg=infer(node.argument,scope,null,name),tp=arg.getType();tp&&tp.constructor==Obj&&"Promise"==tp.name?tp.hasProp(":t")&&tp.getProp(":t").propagate(out):arg.propagate(out)}),MemberExpression:fill(function(node,scope,out){var name=propName(node),wg;if("<i>"==name){var propType=infer(node.property,scope),symName=symbolName(propType);symName?name=node.propName=symName:propType.hasType(cx.num)||(wg=6)}infer(node.object,scope).getProp(name).propagate(out,wg)}),Identifier:ret(function(node,scope){if("arguments"==node.name){var fnScope=functionScope(scope,!1);!fnScope.fnType||node.name in fnScope.props||fnScope.defProp(node.name,fnScope.fnType.originNode).addType(new Arr(fnScope.fnType.arguments=new AVal))}return scope.getProp(node.name)}),ThisExpression:ret(function(_node,scope){return getThis(scope)}),Super:ret(function(node){return node.superType=cx.curSuper||ANull}),Literal:ret(function(node){return literalType(node)}),TemplateLiteral:ret(function(node,scope){for(var i=0;i<node.expressions.length;++i)infer(node.expressions[i],scope,ANull);return cx.str}),TaggedTemplateExpression:fill(function(node,scope,out){for(var args=[new Arr(cx.str)],i=0;i<node.quasi.expressions.length;++i)args.push(infer(node.quasi.expressions[i],scope));infer(node.tag,scope,new IsCallee(cx.topScope,args,node.quasi.expressions,out))}),YieldExpression:ret(function(node,scope){var output=ANull,fn=functionScope(scope).fnType;return fn&&(fn.retval==ANull&&(fn.retval=new AVal),fn.yieldval||(fn.yieldval=new AVal),output=fn.retval),node.argument&&(node.delegate?infer(node.argument,scope,new HasMethodCall("next",[],null,new GetProp("value",output))):infer(node.argument,scope,output)),fn?fn.yieldval:ANull})};function infer(node,scope,out,name){var handler=inferExprVisitor[node.type];return handler?handler(node,scope,out,name):ANull}function loopPattern(init){return"VariableDeclaration"==init.type?init.declarations[0].id:init}inferExprVisitor.ArrowFunctionExpression=inferExprVisitor.FunctionExpression;var inferWrapper=exports.inferWrapper=walk.make({Expression:function(node,scope){infer(node,node.scope||scope,ANull)},ObjectExpression:function(node,scope){infer(node,node.scope||scope,ANull)},FunctionDeclaration:function(node,scope,c){var inner=node.scope,fn=inner.fnType;connectParams(node,inner),c(node.body,inner,"Statement"),maybeTagAsInstantiated(node,fn)||maybeTagAsGeneric(fn),node.id&&scope.getProp(node.id.name).addType(fn)},Statement:function(node,scope,c){c(node,node.scope||scope)},ExportDefaultDeclaration:function(node,scope,c){c(node.declaration,node.scope||scope)},VariableDeclaration:function(node,scope){for(var i=0;i<node.declarations.length;++i){var decl=node.declarations[i];if("Identifier"==decl.id.type){var prop=scope.getProp(decl.id.name);decl.init&&infer(decl.init,scope,prop,decl.id.name)}else decl.init&&connectPattern(decl.id,scope,infer(decl.init,scope))}},ClassDeclaration:function(node,scope){node.id?scope.getProp(node.id.name).addType(inferClass(node,scope,node.id.name)):inferClass(node,scope)},ReturnStatement:function(node,scope){if(node.argument){var output=ANull,fn=functionScope(scope).fnType;fn&&(fn.retval==ANull&&(fn.retval=new AVal),output=fn.retval),infer(node.argument,scope,output)}},ForInStatement:function(node,scope,c){var source=infer(node.right,scope);if("Identifier"==node.right.type&&node.right.name in scope.props||"MemberExpression"==node.right.type&&"prototype"==node.right.property.name){maybeInstantiate(scope,5);var pattern=loopPattern(node.left);"Identifier"==pattern.type?(pattern.name in scope.props&&(scope.getProp(pattern.name).iteratesOver=source),source.getProp("<i>").propagate(ensureVar(pattern,scope))):connectPattern(pattern,scope,source.getProp("<i>"))}c(node.body,scope,"Statement")},ForOfStatement:function(node,scope,c){var pattern=loopPattern(node.left),target;"Identifier"==pattern.type?target=ensureVar(pattern,scope):connectPattern(pattern,scope,target=new AVal),node.await?infer(node.right,scope,new HasMethodCall(":Symbol.asyncIterator",[],null,new HasMethodCall("next",[],null,new GetProp(":t",new GetProp("value",target))))):infer(node.right,scope,new HasMethodCall(":Symbol.iterator",[],null,new HasMethodCall("next",[],null,new GetProp("value",target)))),c(node.body,scope,"Statement")}}),parse=exports.parse=function(text,options,thirdArg){var ast;options&&!Array.isArray(options)||(options=thirdArg);try{ast=acorn.parse(text,options)}catch(e){ast=acorn_loose.parse(text,options)}return ast};function makePredicate(origins,start,end){var arr=Array.isArray(origins);return arr&&1==origins.length&&(origins=origins[0],arr=!1),arr?null==end?function(n){return origins.indexOf(n.origin)>-1}:function(n,pos){return pos&&pos.start>=start&&pos.end<=end&&origins.indexOf(n.origin)>-1}:null==end?function(n){return n.origin==origins}:function(n,pos){return pos&&pos.start>=start&&pos.end<=end&&n.origin==origins}}function findByPropertyName(name){guessing=!0;var found=objsWithProp(name);if(found)for(var i=0;i<found.length;++i){var val=found[i].getProp(name);if(!val.isEmpty())return val}return ANull}function generatorResult(input,output,async){var defs=cx.definitions.ecmascript,valObj=new Obj(!0);valObj.defProp("done").addType(cx.bool),output.propagate(valObj.defProp("value"));var retObj=valObj;async&&defs&&(retObj=new Obj(defs["Promise.prototype"])).getType().propagate(new DefProp(":t",valObj));var method=new Fn(null,ANull,input?[input]:[],input?["?"]:[],retObj),result=new Obj(!defs||(async?defs.async_generator_prototype:defs.generator_prototype));return result.defProp("next").addType(method),result}function maybeIterator(fn,output){return fn.generator?fn.computeRet?generatorResult(fn.yieldval,output,fn.async):(!0===fn.generator&&(fn.generator=generatorResult(fn.yieldval,output,fn.async)),fn.generator):output}function computeReturnType(funcNode,argNodes,scope){var fn=findType(funcNode,scope).getFunctionType();if(!fn)return ANull;var result=fn.retval;if(fn.computeRet){for(var i=0,args=[];i<argNodes.length;++i)args.push(findType(argNodes[i],scope));var self=ANull;"MemberExpression"==funcNode.type&&(self=findType(funcNode.object,scope)),result=fn.computeRet(self,args,argNodes)}return maybeIterator(fn,result)}exports.analyze=function(ast,name,scope){"string"==typeof ast&&(ast=parse(ast)),name||(name="file#"+cx.origins.length),exports.addOrigin(cx.curOrigin=name),scope||(scope=cx.topScope),cx.startAnalysis(),walk.recursive(ast,scope,null,scopeGatherer),cx.parent&&cx.parent.signal("preInfer",ast,scope),walk.recursive(ast,scope,null,inferWrapper),cx.parent&&cx.parent.signal("postInfer",ast,scope),cx.curOrigin=null},exports.purge=function(origins,start,end){var test=makePredicate(origins,start,end);for(var prop in++cx.purgeGen,cx.topScope.purge(test),cx.props){for(var list=cx.props[prop],i=0;i<list.length;++i){var obj,av=list[i].props[prop];av&&!test(av,av.originNode)||list.splice(i--,1)}list.length||delete cx.props[prop]}},AVal.prototype.purge=function(test){if(this.purgeGen!=cx.purgeGen){this.purgeGen=cx.purgeGen;for(var i=0;i<this.types.length;++i){var type=this.types[i];test(type,type.originNode)?this.types.splice(i--,1):type.purge(test)}if(this.types.length||(this.maxWeight=0),this.forward)for(var i=0;i<this.forward.length;++i){var f=this.forward[i];test(f)?(this.forward.splice(i--,1),this.props&&(this.props=null)):f.purge&&f.purge(test)}}},ANull.purge=function(){},Obj.prototype.purge=function(test){if(this.purgeGen==cx.purgeGen)return!0;for(var p in this.purgeGen=cx.purgeGen,this.props){var av=this.props[p];test(av,av.originNode)&&this.removeProp(p),av.purge(test)}},Fn.prototype.purge=function(test){if(!Obj.prototype.purge.call(this,test)){this.self.purge(test),this.retval.purge(test);for(var i=0;i<this.args.length;++i)this.args[i].purge(test)}};var typeFinder=exports.typeFinder={ArrayExpression:function(node,scope){return arrayLiteralType(node.elements,scope,findType)},ObjectExpression:function(node){return node.objType},ClassDeclaration:function(node){return node.objType},ClassExpression:function(node){return node.objType},FunctionDeclaration:function(node){return node.scope.fnType},FunctionExpression:function(node){return node.scope.fnType},ArrowFunctionExpression:function(node){return node.scope.fnType},SequenceExpression:function(node,scope){return findType(node.expressions[node.expressions.length-1],scope)},UnaryExpression:function(node){return unopResultType(node.operator)},UpdateExpression:function(){return cx.num},BinaryExpression:function(node,scope){if(binopIsBoolean(node.operator))return cx.bool;if("+"==node.operator){var lhs=findType(node.left,scope),rhs=findType(node.right,scope);if(lhs.hasType(cx.str)||rhs.hasType(cx.str))return cx.str}return cx.num},AssignmentExpression:function(node,scope){return findType(node.right,scope)},LogicalExpression:function(node,scope){var lhs=findType(node.left,scope);return lhs.isEmpty()?findType(node.right,scope):lhs},ConditionalExpression:function(node,scope){var lhs=findType(node.consequent,scope);return lhs.isEmpty()?findType(node.alternate,scope):lhs},NewExpression:function(node,scope){var f=findType(node.callee,scope).getFunctionType(),proto=f&&f.getProp("prototype").getObjType();return proto?getInstance(proto,f):ANull},CallExpression:function(node,scope){return computeReturnType(node.callee,node.arguments,scope)},MemberExpression:function(node,scope){var propN=propName(node),obj=findType(node.object,scope).getType();return obj?obj.getProp(propN):"<i>"==propN?ANull:findByPropertyName(propN)},MethodDefinition:function(node){var propN=propName(node),obj=getThis(node.value.scope).getType();return obj?obj.getProp(propN):ANull},Identifier:function(node,scope){return scope.hasProp(node.name)||ANull},ThisExpression:function(_node,scope){return getThis(scope)},Literal:function(node){return literalType(node)},Super:ret(function(node){return node.superType}),TemplateLiteral:function(){return cx.str},TaggedTemplateExpression:function(node,scope){return computeReturnType(node.tag,node.quasi.expressions,scope)},YieldExpression:function(_node,scope){var fn=functionScope(scope).fnType;return fn?fn.yieldval:ANull}};function findType(node,scope){var finder=typeFinder[node.type];return finder?finder(node,scope):ANull}var searchVisitor=exports.searchVisitor=walk.make({Function:function(node,_st,c){walk.base.Function(node,node.scope,c)},CatchClause:function(node,_st,c){walk.base.CatchClause(node,node.scope,c)},Property:function(node,st,c){node.computed&&c(node.key,st,"Expression"),node.key!=node.value&&c(node.value,st,"Expression")},Statement:function(node,st,c){c(node,node.scope||st)},ImportSpecifier:function(node,st,c){c(node.local,st)},ImportDefaultSpecifier:function(node,st,c){c(node.local,st)},ImportNamespaceSpecifier:function(node,st,c){c(node.local,st)}}),searchExprVisitor=exports.searchExprVisitor=walk.make({MemberExpression:function(node,st,c){c(node.object,st,"Expression"),node.computed&&c(node.property,st,"Expression")},Property:function(node,st,c){node.computed&&c(node.key,st,"Expression"),c(node.value,st,"Expression")}},searchVisitor);exports.fullVisitor=walk.make({MemberExpression:function(node,st,c){c(node.object,st,"Expression"),c(node.property,st,node.computed?"Expression":null)},Property:function(node,st,c){node.computed&&c(node.key,st,"Expression"),c(node.value,st,"Expression")}},searchVisitor),exports.findExpressionAt=function(ast,start,end,defaultScope,filter){var test=filter||function(_t,node){return("Identifier"!=node.type||"âœ–"!=node.name)&&typeFinder.hasOwnProperty(node.type)};return walk.findNodeAt(ast,start,end,test,searchExprVisitor,defaultScope||cx.topScope)},exports.findClosestExpression=function(ast,start,end,defaultScope,filter){var test=filter||function(_t,node){return!(null!=start&&node.start>start)&&(("Identifier"!=node.type||"âœ–"!=node.name)&&typeFinder.hasOwnProperty(node.type))};return walk.findNodeAround(ast,end,test,searchExprVisitor,defaultScope||cx.topScope)},exports.findExpressionAround=function(ast,start,end,defaultScope,filter){var test=filter||function(_t,node){return!(null!=start&&node.start>start)&&(("Identifier"!=node.type||"âœ–"!=node.name)&&typeFinder.hasOwnProperty(node.type))};return walk.findNodeAround(ast,end,test,searchVisitor,defaultScope||cx.topScope)},exports.expressionType=function(found){return findType(found.node,found.state)},exports.parentNode=function(child,ast){var stack=[];function c(node,st,override){if(node.start<=child.start&&node.end>=child.end){var top=stack[stack.length-1];if(node==child)throw{found:top};top!=node&&stack.push(node),walk.base[override||node.type](node,st,c),top!=node&&stack.pop()}}try{c(ast,null)}catch(e){if(e.found)return e.found;throw e}};var findTypeFromContext=exports.findTypeFromContext={ArrayExpression:function(parent,_,get){return get(parent,!0).getProp("<i>")},ObjectExpression:function(parent,node,get){for(var i=0;i<parent.properties.length;++i){var prop=node.properties[i];if(prop.value==node)return get(parent,!0).getProp(propName(prop))}},UnaryExpression:function(parent){return unopResultType(parent.operator)},UpdateExpression:function(){return cx.num},BinaryExpression:function(parent){return binopIsBoolean(parent.operator)?cx.bool:cx.num},AssignmentExpression:function(parent,_,get){return get(parent.left)},LogicalExpression:function(parent,_,get){return get(parent,!0)},ConditionalExpression:function(parent,node,get){if(parent.consequent==node||parent.alternate==node)return get(parent,!0)},CallExpression:function(parent,node,get){for(var i=0;i<parent.arguments.length;i++){var arg;if(parent.arguments[i]==node){var calleeType=get(parent.callee).getFunctionType();if(calleeType instanceof Fn)return calleeType.args[i];break}}},ReturnStatement:function(_parent,node,get){var fnNode=walk.findNodeAround(node.sourceFile.ast,node.start-1,"Function");if(fnNode){var fnType="FunctionDeclaration"!=fnNode.node.type?get(fnNode.node,!0).getFunctionType():fnNode.node.scope.fnType;if(fnType)return fnType.retval.getType()}},VariableDeclarator:function(parent,node,get){if(parent.init==node)return get(parent.id)}};findTypeFromContext.NewExpression=findTypeFromContext.CallExpression,exports.typeFromContext=function(ast,found){var parent=exports.parentNode(found.node,ast),type=null;if(findTypeFromContext.hasOwnProperty(parent.type)){var finder=findTypeFromContext[parent.type];type=finder&&finder(parent,found.node,function(node,fromContext){var obj={node:node,state:found.state},tp;return(fromContext?exports.typeFromContext(ast,obj):exports.expressionType(obj))||ANull})}return type||exports.expressionType(found)};var guessing=!1;exports.resetGuessing=function(val){guessing=val},exports.didGuess=function(){return guessing},exports.forAllPropertiesOf=function(type,f){type.gatherProperties(f,0)},exports.findRefs=function(ast,baseScope,name,refScope,f){function handleId(node,scope,ancestors){var parent=ancestors[ancestors.length-2];if(("MemberExpression"!=parent.type||parent.computed||!node.object)&&node.name==name&&(node!=ast.id||"FunctionDeclaration"!=ast.type)&&parent.property!==node)for(var s=scope;s;s=s.prev)if(s==refScope&&f(node,scope,ancestors),name in s.props)return}walk.ancestor(ast,{Identifier:handleId,VariablePattern:handleId},exports.fullVisitor,baseScope)};var simpleWalker=walk.make({Function:function(node,_scope,c){c(node.body,node.scope,node.expression?"Expression":"Statement")},Statement:function(node,scope,c){c(node,node.scope||scope)}});exports.findPropRefs=function(ast,scope,objType,name,f){for(;objType&&!objType.props[name]&&(!objType.maybeProps||!objType.maybeProps[name]);)objType=objType.proto;if(!objType)throw new Error("Couldn't locate property in the base object type.");function isObjTypeProto(type){for(;type&&type!=objType;){if(type.props[name]||type.maybeProps&&type.maybeProps[name])return!1;type=type.proto}return type}walk.simple(ast,{MemberExpression:function(node,scope){node.computed||propName(node)!=name||isObjTypeProto(findType(node.object,scope).getType())&&f(node.property,scope)},ObjectExpression:function(node,scope){if(findType(node,scope).getType()==objType)for(var i=0;i<node.properties.length;++i)propName(node.properties[i])==name&&f(node.properties[i].key,scope)},MethodDefinition:function(node){propName(node)==name&&node.value&&isObjTypeProto(getThis(node.value.scope).getType())&&f(node.key,node.value.scope)}},simpleWalker,scope)};var scopeAt=exports.scopeAt=function(ast,pos,defaultScope){var found=walk.findNodeAround(ast,pos,function(_,node){return node.scope});return found?found.node.scope:defaultScope||cx.topScope};exports.forAllLocalsAt=function(ast,pos,defaultScope,f){var scope;scopeAt(ast,pos,defaultScope).gatherProperties(f,0)},def=exports.def=def.init({},exports)});
//# sourceMappingURL=infer.js.map
