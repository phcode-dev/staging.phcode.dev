!function(mod){"object"==typeof exports&&"object"==typeof module?mod(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed"],mod):mod(CodeMirror)}(function(CodeMirror){"use strict";var paramData={noEndTag:!0,soyState:"param-def"},tags={alias:{noEndTag:!0},delpackage:{noEndTag:!0},namespace:{noEndTag:!0,soyState:"namespace-def"},"@attribute":paramData,"@attribute?":paramData,"@param":paramData,"@param?":paramData,"@inject":paramData,"@inject?":paramData,"@state":paramData,template:{soyState:"templ-def",variableScope:!0},extern:{soyState:"param-def"},export:{soyState:"export"},literal:{},msg:{},fallbackmsg:{noEndTag:!0,reduceIndent:!0},select:{},plural:{},let:{soyState:"var-def"},if:{},javaimpl:{},jsimpl:{},elseif:{noEndTag:!0,reduceIndent:!0},else:{noEndTag:!0,reduceIndent:!0},switch:{},case:{noEndTag:!0,reduceIndent:!0},default:{noEndTag:!0,reduceIndent:!0},foreach:{variableScope:!0,soyState:"for-loop"},ifempty:{noEndTag:!0,reduceIndent:!0},for:{variableScope:!0,soyState:"for-loop"},call:{soyState:"templ-ref"},param:{soyState:"param-ref"},print:{noEndTag:!0},deltemplate:{soyState:"templ-def",variableScope:!0},delcall:{soyState:"templ-ref"},log:{},element:{variableScope:!0},velog:{},const:{soyState:"const-def"}},indentingTags=Object.keys(tags).filter(function(tag){return!tags[tag].noEndTag||tags[tag].reduceIndent});CodeMirror.defineMode("soy",function(config){var textMode=CodeMirror.getMode(config,"text/plain"),modes={html:CodeMirror.getMode(config,{name:"text/html",multilineTagIndentFactor:2,multilineTagIndentPastTag:!1,allowMissingTagName:!0}),attributes:textMode,text:textMode,uri:textMode,trusted_resource_uri:textMode,css:CodeMirror.getMode(config,"text/css"),js:CodeMirror.getMode(config,{name:"text/javascript",statementIndent:2*config.indentUnit})};function last(array){return array[array.length-1]}function tokenUntil(stream,state,untilRegExp){if(stream.sol()){for(var indent=0;indent<state.indent&&stream.eat(/\s/);indent++);if(indent)return null}var oldString=stream.string,match=untilRegExp.exec(oldString.substr(stream.pos));match&&(stream.string=oldString.substr(0,stream.pos+match.index));var result=stream.hideFirstChars(state.indent,function(){var localState=last(state.localStates);return localState.mode.token(stream,localState.state)});return stream.string=oldString,result}function contains(list,element){for(;list;){if(list.element===element)return!0;list=list.next}return!1}function prepend(list,element){return{element:element,next:list}}function popcontext(state){state.context&&(state.context.scope&&(state.variables=state.context.scope),state.context=state.context.previousContext)}function ref(list,name,loose){return contains(list,name)?"variable-2":loose?"variable":"variable-2 error"}function Context(previousContext,tag,scope){this.previousContext=previousContext,this.tag=tag,this.kind=null,this.scope=scope}function expression(stream,state){var match;return stream.match(/[[]/)?(state.soyState.push("list-literal"),state.context=new Context(state.context,"list-literal",state.variables),state.lookupVariables=!1,null):stream.match(/\bmap(?=\()/)?(state.soyState.push("map-literal"),"keyword"):stream.match(/\brecord(?=\()/)?(state.soyState.push("record-literal"),"keyword"):stream.match(/([\w]+)(?=\()/)?"variable callee":(match=stream.match(/^["']/))?(state.soyState.push("string"),state.quoteKind=match[0],"string"):stream.match(/^[(]/)?(state.soyState.push("open-parentheses"),null):stream.match(/(null|true|false)(?!\w)/)||stream.match(/0x([0-9a-fA-F]{2,})/)||stream.match(/-?([0-9]*[.])?[0-9]+(e[0-9]*)?/)?"atom":stream.match(/(\||[+\-*\/%]|[=!]=|\?:|[<>]=?)/)?"operator":(match=stream.match(/^\$([\w]+)/))?ref(state.variables,match[1],!state.lookupVariables):(match=stream.match(/^\w+/))?/^(?:as|and|or|not|in|if)$/.test(match[0])?"keyword":null:(stream.next(),null)}return{startState:function(){return{soyState:[],variables:prepend(null,"ij"),scopes:null,indent:0,quoteKind:null,context:null,lookupVariables:!0,localStates:[{mode:modes.html,state:CodeMirror.startState(modes.html)}]}},copyState:function(state){return{tag:state.tag,soyState:state.soyState.concat([]),variables:state.variables,context:state.context,indent:state.indent,quoteKind:state.quoteKind,lookupVariables:state.lookupVariables,localStates:state.localStates.map(function(localState){return{mode:localState.mode,state:CodeMirror.copyState(localState.mode,localState.state)}})}},token:function(stream,state){var match;switch(last(state.soyState)){case"comment":if(stream.match(/^.*?\*\//)?state.soyState.pop():stream.skipToEnd(),!state.context||!state.context.scope)for(var paramRe=/@param\??\s+(\S+)/g,current=stream.current(),match;match=paramRe.exec(current);)state.variables=prepend(state.variables,match[1]);return"comment";case"string":var match;return(match=stream.match(/^.*?(["']|\\[\s\S])/))?match[1]==state.quoteKind&&(state.quoteKind=null,state.soyState.pop()):stream.skipToEnd(),"string"}if(!state.soyState.length||"literal"!=last(state.soyState)){if(stream.match(/^\/\*/))return state.soyState.push("comment"),"comment";if(stream.match(stream.sol()?/^\s*\/\/.*/:/^\s+\/\/.*/))return"comment"}switch(last(state.soyState)){case"templ-def":return(match=stream.match(/^\.?([\w]+(?!\.[\w]+)*)/))?(state.soyState.pop(),"def"):(stream.next(),null);case"templ-ref":return(match=stream.match(/(\.?[a-zA-Z_][a-zA-Z_0-9]+)+/))?(state.soyState.pop(),"."==match[0][0]?"variable-2":"variable"):(match=stream.match(/^\$([\w]+)/))?(state.soyState.pop(),ref(state.variables,match[1],!state.lookupVariables)):(stream.next(),null);case"namespace-def":return(match=stream.match(/^\.?([\w\.]+)/))?(state.soyState.pop(),"variable"):(stream.next(),null);case"param-def":return(match=stream.match(/^\*/))?(state.soyState.pop(),state.soyState.push("param-type"),"type"):(match=stream.match(/^\w+/))?(state.variables=prepend(state.variables,match[0]),state.soyState.pop(),state.soyState.push("param-type"),"def"):(stream.next(),null);case"param-ref":return(match=stream.match(/^\w+/))?(state.soyState.pop(),"property"):(stream.next(),null);case"open-parentheses":return stream.match(/[)]/)?(state.soyState.pop(),null):expression(stream,state);case"param-type":var peekChar=stream.peek();return-1!="}]=>,".indexOf(peekChar)?(state.soyState.pop(),null):"["==peekChar?(state.soyState.push("param-type-record"),null):"("==peekChar?(state.soyState.push("param-type-template"),null):"<"==peekChar?(state.soyState.push("param-type-parameter"),null):(match=stream.match(/^([\w]+|[?])/))?"type":(stream.next(),null);case"param-type-record":var peekChar;return"]"==(peekChar=stream.peek())?(state.soyState.pop(),null):stream.match(/^\w+/)?(state.soyState.push("param-type"),"property"):(stream.next(),null);case"param-type-parameter":return stream.match(/^[>]/)?(state.soyState.pop(),null):stream.match(/^[<,]/)?(state.soyState.push("param-type"),null):(stream.next(),null);case"param-type-template":return stream.match(/[>]/)?(state.soyState.pop(),state.soyState.push("param-type"),null):stream.match(/^\w+/)?(state.soyState.push("param-type"),"def"):(stream.next(),null);case"var-def":return(match=stream.match(/^\$([\w]+)/))?(state.variables=prepend(state.variables,match[1]),state.soyState.pop(),"def"):(stream.next(),null);case"for-loop":return stream.match(/\bin\b/)?(state.soyState.pop(),"keyword"):"$"==stream.peek()?(state.soyState.push("var-def"),null):(stream.next(),null);case"record-literal":return stream.match(/^[)]/)?(state.soyState.pop(),null):stream.match(/[(,]/)?(state.soyState.push("map-value"),state.soyState.push("record-key"),null):(stream.next(),null);case"map-literal":return stream.match(/^[)]/)?(state.soyState.pop(),null):stream.match(/[(,]/)?(state.soyState.push("map-value"),state.soyState.push("map-value"),null):(stream.next(),null);case"list-literal":return stream.match("]")?(state.soyState.pop(),state.lookupVariables=!0,popcontext(state),null):stream.match(/\bfor\b/)?(state.lookupVariables=!0,state.soyState.push("for-loop"),"keyword"):expression(stream,state);case"record-key":return stream.match(/[\w]+/)?"property":stream.match(/^[:]/)?(state.soyState.pop(),null):(stream.next(),null);case"map-value":return")"==stream.peek()||","==stream.peek()||stream.match(/^[:)]/)?(state.soyState.pop(),null):expression(stream,state);case"import":return stream.eat(";")?(state.soyState.pop(),state.indent-=2*config.indentUnit,null):stream.match(/\w+(?=\s+as\b)/)?"variable":(match=stream.match(/\w+/))?/\b(from|as)\b/.test(match[0])?"keyword":"def":(match=stream.match(/^["']/))?(state.soyState.push("string"),state.quoteKind=match[0],"string"):(stream.next(),null);case"tag":var endTag,tagName;void 0===state.tag?(endTag=!0,tagName=""):tagName=(endTag="/"==state.tag[0])?state.tag.substring(1):state.tag;var tag=tags[tagName];if(stream.match(/^\/?}/)){var selfClosed="/}"==stream.current();return selfClosed&&!endTag&&popcontext(state),"/template"==state.tag||"/deltemplate"==state.tag?(state.variables=prepend(null,"ij"),state.indent=0):state.indent-=config.indentUnit*(selfClosed||-1==indentingTags.indexOf(state.tag)?2:1),state.soyState.pop(),"keyword"}if(stream.match(/^([\w?]+)(?==)/)){if(state.context&&state.context.tag==tagName&&"kind"==stream.current()&&(match=stream.match(/^="([^"]+)/,!1))){var kind=match[1];state.context.kind=kind;var mode=modes[kind]||modes.html,localState;(localState=last(state.localStates)).mode.indent&&(state.indent+=localState.mode.indent(localState.state,"","")),state.localStates.push({mode:mode,state:CodeMirror.startState(mode)})}return"attribute"}return expression(stream,state);case"template-call-expression":return stream.match(/^([\w-?]+)(?==)/)?"attribute":stream.eat(">")?(state.soyState.pop(),"keyword"):stream.eat("/>")?(state.soyState.pop(),"keyword"):expression(stream,state);case"literal":return stream.match("{/literal}",!1)?(state.soyState.pop(),this.token(stream,state)):tokenUntil(stream,state,/\{\/literal}/);case"export":if(match=stream.match(/\w+/)){if(state.soyState.pop(),"const"==match)return state.soyState.push("const-def"),"keyword";if("extern"==match)return state.soyState.push("param-def"),"keyword"}else stream.next();return null;case"const-def":return stream.match(/^\w+/)?(state.soyState.pop(),"def"):(stream.next(),null)}if(stream.match("{literal}"))return state.indent+=config.indentUnit,state.soyState.push("literal"),state.context=new Context(state.context,"literal",state.variables),"keyword";if(match=stream.match(/^\{([/@\\]?\w+\??)(?=$|[\s}]|\/[/*])/)){var prevTag=state.tag;state.tag=match[1];var endTag="/"==state.tag[0],indentingTag=!!tags[state.tag],tagName=endTag?state.tag.substring(1):state.tag,tag=tags[tagName];"/switch"!=state.tag&&(state.indent+=((endTag||tag&&tag.reduceIndent)&&"switch"!=prevTag?1:2)*config.indentUnit),state.soyState.push("tag");var tagError=!1;if(tag)if(endTag||tag.soyState&&state.soyState.push(tag.soyState),tag.noEndTag||!indentingTag&&endTag){if(endTag){var isBalancedForExtern="extern"==tagName&&state.context&&"export"==state.context.tag;if(!state.context||state.context.tag!=tagName&&!isBalancedForExtern)tagError=!0;else if(state.context){var localState;if(state.context.kind)state.localStates.pop(),(localState=last(state.localStates)).mode.indent&&(state.indent-=localState.mode.indent(localState.state,"",""));popcontext(state)}}}else state.context=new Context(state.context,state.tag,tag.variableScope?state.variables:null);else endTag&&(tagError=!0);return(tagError?"error ":"")+"keyword"}return stream.eat("{")?(state.tag="print",state.indent+=2*config.indentUnit,state.soyState.push("tag"),"keyword"):!state.context&&stream.sol()&&stream.match(/import\b/)?(state.soyState.push("import"),state.indent+=2*config.indentUnit,"keyword"):(match=stream.match("<{"))?(state.soyState.push("template-call-expression"),state.indent+=2*config.indentUnit,state.soyState.push("tag"),"keyword"):(match=stream.match("</>"))?(state.indent-=1*config.indentUnit,"keyword"):tokenUntil(stream,state,/\{|\s+\/\/|\/\*/)},indent:function(state,textAfter,line){var indent=state.indent,top=last(state.soyState);if("comment"==top)return CodeMirror.Pass;if("literal"==top)/^\{\/literal}/.test(textAfter)&&(indent-=config.indentUnit);else{if(/^\s*\{\/(template|deltemplate)\b/.test(textAfter))return 0;/^\{(\/|(fallbackmsg|elseif|else|ifempty)\b)/.test(textAfter)&&(indent-=config.indentUnit),"switch"!=state.tag&&/^\{(case|default)\b/.test(textAfter)&&(indent-=config.indentUnit),/^\{\/switch\b/.test(textAfter)&&(indent-=config.indentUnit)}var localState=last(state.localStates);return indent&&localState.mode.indent&&(indent+=localState.mode.indent(localState.state,textAfter,line)),indent},innerMode:function(state){return state.soyState.length&&"literal"!=last(state.soyState)?null:last(state.localStates)},electricInput:/^\s*\{(\/|\/template|\/deltemplate|\/switch|fallbackmsg|elseif|else|case|default|ifempty|\/literal\})$/,lineComment:"//",blockCommentStart:"/*",blockCommentEnd:"*/",blockCommentContinue:" * ",useInnerComments:!1,fold:"indent"}},"htmlmixed"),CodeMirror.registerHelper("wordChars","soy",/[\w$]/),CodeMirror.registerHelper("hintWords","soy",Object.keys(tags).concat(["css","debugger"])),CodeMirror.defineMIME("text/x-soy","soy")});
//# sourceMappingURL=soy.js.map
