define(function(require,exports,module){var _=require("thirdparty/lodash"),Mustache=require("thirdparty/mustache/mustache"),Dialogs=require("widgets/Dialogs"),DropdownButton=require("widgets/DropdownButton").DropdownButton,StringUtils=require("utils/StringUtils"),Strings=require("strings"),PreferencesManager=require("preferences/PreferencesManager"),FindUtils=require("search/FindUtils"),EditFilterTemplate=require("text!htmlContent/edit-filter-dialog.html"),FilterNameTemplate=require("text!htmlContent/filter-name.html"),FIRST_FILTER_INDEX=3,FILTER_NAME_CHARACTER_MAX=20,_context=null,_picker=null;function _getCondensedForm(filter){return _.isArray(filter)?filter.length>2?filter.slice(0,2).join(", ")+" "+StringUtils.format(Strings.FILE_FILTER_CLIPPED_SUFFIX,filter.length-2):filter.join(", "):""}function _doPopulate(){var dropdownItems=[Strings.NEW_FILE_FILTER,Strings.CLEAR_FILE_FILTER],filterSets=PreferencesManager.get("fileFilters")||[];filterSets.length&&(dropdownItems.push("---"),filterSets=filterSets.filter(function(filter){return""!==_getCondensedForm(filter.patterns)}),dropdownItems=dropdownItems.concat(filterSets)),_picker.items=dropdownItems}function _getFilterIndex(filterSets,filter){var index=-1;return filter&&filterSets.length?_.findIndex(filterSets,_.partial(_.isEqual,filter)):-1}function getActiveFilter(){var filterSets=PreferencesManager.get("fileFilters")||[],activeFilterIndex=PreferencesManager.getViewState("activeFileFilter"),oldFilter=PreferencesManager.getViewState("search.exclusions")||[],activeFilter=null;return void 0===activeFilterIndex&&oldFilter.length?(-1===(activeFilterIndex=_getFilterIndex(filterSets,activeFilter={name:"",patterns:oldFilter}))&&(activeFilterIndex=filterSets.length,filterSets.push(activeFilter),PreferencesManager.set("fileFilters",filterSets)),PreferencesManager.setViewState("activeFileFilter",activeFilterIndex)):activeFilterIndex>-1&&activeFilterIndex<filterSets.length&&(activeFilter=filterSets[activeFilterIndex]),activeFilter}function _updatePicker(){var filter=getActiveFilter();if(filter&&filter.patterns.length){var label=filter.name||_getCondensedForm(filter.patterns);_picker.setButtonLabel(StringUtils.format(Strings.EXCLUDE_FILE_FILTER,label))}else _picker.setButtonLabel(Strings.NO_FILE_FILTER)}function setActiveFilter(filter,index){var filterSets=PreferencesManager.get("fileFilters")||[];if(filter){if(-1===index)index=filterSets.length,filterSets.push(filter);else{if(!(index>-1&&index<filterSets.length))return void console.log("setActiveFilter is called with an invalid index: "+index);_.isEqual(filterSets[index],filter)||(filterSets[index]=filter)}PreferencesManager.set("fileFilters",filterSets),PreferencesManager.setViewState("activeFileFilter",index)}else PreferencesManager.setViewState("activeFileFilter",-1);FindUtils.notifyFileFiltersChanged()}function compile(userFilter){var wrappedGlobs,regexStrings;return userFilter.map(function(glob){if("**"!==glob.substr(0,2)&&(glob="**"+glob),"**"!==glob.substr(-2,2)){var lastSeg=glob.lastIndexOf("/");-1===glob.indexOf(".",lastSeg+1)&&(glob+="**")}return glob}).map(function(glob){var reStr="",i;for(i=0;i<glob.length;i++){var ch=glob[i];"*"===ch?"*"===glob[i+1]?"/"===glob[i+2]&&"/"===glob[i-1]?(reStr+="(.*/)?",i+=2):(reStr+=".*",i++):reStr+="[^/]*":reStr+="?"===ch?"[^/]":StringUtils.regexEscape(ch)}return"^"+reStr+"$"}).join("|")}function filterPath(compiledFilter,fullPath){if(!compiledFilter)return!0;var re=new RegExp(compiledFilter);return!fullPath.match(re)}function filterFileList(compiledFilter,files){if(!compiledFilter)return files;var re=new RegExp(compiledFilter);return files.filter(function(f){return!re.test(f.fullPath)})}function getPathsMatchingFilter(compiledFilter,filePaths){if(!compiledFilter)return filePaths;var re=new RegExp(compiledFilter);return filePaths.filter(function(f){return f.match(re)})}function editFilter(filter,index){var lastFocus=window.document.activeElement,templateVars={instruction:StringUtils.format(Strings.FILE_FILTER_INSTRUCTIONS,brackets.config.glob_help_url),Strings:Strings},dialog=Dialogs.showModalDialogUsingTemplate(Mustache.render(EditFilterTemplate,templateVars)),$nameField=dialog.getElement().find(".exclusions-name"),$editField=dialog.getElement().find(".exclusions-editor"),$remainingField=dialog.getElement().find(".exclusions-name-characters-remaining");function getValue(){var newFilter;return $editField.val().split("\n").filter(function(glob){return glob.trim().length})}$nameField.val(filter.name),$editField.val(filter.patterns.join("\n")).focus(),$nameField.bind("input",function(){var remainingCharacters=FILTER_NAME_CHARACTER_MAX-$(this).val().length;remainingCharacters<.25*FILTER_NAME_CHARACTER_MAX?($remainingField.show(),$remainingField.text(StringUtils.format(Strings.FILTER_NAME_REMAINING,remainingCharacters)),remainingCharacters<0?$remainingField.addClass("exclusions-name-characters-limit-reached"):$remainingField.removeClass("exclusions-name-characters-limit-reached")):$remainingField.hide(),updatePrimaryButton()}),dialog.done(function(buttonId){buttonId===Dialogs.DIALOG_BTN_OK&&(setActiveFilter({name:$nameField.val(),patterns:getValue()},index),_updatePicker(),_doPopulate()),lastFocus.focus()});var $fileCount=dialog.getElement().find(".exclusions-filecount");function updateFileCount(){_context.promise.done(function(files){var filter=getValue();if(filter.length){var filtered=filterFileList(compile(filter),files);$fileCount.html(StringUtils.format(Strings.FILTER_FILE_COUNT,filtered.length,files.length,_context.label))}else $fileCount.html(StringUtils.format(Strings.FILTER_FILE_COUNT_ALL,files.length,_context.label))})}var $primaryBtn=dialog.getElement().find(".primary");function updatePrimaryButton(){var trimmedValue=$editField.val().trim(),exclusionNameLength=$nameField.val().length;$primaryBtn.prop("disabled",!trimmedValue.length||exclusionNameLength>FILTER_NAME_CHARACTER_MAX)}return $editField.on("input",updatePrimaryButton),updatePrimaryButton(),_context?($editField.on("input",_.debounce(updateFileCount,400)),updateFileCount()):$fileCount.hide(),dialog.getPromise()}function commitPicker(picker){var filter=getActiveFilter();return filter&&filter.patterns.length?compile(filter.patterns):""}function _handleDeleteFilter(e){var filterSets=PreferencesManager.get("fileFilters")||[],activeFilterIndex=PreferencesManager.getViewState("activeFileFilter"),filterIndex=$(e.target).parent().data("index")-FIRST_FILTER_INDEX;e.stopPropagation(),filterSets.splice(filterIndex,1),PreferencesManager.set("fileFilters",filterSets),activeFilterIndex===filterIndex?setActiveFilter(null):activeFilterIndex>filterIndex&&setActiveFilter(filterSets[--activeFilterIndex],activeFilterIndex),_updatePicker(),_doPopulate(),_picker.refresh()}function _handleEditFilter(e){var filterSets=PreferencesManager.get("fileFilters")||[],filterIndex=$(e.target).parent().data("index")-FIRST_FILTER_INDEX;e.stopPropagation(),_picker.closeDropdown(),editFilter(filterSets[filterIndex],filterIndex)}function _handleListRendered(event,$dropdown){var activeFilterIndex=PreferencesManager.getViewState("activeFileFilter"),checkedItemIndex=activeFilterIndex>-1?activeFilterIndex+FIRST_FILTER_INDEX:-1;_picker.setChecked(checkedItemIndex,!0),$dropdown.find(".filter-trash-icon").on("click",_handleDeleteFilter),$dropdown.find(".filter-edit-icon").on("click",_handleEditFilter)}function createFilterPicker(context){function itemRenderer(item,index){if(index<FIRST_FILTER_INDEX)return"<span class='recent-filter-name'></span>"+_.escape(item);var condensedPatterns=_getCondensedForm(item.patterns),templateVars={"filter-name":_.escape(item.name||condensedPatterns),"filter-patterns":item.name?" - "+_.escape(condensedPatterns):""};return Mustache.render(FilterNameTemplate,templateVars)}return _context=context,_picker=new DropdownButton("",[],itemRenderer),_updatePicker(),_doPopulate(),_picker.$button.addClass("file-filter-picker no-focus"),_picker.on("listRendered",_handleListRendered),_picker.on("select",function(event,item,itemIndex){0===itemIndex?(_picker.closeDropdown(),editFilter({name:"",patterns:[]},-1)):1===itemIndex?(_picker.setChecked(itemIndex,!1),setActiveFilter(null),_updatePicker()):itemIndex>=FIRST_FILTER_INDEX&&item&&(setActiveFilter(item,itemIndex-FIRST_FILTER_INDEX),_picker.setChecked(itemIndex,!0),_updatePicker())}),_picker.$button}function showDropdown(){_picker&&_picker.showDropdown()}function closeDropdown(){_picker&&_picker.closeDropdown()}exports.showDropdown=showDropdown,exports.closeDropdown=closeDropdown,exports.createFilterPicker=createFilterPicker,exports.commitPicker=commitPicker,exports.getActiveFilter=getActiveFilter,exports.setActiveFilter=setActiveFilter,exports.editFilter=editFilter,exports.compile=compile,exports.filterPath=filterPath,exports.filterFileList=filterFileList,exports.getPathsMatchingFilter=getPathsMatchingFilter});
//# sourceMappingURL=FileFilters.js.map
