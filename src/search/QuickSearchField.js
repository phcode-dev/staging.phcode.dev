define(function(require,exports,module){var KeyEvent=require("utils/KeyEvent");function QuickSearchField($input,options){this.$input=$input,this.options=options,options.maxResults=options.maxResults||10,this._handleInput=this._handleInput.bind(this),this._handleKeyDown=this._handleKeyDown.bind(this),void 0!==options.highlightZeroResults?this._highlightZeroResults=options.highlightZeroResults:this._highlightZeroResults=!0,$input.on("input",this._handleInput),$input.on("keydown",this._handleKeyDown),this._firstHighlightIndex=options.firstHighlightIndex,this._dropdownTop=$input.offset().top+$input.height()+(options.verticalAdjust||0)}QuickSearchField.prototype.options=null,QuickSearchField.prototype._pending=null,QuickSearchField.prototype._commitPending=!1,QuickSearchField.prototype._displayedQuery=null,QuickSearchField.prototype._displayedResults=null,QuickSearchField.prototype._highlightIndex=null,QuickSearchField.prototype._$dropdown=null,QuickSearchField.prototype.$input=null,QuickSearchField.prototype._handleInput=function(){this._pending=null;var valueAtEvent=this.$input.val(),self=this;setTimeout(function(){self.$input.val()===valueAtEvent&&self.updateResults()},0)},QuickSearchField.prototype._handleKeyDown=function(event){event.keyCode===KeyEvent.DOM_VK_RETURN?this._displayedQuery===this.$input.val()?(event.preventDefault(),this._doCommit()):this._commitPending=!0:event.keyCode===KeyEvent.DOM_VK_DOWN?(this._displayedResults&&this._displayedResults.length&&(null===this._highlightIndex||this._highlightIndex===this._displayedResults.length-1?this._highlightIndex=0:this._highlightIndex++,this._updateHighlight(!0)),event.preventDefault()):event.keyCode===KeyEvent.DOM_VK_UP&&(this._displayedResults&&this._displayedResults.length&&(null===this._highlightIndex||0===this._highlightIndex?this._highlightIndex=this._displayedResults.length-1:this._highlightIndex--,this._updateHighlight(!0)),event.preventDefault())},QuickSearchField.prototype._doCommit=function(index){var item;this._displayedResults&&this._displayedResults.length&&(index>=0?item=this._displayedResults[index]:this._highlightIndex>=0&&(item=this._displayedResults[this._highlightIndex])),this.options.onCommit(item,this._displayedQuery)},QuickSearchField.prototype._updateHighlight=function(explicit){if(this._$dropdown){var $items=this._$dropdown.find("li");$items.removeClass("highlight"),null!==this._highlightIndex&&($items.eq(this._highlightIndex).addClass("highlight"),this.options.onHighlight(this._displayedResults[this._highlightIndex],this.$input.val(),explicit))}},QuickSearchField.prototype.updateResults=function(){this._pending=null;var query=this.$input.val(),results=this.options.resultProvider(query);if(results.done&&results.fail){this._pending=results;var self=this;this._pending.done(function(realResults){self._pending===results&&(self._render(realResults,query),this._pending=null)}),this._pending&&this._pending.fail(function(){self._pending===results&&(self._render([],query),this._pending=null)})}else this._render(results,query)},QuickSearchField.prototype._closeDropdown=function(){this._$dropdown&&(this._$dropdown.remove(),this._$dropdown=null)},QuickSearchField.prototype._openDropdown=function(htmlContent){if(!this._$dropdown){var self=this;this._$dropdown=$("<ol class='quick-search-container'/>").appendTo("body").css({position:"absolute",top:this._dropdownTop,left:this.$input.offset().left,width:this.$input.outerWidth()}).click(function(event){var $item=$(event.target).closest("li");$item.length&&self._doCommit($item.index())})}this._$dropdown.html(htmlContent)},QuickSearchField.prototype._render=function(results,query){if(this._displayedQuery=query,this._displayedResults=results,this._firstHighlightIndex>=0?this._highlightIndex=this._firstHighlightIndex:this._highlightIndex=null,results.error||0===results.length)this._closeDropdown(),this._highlightZeroResults&&this.$input.addClass("no-results");else if(results.hasOwnProperty("error"))this._closeDropdown(),this._highlightZeroResults&&this.$input.removeClass("no-results");else{this._highlightZeroResults&&this.$input.removeClass("no-results");var count=Math.min(results.length,this.options.maxResults),html="",i;for(i=0;i<count;i++)html+=this.options.formatter(results[i],query);this._openDropdown(html),this._updateHighlight(!1)}this._commitPending&&(this._commitPending=!1,this._doCommit())},QuickSearchField.prototype.setText=function(value){this.$input.val(value),this.updateResults()},QuickSearchField.prototype.destroy=function(){this._pending=null,this._closeDropdown()},exports.QuickSearchField=QuickSearchField});
//# sourceMappingURL=QuickSearchField.js.map
