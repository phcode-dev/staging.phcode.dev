define(function(require,exports,module){const CommandManager=require("command/CommandManager"),Commands=require("command/Commands"),EditorManager=require("editor/EditorManager"),Menus=require("command/Menus"),PreferencesManager=require("preferences/PreferencesManager"),Strings=require("strings"),ViewUtils=require("utils/ViewUtils"),AppInit=require("utils/AppInit"),WorkspaceManager=require("view/WorkspaceManager"),ProviderRegistrationHandler=require("features/PriorityBasedRegistration").RegistrationHandler,previewContainerHTML='<div id="quick-view-container">\n    <div class="preview-content">\n    </div>\n</div>',_providerRegistrationHandler=new ProviderRegistrationHandler,registerQuickViewProvider=_providerRegistrationHandler.registerProvider.bind(_providerRegistrationHandler),removeQuickViewProvider=_providerRegistrationHandler.removeProvider.bind(_providerRegistrationHandler);function _getQuickViewProviders(editor){let quickViewProviders=[],language=editor.getLanguageForSelection(),enabledProviders=_providerRegistrationHandler.getProvidersForLanguageId(language.getId());for(let item of enabledProviders)quickViewProviders.push(item.provider);return quickViewProviders}let enabled,prefs=null,$previewContainer,$previewContent,_currentMousePos,animationRequest;const CMD_ENABLE_QUICK_VIEW="view.enableQuickView",QUICK_VIEW_EDITOR_MARKER="quickViewMark",HOVER_DELAY=500,POINTER_HEIGHT=10,POPOVER_HORZ_MARGIN=5;(prefs=PreferencesManager.getExtensionPrefs("quickview")).definePreference("enabled","boolean",!0,{description:Strings.DESCRIPTION_QUICK_VIEW_ENABLED});let popoverState=null;function hidePreview(){popoverState&&(popoverState.visible&&(popoverState.marker.clear(),$previewContent.empty(),$previewContainer.hide(),$previewContainer.removeClass("active"),EditorManager.getActiveEditor()&&EditorManager.getActiveEditor().focus()),showPreviewQueued=!1,mouseInPreviewContainer=!1,window.clearTimeout(popoverState.hoverTimer),popoverState=null)}function positionPreview(editor,xpos,ypos,ybot){if($previewContent.find("#quick-view-popover-root").is(":empty"))return void hidePreview();let previewWidth=$previewContainer.outerWidth(),top=ypos-$previewContainer.outerHeight()-POINTER_HEIGHT,left=xpos-previewWidth/2,elementRect={top:top,left:left-POPOVER_HORZ_MARGIN,height:$previewContainer.outerHeight()+POINTER_HEIGHT,width:previewWidth+2*POPOVER_HORZ_MARGIN},clip=ViewUtils.getElementClipSize($(editor.getRootElement()),elementRect);clip.left>0?left+=clip.left:clip.right>0&&(left-=clip.right),clip.top>0?(top=ybot+POINTER_HEIGHT,$previewContainer.removeClass("preview-bubble-above").addClass("preview-bubble-below")):$previewContainer.removeClass("preview-bubble-below").addClass("preview-bubble-above"),$previewContainer.css({left:left,top:top}).addClass("active")}function _isResultBeforePopoverStart(editor,popover,result){return!popover.start||editor.indexFromPos(result.start)<editor.indexFromPos(popover.start)}function _isResultAfterPopoverEnd(editor,popover,result){return!popover.end||editor.indexFromPos(popover.start)>editor.indexFromPos(result.end)}function _createPopoverState(editor,popoverResults){if(popoverResults&&popoverResults.length){let popover={content:$("<div id='quick-view-popover-root'></div>")};for(let result of popoverResults)_isResultBeforePopoverStart(editor,popover,result)&&(popover.start=result.start),_isResultAfterPopoverEnd(editor,popover,result)&&(popover.end=result.end),popover.content.append(result.content);let startCoord=editor.charCoords(popover.start),endCoord=editor.charCoords(popover.end);return popover.xpos=(endCoord.left-startCoord.left)/2+startCoord.left,endCoord.left<startCoord.left&&(popover.xpos=startCoord.left),popover.ytop=startCoord.top,popover.ybot=startCoord.bottom,popover.visible=!1,popover.editor=editor,popover}return null}async function queryPreviewProviders(editor,pos,token){let line=editor.document.getLine(pos.line),providers=_getQuickViewProviders(editor),popovers=[],providerPromises=[];for(let provider of providers)provider.getQuickView?providerPromises.push(provider.getQuickView(editor,pos,token,line)):console.error("Quickview provider does not implement the required getQuickView function",provider);let results=await Promise.allSettled(providerPromises);for(let result of results)"fulfilled"===result.status&&result.value&&popovers.push(result.value);return _createPopoverState(editor,popovers)}function _renderPreview(editor){if(popoverState&&popoverState.start&&popoverState.end){popoverState.marker=editor.markText(QUICK_VIEW_EDITOR_MARKER,popoverState.start,popoverState.end,{className:"quick-view-highlight"});let $popoverContent=$(popoverState.content);$previewContent.append($popoverContent),$previewContainer.show(),popoverState.visible=!0,positionPreview(editor,popoverState.xpos,popoverState.ytop,popoverState.ybot),$popoverContent[0].addEventListener("DOMSubtreeModified",()=>{positionPreview(editor,popoverState.xpos,popoverState.ytop,popoverState.ybot)},!1)}}let currentQueryID=0;async function showPreview(editor){let token;if(editor||(editor=EditorManager.getHoveredEditor(_currentMousePos)),!editor)return void hidePreview();let pos=editor.coordsChar({left:_currentMousePos.clientX,top:_currentMousePos.clientY});if(pos.ch>=editor.document.getLine(pos.line).length)return;token=editor.getToken(pos);let savedQueryId=++currentQueryID;popoverState=await queryPreviewProviders(editor,pos,token),savedQueryId===currentQueryID&&_renderPreview(editor)}function _isMouseFarFromPopup(){const previewRect=$previewContainer[0].getBoundingClientRect(),docRect={height:$(document).height(),width:$(document).width()},thresholdPercent=5;function _isDistanceExceedThreshold(smaller,larger,total,threshold){return(larger-smaller)/total*100>threshold}let x=_currentMousePos.clientX,y=_currentMousePos.clientY;return!!(x<previewRect.left&&_isDistanceExceedThreshold(x,previewRect.left,docRect.width,5)||x>previewRect.right&&_isDistanceExceedThreshold(previewRect.right,x,docRect.width,5)||y<previewRect.top&&_isDistanceExceedThreshold(y,previewRect.top,docRect.height,5)||y>previewRect.bottom&&_isDistanceExceedThreshold(previewRect.bottom,y,docRect.height,5))}let showPreviewQueued=!1;function processMouseMove(){if(animationRequest=null,mouseInPreviewContainer)return;let editor=null;if(popoverState&&popoverState.visible&&(editor=EditorManager.getHoveredEditor(_currentMousePos))){let pos=editor.coordsChar({left:_currentMousePos.clientX,top:_currentMousePos.clientY});if(popoverState.start&&popoverState.end&&editor.posWithinRange(pos,popoverState.start,popoverState.end,!0)&&pos.ch<editor.document.getLine(pos.line).length)return;if(_isMouseFarFromPopup())return void hidePreview()}showPreviewQueued||(showPreviewQueued=!0,(popoverState=popoverState||{}).hoverTimer=window.setTimeout(function(){showPreviewQueued=!1,mouseInPreviewContainer||(hidePreview(),popoverState={},showPreview(editor))},HOVER_DELAY))}function handleMouseMove(event){_currentMousePos={clientX:event.clientX,clientY:event.clientY},enabled&&(0===event.buttons?animationRequest||(animationRequest=window.requestAnimationFrame(processMouseMove)):hidePreview())}function onActiveEditorChange(event,current,previous){hidePreview(),previous&&previous.document&&previous.document.off("change",hidePreview),current&&current.document&&current.document.on("change",hidePreview)}function updateMenuItemCheckmark(){CommandManager.get(CMD_ENABLE_QUICK_VIEW).setChecked(enabled)}let mouseInPreviewContainer=!1;function mouseOut(_evt){setTimeout(()=>{mouseInPreviewContainer||$previewContainer[0].contains(_evt.toElement)||hidePreview()},HOVER_DELAY)}function _mouseEnteredPreviewContainer(){mouseInPreviewContainer=!0}function _mouseExitedPreviewContainer(){mouseInPreviewContainer=!1}function setEnabled(_enabled,doNotSave){if(enabled!==_enabled){enabled=_enabled;let editorHolder=$("#editor-holder")[0],previewContainer=$previewContainer[0];enabled?(editorHolder.addEventListener("mousemove",handleMouseMove,!0),editorHolder.addEventListener("scroll",hidePreview,!0),editorHolder.addEventListener("mouseout",mouseOut,!0),previewContainer.addEventListener("mouseover",_mouseEnteredPreviewContainer,!0),previewContainer.addEventListener("mouseout",_mouseExitedPreviewContainer,!0),onActiveEditorChange(null,EditorManager.getActiveEditor(),null),EditorManager.on("activeEditorChange",onActiveEditorChange)):(editorHolder.removeEventListener("mousemove",handleMouseMove,!0),editorHolder.removeEventListener("scroll",hidePreview,!0),editorHolder.removeEventListener("mouseout",mouseOut,!0),previewContainer.removeEventListener("mouseover",_mouseEnteredPreviewContainer,!0),previewContainer.removeEventListener("mouseout",_mouseExitedPreviewContainer,!0),onActiveEditorChange(null,null,EditorManager.getActiveEditor()),EditorManager.off("activeEditorChange",onActiveEditorChange),hidePreview()),doNotSave||(prefs.set("enabled",enabled),prefs.save())}updateMenuItemCheckmark()}function toggleEnableQuickView(){setEnabled(!enabled)}function _forceShow(popover){hidePreview(),_currentMousePos={clientX:popover.xpos,clientY:Math.floor((popover.ybot+popover.ytop)/2)},popoverState=popover,_renderPreview(popover.editor)}function _handleEscapeKeyEvent(event){return!!isQuickViewShown()&&(hidePreview(),event.preventDefault(),event.stopPropagation(),!0)}function isQuickViewShown(){return popoverState&&popoverState.visible||!1}AppInit.appReady(function(){$previewContainer=$(previewContainerHTML).appendTo($("body")),$previewContent=$previewContainer.find(".preview-content"),CommandManager.register(Strings.CMD_ENABLE_QUICK_VIEW,CMD_ENABLE_QUICK_VIEW,toggleEnableQuickView),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(CMD_ENABLE_QUICK_VIEW,null,Menus.AFTER,Commands.VIEW_TOGGLE_INSPECTION),setEnabled(prefs.get("enabled"),!0),prefs.on("change","enabled",function(){setEnabled(prefs.get("enabled"),!0)}),WorkspaceManager.addEscapeKeyEventHandler("quickView",_handleEscapeKeyEvent)}),exports._queryPreviewProviders=queryPreviewProviders,exports._forceShow=_forceShow,exports.registerQuickViewProvider=registerQuickViewProvider,exports.removeQuickViewProvider=removeQuickViewProvider,exports.isQuickViewShown=isQuickViewShown});
//# sourceMappingURL=QuickViewManager.js.map
