import{Workbox}from"https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";function _getBaseURL(){let baseURL=window.location.href;return location.href.indexOf("?")>-1&&(baseURL=location.href.substring(0,location.href.indexOf("?"))),location.href.indexOf("#")>-1&&(baseURL=baseURL.substring(0,baseURL.indexOf("#"))),location.href.indexOf("/")>-1&&(baseURL=baseURL.substring(0,baseURL.lastIndexOf("/"))),baseURL.endsWith("/")||(baseURL+="/"),baseURL}function getRoute(){return"phoenix/vfs"}function _isServiceWorkerLoaderPage(){const indexUrl=`${location.origin}/index.html`,baseUrl=`${location.origin}/`,devURL="http://localhost:8000/src/",currentURL=_getBaseURL();return console.log("currentURL",currentURL,indexUrl,baseUrl,devURL),currentURL===baseUrl||currentURL===indexUrl||currentURL===devURL}async function shouldUpdate(){return!0}if(window.fsServerUrl=_getBaseURL()+getRoute()+"/",_isServiceWorkerLoaderPage()&&"serviceWorker"in navigator){logger.leaveTrail("Service worker loader: Loading  from page..."+window.location.href);const wb=new Workbox(`virtual-server-main.js?debug=false&route=${getRoute()}`,{updateViaCache:"none"});let isServerReady=!1;function serverReady(){console.log("Service worker loader: Server ready."),isServerReady=!0,wb.messageSW({type:"INIT_PHOENIX_CONFIG",debugMode:"true"===window.logger.logToConsolePref,logLivePreview:window.logger.loggingOptions.logLivePreview}).then(config=>{logger.leaveTrail(`Service worker loader: Server ready! Service worker inited at base url: ${config.baseURL}`)}).catch(err=>{console.error("Service worker loader: Error while init of service worker",err)})}function serverInstall(){logger.leaveTrail("Service worker loader: Web server Worker installed.")}window.Phoenix.cache={},window.refreshServiceWorkerCache=function(doneCB){isServerReady?(logger.leaveTrail("Service worker loader: triggering REFRESH_CACHE"),wb.messageSW({type:"REFRESH_CACHE"}).then(({updatedFilesCount:updatedFilesCount})=>{if(logger.leaveTrail("Service worker loader: refresh cache updatedFilesCount: "+updatedFilesCount),window.Phoenix.cache.updatePendingReloadReason="refreshCache",window.Phoenix.cache.updatedFilesCount=updatedFilesCount||0,updatedFilesCount){let lessRefreshInterval=setInterval(()=>{window.less&&window.less.refresh&&(window.less.refresh(!0),clearInterval(lessRefreshInterval))},500)}doneCB&&doneCB()}).catch(err=>{console.error("Service worker loader: Error while triggering refresh cache",err),doneCB&&doneCB("REFRESH_CACHE Error")})):setTimeout(()=>{window.refreshServiceWorkerCache(doneCB)},100)},window.messageSW=function(params){return wb.messageSW(params)};const showSkipWaitingPrompt=async event=>{const updateAccepted=await shouldUpdate();updateAccepted&&wb.messageSkipWaiting()};wb.addEventListener("waiting",event=>{logger.leaveTrail("Service worker loader: A new service worker is pending load. Trying to update worker now."),window.Phoenix.cache.updatePendingReloadReason="skipWait",showSkipWaitingPrompt(event)}),wb.controlling.then(serverReady),wb.addEventListener("installed",event=>{event.isUpdate||serverInstall()}),wb.register()}
//# sourceMappingURL=virtual-server-loader.js.map
