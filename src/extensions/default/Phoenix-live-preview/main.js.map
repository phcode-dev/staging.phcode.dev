{"version":3,"sources":["extensions/default/Phoenix-live-preview/main.js"],"names":["define","require","exports","module","ExtensionUtils","brackets","getModule","EditorManager","CommandManager","Commands","Menus","WorkspaceManager","AppInit","ProjectManager","MainViewManager","Strings","Mustache","Metrics","FileViewController","NotificationUI","LiveDevelopment","utils","LIVE_PREVIEW_PANEL_ID","panelHTML","$icon","$iframe","$panel","$pinUrlBtn","$highlightBtn","$livePreviewPopBtn","$reloadBtn","loadStyleSheet","panel","urlPinned","tab","_setPanelVisibility","isVisible","toggleClass","show","_loadPreview","attr","hide","_startOrStopLivePreviewIfRequired","explicitClickOnLPIcon","visible","isInactive","openLivePreview","closeLivePreview","getConnectionIds","length","closed","_toggleVisibilityOnClick","_togglePinUrl","pinStatus","hasClass","removeClass","addClass","setLivePreviewPinned","countEvent","EVENT_TYPE","LIVE_PREVIEW","_updateLiveHighlightToggleStatus","isHighlightEnabled","get","FILE_LIVE_HIGHLIGHT","getChecked","_toggleLiveHighlights","execute","_popoutLivePreview","open","_setTitle","fileName","message","LIVE_DEV_SELECT_FILE_TO_PREVIEW","tooltip","LIVE_DEV_STATUS_TIP_OUT_OF_SYNC","document","getElementById","textContent","title","async","_createExtensionPanel","templateVars","livePreview","clickToReload","LIVE_DEV_CLICK_TO_RELOAD_PAGE","toggleLiveHighlight","LIVE_DEV_TOGGLE_LIVE_HIGHLIGHT","clickToPopout","LIVE_DEV_CLICK_POPOUT","clickToPinUnpin","LIVE_DEV_CLICK_TO_PIN_UNPIN","PANEL_MIN_SIZE","INITIAL_PANEL_SIZE","body","clientWidth","$","click","render","find","onload","createPluginPanel","recomputeLayout","_renderMarkdown","fullPath","newSrc","console","log","window","messageSW","type","root","paths","then","status","location","catch","err","error","_renderPreview","previewDetails","isMarkdownFile","src","getExtension","savedScrollPositions","_saveScrollPositionsIfPossible","currentSrc","getNoPreviewURL","scrollX","contentWindow","scrollY","e","force","saved","getPreviewDetails","URL","encodeURI","filePath","contentDocument","savePageCtrlSDisabledByPhoenix","addEventListener","key","navigator","platform","match","metaKey","ctrlKey","preventDefault","scrollTo","savedPositions","_projectFileChanges","evt","changedFile","isFile","isActive","isHTMLFile","_showPopoutNotificationIfNeeded","livePreviewEnabledOnProjectSwitch","_projectOpened","openAndSelectDocument","PROJECT_MANAGER","done","_projectClosed","_activeDocChanged","path","notificationKey","popoutMessageShown","localStorage","getItem","isPanelVisible","endsWith","createFromTemplate","GUIDED_LIVE_PREVIEW_POPOUT","allowedPlacements","autoCloseTimeS","dismissOnClick","setItem","_openLivePreviewURL","_event","currentPreviewDetails","appReady","fileMenu","on","EVENT_PROJECT_FILE_CHANGED","EVENT_PROJECT_OPEN","EVENT_PROJECT_CLOSE","register","CMD_LIVE_FILE_PREVIEW","FILE_LIVE_FILE_PREVIEW","getMenu","AppMenuBar","FILE_MENU","addMenuItem","setTimeout","EVENT_OPEN_PREVIEW_URL","EVENT_CONNECTION_CLOSE","EVENT_LIVE_HIGHLIGHT_PREF_CHANGED"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n */\n\n/*jslint vars: true, plusplus: true, devel: true, nomen: true, regexp: true, indent: 4, maxerr: 50 */\n/*global define, brackets */\n//jshint-ignore:no-start\n\ndefine(function (require, exports, module) {\n    const ExtensionUtils   = brackets.getModule(\"utils/ExtensionUtils\"),\n        EditorManager      = brackets.getModule(\"editor/EditorManager\"),\n        CommandManager     = brackets.getModule(\"command/CommandManager\"),\n        Commands           = brackets.getModule(\"command/Commands\"),\n        Menus              = brackets.getModule(\"command/Menus\"),\n        WorkspaceManager   = brackets.getModule(\"view/WorkspaceManager\"),\n        AppInit            = brackets.getModule(\"utils/AppInit\"),\n        ProjectManager     = brackets.getModule(\"project/ProjectManager\"),\n        MainViewManager    = brackets.getModule(\"view/MainViewManager\"),\n        Strings            = brackets.getModule(\"strings\"),\n        Mustache           = brackets.getModule(\"thirdparty/mustache/mustache\"),\n        Metrics            = brackets.getModule(\"utils/Metrics\"),\n        FileViewController = brackets.getModule(\"project/FileViewController\"),\n        NotificationUI = brackets.getModule(\"widgets/NotificationUI\"),\n        LiveDevelopment = brackets.getModule(\"LiveDevelopment/main\"),\n        utils = require('utils');\n\n    const LIVE_PREVIEW_PANEL_ID = \"live-preview-panel\";\n\n\n    // Templates\n    let panelHTML       = require(\"text!panel.html\");\n    ExtensionUtils.loadStyleSheet(module, \"live-preview.css\");\n\n    // jQuery objects\n    let $icon,\n        $iframe,\n        $panel,\n        $pinUrlBtn,\n        $highlightBtn,\n        $livePreviewPopBtn,\n        $reloadBtn;\n\n    // Other vars\n    let panel,\n        urlPinned,\n        tab = null;\n\n    function _setPanelVisibility(isVisible) {\n        if (isVisible) {\n            $icon.toggleClass(\"active\");\n            panel.show();\n            _loadPreview(true);\n        } else {\n            $icon.toggleClass(\"active\");\n            $iframe.attr('src', 'about:blank');\n            panel.hide();\n        }\n    }\n\n    function _startOrStopLivePreviewIfRequired(explicitClickOnLPIcon) {\n        let visible = panel.isVisible();\n        if(visible && LiveDevelopment.isInactive()) {\n            LiveDevelopment.openLivePreview();\n        } else if(visible && explicitClickOnLPIcon) {\n            LiveDevelopment.closeLivePreview();\n            LiveDevelopment.openLivePreview();\n        } else if(!visible && LiveDevelopment.getConnectionIds().length === 0 && (!tab || tab.closed)) {\n            LiveDevelopment.closeLivePreview();\n        }\n    }\n    function _toggleVisibilityOnClick() {\n        let visible = !panel.isVisible();\n        _setPanelVisibility(visible);\n        _startOrStopLivePreviewIfRequired(true);\n    }\n\n    function _togglePinUrl() {\n        let pinStatus = $pinUrlBtn.hasClass('pin-icon');\n        if(pinStatus){\n            $pinUrlBtn.removeClass('pin-icon').addClass('unpin-icon');\n        } else {\n            $pinUrlBtn.removeClass('unpin-icon').addClass('pin-icon');\n        }\n        urlPinned = !pinStatus;\n        LiveDevelopment.setLivePreviewPinned(urlPinned);\n        _loadPreview();\n        Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"pinURLBtn\", \"click\");\n    }\n\n    function _updateLiveHighlightToggleStatus() {\n        let isHighlightEnabled = CommandManager.get(Commands.FILE_LIVE_HIGHLIGHT).getChecked();\n        if(isHighlightEnabled){\n            $highlightBtn.removeClass('pointer-icon').addClass('pointer-fill-icon');\n        } else {\n            $highlightBtn.removeClass('pointer-fill-icon').addClass('pointer-icon');\n        }\n    }\n\n    function _toggleLiveHighlights() {\n        CommandManager.execute(Commands.FILE_LIVE_HIGHLIGHT);\n        Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"HighlightBtn\", \"click\");\n    }\n\n    function _popoutLivePreview() {\n        if(!tab || tab.closed){\n            tab = open();\n            Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"popoutBtn\", \"click\");\n        }\n        _loadPreview(true);\n    }\n\n    function _setTitle(fileName) {\n        let message = Strings.LIVE_DEV_SELECT_FILE_TO_PREVIEW,\n            tooltip = message;\n        if(fileName){\n            message = `${fileName} - ${Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC}`;\n            tooltip = `${Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC} - ${fileName}`;\n        }\n        document.getElementById(\"panel-live-preview-title\").textContent = message;\n        document.getElementById(\"live-preview-plugin-toolbar\").title = tooltip;\n    }\n\n    async function _createExtensionPanel() {\n        let templateVars = {\n            Strings: Strings,\n            livePreview: Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC,\n            clickToReload: Strings.LIVE_DEV_CLICK_TO_RELOAD_PAGE,\n            toggleLiveHighlight: Strings.LIVE_DEV_TOGGLE_LIVE_HIGHLIGHT,\n            clickToPopout: Strings.LIVE_DEV_CLICK_POPOUT,\n            clickToPinUnpin: Strings.LIVE_DEV_CLICK_TO_PIN_UNPIN\n        };\n        const PANEL_MIN_SIZE = 50;\n        const INITIAL_PANEL_SIZE = document.body.clientWidth/2.5;\n        $icon = $(\"#toolbar-go-live\");\n        $icon.click(_toggleVisibilityOnClick);\n        $panel = $(Mustache.render(panelHTML, templateVars));\n        $iframe = $panel.find(\"#panel-live-preview-frame\");\n        $pinUrlBtn = $panel.find(\"#pinURLButton\");\n        $highlightBtn = $panel.find(\"#highlightLPButton\");\n        $reloadBtn = $panel.find(\"#reloadLivePreviewButton\");\n        $livePreviewPopBtn = $panel.find(\"#livePreviewPopoutButton\");\n        $iframe[0].onload = function () {\n            $iframe.attr('srcdoc', null);\n        };\n\n        panel = WorkspaceManager.createPluginPanel(LIVE_PREVIEW_PANEL_ID, $panel,\n            PANEL_MIN_SIZE, $icon, INITIAL_PANEL_SIZE);\n\n        WorkspaceManager.recomputeLayout(false);\n        _updateLiveHighlightToggleStatus();\n        $pinUrlBtn.click(_togglePinUrl);\n        $highlightBtn.click(_toggleLiveHighlights);\n        $livePreviewPopBtn.click(_popoutLivePreview);\n        $reloadBtn.click(()=>{\n            LiveDevelopment.closeLivePreview();\n            LiveDevelopment.openLivePreview();\n            _loadPreview(true);\n            Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"reloadBtn\", \"click\");\n        });\n    }\n\n    function _renderMarkdown(fullPath, newSrc) {\n        console.log(`Markdown Static server _updateInstrumentedURLSInWorker: `, [fullPath], newSrc);\n        window.messageSW({\n            type: 'setInstrumentedURLs',\n            root: \"\",\n            paths: [fullPath]\n        }).then((status)=>{\n            console.log(`Markdown server received msg from Service worker: setInstrumentedURLs done: `, status);\n            $iframe.attr('srcdoc', null);\n            $iframe.attr('src', newSrc);\n            if(tab && !tab.closed){\n                tab.location = newSrc;\n            }\n        }).catch(err=>{\n            console.error(`Markdown error while from sw rendering failed for ${fullPath}: `, err);\n        });\n    }\n\n    function _renderPreview(previewDetails, newSrc) {\n        let fullPath = previewDetails.fullPath;\n        if(previewDetails.isMarkdownFile){\n            _renderMarkdown(fullPath, newSrc);\n            Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"render\", \"markdown\");\n        } else {\n            $iframe.attr('srcdoc', null);\n            $iframe.attr('src', newSrc);\n            $iframe[0].src = newSrc;\n            if(tab && !tab.closed){\n                tab.location = newSrc;\n            }\n            Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"render\", utils.getExtension(fullPath));\n        }\n    }\n\n    let savedScrollPositions = {};\n\n    function _saveScrollPositionsIfPossible() {\n        let currentSrc = $iframe.src || utils.getNoPreviewURL();\n        try{\n            let scrollX = $iframe[0].contentWindow.scrollX;\n            let scrollY = $iframe[0].contentWindow.scrollY;\n            savedScrollPositions[currentSrc] = {\n                scrollX: scrollX,\n                scrollY: scrollY\n            };\n            return {scrollX, scrollY, currentSrc};\n        }catch (e) {\n            return {scrollX: 0, scrollY: 0, currentSrc};\n        }\n    }\n\n    async function _loadPreview(force) {\n        if(panel.isVisible() || (tab && !tab.closed)){\n            let saved = _saveScrollPositionsIfPossible();\n            // panel-live-preview-title\n            let previewDetails = await utils.getPreviewDetails();\n            let newSrc = saved.currentSrc;\n            if (!urlPinned && previewDetails.URL) {\n                newSrc = encodeURI(previewDetails.URL);\n                _setTitle(previewDetails.filePath);\n            }\n            $iframe[0].onload = function () {\n                $iframe[0].contentDocument.savePageCtrlSDisabledByPhoenix = true;\n                $iframe[0].contentDocument.addEventListener(\"keydown\", function(e) {\n                    // inside live preview iframe, we disable ctrl-s browser save page dialog\n                    if (e.key === 's' && (navigator.platform.match(\"Mac\") ? e.metaKey : e.ctrlKey)) {\n                        e.preventDefault();\n                    }\n                }, false);\n                if(saved.currentSrc === newSrc){\n                    $iframe[0].contentWindow.scrollTo(saved.scrollX, saved.scrollY);\n                } else {\n                    let savedPositions = savedScrollPositions[newSrc];\n                    if(savedPositions){\n                        $iframe[0].contentWindow.scrollTo(savedPositions.scrollX, savedPositions.scrollY);\n                    }\n                }\n            };\n            if(saved.currentSrc !== newSrc || force === true){\n                $iframe.src = newSrc;\n                _renderPreview(previewDetails, newSrc);\n            }\n        }\n    }\n\n    async function _projectFileChanges(evt, changedFile) {\n        if(changedFile && changedFile.isFile && changedFile.fullPath && changedFile.fullPath !== '/fs/app/state.json'){\n            // we are getting this change event somehow.\n            // bug, investigate why we get this change event as a project file change.\n            const previewDetails = await utils.getPreviewDetails();\n            if(!(LiveDevelopment.isActive() && previewDetails.isHTMLFile)) {\n                // We force reload live preview on save for all non html preview-able file or\n                // if html file and live preview isnt active.\n                _loadPreview(true);\n            }\n            _showPopoutNotificationIfNeeded(changedFile.fullPath);\n        }\n    }\n\n    let livePreviewEnabledOnProjectSwitch = false;\n    async function _projectOpened() {\n        if(urlPinned){\n            _togglePinUrl();\n        }\n        $iframe[0].src = utils.getNoPreviewURL();\n        if(tab && !tab.closed){\n            tab.location = utils.getNoPreviewURL();\n        }\n        if(!panel.isVisible()){\n            return;\n        }\n        let previewDetails = await utils.getPreviewDetails();\n        if(previewDetails.fullPath){\n            FileViewController.openAndSelectDocument(previewDetails.fullPath, FileViewController.PROJECT_MANAGER)\n                .done(()=>{\n                    LiveDevelopment.closeLivePreview();\n                    LiveDevelopment.openLivePreview();\n                    _loadPreview(true);\n                });\n        }\n        _loadPreview(true);\n    }\n\n    function _projectClosed() {\n        LiveDevelopment.closeLivePreview();\n        livePreviewEnabledOnProjectSwitch = false;\n    }\n\n    function _activeDocChanged() {\n        if(!LiveDevelopment.isActive() && !livePreviewEnabledOnProjectSwitch\n            && (panel.isVisible() || (tab && !tab.closed))) {\n            // we do this only once after project switch if live preview for a doc is not active.\n            LiveDevelopment.closeLivePreview();\n            LiveDevelopment.openLivePreview();\n            livePreviewEnabledOnProjectSwitch = true;\n        }\n    }\n\n    function _showPopoutNotificationIfNeeded(path) {\n        let notificationKey = 'livePreviewPopoutShown';\n        let popoutMessageShown = localStorage.getItem(notificationKey);\n        if(!popoutMessageShown && WorkspaceManager.isPanelVisible(LIVE_PREVIEW_PANEL_ID)\n            && (path.endsWith('.html') || path.endsWith('.htm'))){\n            NotificationUI.createFromTemplate(Strings.GUIDED_LIVE_PREVIEW_POPOUT,\n                \"livePreviewPopoutButton\", {\n                    allowedPlacements: ['bottom'],\n                    autoCloseTimeS: 15,\n                    dismissOnClick: true}\n            );\n            localStorage.setItem(notificationKey, \"true\");\n        }\n    }\n\n    /**\n     * EVENT_OPEN_PREVIEW_URL triggers this once live preview infrastructure is instrumented and ready to accept live\n     * preview connections from browsers. So, if we have loaded an earlier live preview, that is most likely not\n     * instrumented code and just plain html for the previewed file. We force load the live preview again here to\n     * load the instrumented live preview code.\n     * @param _event\n     * @param previewDetails\n     * @return {Promise<void>}\n     * @private\n     */\n    async function _openLivePreviewURL(_event, previewDetails) {\n        _loadPreview(true);\n        const currentPreviewDetails = await utils.getPreviewDetails();\n        if(!currentPreviewDetails.isMarkdownFile && currentPreviewDetails.fullPath !== previewDetails.fullPath){\n            console.error(\"Live preview URLs differ between phoenix live preview extension and core live preview\",\n                currentPreviewDetails, previewDetails);\n        }\n    }\n\n    AppInit.appReady(function () {\n        _createExtensionPanel();\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED, _projectFileChanges);\n        MainViewManager.on(\"currentFileChange\", _loadPreview);\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN, _projectOpened);\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_CLOSE, _projectClosed);\n        EditorManager.on(\"activeEditorChange\", _activeDocChanged);\n        CommandManager.register(Strings.CMD_LIVE_FILE_PREVIEW,  Commands.FILE_LIVE_FILE_PREVIEW, function () {\n            _toggleVisibilityOnClick();\n        });\n        let fileMenu = Menus.getMenu(Menus.AppMenuBar.FILE_MENU);\n        fileMenu.addMenuItem(Commands.FILE_LIVE_FILE_PREVIEW, \"\");\n        // We always show the live preview panel on startup if there is a preview file\n        setTimeout(async ()=>{\n            LiveDevelopment.openLivePreview();\n            let previewDetails = await utils.getPreviewDetails();\n            if(previewDetails.filePath){\n                // only show if there is some file to preview and not the default no-preview preview on startup\n                _setPanelVisibility(true);\n            }\n        }, 1000);\n        LiveDevelopment.on(LiveDevelopment.EVENT_OPEN_PREVIEW_URL, _openLivePreviewURL);\n        LiveDevelopment.on(LiveDevelopment.EVENT_CONNECTION_CLOSE, function () {\n            // the connection close pool will take some time to settle\n            setTimeout(_startOrStopLivePreviewIfRequired, 15000);\n        });\n        LiveDevelopment.on(LiveDevelopment.EVENT_LIVE_HIGHLIGHT_PREF_CHANGED, _updateLiveHighlightToggleStatus);\n    });\n});\n\n\n"],"file":"main.js"}