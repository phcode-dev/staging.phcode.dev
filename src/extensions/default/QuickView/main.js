define(function(require,exports,module){var ColorUtils=brackets.getModule("utils/ColorUtils"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),CSSUtils=brackets.getModule("language/CSSUtils"),EditorManager=brackets.getModule("editor/EditorManager"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),FileUtils=brackets.getModule("file/FileUtils"),FileSystem=brackets.getModule("filesystem/FileSystem"),Menus=brackets.getModule("command/Menus"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),LanguageManager=brackets.getModule("language/LanguageManager"),Strings=brackets.getModule("strings"),ViewUtils=brackets.getModule("utils/ViewUtils"),TokenUtils=brackets.getModule("utils/TokenUtils"),PathUtils=brackets.getModule("thirdparty/path-utils/path-utils"),previewContainerHTML=require("text!QuickViewTemplate.html"),enabled,prefs=null,$previewContainer,$previewContent,lastMousePos,animationRequest,extensionlessImagePreview,CMD_ENABLE_QUICK_VIEW="view.enableQuickView",HOVER_DELAY=350,POINTER_HEIGHT=15,POPOVER_HORZ_MARGIN=5,styleLanguages=["css","text/x-less","sass","text/x-scss","stylus"],validProtocols=["data:","http:","https:","ftp:","file:"];(prefs=PreferencesManager.getExtensionPrefs("quickview")).definePreference("enabled","boolean",!0,{description:Strings.DESCRIPTION_QUICK_VIEW_ENABLED}),prefs.definePreference("extensionlessImagePreview","boolean",!0,{description:Strings.DESCRIPTION_EXTENSION_LESS_IMAGE_PREVIEW});var popoverState=null;function hidePreview(){popoverState&&(popoverState.visible?(popoverState.marker.clear(),$previewContent.empty(),$previewContainer.hide(),$previewContainer.removeClass("active")):window.clearTimeout(popoverState.hoverTimer),popoverState=null)}function positionPreview(editor,xpos,ypos,ybot){var previewWidth=$previewContainer.outerWidth(),top=ypos-$previewContainer.outerHeight()-POINTER_HEIGHT,left=xpos-previewWidth/2,elementRect={top:top,left:left-POPOVER_HORZ_MARGIN,height:$previewContainer.outerHeight()+POINTER_HEIGHT,width:previewWidth+2*POPOVER_HORZ_MARGIN},clip=ViewUtils.getElementClipSize($(editor.getRootElement()),elementRect);clip.left>0?left+=clip.left:clip.right>0&&(left-=clip.right),clip.top>0?(top=ybot+POINTER_HEIGHT,$previewContainer.removeClass("preview-bubble-above").addClass("preview-bubble-below")):$previewContainer.removeClass("preview-bubble-below").addClass("preview-bubble-above"),$previewContainer.css({left:left,top:top}).addClass("active")}function divContainsMouse($div,mousePos){var offset=$div.offset();return mousePos.clientX>=offset.left&&mousePos.clientX<=offset.left+$div.width()&&mousePos.clientY>=offset.top&&mousePos.clientY<=offset.top+$div.height()}function colorAndGradientPreviewProvider(editor,pos,token,line){var gradientRegEx=/-webkit-gradient\((?:[^\(]*?(?:\((?:[^\(]*?(?:\([^\)]*?\))*?)*?\))*?)*?\)|(?:(?:-moz-|-ms-|-o-|-webkit-|:|\s)((repeating-)?linear-gradient)|(?:-moz-|-ms-|-o-|-webkit-|:|\s)((repeating-)?radial-gradient))(\((?:[^\)]*?(?:\([^\)]*?\))*?)*?\))/gi,colorRegEx=new RegExp(ColorUtils.COLOR_REGEX),mode=TokenUtils.getModeAt(editor._codeMirror,pos,!1),isStyleSheet=-1!==styleLanguages.indexOf(mode);function areParensBalanced(str){var i,nestLevel=0,len;for(isStyleSheet&&(str=CSSUtils.reduceStyleSheetForRegExParsing(str)),len=str.length,i=0;i<len;i++)switch(str[i]){case"(":nestLevel++;break;case")":nestLevel--;break;case"\\":i++}return 0===nestLevel}function execGradientMatch(line,parensBalanced){var gradientMatch=parensBalanced?gradientRegEx.exec(line):null,prefix="",colorValue;return gradientMatch&&(-1!==gradientMatch[0].indexOf("@")?gradientMatch=null:(gradientMatch[0].match(/-o-|-moz-|-ms-|-webkit-/i)&&(prefix="-webkit-"),gradientMatch[1]?colorValue=gradientMatch[1]+gradientMatch[5]:gradientMatch[3]?colorValue=gradientMatch[3]+gradientMatch[5]:gradientMatch[0]&&(colorValue=gradientMatch[0],prefix=""))),{match:gradientMatch,prefix:prefix,colorValue:colorValue}}function execColorMatch(editor,line,pos){var colorMatch,ignoreNamedColors;function hyphenOnMatchBoundary(match,line){var beforeIndex,afterIndex;if(match){if((beforeIndex=match.index-1)>=0&&"-"===line[beforeIndex])return!0;if((afterIndex=match.index+match[0].length)<line.length&&"-"===line[afterIndex])return!0}return!1}function isNamedColor(match){if(match&&match[0]&&/^[a-z]+$/i.test(match[0]))return!0}do{if(!(colorMatch=colorRegEx.exec(line)))break;if(void 0===ignoreNamedColors){var mode=TokenUtils.getModeAt(editor._codeMirror,pos,!1).name;ignoreNamedColors=-1===styleLanguages.indexOf(mode)}}while(hyphenOnMatchBoundary(colorMatch,line)||ignoreNamedColors&&isNamedColor(colorMatch));return colorMatch}function splitStyleProperty(property){var token=/((?:[^"']|".*?"|'.*?')*?)([(,)]|$)/g,recurse=function(){for(var array=[];;){var result=token.exec(property);if("("===result[2]){var str=result[1].trim()+"("+recurse().join(",")+")";str+=(result=token.exec(property))[1],array.push(str)}else array.push(result[1].trim());if(","!==result[2])return array}};return recurse()}function isGradientColorStop(args){return args.length>0&&null!==args[0].match(colorRegEx)}function hasLengthInPixels(args){return args.length>1&&args[1].indexOf("px")>0}function ensureHexFormat(str){return/^0x/.test(str)?str.replace("0x","#"):str}function normalizeGradientExpressionForQuickview(expression){if(expression.indexOf("px")>0){var paramStart=expression.indexOf("(")+1,paramEnd=expression.lastIndexOf(")"),parameters,params=splitStyleProperty(expression.substring(paramStart,paramEnd)),lowerBound=0,upperBound=$previewContainer.width(),args,thisSize,i;for(i=0;i<params.length;i++)hasLengthInPixels(args=params[i].split(" "))&&(thisSize=parseFloat(args[1]),upperBound=Math.max(upperBound,thisSize),thisSize<0&&(lowerBound=Math.min(lowerBound,thisSize)));for(upperBound+=lowerBound=Math.abs(lowerBound),i=0;i<params.length;i++)isGradientColorStop(args=params[i].split(" "))&&hasLengthInPixels(args)&&(thisSize=0===upperBound?0:(parseFloat(args[1])+lowerBound)/upperBound*100,args[1]=thisSize+"%"),params[i]=args.join(" ");expression=expression.substring(0,paramStart)+params.join(", ")+expression.substring(paramEnd)}return expression}for(var parensBalanced=areParensBalanced(line),gradientMatch=execGradientMatch(line,parensBalanced),match=gradientMatch.match||execColorMatch(editor,line,pos),cm=editor._codeMirror;match;){if(pos.ch<match.index){if(!gradientMatch.match)break;gradientMatch={match:null,prefix:"",colorValue:null}}else if(pos.ch<=match.index+match[0].length){var previewCSS=gradientMatch.prefix+(gradientMatch.colorValue||match[0]),preview="<div class='color-swatch' style='background:"+(previewCSS=normalizeGradientExpressionForQuickview(ensureHexFormat(previewCSS)))+"'></div>",startPos={line:pos.line,ch:match.index},endPos={line:pos.line,ch:match.index+match[0].length},startCoords=cm.charCoords(startPos),xPos;return{start:startPos,end:endPos,content:preview,xpos:xPos=(cm.charCoords(endPos).left-startCoords.left)/2+startCoords.left,ytop:startCoords.top,ybot:startCoords.bottom,_previewCSS:previewCSS}}gradientMatch.match&&(gradientMatch=execGradientMatch(line,parensBalanced)),match=gradientMatch.match||execColorMatch(editor,line,pos)}return null}function imagePreviewProvider(editor,pos,token,line){var cm=editor._codeMirror,urlRegEx=/url\(([^\)]*)\)/gi,tokenString,urlMatch,sPos,ePos;if("string"===token.type)tokenString=token.string;else for(urlMatch=urlRegEx.exec(line);urlMatch&&!(pos.ch<urlMatch.index);){if(pos.ch<=urlMatch.index+urlMatch[0].length){tokenString=urlMatch[1];break}urlMatch=urlRegEx.exec(line)}if(!tokenString)return null;tokenString=tokenString.replace(/(^['"])|(['"]$)/g,"");var docPath=editor.document.file.fullPath,imgPath,parsed=PathUtils.parseUrl(tokenString),hasProtocol=""!==parsed.protocol&&-1!==validProtocols.indexOf(parsed.protocol.trim().toLowerCase()),ext=parsed.filenameExtension.replace(/^\./,""),language=LanguageManager.getLanguageForExtension(ext),id=language&&language.getId(),isImage="image"===id||"svg"===id,loadFromDisk=null;if(hasProtocol&&(isImage||!ext&&extensionlessImagePreview)?imgPath=tokenString:!hasProtocol&&isImage&&(imgPath="",loadFromDisk=window.path.normalize(FileUtils.getDirectoryPath(docPath)+tokenString)),!loadFromDisk&&!imgPath)return null;urlMatch?(sPos={line:pos.line,ch:urlMatch.index},ePos={line:pos.line,ch:urlMatch.index+urlMatch[0].length}):(sPos={line:pos.line,ch:token.start},ePos={line:pos.line,ch:token.end});var imgPreview="<div class='image-preview'>    <img src=\""+imgPath+'"></div>',coord=cm.charCoords(sPos),xpos,showHandler;function showHandlerWithImageURL(imageURL){$previewContainer.hide();var img=$previewContainer.find(".image-preview > img");imageURL&&(img[0].src=imageURL),img.on("load",function(){$previewContent.append("<div class='img-size'>"+this.naturalWidth+" &times; "+this.naturalHeight+" "+Strings.UNIT_PIXELS+"</div>"),$previewContainer.show(),positionPreview(editor,popoverState.xpos,popoverState.ytop,popoverState.ybot)}).on("error",function(e){e.preventDefault(),hidePreview()})}function _imageToDataURI(file,cb){let contentType="data:image;base64,";file.name.endsWith(".svg")&&(contentType="data:image/svg+xml;base64,"),file.read({encoding:window.fs.BYTE_ARRAY_ENCODING},function(err,content,encoding,stat){var base64=window.btoa(new Uint8Array(content).reduce((data,byte)=>data+String.fromCharCode(byte),"")),dataURL;cb(null,contentType+base64)})}return{start:sPos,end:ePos,content:imgPreview,onShow:function(){var imageFile;loadFromDisk?_imageToDataURI(FileSystem.getFileForPath(loadFromDisk),function(err,dataURL){showHandlerWithImageURL(dataURL)}):showHandlerWithImageURL()},xpos:(cm.charCoords(ePos).left-coord.left)/2+coord.left,ytop:coord.top,ybot:coord.bottom,_imgPath:imgPath||loadFromDisk}}function queryPreviewProviders(editor,pos,token){var line=editor.document.getLine(pos.line),popover=colorAndGradientPreviewProvider(editor,pos,token,line)||imagePreviewProvider(editor,pos,token,line);return popover?(popover.visible=!1,popover.editor=editor,popover):null}function getHoveredEditor(mousePos){var fullEditor=EditorManager.getCurrentFullEditor();if(fullEditor&&mousePos){var inlines=fullEditor.getInlineWidgets(),i,editor;for(i=0;i<inlines.length;i++){var $inlineEditorRoot=inlines[i].editor&&$(inlines[i].editor.getRootElement()),$otherDiv=inlines[i].$htmlContent;if($inlineEditorRoot&&divContainsMouse($inlineEditorRoot,mousePos)){editor=inlines[i].editor;break}if($otherDiv&&divContainsMouse($otherDiv,mousePos))return}return editor||divContainsMouse($(fullEditor.getRootElement()),mousePos)&&(editor=fullEditor),editor}}function showPreview(editor,popover){var token,cm;if(editor||(editor=getHoveredEditor(lastMousePos)),editor&&editor._codeMirror){var pos=(cm=editor._codeMirror).coordsChar({left:lastMousePos.clientX,top:lastMousePos.clientY});pos.ch>=editor.document.getLine(pos.line).length||(popover?popoverState=popover:(token=TokenUtils.getTokenAt(cm,pos),popoverState=$.extend({},popoverState,queryPreviewProviders(editor,pos,token))),popoverState&&popoverState.start&&popoverState.end&&(popoverState.marker=cm.markText(popoverState.start,popoverState.end,{className:"quick-view-highlight"}),$previewContent.append(popoverState.content),$previewContainer.show(),popoverState.visible=!0,popoverState.onShow?popoverState.onShow():positionPreview(editor,popoverState.xpos,popoverState.ytop,popoverState.ybot)))}else hidePreview()}function processMouseMove(){if(animationRequest=null,lastMousePos){var showImmediately=!1,editor=null;if(popoverState&&popoverState.visible){if((editor=getHoveredEditor(lastMousePos))&&editor._codeMirror){var cm,pos=editor._codeMirror.coordsChar({left:lastMousePos.clientX,top:lastMousePos.clientY});if(popoverState.start&&popoverState.end&&editor.posWithinRange(pos,popoverState.start,popoverState.end,!0)&&pos.ch<editor.document.getLine(pos.line).length)return}showImmediately=!0}hidePreview(),(popoverState={}).hoverTimer=window.setTimeout(function(){showPreview(editor)},showImmediately?0:HOVER_DELAY)}}function handleMouseMove(event){lastMousePos=null,enabled&&(event.which?hidePreview():(lastMousePos={clientX:event.clientX,clientY:event.clientY},animationRequest||(animationRequest=window.requestAnimationFrame(processMouseMove))))}function onActiveEditorChange(event,current,previous){hidePreview(),previous&&previous.document&&previous.document.off("change",hidePreview),current&&current.document&&current.document.on("change",hidePreview)}function updateMenuItemCheckmark(){CommandManager.get(CMD_ENABLE_QUICK_VIEW).setChecked(enabled)}function setExtensionlessImagePreview(_extensionlessImagePreview,doNotSave){extensionlessImagePreview!==_extensionlessImagePreview&&(extensionlessImagePreview=_extensionlessImagePreview,doNotSave||(prefs.set("extensionlessImagePreview",enabled),prefs.save()))}function setEnabled(_enabled,doNotSave){if(enabled!==_enabled){enabled=_enabled;var editorHolder=$("#editor-holder")[0];enabled?(editorHolder.addEventListener("mousemove",handleMouseMove,!0),editorHolder.addEventListener("scroll",hidePreview,!0),editorHolder.addEventListener("mouseout",hidePreview,!0),onActiveEditorChange(null,EditorManager.getActiveEditor(),null),EditorManager.on("activeEditorChange",onActiveEditorChange)):(editorHolder.removeEventListener("mousemove",handleMouseMove,!0),editorHolder.removeEventListener("scroll",hidePreview,!0),editorHolder.removeEventListener("mouseout",hidePreview,!0),onActiveEditorChange(null,null,EditorManager.getActiveEditor()),EditorManager.off("activeEditorChange",onActiveEditorChange),hidePreview()),doNotSave||(prefs.set("enabled",enabled),prefs.save())}updateMenuItemCheckmark()}function toggleEnableQuickView(){setEnabled(!enabled)}function _forceShow(popover){hidePreview(),lastMousePos={clientX:popover.xpos,clientY:Math.floor((popover.ybot+popover.ytop)/2)},showPreview(popover.editor,popover)}$previewContainer=$(previewContainerHTML).appendTo($("body")),$previewContent=$previewContainer.find(".preview-content"),ExtensionUtils.loadStyleSheet(module,"QuickView.less"),CommandManager.register(Strings.CMD_ENABLE_QUICK_VIEW,CMD_ENABLE_QUICK_VIEW,toggleEnableQuickView),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(CMD_ENABLE_QUICK_VIEW,null,Menus.AFTER,Commands.VIEW_TOGGLE_INSPECTION),setEnabled(prefs.get("enabled"),!0),setExtensionlessImagePreview(prefs.get("extensionlessImagePreview"),!0),prefs.on("change","enabled",function(){setEnabled(prefs.get("enabled"),!0)}),prefs.on("change","extensionlessImagePreview",function(){setExtensionlessImagePreview(prefs.get("extensionlessImagePreview"))}),exports._queryPreviewProviders=queryPreviewProviders,exports._forceShow=_forceShow});
//# sourceMappingURL=main.js.map
