define(function(require,exports,module){var EditorManager=brackets.getModule("editor/EditorManager"),ScopeManager=brackets.getModule("JSUtils/ScopeManager"),Session=brackets.getModule("JSUtils/Session"),MessageIds=JSON.parse(brackets.getModule("text!JSUtils/MessageIds.json")),TokenUtils=brackets.getModule("utils/TokenUtils"),Strings=brackets.getModule("strings"),ProjectManager=brackets.getModule("project/ProjectManager"),session=null,keywords=["define","alert","exports","require","module","arguments"];function initializeSession(editor){session=new Session(editor)}function getRefs(fileInfo,offset){return ScopeManager.postMessage({type:MessageIds.TERN_REFS,fileInfo:fileInfo,offset:offset}),ScopeManager.addPendingRequest(fileInfo.name,offset,MessageIds.TERN_REFS)}function requestFindRefs(session,document,offset){if(document&&session){var path=document.file.fullPath,fileInfo,ternPromise;return{promise:getRefs({type:MessageIds.TERN_FILE_INFO_TYPE_FULL,name:path,offsetLines:0,text:ScopeManager.filterText(session.getJavascriptText())},offset)}}}function handleRename(){var editor=EditorManager.getActiveEditor(),offset,handleFindRefs,token;if(editor)if(editor.getSelections().length>1)editor.displayErrorMessageAtCursor(Strings.ERROR_RENAME_MULTICURSOR);else if(initializeSession(editor),editor&&"javascript"===editor.getModeForSelection()){if(token=TokenUtils.getTokenAt(editor._codeMirror,editor._codeMirror.posFromIndex(session.getOffset())),!(keywords.indexOf(token.string)>=0)){var result=new $.Deferred;return offset=session.getOffset(),requestFindReferences(session,offset),result.promise()}editor.displayErrorMessageAtCursor(Strings.ERROR_RENAME_GENERAL)}function isInSameFile(obj,refsResp){var projectRoot=ProjectManager.getProjectRoot(),projectDir,fileName="";return projectRoot&&(projectDir=projectRoot.fullPath),projectDir&&refsResp&&refsResp.file&&0===refsResp.file.indexOf(projectDir)&&(fileName=refsResp.file.slice(projectDir.length)),obj&&(obj.file===refsResp.file||obj.file===fileName||obj.file===refsResp.file.slice(1,refsResp.file.length))}function handleFindRefs(refsResp){if(refsResp&&refsResp.references&&refsResp.references.refs){var inlineWidget=EditorManager.getFocusedInlineWidget(),editor=EditorManager.getActiveEditor(),refs=refsResp.references.refs,isInTextRange;if(inlineWidget)if(!!refs.find(function(item){return item.start.line<inlineWidget._startLine||item.end.line>inlineWidget._endLine}))return void editor.displayErrorMessageAtCursor(Strings.ERROR_RENAME_QUICKEDIT);var currentPosition=editor.posFromIndex(refsResp.offset),refsArray,primaryRef;if((refsArray=refs.filter(function(element){return isInSameFile(element,refsResp)})).length===refs.length)refsArray.find(function(element){return(element.start.line===currentPosition.line||element.end.line===currentPosition.line)&&currentPosition.ch<=element.end.ch&&currentPosition.ch>=element.start.ch}).primary=!0,editor.setSelections(refsArray)}}function requestFindReferences(session,offset){var response=requestFindRefs(session,session.editor.document,offset);response&&response.hasOwnProperty("promise")&&response.promise.done(handleFindRefs).fail(function(){result.reject()})}}exports.handleRename=handleRename});
//# sourceMappingURL=RenameIdentifier.js.map
