define(function(require,exports,module){var AppInit=brackets.getModule("utils/AppInit"),CodeHintManager=brackets.getModule("editor/CodeHintManager"),HTMLUtils=brackets.getModule("language/HTMLUtils"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),Strings=brackets.getModule("strings"),HTMLTags=require("text!HtmlTags.json"),HTMLAttributes=require("text!HtmlAttributes.json"),tags,attributes;function TagHints(){this.exclusion=null}function AttrHints(){this.globalAttributes=this.readGlobalAttrHints(),this.cachedHints=null,this.exclusion=""}PreferencesManager.definePreference("codehint.TagHints","boolean",!0,{description:Strings.DESCRIPTION_HTML_TAG_HINTS}),PreferencesManager.definePreference("codehint.AttrHints","boolean",!0,{description:Strings.DESCRIPTION_ATTR_HINTS}),TagHints.prototype.updateExclusion=function(){var textAfterCursor;this.exclusion&&this.tagInfo&&(textAfterCursor=this.tagInfo.tagName.substr(this.tagInfo.position.offset),CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)||(this.exclusion=null))},TagHints.prototype.hasHints=function(editor,implicitChar){var pos=editor.getCursorPos();return this.tagInfo=HTMLUtils.getTagInfo(editor,pos),this.editor=editor,null===implicitChar?this.tagInfo.position.tokenType===HTMLUtils.TAG_NAME&&this.tagInfo.position.offset>=0&&(0===this.tagInfo.position.offset?this.exclusion=this.tagInfo.tagName:this.updateExclusion(),!0):"<"===implicitChar&&(this.exclusion=this.tagInfo.tagName,!0)},TagHints.prototype.getHints=function(implicitChar){var query,result;return this.tagInfo=HTMLUtils.getTagInfo(this.editor,this.editor.getCursorPos()),this.tagInfo.position.tokenType===HTMLUtils.TAG_NAME&&this.tagInfo.position.offset>=0?(this.updateExclusion(),query=this.tagInfo.tagName.slice(0,this.tagInfo.position.offset),{hints:result=$.map(tags,function(value,key){if(0===key.indexOf(query))return key}).sort(),match:query,selectInitial:!0,handleWideResults:!1}):null},TagHints.prototype.insertHint=function(completion){var start={line:-1,ch:-1},end={line:-1,ch:-1},cursor=this.editor.getCursorPos(),charCount=0;if(this.tagInfo.position.tokenType===HTMLUtils.TAG_NAME){var textAfterCursor=this.tagInfo.tagName.substr(this.tagInfo.position.offset);charCount=CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)?this.tagInfo.position.offset:this.tagInfo.tagName.length}return end.line=start.line=cursor.line,start.ch=cursor.ch-this.tagInfo.position.offset,end.ch=start.ch+charCount,(this.exclusion||completion!==this.tagInfo.tagName)&&(start.ch!==end.ch?this.editor.document.replaceRange(completion,start,end):this.editor.document.replaceRange(completion,start),this.exclusion=null),!1},AttrHints.prototype.readGlobalAttrHints=function(){return $.map(attributes,function(value,key){if("true"===value.global)return key})},AttrHints.prototype._getValueHintsForAttr=function(query,tagName,attrName){var hints=[],tagPlusAttr,attrInfo=attributes[tagName+"/"+attrName]||attributes[attrName];return attrInfo&&("boolean"===attrInfo.type?hints=["false","true"]:attrInfo.attribOption&&(hints=attrInfo.attribOption)),hints},AttrHints.prototype.updateExclusion=function(attrNameOnly){if(this.exclusion&&this.tagInfo){var tokenType=this.tagInfo.position.tokenType,offset=this.tagInfo.position.offset,textAfterCursor;tokenType===HTMLUtils.ATTR_NAME?textAfterCursor=this.tagInfo.attr.name.substr(offset):attrNameOnly||tokenType!==HTMLUtils.ATTR_VALUE||(textAfterCursor=this.tagInfo.attr.value.substr(offset)),CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)||(this.exclusion=null)}},AttrHints.prototype.hasHints=function(editor,implicitChar){var pos=editor.getCursorPos(),tokenType,offset,query;if(this.editor=editor,this.tagInfo=HTMLUtils.getTagInfo(editor,pos),tokenType=this.tagInfo.position.tokenType,offset=this.tagInfo.position.offset,null===implicitChar){if(query=null,tokenType===HTMLUtils.ATTR_NAME)offset>=0&&(query=this.tagInfo.attr.name.slice(0,offset));else if(tokenType===HTMLUtils.ATTR_VALUE&&(query=this.tagInfo.position.offset>=0?this.tagInfo.attr.value.slice(0,offset):"",this.tagInfo.attr.name)){var hints=this._getValueHintsForAttr({queryStr:query},this.tagInfo.tagName,this.tagInfo.attr.name);if(hints instanceof Array){var i,foundPrefix=!1;for(i=0;i<hints.length;i++)if(0===hints[i].indexOf(query)){foundPrefix=!0;break}foundPrefix||(query=null)}}return offset>=0&&(tokenType===HTMLUtils.ATTR_NAME&&0===offset?this.exclusion=this.tagInfo.attr.name:this.updateExclusion(!1)),null!==query}return(" "===implicitChar||"'"===implicitChar||'"'===implicitChar||"="===implicitChar)&&(tokenType===HTMLUtils.ATTR_NAME&&(this.exclusion=this.tagInfo.attr.name),!0)},AttrHints.prototype.getHints=function(implicitChar){var cursor=this.editor.getCursorPos(),query={queryStr:null},tokenType,offset,result=[];if(this.tagInfo=HTMLUtils.getTagInfo(this.editor,cursor),tokenType=this.tagInfo.position.tokenType,offset=this.tagInfo.position.offset,tokenType!==HTMLUtils.ATTR_NAME&&tokenType!==HTMLUtils.ATTR_VALUE||(query.tag=this.tagInfo.tagName,offset>=0?(tokenType===HTMLUtils.ATTR_NAME?query.queryStr=this.tagInfo.attr.name.slice(0,offset):(query.queryStr=this.tagInfo.attr.value.slice(0,offset),query.attrName=this.tagInfo.attr.name),this.updateExclusion(!1)):tokenType===HTMLUtils.ATTR_VALUE&&(query.queryStr="",query.attrName=this.tagInfo.attr.name),query.usedAttr=HTMLUtils.getTagAttributes(this.editor,cursor)),query.tag&&null!==query.queryStr){var tagName=query.tag,attrName=query.attrName,filter=query.queryStr,unfiltered=[],hints;if(attrName?hints=this._getValueHintsForAttr(query,tagName,attrName):tags&&tags[tagName]&&tags[tagName].attributes&&(unfiltered=tags[tagName].attributes.concat(this.globalAttributes),hints=$.grep(unfiltered,function(attr,i){return $.inArray(attr,query.usedAttr)<0})),hints instanceof Array&&hints.length)return console.assert(!result.length),{hints:result=$.map(hints,function(item){if(0===item.indexOf(filter))return item}).sort(),match:query.queryStr,selectInitial:!0,handleWideResults:!1};if(hints instanceof Object&&hints.hasOwnProperty("done")){var deferred=$.Deferred();return hints.done(function(asyncHints){deferred.resolveWith(this,[{hints:asyncHints,match:query.queryStr,selectInitial:!0,handleWideResults:!1}])}),deferred}return null}},AttrHints.prototype.insertHint=function(completion){var cursor=this.editor.getCursorPos(),start={line:-1,ch:-1},end={line:-1,ch:-1},tokenType=this.tagInfo.position.tokenType,offset=this.tagInfo.position.offset,charCount=0,insertedName=!1,replaceExistingOne=this.tagInfo.attr.valueAssigned,endQuote="",shouldReplace=!0,textAfterCursor;return tokenType===HTMLUtils.ATTR_NAME?(textAfterCursor=this.tagInfo.attr.name.substr(offset),CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)?(charCount=offset,replaceExistingOne=!1):charCount=this.tagInfo.attr.name.length,!replaceExistingOne&&attributes&&attributes[completion]&&"flag"!==attributes[completion].type?(completion+='=""',insertedName=!0):completion===this.tagInfo.attr.name&&(shouldReplace=!1)):tokenType===HTMLUtils.ATTR_VALUE&&(textAfterCursor=this.tagInfo.attr.value.substr(offset),CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)?(charCount=offset,this.exclusion=null):charCount=this.tagInfo.attr.value.length,this.tagInfo.attr.hasEndQuote?completion===this.tagInfo.attr.value&&(shouldReplace=!1):(endQuote=this.tagInfo.attr.quoteChar)?completion+=endQuote:0===offset&&(completion='"'+completion+'"')),end.line=start.line=cursor.line,start.ch=cursor.ch-offset,end.ch=start.ch+charCount,shouldReplace&&(start.ch!==end.ch?this.editor.document.replaceRange(completion,start,end):this.editor.document.replaceRange(completion,start)),insertedName?(this.editor.setCursorPos(start.line,start.ch+completion.length-1),!0):(tokenType===HTMLUtils.ATTR_VALUE&&this.tagInfo.attr.hasEndQuote&&this.editor.setCursorPos(start.line,start.ch+completion.length+1),!1)},AppInit.appReady(function(){tags=JSON.parse(HTMLTags),attributes=JSON.parse(HTMLAttributes);var tagHints=new TagHints,attrHints=new AttrHints;CodeHintManager.registerHintProvider(tagHints,["html"],0),CodeHintManager.registerHintProvider(attrHints,["html"],0),exports.tagHintProvider=tagHints,exports.attrHintProvider=attrHints})});
//# sourceMappingURL=main.js.map
