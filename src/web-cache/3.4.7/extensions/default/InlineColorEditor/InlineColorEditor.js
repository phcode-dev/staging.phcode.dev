define(function(require,exports,module){var InlineWidget=brackets.getModule("editor/InlineWidget").InlineWidget,ColorEditor=require("ColorEditor").ColorEditor,ColorUtils=brackets.getModule("utils/ColorUtils"),MAX_USED_COLORS=7,lastOriginId=1;function InlineColorEditor(color,marker){this._color=color,this._marker=marker,this._isOwnChange=!1,this._isHostChange=!1,this._origin="+InlineColorEditor_"+lastOriginId++,this._handleColorChange=this._handleColorChange.bind(this),this._handleHostDocumentChange=this._handleHostDocumentChange.bind(this),InlineWidget.call(this)}function _colorSort(a,b){return a.count===b.count?0:a.count>b.count?-1:a.count<b.count?1:void 0}InlineColorEditor.prototype=Object.create(InlineWidget.prototype),InlineColorEditor.prototype.constructor=InlineColorEditor,InlineColorEditor.prototype.parentClass=InlineWidget.prototype,InlineColorEditor.prototype.colorEditor=null,InlineColorEditor.prototype._color=null,InlineColorEditor.prototype._marker=null,InlineColorEditor.prototype._isOwnChange=null,InlineColorEditor.prototype._isHostChange=null,InlineColorEditor.prototype._origin=null,InlineColorEditor.prototype.getCurrentRange=function(){var pos,start,end;if(!(start=(pos=this._marker&&this._marker.find())&&pos.from))return null;(end=pos.to)||(end={line:start.line});var line,matches=this.hostEditor.document.getLine(start.line).substr(start.ch).match(ColorUtils.COLOR_REGEX);return matches&&(void 0===end.ch||end.ch-start.ch<matches[0].length)&&(end.ch=start.ch+matches[0].length,this._marker.clear(),this._marker=this.hostEditor._codeMirror.markText(start,end)),void 0===end.ch?null:{start:start,end:end}},InlineColorEditor.prototype._handleColorChange=function(colorString){var self=this;if(colorString!==this._color){var range=this.getCurrentRange();if(!range)return;if(!this._isHostChange){var endPos={line:range.start.line,ch:range.start.ch+colorString.length};this._isOwnChange=!0,this.hostEditor.document.batchOperation(function(){self.hostEditor.setSelection(range.start,range.end),self.hostEditor.document.replaceRange(colorString,range.start,range.end,self._origin),self.hostEditor.setSelection(range.start,endPos),self._marker&&(self._marker.clear(),self._marker=self.hostEditor._codeMirror.markText(range.start,endPos))}),this._isOwnChange=!1}this._color=colorString}},InlineColorEditor.prototype.load=function(hostEditor){InlineColorEditor.prototype.parentClass.load.apply(this,arguments);var allColorsInDoc=this.hostEditor.document.getText().match(ColorUtils.COLOR_REGEX),swatchInfo=this._collateColors(allColorsInDoc,7);this.colorEditor=new ColorEditor(this.$htmlContent,this._color,this._handleColorChange,swatchInfo)},InlineColorEditor.prototype.onAdded=function(){InlineColorEditor.prototype.parentClass.onAdded.apply(this,arguments);var doc=this.hostEditor.document;doc.addRef(),doc.on("change",this._handleHostDocumentChange),this.hostEditor.setInlineWidgetHeight(this,this.colorEditor.getRootElement().outerHeight(),!0),this.colorEditor.focus()},InlineColorEditor.prototype.onClosed=function(){InlineColorEditor.prototype.parentClass.onClosed.apply(this,arguments),this._marker&&this._marker.clear();var doc=this.hostEditor.document;doc.off("change",this._handleHostDocumentChange),doc.releaseRef(),this.colorEditor.destroy()},InlineColorEditor.prototype._collateColors=function(originalArray,maxLength){var colorInfo={};originalArray.forEach(function(originalColor){var key=originalColor.toLowerCase();colorInfo[key]?colorInfo[key].count++:colorInfo[key]={value:originalColor,count:1}});var uniqueColors=$.map(colorInfo,function(info){return info});return uniqueColors.sort(_colorSort),uniqueColors.slice(0,maxLength)},InlineColorEditor.prototype._handleHostDocumentChange=function(){if(!this._isOwnChange){var range=this.getCurrentRange();if(range){var newColor=this.hostEditor.document.getRange(range.start,range.end);newColor!==this._color&&this.colorEditor.isValidColor(newColor)&&(this._isHostChange=!0,this.colorEditor.setColorFromString(newColor),this._isHostChange=!1)}else this.close()}},exports.InlineColorEditor=InlineColorEditor});
//# sourceMappingURL=InlineColorEditor.js.map
