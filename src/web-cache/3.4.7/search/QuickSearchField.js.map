{"version":3,"sources":["search/QuickSearchField.js"],"names":["define","require","exports","module","KeyEvent","QuickSearchField","$input","options","this","maxResults","_handleInput","bind","_handleKeyDown","undefined","highlightZeroResults","_highlightZeroResults","on","_firstHighlightIndex","firstHighlightIndex","_dropdownTop","offset","top","height","verticalAdjust","prototype","_pending","_commitPending","_displayedQuery","_displayedResults","_highlightIndex","_$dropdown","valueAtEvent","val","self","setTimeout","updateResults","event","keyCode","DOM_VK_RETURN","preventDefault","_doCommit","DOM_VK_DOWN","length","_updateHighlight","DOM_VK_UP","index","item","onCommit","explicit","$items","find","removeClass","eq","addClass","onHighlight","query","results","resultProvider","done","fail","realResults","_render","_closeDropdown","remove","_openDropdown","htmlContent","$","appendTo","css","position","left","width","outerWidth","click","$item","target","closest","html","error","hasOwnProperty","count","Math","min","i","formatter","setText","value","destroy"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n * Original work Copyright (c) 2013 - 2021 Adobe Systems Incorporated. All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/*\n * Text field with attached dropdown list that is updated (based on a provider) whenever the text changes.\n *\n * For styling, the DOM structure of the popup is as follows:\n *  body\n *      ol.quick-search-container\n *          li\n *          li.highlight\n *          li\n * And the text field is:\n *      input\n *      input.no-results\n */\ndefine(function (require, exports, module) {\n\n\n    var KeyEvent = require(\"utils/KeyEvent\");\n\n\n    /**\n     * Attaches to an existing <input> tag\n     *\n     * @constructor\n     *\n     * @param {!jQueryObject} $input\n     * @param {!function(string):($.Promise|Array.<*>|{error:?string}} options.resultProvider\n     *          Given the current search text, returns an an array of result objects, an error object, or a\n     *          Promise that yields one of those. If the Promise is still outstanding when the query next\n     *          changes, resultProvider() will be called again (without waiting for the earlier Promise), and\n     *          the Promise's result will be ignored.\n     *          If the provider yields [], or a non-null error string, input is decorated with \".no-results\"; if\n     *          the provider yields a null error string, input is not decorated.\n     *\n     * @param {!function(*, string):string} options.formatter\n     *          Converts one result object to a string of HTML text. Passed the item and the current query. The\n     *          outermost element must be <li>. The \".highlight\" class can be ignored as it is applied automatically.\n     * @param {!function(?*, string):void} options.onCommit\n     *          Called when an item is selected by clicking or pressing Enter. Passed the item and the current\n     *          query. If the current result list is not up to date with the query text at the time Enter is\n     *          pressed, waits until it is before running this callback. If Enter pressed with no results, passed\n     *          null. The popup remains open after this event.\n     * @param {!function(*, string, boolean):void} options.onHighlight\n     *          Called when an item is highlighted in the list. Passed the item, the current query, and a flag that is\n     *          true if the item was highlighted explicitly (arrow keys), not simply due to a results list update. Since\n     *          the top item in the list is always initially highlighted, every time the list is updated onHighlight()\n     *          is called with the top item and with the explicit flag set to false.\n     * @param {?number} options.maxResults\n     *          Maximum number of items from resultProvider() to display in the popup.\n     * @param {?number} options.verticalAdjust\n     *          Number of pixels to position the popup below where $input is when constructor is called. Useful\n     *          if UI is going to animate position after construction, but QuickSearchField may receive input\n     *          before the animation is done.\n     * @param {?number} options.firstHighlightIndex\n     *          Index of the result that is highlighted by default. null to not highlight any result.\n     */\n    function QuickSearchField($input, options) {\n        this.$input = $input;\n        this.options = options;\n\n        options.maxResults = options.maxResults || 10;\n\n        this._handleInput   = this._handleInput.bind(this);\n        this._handleKeyDown = this._handleKeyDown.bind(this);\n\n        if (options.highlightZeroResults !== undefined) {\n            this._highlightZeroResults = options.highlightZeroResults;\n        } else {\n            this._highlightZeroResults = true;\n        }\n\n        $input.on(\"input\", this._handleInput);\n        $input.on(\"keydown\", this._handleKeyDown);\n\n        // For search History this value is set to null\n        this._firstHighlightIndex = options.firstHighlightIndex;\n\n        this._dropdownTop = $input.offset().top + $input.height() + (options.verticalAdjust || 0);\n    }\n\n    /** @type {!Object} */\n    QuickSearchField.prototype.options = null;\n\n    /** @type {?$.Promise} Promise corresponding to latest resultProvider call. Any earlier promises ignored */\n    QuickSearchField.prototype._pending = null;\n\n    /** @type {boolean} True if Enter already pressed & just waiting for results to arrive before committing */\n    QuickSearchField.prototype._commitPending = false;\n\n    /** @type {?string} Value of $input corresponding to the _displayedResults list */\n    QuickSearchField.prototype._displayedQuery = null;\n\n    /** @type {?Array.<*>}  Latest resultProvider result */\n    QuickSearchField.prototype._displayedResults = null;\n\n    /** @type {?number} */\n    QuickSearchField.prototype._highlightIndex = null;\n\n    /** @type {?jQueryObject} Dropdown's <ol>, while open; null while closed */\n    QuickSearchField.prototype._$dropdown = null;\n\n    /** @type {!jQueryObject} */\n    QuickSearchField.prototype.$input = null;\n\n\n    /** When text field changes, update results list */\n    QuickSearchField.prototype._handleInput = function () {\n        this._pending = null;  // immediately invalidate any previous Promise\n\n        var valueAtEvent = this.$input.val();\n        var self = this;\n        // The timeout lets us skip over a backlog of multiple keyboard events when the provider is responding\n        // so slowly that JS execution can't keep up. All the remaining input events are serviced before the\n        // first timeout runs; then all the queued-up timeouts run in a row. All except the last one can no-op.\n        setTimeout(function () {\n            if (self.$input.val() === valueAtEvent) {\n                self.updateResults();\n            }\n        }, 0);\n    };\n\n    /** Handle special keys: Enter, Up/Down */\n    QuickSearchField.prototype._handleKeyDown = function (event) {\n        if (event.keyCode === KeyEvent.DOM_VK_RETURN) {\n            // Enter should always act on the latest results. If input has changed and we're still waiting for\n            // new results, just flag the 'commit' for later\n            if (this._displayedQuery === this.$input.val()) {\n                event.preventDefault();  // prevents keyup from going to someone else after we close\n                this._doCommit();\n            } else {\n                // Once the current wait resolves, _render() will run the commit\n                this._commitPending = true;\n            }\n        } else if (event.keyCode === KeyEvent.DOM_VK_DOWN) {\n            // Highlight changes are always done synchronously on the currently shown result list. If the list\n            // later changes, the highlight is reset to the top\n            if (this._displayedResults && this._displayedResults.length) {\n                if (this._highlightIndex === null || this._highlightIndex === this._displayedResults.length - 1) {\n                    this._highlightIndex = 0;\n                } else {\n                    this._highlightIndex++;\n                }\n                this._updateHighlight(true);\n            }\n            event.preventDefault(); // treated as Home key otherwise\n\n        } else if (event.keyCode === KeyEvent.DOM_VK_UP) {\n            if (this._displayedResults && this._displayedResults.length) {\n                if (this._highlightIndex === null || this._highlightIndex === 0) {\n                    this._highlightIndex = this._displayedResults.length - 1;\n                } else {\n                    this._highlightIndex--;\n                }\n                this._updateHighlight(true);\n            }\n            event.preventDefault(); // treated as End key otherwise\n        }\n    };\n\n    /** Call onCommit() immediately */\n    QuickSearchField.prototype._doCommit = function (index) {\n        var item;\n        if (this._displayedResults && this._displayedResults.length) {\n            if (index >= 0) {\n                item = this._displayedResults[index];\n            } else if (this._highlightIndex >= 0) {\n                item = this._displayedResults[this._highlightIndex];\n            }\n        }\n        this.options.onCommit(item, this._displayedQuery);\n    };\n\n    /** Update display to reflect value of _highlightIndex, & call onHighlight() */\n    QuickSearchField.prototype._updateHighlight = function (explicit) {\n        if (this._$dropdown) {\n            var $items = this._$dropdown.find(\"li\");\n            $items.removeClass(\"highlight\");\n            if (this._highlightIndex !== null) {\n                $items.eq(this._highlightIndex).addClass(\"highlight\");\n\n                this.options.onHighlight(this._displayedResults[this._highlightIndex], this.$input.val(), explicit);\n            }\n        }\n    };\n\n    /**\n     * Refresh the results dropdown, as if the user had changed the search text. Useful for providers that\n     * want to show cached data initially, then update the results with fresher data once available.\n     */\n    QuickSearchField.prototype.updateResults = function () {\n        this._pending = null;  // immediately invalidate any previous Promise\n\n        var query = this.$input.val();\n        var results = this.options.resultProvider(query);\n        if (results.done && results.fail) {\n            // Provider returned an async result - mark it as the latest Promise and if it's still latest when\n            // it resolves, render the results then\n            this._pending = results;\n            var self = this;\n            this._pending.done(function (realResults) {\n                if (self._pending === results) {\n                    self._render(realResults, query);\n                    this._pending = null;\n                }\n            });\n            if (this._pending) {\n                this._pending.fail(function () {\n                    if (self._pending === results) {\n                        self._render([], query);\n                        this._pending = null;\n                    }\n                });\n            }\n        } else {\n            // Synchronous result - render immediately\n            this._render(results, query);\n        }\n    };\n\n\n    /** Close dropdown result list if visible */\n    QuickSearchField.prototype._closeDropdown = function () {\n        if (this._$dropdown) {\n            this._$dropdown.remove();\n            this._$dropdown = null;\n        }\n    };\n\n    /**\n     * Open dropdown result list & populate with the given content\n     * @param {!string} htmlContent\n     */\n    QuickSearchField.prototype._openDropdown = function (htmlContent) {\n        if (!this._$dropdown) {\n            var self = this;\n            this._$dropdown = $(\"<ol class='quick-search-container'/>\").appendTo(\"body\")\n                .css({\n                    position: \"absolute\",\n                    top: this._dropdownTop,\n                    left: this.$input.offset().left,\n                    width: this.$input.outerWidth()\n                })\n                .click(function (event) {\n                    // Unlike the Enter key, where we wait to catch up with typing, clicking commits immediately\n                    var $item = $(event.target).closest(\"li\");\n                    if ($item.length) {\n                        self._doCommit($item.index());\n                    }\n                });\n        }\n        this._$dropdown.html(htmlContent);\n    };\n\n    /**\n     * Given finished provider result, format it into HTML and show in dropdown, and update \"no-results\" style.\n     * If an Enter key commit was pending from earlier, process it now.\n     * @param {!Array.<*>} results\n     * @param {!string} query\n     */\n    QuickSearchField.prototype._render = function (results, query) {\n        this._displayedQuery = query;\n        this._displayedResults = results;\n        if (this._firstHighlightIndex >= 0) {\n            this._highlightIndex = this._firstHighlightIndex;\n        } else {\n            this._highlightIndex = null;\n        }\n        // TODO: fixup to match prev value's item if possible?\n\n        if (results.error || results.length === 0) {\n            this._closeDropdown();\n            if (this._highlightZeroResults) {\n                this.$input.addClass(\"no-results\");\n            }\n        } else if (results.hasOwnProperty(\"error\")) {\n            // Error present but falsy - no results to show, but don't decorate with error style\n            this._closeDropdown();\n            if (this._highlightZeroResults) {\n                this.$input.removeClass(\"no-results\");\n            }\n        } else {\n            if (this._highlightZeroResults) {\n                this.$input.removeClass(\"no-results\");\n            }\n\n            var count = Math.min(results.length, this.options.maxResults),\n                html = \"\",\n                i;\n            for (i = 0; i < count; i++) {\n                html += this.options.formatter(results[i], query);\n            }\n            this._openDropdown(html);\n\n            // Highlight top item and trigger highlight callback\n            this._updateHighlight(false);\n        }\n\n        // If Enter key was pressed earlier, handle it now that we've gotten results back\n        if (this._commitPending) {\n            this._commitPending = false;\n            this._doCommit();\n        }\n    };\n\n\n    /**\n     * Programmatically changes the search text and updates the results.\n     * @param {!string} value\n     */\n    QuickSearchField.prototype.setText = function (value) {\n        this.$input.val(value);\n        this.updateResults();  // programmatic changes don't trigger \"input\" event\n    };\n\n    /**\n     * Closes the dropdown, and discards any pending Promises.\n     */\n    QuickSearchField.prototype.destroy = function () {\n        this._pending = null;  // immediately invalidate any pending Promise\n        this._closeDropdown();\n    };\n\n\n    exports.QuickSearchField = QuickSearchField;\n});\n"],"file":"QuickSearchField.js"}