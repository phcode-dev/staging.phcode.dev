{"version":3,"sources":["extensionsIntegrated/Phoenix/newly-added-features.js"],"names":["define","require","exports","module","FileViewController","DocumentManager","FileSystem","FileUtils","Metrics","_getUpdateMarkdownURL","Phoenix","baseURL","_getUpdateMarkdownLocalPath","VFS","getDefaultProjectDir","async","_getUpdateMarkdownText","Promise","resolve","reject","fetch","then","response","text","catch","_showNewFeatureMarkdownDoc","setTimeout","openFileAndAddToWorkingSet","countEvent","EVENT_TYPE","PLATFORM","_readMarkdownTextFile","markdownFile","getFileForPath","window","jsPromise","getDocumentText","e","_showNewUpdatesIfPresent","newMarkdownText","replace","currentMarkdownText","writeText","done","fail","console","error","init","firstBoot","testEnvironment"],"mappings":"AAsBAA,OAAO,SAAUC,QAASC,QAASC,QAC/B,MAAMC,mBAAwBH,QAAQ,8BAClCI,gBAAkBJ,QAAQ,4BAC1BK,WAAaL,QAAQ,yBACrBM,UAAYN,QAAQ,kBACpBO,QAAUP,QAAQ,iBAEtB,SAASQ,wBACL,OAAOC,QAAQC,QAAU,oDAG7B,SAASC,8BACL,OAAOF,QAAQG,IAAIC,uBAAyB,0BAGhDC,eAAeC,yBACX,OAAO,IAAIC,QAAQ,CAACC,QAASC,UACzBC,MAAMX,yBACDY,KAAKC,UAAYA,SAASC,QAC1BF,KAAKN,eAAgBQ,MAClBL,QAAQK,QAEXC,MAAML,UAInB,SAASM,6BAELC,WAAW,KACPtB,mBAAmBuB,2BAA2Bf,+BAC9CJ,QAAQoB,WAAWpB,QAAQqB,WAAWC,SAAU,YAAa,UAC9D,KAGPf,eAAegB,wBACX,IACI,IAAIC,aAAe1B,WAAW2B,eAAerB,+BAC7C,aAAasB,OAAOC,UAAU9B,gBAAgB+B,gBAAgBJ,eAChE,MAAMK,GACJ,MAAO,IAIftB,eAAeuB,2BAEX,IAAIC,uBAAyBvB,0BAA0BwB,QAAQ,MAAO,IAClEC,oBACJ,GAAGF,yBAD8BR,yBAAyBS,QAAQ,MAAO,IAC9B,CACvC,IAAIR,aAAe1B,WAAW2B,eAAerB,+BAE7CL,UAAUmC,UAAUV,aAAcO,iBAAiB,GAC9CI,KAAKlB,4BACLmB,KAAMP,IACHQ,QAAQC,MAAM,qDAAsDT,MAKpFnC,QAAQ6C,KAAO,WACPrC,QAAQsC,WAAcd,OAAOe,iBAC7BX","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/*globals Phoenix*/\n\ndefine(function (require, exports, module) {\n    const FileViewController    = require(\"project/FileViewController\"),\n        DocumentManager = require(\"document/DocumentManager\"),\n        FileSystem = require(\"filesystem/FileSystem\"),\n        FileUtils = require(\"file/FileUtils\"),\n        Metrics = require(\"utils/Metrics\");\n\n    function _getUpdateMarkdownURL() {\n        return Phoenix.baseURL + \"assets/default-project/en/Newly_added_features.md\";\n    }\n\n    function _getUpdateMarkdownLocalPath() {\n        return Phoenix.VFS.getDefaultProjectDir() + \"Newly_added_features.md\";\n    }\n\n    async function _getUpdateMarkdownText() {\n        return new Promise((resolve, reject)=>{\n            fetch(_getUpdateMarkdownURL())\n                .then(response => response.text())\n                .then(async function (text) {\n                    resolve(text);\n                })\n                .catch(reject);\n        });\n    }\n\n    function _showNewFeatureMarkdownDoc() {\n        // We wait for few seconds after boot to grab user attention\n        setTimeout(()=>{\n            FileViewController.openFileAndAddToWorkingSet(_getUpdateMarkdownLocalPath());\n            Metrics.countEvent(Metrics.EVENT_TYPE.PLATFORM, \"newFeatMD\", \"shown\");\n        }, 3000);\n    }\n\n    async function _readMarkdownTextFile() {\n        try{\n            let markdownFile = FileSystem.getFileForPath(_getUpdateMarkdownLocalPath());\n            return await window.jsPromise(DocumentManager.getDocumentText(markdownFile));\n        } catch(e){\n            return \"\";\n        }\n    }\n\n    async function _showNewUpdatesIfPresent() {\n        // codemirror documents are always \\n instead of \\r\\n line endings. so we strip here too\n        let newMarkdownText = (await _getUpdateMarkdownText()).replace(/\\r/g, '');\n        let currentMarkdownText = (await _readMarkdownTextFile()).replace(/\\r/g, '');\n        if(newMarkdownText !== currentMarkdownText){\n            let markdownFile = FileSystem.getFileForPath(_getUpdateMarkdownLocalPath());\n            // if the user overwrites the markdown file, then the user edited content will be nuked here.\n            FileUtils.writeText(markdownFile, newMarkdownText, true)\n                .done(_showNewFeatureMarkdownDoc)\n                .fail((e)=>{\n                    console.error(\"Error while showing new feature markdown on update\", e);\n                });\n        }\n    }\n\n    exports.init = function () {\n        if(!Phoenix.firstBoot && !window.testEnvironment){\n            _showNewUpdatesIfPresent();\n        }\n    };\n});\n"],"file":"newly-added-features.js"}