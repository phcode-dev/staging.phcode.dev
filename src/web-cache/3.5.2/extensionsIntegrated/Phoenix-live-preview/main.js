define(function(require,exports,module){const ExtensionUtils=require("utils/ExtensionUtils"),EditorManager=require("editor/EditorManager"),ExtensionInterface=require("utils/ExtensionInterface"),CommandManager=require("command/CommandManager"),Commands=require("command/Commands"),Menus=require("command/Menus"),WorkspaceManager=require("view/WorkspaceManager"),AppInit=require("utils/AppInit"),ProjectManager=require("project/ProjectManager"),MainViewManager=require("view/MainViewManager"),Strings=require("strings"),Mustache=require("thirdparty/mustache/mustache"),Metrics=require("utils/Metrics"),LiveDevelopment=require("LiveDevelopment/main"),LiveDevServerManager=require("LiveDevelopment/LiveDevServerManager"),NativeApp=require("utils/NativeApp"),StringUtils=require("utils/StringUtils"),FileSystem=require("filesystem/FileSystem"),BrowserStaticServer=require("./BrowserStaticServer"),NodeStaticServer=require("./NodeStaticServer"),TrustProjectHTML=require("text!./trust-project.html"),panelHTML=require("text!./panel.html"),utils=require("./utils"),StaticServer=Phoenix.browser.isTauri?NodeStaticServer:BrowserStaticServer,PREVIEW_TRUSTED_PROJECT_KEY="preview_trusted",PREVIEW_PROJECT_README_KEY="preview_readme",LIVE_PREVIEW_PANEL_ID="live-preview-panel",LIVE_PREVIEW_IFRAME_ID="panel-live-preview-frame",LIVE_PREVIEW_IFRAME_HTML='\n    <iframe id="panel-live-preview-frame" title="Live Preview" style="border: none"\n             width="100%" height="100%" seamless="true"\n             src=\'about:blank\'\n             sandbox="allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-scripts allow-forms allow-modals allow-pointer-lock">\n    </iframe>\n    ';function _isLiveHighlightEnabled(){return CommandManager.get(Commands.FILE_LIVE_HIGHLIGHT).getChecked()}function _getTrustProjectPage(){const trustProjectMessage=StringUtils.format(Strings.TRUST_PROJECT,path.basename(ProjectManager.getProjectRoot().fullPath)),templateVars={trustProjectMessage:trustProjectMessage,Strings:Strings};return Mustache.render(TrustProjectHTML,templateVars)}function _isProjectPreviewTrusted(){if(Phoenix.isTestWindow||Phoenix.browser.isTauri)return!0;const projectPath=ProjectManager.getProjectRoot().fullPath;if(projectPath===ProjectManager.getWelcomeProjectPath()||projectPath===ProjectManager.getExploreProjectPath())return!0;const isTrustedProject=`${PREVIEW_TRUSTED_PROJECT_KEY}-${projectPath}`;return!!PhStore.getItem(isTrustedProject)}function _setProjectReadmePreviewdOnce(){const projectPath=ProjectManager.getProjectRoot().fullPath,previewReadmeKey=`${PREVIEW_PROJECT_README_KEY}-${projectPath}`;PhStore.setItem(previewReadmeKey,!0)}function _isProjectReadmePreviewdOnce(){const projectPath=ProjectManager.getProjectRoot().fullPath,previewReadmeKey=`${PREVIEW_PROJECT_README_KEY}-${projectPath}`;return!!PhStore.getItem(previewReadmeKey)}function _createStaticServer(){var config={pathResolver:ProjectManager.makeProjectRelativeIfPossible,root:ProjectManager.getProjectRoot().fullPath};return new StaticServer.StaticServer(config)}let $icon,$iframe,$panel,$pinUrlBtn,$highlightBtn,$livePreviewPopBtn,$reloadBtn;window.addEventListener("blur",function(){setTimeout(function(){const editor=EditorManager.getActiveEditor();_isLiveHighlightEnabled()&&editor&&(document.activeElement!==document.getElementById(LIVE_PREVIEW_IFRAME_ID)||utils.isHTMLFile(editor.document.file.fullPath)||editor.focus())},100)}),window._trustCurrentProjectForLivePreview=function(){$iframe.attr("srcdoc",null);const projectPath=ProjectManager.getProjectRoot().fullPath,isTrustedProjectKey=`${PREVIEW_TRUSTED_PROJECT_KEY}-${projectPath}`;PhStore.setItem(isTrustedProjectKey,!0),_loadPreview(!0)},ExtensionInterface.registerExtensionInterface(ExtensionInterface._DEFAULT_EXTENSIONS_INTERFACE_NAMES.PHOENIX_LIVE_PREVIEW,exports),ExtensionUtils.loadStyleSheet(module,"live-preview.css");let panel,urlPinned,currentLivePreviewURL="",currentPreviewFile="";function _blankIframe(){let newIframe=$(LIVE_PREVIEW_IFRAME_HTML);newIframe.insertAfter($iframe),$iframe.remove(),$iframe=newIframe}let panelShownOnce=!1;function _setPanelVisibility(isVisible){isVisible?(panelShownOnce=!0,$icon.toggleClass("active"),panel.show(),_loadPreview(!0)):($icon.toggleClass("active"),_blankIframe(),panel.hide())}function _startOrStopLivePreviewIfRequired(explicitClickOnLPIcon){let visible=panel&&panel.isVisible();visible&&(LiveDevelopment.isInactive()||explicitClickOnLPIcon)?LiveDevelopment.openLivePreview():visible||!LiveDevelopment.isActive()||StaticServer.hasActiveLivePreviews()||LiveDevelopment.closeLivePreview()}function _toggleVisibilityOnClick(){let visible;_setPanelVisibility(!panel.isVisible()),_startOrStopLivePreviewIfRequired(!0)}function _togglePinUrl(){let pinStatus=$pinUrlBtn.hasClass("pin-icon");pinStatus?$pinUrlBtn.removeClass("pin-icon").addClass("unpin-icon"):$pinUrlBtn.removeClass("unpin-icon").addClass("pin-icon"),urlPinned=!pinStatus,LiveDevelopment.setLivePreviewPinned(urlPinned,currentPreviewFile),_loadPreview(!0),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"pinURLBtn","click")}function _updateLiveHighlightToggleStatus(){let isHighlightEnabled;_isLiveHighlightEnabled()?$highlightBtn.removeClass("pointer-icon").addClass("pointer-fill-icon"):$highlightBtn.removeClass("pointer-fill-icon").addClass("pointer-icon")}function _toggleLiveHighlights(){LiveDevelopment.togglePreviewHighlight(),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"HighlightBtn","click")}function _popoutLivePreview(){const openURL=StaticServer.getTabPopoutURL(currentLivePreviewURL);NativeApp.openURLInDefaultBrowser(openURL,"livePreview"),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"popoutBtn","click"),_loadPreview(!0),_setPanelVisibility(!1)}function _setTitle(fileName){let message=Strings.LIVE_DEV_SELECT_FILE_TO_PREVIEW,tooltip=message;fileName&&(message=`${fileName} - ${Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC}`,tooltip=`${Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC} - ${fileName}`),document.getElementById("panel-live-preview-title").textContent=message,document.getElementById("live-preview-plugin-toolbar").title=tooltip}async function _createExtensionPanel(){let templateVars={Strings:Strings,livePreview:Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC,clickToReload:Strings.LIVE_DEV_CLICK_TO_RELOAD_PAGE,toggleLiveHighlight:Strings.LIVE_DEV_TOGGLE_LIVE_HIGHLIGHT,clickToPopout:Strings.LIVE_DEV_CLICK_POPOUT,clickToPinUnpin:Strings.LIVE_DEV_CLICK_TO_PIN_UNPIN};const PANEL_MIN_SIZE=50,INITIAL_PANEL_SIZE=document.body.clientWidth/2.5;($icon=$("#toolbar-go-live")).click(_toggleVisibilityOnClick),$panel=$(Mustache.render(panelHTML,templateVars)),$iframe=$panel.find("#panel-live-preview-frame"),$pinUrlBtn=$panel.find("#pinURLButton"),$highlightBtn=$panel.find("#highlightLPButton"),$reloadBtn=$panel.find("#reloadLivePreviewButton"),$livePreviewPopBtn=$panel.find("#livePreviewPopoutButton"),$iframe[0].onload=function(){$iframe.attr("srcdoc",null)};const popoutSupported=Phoenix.browser.isTauri||Phoenix.browser.desktop.isChromeBased||Phoenix.browser.desktop.isFirefox;popoutSupported||$livePreviewPopBtn.addClass("forced-hidden"),panel=WorkspaceManager.createPluginPanel(LIVE_PREVIEW_PANEL_ID,$panel,50,$icon,INITIAL_PANEL_SIZE),WorkspaceManager.recomputeLayout(!1),_updateLiveHighlightToggleStatus(),$pinUrlBtn.click(_togglePinUrl),$highlightBtn.click(_toggleLiveHighlights),$livePreviewPopBtn.click(_popoutLivePreview),$reloadBtn.click(()=>{LiveDevelopment.openLivePreview(),_loadPreview(!0),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"reloadBtn","click")})}async function _loadPreview(force){const isPreviewLoadable=panel.isVisible()||StaticServer.hasActiveLivePreviews();if(!isPreviewLoadable)return;let previewDetails=await StaticServer.getPreviewDetails();if(urlPinned&&!force)return;let newSrc=encodeURI(previewDetails.URL);if($iframe.attr("src")===newSrc&&!force)return;urlPinned||(currentLivePreviewURL=newSrc,currentPreviewFile=previewDetails.fullPath);let relativeOrFullPath=ProjectManager.makeProjectRelativeIfPossible(currentPreviewFile);if(_setTitle(relativeOrFullPath=Phoenix.app.getDisplayPath(relativeOrFullPath)),panel.isVisible()){let newIframe=$(LIVE_PREVIEW_IFRAME_HTML);newIframe.insertAfter($iframe),$iframe.remove(),$iframe=newIframe,_isProjectPreviewTrusted()?$iframe.attr("src",currentLivePreviewURL):$iframe.attr("srcdoc",_getTrustProjectPage())}Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"render",utils.getExtension(previewDetails.fullPath)),StaticServer.redirectAllTabs(currentLivePreviewURL)}async function _projectFileChanges(evt,changedFile){if(changedFile&&utils.isPreviewableFile(changedFile.fullPath)){const previewDetails=await StaticServer.getPreviewDetails();LiveDevelopment.isActive()&&previewDetails.isHTMLFile||_loadPreview(!0)}}function _openReadmeMDIfFirstTime(){if(!_isProjectReadmePreviewdOnce()&&!Phoenix.isTestWindow){const readmePath=`${ProjectManager.getProjectRoot().fullPath}README.md`,fileEntry=FileSystem.getFileForPath(readmePath);fileEntry.exists(function(err,exists){!err&&exists&&(CommandManager.execute(Commands.FILE_ADD_TO_WORKING_SET,{fullPath:readmePath}),_setProjectReadmePreviewdOnce())})}}async function _projectOpened(_evt){_openReadmeMDIfFirstTime(),LiveDevelopment.isActive()||!panel.isVisible()&&!StaticServer.hasActiveLivePreviews()||LiveDevelopment.openLivePreview(),urlPinned&&_togglePinUrl(),$iframe.attr("src",StaticServer.getNoPreviewURL()),panel.isVisible()&&_loadPreview(!0)}function _projectClosed(){urlPinned&&_togglePinUrl(),LiveDevelopment.closeLivePreview()}function _activeDocChanged(){LiveDevelopment.isActive()||!panel.isVisible()&&!StaticServer.hasActiveLivePreviews()||LiveDevelopment.openLivePreview()}async function _openLivePreviewURL(_event,previewDetails){_loadPreview(!0);const currentPreviewDetails=await StaticServer.getPreviewDetails();currentPreviewDetails.isHTMLFile&&currentPreviewDetails.fullPath!==previewDetails.fullPath&&console.error("Live preview URLs differ between phoenix live preview extension and core live preview",currentPreviewDetails,previewDetails)}function _currentFileChanged(_event,newFile){newFile&&utils.isPreviewableFile(newFile.fullPath)&&_loadPreview()}AppInit.appReady(function(){if(Phoenix.isSpecRunnerWindow)return;_createExtensionPanel(),StaticServer.init(),LiveDevServerManager.registerServer({create:_createStaticServer},5),ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED,_projectFileChanges),MainViewManager.on("currentFileChange",_currentFileChanged),ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN,_projectOpened),ProjectManager.on(ProjectManager.EVENT_PROJECT_CLOSE,_projectClosed),EditorManager.on("activeEditorChange",_activeDocChanged),CommandManager.register(Strings.CMD_LIVE_FILE_PREVIEW,Commands.FILE_LIVE_FILE_PREVIEW,function(){_toggleVisibilityOnClick()});let fileMenu=Menus.getMenu(Menus.AppMenuBar.FILE_MENU);fileMenu.addMenuItem(Commands.FILE_LIVE_FILE_PREVIEW,"",Menus.AFTER,Commands.FILE_EXTENSION_MANAGER),fileMenu.addMenuDivider(Menus.BEFORE,Commands.FILE_LIVE_FILE_PREVIEW),LiveDevelopment.openLivePreview(),LiveDevelopment.on(LiveDevelopment.EVENT_OPEN_PREVIEW_URL,_openLivePreviewURL),LiveDevelopment.on(LiveDevelopment.EVENT_LIVE_HIGHLIGHT_PREF_CHANGED,_updateLiveHighlightToggleStatus),LiveDevelopment.on(LiveDevelopment.EVENT_LIVE_PREVIEW_RELOAD,()=>{_loadPreview(!0)}),StaticServer.on(StaticServer.EVENT_SERVER_READY,function(_evt,event){StaticServer.getPreviewDetails().then(previewDetails=>{previewDetails.URL&&!panelShownOnce&&_setPanelVisibility(!0),_loadPreview(!0)})});let consecutiveEmptyClientsCount=0;setInterval(()=>{StaticServer.hasActiveLivePreviews()?consecutiveEmptyClientsCount=0:consecutiveEmptyClientsCount++,consecutiveEmptyClientsCount>5&&_startOrStopLivePreviewIfRequired()},1e3),_projectOpened()}),exports.LIVE_PREVIEW_PANEL_ID=LIVE_PREVIEW_PANEL_ID});
//# sourceMappingURL=main.js.map
