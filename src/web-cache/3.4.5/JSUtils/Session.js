define(function(require,exports,module){var StringMatch=require("utils/StringMatch"),TokenUtils=require("utils/TokenUtils"),LanguageManager=require("language/LanguageManager"),HTMLUtils=require("language/HTMLUtils"),HintUtils=require("JSUtils/HintUtils"),ScopeManager=require("JSUtils/ScopeManager"),Acorn=require("thirdparty/acorn/dist/acorn"),Acorn_Loose=require("thirdparty/acorn/dist/acorn_loose");function Session(editor){this.editor=editor,this.path=editor.document.file.fullPath,this.ternHints=[],this.ternGuesses=null,this.fnType=null,this.builtins=null}function getLexicalState(token){return token.state.lexical?token.state.lexical:token.state.localState&&token.state.localState.lexical?token.state.localState.lexical:void 0}function penalizeUnderscoreValueCompare(a,b){var aName=a.value.toLowerCase(),bName=b.value.toLowerCase();return"_"===aName[0]&&"_"!==bName[0]?1:"_"===bName[0]&&"_"!==aName[0]?-1:aName<bName?-1:aName>bName?1:0}Session.prototype._getBuiltins=function(){return this.builtins||(this.builtins=ScopeManager.getBuiltins(),this.builtins.push("requirejs.js")),this.builtins},Session.prototype.getPath=function(){return this.path},Session.prototype.getCursor=function(){return this.editor.getCursorPos()},Session.prototype.getLine=function(line){var doc;return this.editor.document.getLine(line)},Session.prototype.getOffset=function(){var cursor=this.getCursor();return this.getOffsetFromCursor(cursor)},Session.prototype.getOffsetFromCursor=function(cursor){return this.editor.indexFromPos(cursor)},Session.prototype.getToken=function(cursor){var cm=this.editor._codeMirror;return cursor?TokenUtils.getTokenAt(cm,cursor):TokenUtils.getTokenAt(cm,this.getCursor())},Session.prototype.getNextTokenOnLine=function(cursor){return(cursor=this.getNextCursorOnLine(cursor))?this.getToken(cursor):null},Session.prototype.getNextCursorOnLine=function(cursor){var doc,line=this.editor.document.getLine(cursor.line);return cursor.ch<line.length?{ch:cursor.ch+1,line:cursor.line}:null},Session.prototype._getPreviousToken=function(cursor){var token,prev=this.getToken(cursor),doc=this.editor.document;do{if(prev.start<cursor.ch)cursor.ch=prev.start;else if(prev.start>0)cursor.ch=prev.start-1;else{if(!(cursor.line>0))break;cursor.ch=doc.getLine(cursor.line-1).length,cursor.line--}prev=this.getToken(cursor)}while(!/\S/.test(prev.string));return prev},Session.prototype.getNextToken=function(cursor,skipWhitespace){var token,next=this.getToken(cursor),doc=this.editor.document;do{if(next.end>cursor.ch)cursor.ch=next.end;else if(next.end<doc.getLine(cursor.line).length)cursor.ch=next.end+1;else{if(!doc.getLine(cursor.line+1)){next=null;break}cursor.ch=0,cursor.line++}next=this.getToken(cursor)}while(skipWhitespace&&!/\S/.test(next.string));return next},Session.prototype.getQuery=function(){var cursor=this.getCursor(),token=this.getToken(cursor),query="",start=cursor.ch,end=start;if(token){for(var line=this.getLine(cursor.line);start>0&&HintUtils.maybeIdentifier(line[start-1]);)start--;query=line.substring(start,end)}return query},Session.prototype.getContext=function(cursor,depth){var token=this.getToken(cursor);return void 0===depth&&(depth=0),")"===token.string?(this._getPreviousToken(cursor),this.getContext(cursor,++depth)):"("===token.string?(this._getPreviousToken(cursor),this.getContext(cursor,--depth)):depth>0||"."===token.string?(this._getPreviousToken(cursor),this.getContext(cursor,depth)):token.string},Session.prototype.findPreviousDot=function(){var cursor=this.getCursor(),token=this.getToken(cursor);return token&&"."===token.string?cursor:(token=this._getPreviousToken(cursor))&&"."===token.string?cursor:void 0},Session.prototype.getFunctionInfo=function(){var inFunctionCall=!1,cursor=this.getCursor(),functionCallPos,token=this.getToken(cursor),lexical,self=this,foundCall=!1;function isOnFunctionIdentifier(){var type=token.type,nextToken,localLexical,localCursor={line:cursor.line,ch:token.end};return"variable-2"!==type&&"variable"!==type&&"property"!==type||!(nextToken=self.getNextToken(localCursor,!0))||"("!==nextToken.string?null:localLexical=getLexicalState(nextToken)}function isInFunctionalCall(lex){return lex&&("call"===lex.info||void 0===lex.info&&("]"===lex.type||"}"===lex.type)&&"call"===lex.prev.info)}if(token&&((foundCall=isInFunctionalCall(lexical=getLexicalState(token)))||(foundCall=isInFunctionalCall(lexical=isOnFunctionIdentifier())),foundCall)){void 0===lexical.info&&(lexical=lexical.prev);var col="call"===lexical.info?lexical.column:lexical.prev.column,line,e,found;for(line=this.getCursor().line,e=Math.max(0,line-9),found=!1;line>=e;--line)if("("===this.getLine(line).charAt(col)){found=!0;break}found&&(inFunctionCall=!0,functionCallPos={line:line,ch:col})}return{inFunctionCall:inFunctionCall,functionCallPos:functionCallPos}},Session.prototype.getType=function(){var propertyLookup=!1,context=null,cursor=this.getCursor(),token=this.getToken(cursor);return token&&("property"===token.type&&(propertyLookup=!0),(cursor=this.findPreviousDot())&&(propertyLookup=!0,context=this.getContext(cursor))),{property:propertyLookup,context:context}},Session.prototype.getHints=function(query,matcher){void 0===query&&(query="");var MAX_DISPLAYED_HINTS=500,type=this.getType(),builtins=this._getBuiltins(),needGuesses=!1,hints;function isBuiltin(origin){return-1!==builtins.indexOf(origin)}function filterWithQueryAndMatcher(hints,matcher){var matchResults;return $.map(hints,function(hint){var searchResult=matcher.match(hint.value,query);return searchResult&&(searchResult.value=hint.value,searchResult.guess=hint.guess,searchResult.type=hint.type,void 0!==hint.keyword&&(searchResult.keyword=hint.keyword),void 0!==hint.literal&&(searchResult.literal=hint.literal),void 0!==hint.depth&&(searchResult.depth=hint.depth),hint.doc&&(searchResult.doc=hint.doc),hint.url&&(searchResult.url=hint.url),!type.property&&!type.showFunctionType&&hint.origin&&isBuiltin(hint.origin)?searchResult.builtin=1:searchResult.builtin=0),searchResult})}return type.property?(0===(hints=filterWithQueryAndMatcher(hints=this.ternHints||[],matcher)).length&&(this.ternGuesses?hints=filterWithQueryAndMatcher(this.ternGuesses,matcher):needGuesses=!0),StringMatch.multiFieldSort(hints,["matchGoodness",penalizeUnderscoreValueCompare])):(hints=filterWithQueryAndMatcher(hints=(hints=(hints=this.ternHints||[]).concat(HintUtils.LITERALS)).concat(HintUtils.KEYWORDS),matcher),StringMatch.multiFieldSort(hints,["matchGoodness","depth","builtin",penalizeUnderscoreValueCompare])),hints.length>500&&(hints=hints.slice(0,500)),{hints:hints,needGuesses:needGuesses}},Session.prototype.setTernHints=function(newHints){this.ternHints=newHints},Session.prototype.setGuesses=function(newGuesses){this.ternGuesses=newGuesses},Session.prototype.setFnType=function(newFnType){this.fnType=newFnType},Session.prototype.setFunctionCallPos=function(functionCallPos){this.functionCallPos=functionCallPos},Session.prototype.getParameterHint=function(){var fnHint=this.fnType,cursor=this.getCursor(),token=this.getToken(this.functionCallPos),start={line:this.functionCallPos.line,ch:token.start},fragment=this.editor.document.getRange(start,{line:this.functionCallPos.line+10,ch:0}),ast;try{ast=Acorn.parse(fragment)}catch(e){ast=Acorn_Loose.parse(fragment,{})}var startOffset=this.getOffsetFromCursor(start),cursorOffset=this.getOffsetFromCursor(cursor),offset=cursorOffset-startOffset,node=ast.body[0],currentArg=-1;if("ExpressionStatement"===node.type&&("SequenceExpression"===(node=node.expression).type&&(node=node.expressions[0]),"BinaryExpression"===node.type&&("CallExpression"===node.left.type?node=node.left:"CallExpression"===node.right.type&&(node=node.right)),"CallExpression"===node.type)){var args=node.arguments,i,n=args.length,lastEnd=offset,text;for(i=0;i<n;i++){if(offset>=(node=args[i]).start&&offset<=node.end){currentArg=i;break}if(offset<node.start){if((text=fragment.substring(lastEnd,node.start)).indexOf(",")>=offset-lastEnd)i--;else if(0===i&&-1!==text.indexOf("(")){currentArg=-1;break}currentArg=Math.max(0,i);break}i+1===n&&-1!==(text=fragment.substring(node.end,offset)).indexOf(",")&&(currentArg=i+1),lastEnd=node.end}0===n&&cursorOffset>this.getOffsetFromCursor(this.functionCallPos)&&(currentArg=0)}return{parameters:fnHint,currentIndex:currentArg}},Session.prototype.getJavascriptText=function(){if("html"===LanguageManager.getLanguageForPath(this.editor.document.file.fullPath).getId()){var text="",editor=this.editor,scriptBlocks=HTMLUtils.findBlocks(editor,"javascript"),htmlStart={line:0,ch:0};return scriptBlocks.forEach(function(scriptBlock){var start=scriptBlock.start,end=scriptBlock.end,htmlText=editor.document.getRange(htmlStart,start);htmlText=htmlText.replace(/./g," "),htmlStart=end,text+=htmlText+scriptBlock.text}),text}return this.editor.document.getText()},Session.prototype.isFunctionName=function(){var cursor=this.getCursor(),prevToken;return"function"===this._getPreviousToken(cursor).string},module.exports=Session});
//# sourceMappingURL=Session.js.map
