{"version":3,"sources":["extensionsIntegrated/Phoenix/serverSync.js"],"names":["define","require","exports","module","ProjectManager","DocumentManager","Dialogs","Strings","StringUtils","DefaultDialogs","Metrics","syncRoot","$icon","userContext","publishURL","USER_CONTEXT","ongoingSyncCount","syncEnabled","projectSyncStarted","projectSyncCompleted","previewURL","_fixLegacyUserContext","PhStore","getItem","localStorage","setItem","_setupUserContext","Math","round","random","toString","_getProjectPreviewURL","projectName","getProjectRoot","name","_uploadFile","filePath","blob","resolve","reject","console","log","uploadFormData","FormData","projectRoot","path","dirname","relativePath","relative","fileName","basename","append","$","ajax","url","type","data","cache","contentType","processData","success","r","error","_readAndUploadFile","file","Promise","fullPath","read","encoding","window","fs","BYTE_ARRAY_ENCODING","err","content","stat","Blob","_uploadFiles","fileList","doneCB","allPromises","push","all","then","_startSync","doneCb","_setSyncInProgress","newSyncRoot","newSyncPath","getAllFiles","files","length","showModalDialog","DIALOG_ID_ERROR","CANNOT_PUBLISH_LARGE_PROJECT","CANNOT_PUBLISH_LARGE_PROJECT_MESSAGE","_setSyncComplete","_projectOpened","allChangedFiles","async","_collectFiles","dirEntry","getContents","fsEntries","fsEntry","isDirectory","contentFiles","_projectFileChanged","target","entry","added","removed","attr","class","title","PUBLISH_SYNC_IN_PROGRESS","PUBLISH_VIEW_PAGE","_showPublishConsentDialogue","publishMessage","format","PUBLISH_CONSENT_MESSAGE","DIALOG_ID_INFO","SHARE_WEBSITE","className","DIALOG_BTN_CLASS_NORMAL","id","DIALOG_BTN_CANCEL","text","CANCEL","DIALOG_BTN_CLASS_PRIMARY","DIALOG_BTN_OK","PUBLISH","done","_loadPreview","_isPreviewableFile","pathSplit","split","extension","includes","toLowerCase","projectRootUrl","currentDocument","getCurrentDocument","currentFile","getSelectedItem","Phoenix","app","openURLInDefaultBrowser","_addToolbarIcon","syncButtonID","href","PUBLISH_PAGE","appendTo","on","countEvent","EVENT_TYPE","SHARING","uniqueFilesToUpload","Set","init","EVENT_PROJECT_OPEN","EVENT_PROJECT_FILE_CHANGED"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/*global fs, Phoenix, path*/\n/*eslint no-console: 0*/\n/*eslint strict: [\"error\", \"global\"]*/\n/* jshint ignore:start */\n\ndefine(function (require, exports, module) {\n\n    const ProjectManager          = require(\"project/ProjectManager\"),\n        DocumentManager     = require(\"document/DocumentManager\"),\n        Dialogs             = require(\"widgets/Dialogs\"),\n        Strings             = require(\"strings\"),\n        StringUtils         = require(\"utils/StringUtils\"),\n        DefaultDialogs      = require(\"widgets/DefaultDialogs\"),\n        Metrics             = require(\"utils/Metrics\");\n\n    let syncRoot = \"\";\n    let $icon;\n    let userContext = \"\";\n    let publishURL = \"https://phcode.site\";\n    const USER_CONTEXT = \"publish.userContext\";\n    let ongoingSyncCount = 0;\n    let syncEnabled = false;\n    let projectSyncStarted = false;\n    let projectSyncCompleted = false;\n    let previewURL;\n\n    function _fixLegacyUserContext() {\n        // In earlier versions, user context data was stored in the browser's localStorage. We have since\n        // transitioned to using PhStore for this purpose. This function helps in migrating the user context\n        // from localStorage to PhStore. This ensures that existing users don't lose access to their published projects.\n        // Note: Published projects are retained for only 30 days. This function is primarily intended to support\n        // users during the transition period and is safe to remove 3 months after the date of this implementation,\n        // as users are informed that their published projects are kept for a 30-day period only.\n        if (!PhStore.getItem(USER_CONTEXT) && localStorage.getItem(USER_CONTEXT)) {\n            PhStore.setItem(USER_CONTEXT, localStorage.getItem(USER_CONTEXT));\n        }\n    }\n\n    function _setupUserContext() {\n        _fixLegacyUserContext();\n        userContext = PhStore.getItem(USER_CONTEXT);\n        if(!userContext){\n            userContext = \"p-\" + Math.round( Math.random()*10000000000000).toString(16);\n            PhStore.setItem(USER_CONTEXT, userContext);\n        }\n    }\n\n    function _getProjectPreviewURL() {\n        let projectName = ProjectManager.getProjectRoot().name;\n        return `${publishURL}/p/${userContext}/${projectName}`;\n    }\n\n    function _uploadFile(filePath, blob, resolve, reject) {\n        console.log('Uploading file for preview: ', filePath);\n        let uploadFormData = new FormData();\n        let projectRoot = path.dirname(syncRoot);\n        let relativePath = path.relative(projectRoot, filePath);\n        let fileName = path.basename(filePath);\n        uploadFormData.append(\"path\", `${userContext}/${path.dirname(relativePath)}`);\n        uploadFormData.append(\"files\", blob, fileName);\n        $.ajax({\n            url: publishURL + '/upload',\n            type: \"POST\",\n            data: uploadFormData,\n            cache: false,\n            contentType: false,\n            processData: false,\n            success: function(r) {\n                resolve();\n            },\n            error: function(r) {\n                reject();\n            }\n        });\n    }\n\n    function _readAndUploadFile(file) {\n        return new Promise((resolve, reject)=>{\n            if(file.fullPath === '/fs/app/state.json'){\n                // somehow we get these changes as project file changes too. don't sync state file\n                resolve();\n                return;\n            }\n            file.read({encoding: window.fs.BYTE_ARRAY_ENCODING}, function (err, content, encoding, stat) {\n                if (err){\n                    reject(err);\n                    return;\n                }\n                let blob = new Blob([content], {type:\"application/octet-stream\"});\n                _uploadFile(file.fullPath, blob, resolve, reject);\n            });\n        });\n    }\n\n    function _uploadFiles(fileList, doneCB) {\n        let allPromises = [];\n        for(let file of fileList){\n            allPromises.push(_readAndUploadFile(file));\n        }\n        Promise.all(allPromises).then(()=>{\n            doneCB();\n        });\n    }\n\n    function _startSync(doneCb) {\n        if(!syncEnabled){\n            return;\n        }\n        projectSyncStarted = true;\n        projectSyncCompleted = false;\n        _setSyncInProgress();\n        let newSyncRoot = ProjectManager.getProjectRoot();\n        let newSyncPath = newSyncRoot.fullPath;\n        if(newSyncPath !== syncRoot){\n            syncRoot = newSyncPath;\n            ProjectManager.getAllFiles().then((files)=>{\n                if(files.length > 500){\n                    Dialogs.showModalDialog(\n                        DefaultDialogs.DIALOG_ID_ERROR,\n                        Strings.CANNOT_PUBLISH_LARGE_PROJECT,\n                        Strings.CANNOT_PUBLISH_LARGE_PROJECT_MESSAGE\n                    );\n                    _setSyncComplete();\n                    if(doneCb){\n                        doneCb();\n                    }\n                    return;\n                }\n                _uploadFiles(files, ()=>{\n                    projectSyncCompleted = true;\n                    if(doneCb){\n                        doneCb();\n                    }\n                    _setSyncComplete();\n                });\n            });\n        }\n    }\n\n    function _projectOpened() {\n        syncEnabled = false;\n        projectSyncStarted = false;\n        projectSyncCompleted = false;\n        previewURL = null;\n    }\n\n    let allChangedFiles = [];\n    async function _collectFiles(dirEntry) {\n        return new Promise((resolve, reject)=>{\n            dirEntry.getContents(async (err,fsEntries)=>{\n                if(err){\n                    reject(err);\n                }\n                for(let fsEntry of fsEntries){\n                    if(fsEntry.isDirectory){\n                        let contentFiles = await _collectFiles(fsEntry);\n                        allChangedFiles.push(...contentFiles);\n                    } else {\n                        allChangedFiles.push(fsEntry);\n                    }\n                }\n            });\n            resolve(allChangedFiles);\n        });\n    }\n\n    async function _projectFileChanged(target, entry, added, removed) {\n        if(!syncEnabled){\n            return;\n        }\n        if(entry){\n            if(entry.isDirectory){\n                await _collectFiles(entry);\n            } else {\n                allChangedFiles.push(entry);\n            }\n        }\n    }\n\n    function _setSyncInProgress() {\n        ongoingSyncCount = ongoingSyncCount+1;\n        $icon.attr({\n            class: \"syncing\",\n            title: Strings.PUBLISH_SYNC_IN_PROGRESS\n        });\n    }\n\n    function _setSyncComplete() {\n        ongoingSyncCount = ongoingSyncCount-1;\n        if(ongoingSyncCount ===0){\n            $icon.attr({\n                class: \"preview\",\n                title: Strings.PUBLISH_VIEW_PAGE\n            });\n        }\n    }\n\n    function _showPublishConsentDialogue() {\n        if(projectSyncStarted){\n            return;\n        }\n        let publishMessage = StringUtils.format(Strings.PUBLISH_CONSENT_MESSAGE,\n            `<a href=\"${_getProjectPreviewURL()}\">${_getProjectPreviewURL()}</a>`);\n        Dialogs.showModalDialog(\n            DefaultDialogs.DIALOG_ID_INFO,\n            Strings.SHARE_WEBSITE,\n            publishMessage,\n            [\n                {\n                    className: Dialogs.DIALOG_BTN_CLASS_NORMAL,\n                    id: Dialogs.DIALOG_BTN_CANCEL,\n                    text: Strings.CANCEL\n                },\n                {\n                    className: Dialogs.DIALOG_BTN_CLASS_PRIMARY,\n                    id: Dialogs.DIALOG_BTN_OK,\n                    text: Strings.PUBLISH\n                }\n            ]\n        )\n            .done(function (id) {\n                if (id === Dialogs.DIALOG_BTN_OK) {\n                    syncEnabled = true;\n                    _startSync(()=>{\n                        _loadPreview();\n                    });\n                }\n            });\n    }\n\n    function _isPreviewableFile(filePath) {\n        let pathSplit = filePath.split('.');\n        let extension = pathSplit && pathSplit.length>1 ? pathSplit[pathSplit.length-1] : null;\n        if(['html', 'htm', 'jpg', 'jpeg', 'png', 'svg', 'pdf', 'xml'].includes(extension.toLowerCase())){\n            return true;\n        }\n        return false;\n    }\n\n    async function _loadPreview() {\n        let projectRootUrl = _getProjectPreviewURL();\n        let currentDocument = DocumentManager.getCurrentDocument();\n        let currentFile = currentDocument? currentDocument.file : ProjectManager.getSelectedItem();\n        if(currentFile){\n            let fullPath = currentFile.fullPath;\n            let projectRoot = ProjectManager.getProjectRoot().fullPath;\n            let relativePath = path.relative(projectRoot, fullPath);\n            if(_isPreviewableFile(relativePath)){\n                previewURL = `${projectRootUrl}/${relativePath}`;\n            }\n        }\n\n        if(!previewURL){\n            previewURL = projectRootUrl;\n        }\n        Phoenix.app.openURLInDefaultBrowser(previewURL);\n    }\n\n    function _addToolbarIcon() {\n        const syncButtonID = \"sync-button\";\n        $icon = $(\"<a>\")\n            .attr({\n                id: syncButtonID,\n                href: \"#\",\n                class: \"preview\",\n                title: Strings.PUBLISH_PAGE\n            })\n            .appendTo($(\"#main-toolbar .buttons\"));\n        $icon.on('click', ()=>{\n            Metrics.countEvent(Metrics.EVENT_TYPE.SHARING, \"shareIcon\", \"clicked\");\n            if(projectSyncCompleted){\n                _setSyncInProgress();\n                let uniqueFilesToUpload = [...new Set(allChangedFiles)];\n                allChangedFiles = [];\n                _uploadFiles(uniqueFilesToUpload, ()=>{\n                    _setSyncComplete();\n                    _loadPreview();\n                });\n            }\n            _showPublishConsentDialogue();\n        });\n    }\n\n    exports.init = function () {\n        _addToolbarIcon();\n        _setupUserContext();\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN, _projectOpened);\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED, _projectFileChanged);\n    };\n});\n"],"file":"serverSync.js"}