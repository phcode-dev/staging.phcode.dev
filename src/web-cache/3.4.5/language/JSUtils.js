define(function(require,exports,module){var _=require("thirdparty/lodash"),Acorn=require("thirdparty/acorn/dist/acorn"),AcornLoose=require("thirdparty/acorn/dist/acorn_loose"),ASTWalker=require("thirdparty/acorn/dist/walk"),CodeMirror=require("thirdparty/CodeMirror/lib/codemirror"),Async=require("utils/Async"),DocumentManager=require("document/DocumentManager"),ChangedDocumentTracker=require("document/ChangedDocumentTracker"),FileSystem=require("filesystem/FileSystem"),FileUtils=require("file/FileUtils"),PerfUtils=require("utils/PerfUtils"),StringUtils=require("utils/StringUtils"),_changedDocumentTracker=new ChangedDocumentTracker;function _findAllFunctionsInText(text){var AST,results={},functionName,resultNode,memberPrefix,match;PerfUtils.markStart(PerfUtils.JSUTILS_REGEXP);try{AST=Acorn.parse(text,{locations:!0})}catch(e){AST=AcornLoose.parse(text,{locations:!0})}function _addResult(node,offset,prefix){memberPrefix=prefix?prefix+" - ":"",resultNode=node.id||node.key||node,functionName=resultNode.name,Array.isArray(results[functionName])||(results[functionName]=[]),results[functionName].push({offsetStart:offset||node.start,label:memberPrefix?memberPrefix+functionName:null,location:resultNode.loc})}return ASTWalker.simple(AST,{FunctionDeclaration:function(node){"âœ–"!==node.id.name&&_addResult(node)},ClassDeclaration:function(node){_addResult(node),ASTWalker.simple(node,{MethodDefinition:function(methodNode){_addResult(methodNode,methodNode.key.start,node.id.name)}})},VariableDeclarator:function(node){!node.init||"FunctionExpression"!==node.init.type&&"ArrowFunctionExpression"!==node.init.type||_addResult(node)},AssignmentExpression:function(node){node.right&&"FunctionExpression"===node.right.type&&node.left&&"MemberExpression"===node.left.type&&node.left.property&&_addResult(node.left.property)},Property:function(node){node.value&&"FunctionExpression"===node.value.type&&node.key&&"Identifier"===node.key.type&&_addResult(node.key)},LabeledStatement:function(node){node.body&&"FunctionDeclaration"===node.body.type&&node.label&&_addResult(node.label)}}),PerfUtils.addMeasurement(PerfUtils.JSUTILS_REGEXP),results}function _getFunctionEndOffset(text,offsetStart){var mode=CodeMirror.getMode({},"javascript"),state=CodeMirror.startState(mode),stream,style,token,curOffset=offsetStart,length=text.length,blockCount=0,lineStart,foundStartBrace=!1;function nextLine(){if(stream&&++curOffset>=length)return!1;lineStart=curOffset;var lineEnd=text.indexOf("\n",lineStart);return-1===lineEnd&&(lineEnd=length),stream=new CodeMirror.StringStream(text.slice(curOffset,lineEnd)),!0}function nextToken(){if(curOffset>=length)return!1;for(stream&&(stream.start=stream.pos);!stream||stream.eol();)if(!nextLine())return!1;return style=mode.token(stream,state),token=stream.current(),curOffset=lineStart+stream.pos,!0}for(;nextToken();)if("comment"!==style&&"regexp"!==style&&"string"!==style&&"string-2"!==style&&("{"===token?(foundStartBrace=!0,blockCount++):"}"===token&&blockCount--),foundStartBrace&&blockCount<=0)return curOffset;return length}function _computeOffsets(doc,functionName,functions,rangeResults){var text=doc.getText(),lines=StringUtils.getLines(text);functions.forEach(function(funcEntry){funcEntry.offsetEnd||(PerfUtils.markStart(PerfUtils.JSUTILS_END_OFFSET),funcEntry.offsetEnd=_getFunctionEndOffset(text,funcEntry.offsetStart),funcEntry.lineStart=StringUtils.offsetToLineNum(lines,funcEntry.offsetStart),funcEntry.lineEnd=StringUtils.offsetToLineNum(lines,funcEntry.offsetEnd),PerfUtils.addMeasurement(PerfUtils.JSUTILS_END_OFFSET)),rangeResults.push({document:doc,name:functionName,lineStart:funcEntry.lineStart,lineEnd:funcEntry.lineEnd})})}function _readFile(fileInfo,result){DocumentManager.getDocumentForPath(fileInfo.fullPath).done(function(doc){var allFunctions=_findAllFunctionsInText(doc.getText());fileInfo.JSUtils={},fileInfo.JSUtils.functions=allFunctions,fileInfo.JSUtils.timestamp=doc.diskTimestamp,result.resolve({doc:doc,functions:allFunctions})}).fail(function(error){result.reject(error)})}function _shouldGetFromCache(fileInfo){var result=new $.Deferred,isChanged=_changedDocumentTracker.isPathChanged(fileInfo.fullPath);if(isChanged&&fileInfo.JSUtils){var doc=DocumentManager.getOpenDocumentForPath(fileInfo.fullPath),file;if(doc&&doc.isDirty)result.resolve(!1);else FileSystem.getFileForPath(fileInfo.fullPath).stat(function(err,stat){err?result.reject(err):result.resolve(fileInfo.JSUtils.timestamp.getTime()===stat.mtime.getTime())})}else result.resolve(!isChanged&&fileInfo.JSUtils);return result.promise()}function _getOffsetsForFunction(docEntries,functionName){var result=new $.Deferred,matchedDocuments=[],rangeResults=[];return docEntries.forEach(function(docEntry){if(_.has(docEntry.functions,functionName)){var functionsInDocument=docEntry.functions[functionName];matchedDocuments.push({doc:docEntry.doc,fileInfo:docEntry.fileInfo,functions:functionsInDocument})}}),Async.doInParallel(matchedDocuments,function(docEntry){var doc=docEntry.doc,oneResult=new $.Deferred;return doc?(_computeOffsets(doc,functionName,docEntry.functions,rangeResults),oneResult.resolve()):DocumentManager.getDocumentForPath(docEntry.fileInfo.fullPath).done(function(fetchedDoc){_computeOffsets(fetchedDoc,functionName,docEntry.functions,rangeResults)}).always(function(){oneResult.resolve()}),oneResult.promise()}).done(function(){result.resolve(rangeResults)}),result.promise()}function _getFunctionsForFile(fileInfo){var result=new $.Deferred;return _shouldGetFromCache(fileInfo).done(function(useCache){useCache?result.resolve({fileInfo:fileInfo,functions:fileInfo.JSUtils.functions}):_readFile(fileInfo,result)}).fail(function(err){result.reject(err)}),result.promise()}function _getFunctionsInFiles(fileInfos){var result=new $.Deferred,docEntries=[];return PerfUtils.markStart(PerfUtils.JSUTILS_GET_ALL_FUNCTIONS),Async.doInParallel(fileInfos,function(fileInfo){var oneResult=new $.Deferred;return _getFunctionsForFile(fileInfo).done(function(docInfo){docEntries.push(docInfo)}).always(function(error){oneResult.resolve()}),oneResult.promise()}).always(function(){_changedDocumentTracker.reset(),PerfUtils.addMeasurement(PerfUtils.JSUTILS_GET_ALL_FUNCTIONS),result.resolve(docEntries)}),result.promise()}function findMatchingFunctions(functionName,fileInfos,keepAllFiles){var result=new $.Deferred,jsFiles=[];return _getFunctionsInFiles(jsFiles=keepAllFiles?fileInfos:fileInfos.filter(function(fileInfo){return"js"===FileUtils.getFileExtension(fileInfo.fullPath).toLowerCase()})).done(function(docEntries){_getOffsetsForFunction(docEntries,functionName).done(function(rangeResults){result.resolve(rangeResults)})}),result.promise()}function findAllMatchingFunctionsInText(text,searchName){var allFunctions=_findAllFunctionsInText(text),result=[],lines=text.split("\n");return _.forEach(allFunctions,function(functions,functionName){functionName!==searchName&&"*"!==searchName||functions.forEach(function(funcEntry){var endOffset=_getFunctionEndOffset(text,funcEntry.offsetStart);result.push({name:functionName,label:funcEntry.label,lineStart:StringUtils.offsetToLineNum(lines,funcEntry.offsetStart),lineEnd:StringUtils.offsetToLineNum(lines,endOffset),nameLineStart:funcEntry.location.start.line-1,nameLineEnd:funcEntry.location.end.line-1,columnStart:funcEntry.location.start.column,columnEnd:funcEntry.location.end.column})})}),result}PerfUtils.createPerfMeasurement("JSUTILS_GET_ALL_FUNCTIONS","Parallel file search across project"),PerfUtils.createPerfMeasurement("JSUTILS_REGEXP","RegExp search for all functions"),PerfUtils.createPerfMeasurement("JSUTILS_END_OFFSET","Find end offset for a single matched function"),exports.findAllMatchingFunctionsInText=findAllMatchingFunctionsInText,exports._getFunctionEndOffset=_getFunctionEndOffset,exports.findMatchingFunctions=findMatchingFunctions});
//# sourceMappingURL=JSUtils.js.map
