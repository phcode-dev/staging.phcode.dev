!function(mod){"object"==typeof exports&&"object"==typeof module?mod(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],mod):mod(CodeMirror)}(function(CodeMirror){"use strict";var GUTTER_ID="CodeMirror-lint-markers",LINT_LINE_ID="CodeMirror-lint-line-";function showTooltip(cm,e,content){var tt=document.createElement("div");function position(e){if(!tt.parentNode)return CodeMirror.off(document,"mousemove",position);tt.style.top=Math.max(0,e.clientY-tt.offsetHeight-5)+"px",tt.style.left=e.clientX+5+"px"}return tt.className="CodeMirror-lint-tooltip cm-s-"+cm.options.theme,tt.appendChild(content.cloneNode(!0)),cm.state.lint.options.selfContain?cm.getWrapperElement().appendChild(tt):document.body.appendChild(tt),CodeMirror.on(document,"mousemove",position),position(e),null!=tt.style.opacity&&(tt.style.opacity=1),tt}function rm(elt){elt.parentNode&&elt.parentNode.removeChild(elt)}function hideTooltip(tt){tt.parentNode&&(null==tt.style.opacity&&rm(tt),tt.style.opacity=0,setTimeout(function(){rm(tt)},600))}function showTooltipFor(cm,e,content,node){var tooltip=showTooltip(cm,e,content);function hide(){CodeMirror.off(node,"mouseout",hide),tooltip&&(hideTooltip(tooltip),tooltip=null)}var poll=setInterval(function(){if(tooltip)for(var n=node;;n=n.parentNode){if(n&&11==n.nodeType&&(n=n.host),n==document.body)return;if(!n){hide();break}}if(!tooltip)return clearInterval(poll)},400);CodeMirror.on(node,"mouseout",hide)}function LintState(cm,conf,hasGutter){for(var prop in this.marked=[],conf instanceof Function&&(conf={getAnnotations:conf}),conf&&!0!==conf||(conf={}),this.options={},this.linterOptions=conf.options||{},defaults)this.options[prop]=defaults[prop];for(var prop in conf)defaults.hasOwnProperty(prop)?null!=conf[prop]&&(this.options[prop]=conf[prop]):conf.options||(this.linterOptions[prop]=conf[prop]);this.timeout=null,this.hasGutter=hasGutter,this.onMouseOver=function(e){onMouseOver(cm,e)},this.waitingFor=0}var defaults={highlightLines:!1,tooltips:!0,delay:500,lintOnChange:!0,getAnnotations:null,async:!1,selfContain:null,formatAnnotation:null,onUpdateLinting:null};function clearMarks(cm){var state=cm.state.lint;state.hasGutter&&cm.clearGutter(GUTTER_ID),state.options.highlightLines&&clearErrorLines(cm);for(var i=0;i<state.marked.length;++i)state.marked[i].clear();state.marked.length=0}function clearErrorLines(cm){cm.eachLine(function(line){var has=line.wrapClass&&/\bCodeMirror-lint-line-\w+\b/.exec(line.wrapClass);has&&cm.removeLineClass(line,"wrap",has[0])})}function makeMarker(cm,labels,severity,multiple,tooltips){var marker=document.createElement("div"),inner=marker;return marker.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+severity,multiple&&((inner=marker.appendChild(document.createElement("div"))).className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),0!=tooltips&&CodeMirror.on(inner,"mouseover",function(e){showTooltipFor(cm,e,labels,inner)}),marker}function getMaxSeverity(a,b){return"error"==a?a:b}function groupByLine(annotations){for(var lines=[],i=0;i<annotations.length;++i){var ann=annotations[i],line=ann.from.line;(lines[line]||(lines[line]=[])).push(ann)}return lines}function annotationTooltip(ann){var severity=ann.severity;severity||(severity="error");var tip=document.createElement("div");return tip.className="CodeMirror-lint-message CodeMirror-lint-message-"+severity,void 0!==ann.messageHTML?tip.innerHTML=ann.messageHTML:tip.appendChild(document.createTextNode(ann.message)),tip}function lintAsync(cm,getAnnotations){var state=cm.state.lint,id=++state.waitingFor;function abort(){id=-1,cm.off("change",abort)}cm.on("change",abort),getAnnotations(cm.getValue(),function(annotations,arg2){cm.off("change",abort),state.waitingFor==id&&(arg2&&annotations instanceof CodeMirror&&(annotations=arg2),cm.operation(function(){updateLinting(cm,annotations)}))},state.linterOptions,cm)}function startLinting(cm){var state=cm.state.lint;if(state){var options=state.options,getAnnotations=options.getAnnotations||cm.getHelper(CodeMirror.Pos(0,0),"lint");if(getAnnotations)if(options.async||getAnnotations.async)lintAsync(cm,getAnnotations);else{var annotations=getAnnotations(cm.getValue(),state.linterOptions,cm);if(!annotations)return;annotations.then?annotations.then(function(issues){cm.operation(function(){updateLinting(cm,issues)})}):cm.operation(function(){updateLinting(cm,annotations)})}}}function updateLinting(cm,annotationsNotSorted){var state=cm.state.lint;if(state){var options=state.options;clearMarks(cm);for(var annotations=groupByLine(annotationsNotSorted),line=0;line<annotations.length;++line){var anns=annotations[line];if(anns){var message=[];anns=anns.filter(function(item){return!(message.indexOf(item.message)>-1)&&message.push(item.message)});for(var maxSeverity=null,tipLabel=state.hasGutter&&document.createDocumentFragment(),i=0;i<anns.length;++i){var ann=anns[i],severity=ann.severity;severity||(severity="error"),maxSeverity=getMaxSeverity(maxSeverity,severity),options.formatAnnotation&&(ann=options.formatAnnotation(ann)),state.hasGutter&&tipLabel.appendChild(annotationTooltip(ann)),ann.to&&state.marked.push(cm.markText(ann.from,ann.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+severity,__annotation:ann}))}state.hasGutter&&cm.setGutterMarker(line,GUTTER_ID,makeMarker(cm,tipLabel,maxSeverity,annotations[line].length>1,options.tooltips)),options.highlightLines&&cm.addLineClass(line,"wrap",LINT_LINE_ID+maxSeverity)}}options.onUpdateLinting&&options.onUpdateLinting(annotationsNotSorted,annotations,cm)}}function onChange(cm){var state=cm.state.lint;state&&(clearTimeout(state.timeout),state.timeout=setTimeout(function(){startLinting(cm)},state.options.delay))}function popupTooltips(cm,annotations,e){for(var target=e.target||e.srcElement,tooltip=document.createDocumentFragment(),i=0;i<annotations.length;i++){var ann=annotations[i];tooltip.appendChild(annotationTooltip(ann))}showTooltipFor(cm,e,tooltip,target)}function onMouseOver(cm,e){var target=e.target||e.srcElement;if(/\bCodeMirror-lint-mark-/.test(target.className)){for(var box=target.getBoundingClientRect(),x=(box.left+box.right)/2,y=(box.top+box.bottom)/2,spans=cm.findMarksAt(cm.coordsChar({left:x,top:y},"client")),annotations=[],i=0;i<spans.length;++i){var ann=spans[i].__annotation;ann&&annotations.push(ann)}annotations.length&&popupTooltips(cm,annotations,e)}}CodeMirror.defineOption("lint",!1,function(cm,val,old){if(old&&old!=CodeMirror.Init&&(clearMarks(cm),!1!==cm.state.lint.options.lintOnChange&&cm.off("change",onChange),CodeMirror.off(cm.getWrapperElement(),"mouseover",cm.state.lint.onMouseOver),clearTimeout(cm.state.lint.timeout),delete cm.state.lint),val){for(var gutters=cm.getOption("gutters"),hasLintGutter=!1,i=0;i<gutters.length;++i)gutters[i]==GUTTER_ID&&(hasLintGutter=!0);var state=cm.state.lint=new LintState(cm,val,hasLintGutter);state.options.lintOnChange&&cm.on("change",onChange),0!=state.options.tooltips&&"gutter"!=state.options.tooltips&&CodeMirror.on(cm.getWrapperElement(),"mouseover",state.onMouseOver),startLinting(cm)}}),CodeMirror.defineExtension("performLint",function(){startLinting(this)})});
//# sourceMappingURL=lint.js.map
