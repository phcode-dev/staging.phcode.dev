define(function main(require,exports,module){var DocumentManager=require("document/DocumentManager"),Commands=require("command/Commands"),AppInit=require("utils/AppInit"),LiveDevelopment=require("LiveDevelopment/LiveDevelopment"),MultiBrowserLiveDev=require("LiveDevelopment/LiveDevMultiBrowser"),Inspector=require("LiveDevelopment/Inspector/Inspector"),CommandManager=require("command/CommandManager"),PreferencesManager=require("preferences/PreferencesManager"),Dialogs=require("widgets/Dialogs"),DefaultDialogs=require("widgets/DefaultDialogs"),UrlParams=require("utils/UrlParams").UrlParams,Strings=require("strings"),ExtensionUtils=require("utils/ExtensionUtils"),StringUtils=require("utils/StringUtils"),params=new UrlParams,config={experimental:!1,debug:!0,autoconnect:!1,highlight:!0,highlightConfig:{borderColor:{r:255,g:229,b:153,a:.66},contentColor:{r:111,g:168,b:220,a:.55},marginColor:{r:246,g:178,b:107,a:.66},paddingColor:{r:147,g:196,b:125,a:.66},showInfo:!0}},_status,_allStatusStyles=["warning","info","success","out-of-sync","sync-error"].join(" "),_$btnGoLive,LiveDevImpl,PREF_MULTIBROWSER="multibrowser",prefs=PreferencesManager.getExtensionPrefs("livedev"),multiBrowserPref=prefs.definePreference(PREF_MULTIBROWSER,"boolean",!1,{description:Strings.DESCRIPTION_LIVE_DEV_MULTIBROWSER}),PREF_REMOTEHIGHLIGHT="remoteHighlight",remoteHighlightPref=prefs.definePreference("remoteHighlight","object",{animateStartValue:{"background-color":"rgba(0, 162, 255, 0.5)",opacity:0},animateEndValue:{"background-color":"rgba(0, 162, 255, 0)",opacity:.6},paddingStyling:{"border-width":"1px","border-style":"dashed","border-color":"rgba(0, 162, 255, 0.5)"},marginStyling:{"background-color":"rgba(21, 165, 255, 0.58)"},borderColor:"rgba(21, 165, 255, 0.85)",showPaddingMargin:!0},{description:Strings.DESCRIPTION_LIVE_DEV_HIGHLIGHT_SETTINGS});function _togglePref(key,value){var val,oldPref=!!prefs.get(key);return(val=void 0===value?!oldPref:!!value)!==oldPref&&prefs.set(key,val),val}function _toggleLivePreviewMultiBrowser(value){var val=_togglePref(PREF_MULTIBROWSER,value);CommandManager.get(Commands.TOGGLE_LIVE_PREVIEW_MB_MODE).setChecked(val),CommandManager.get(Commands.FILE_PROJECT_SETTINGS).setEnabled(!val)}function _loadStyles(){var lessText=require("text!LiveDevelopment/main.less");less.render(lessText,function onParse(err,tree){console.assert(!err,err),ExtensionUtils.addEmbeddedStyleSheet(tree.css)})}function _setLabel($btn,text,style,tooltip){$("span",$btn).remove(),$btn.removeClass(_allStatusStyles),text&&text.length>0?$('<span class="label">').addClass(style).text(text).appendTo($btn):$btn.addClass(style),tooltip&&$btn.attr("title",tooltip)}function _handleGoLiveCommand(){window.alert("Coming soon: live preview support"),LiveDevImpl.status>=LiveDevImpl.STATUS_ACTIVE?LiveDevImpl.close():LiveDevImpl.status<=LiveDevImpl.STATUS_INACTIVE&&(params.get("skipLiveDevelopmentInfo")||PreferencesManager.getViewState("livedev.afterFirstLaunch")?LiveDevImpl.open():(PreferencesManager.setViewState("livedev.afterFirstLaunch","true"),Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_INFO,Strings.LIVE_DEVELOPMENT_INFO_TITLE,Strings.LIVE_DEVELOPMENT_INFO_MESSAGE).done(function(id){LiveDevImpl.open()})))}function _showStatusChangeReason(reason){if(_$btnGoLive.twipsy("hide").removeData("twipsy"),reason&&"explicit_close"!==reason){var translatedReason=Strings["LIVE_DEV_"+reason.toUpperCase()];translatedReason||(translatedReason=StringUtils.format(Strings.LIVE_DEV_CLOSED_UNKNOWN_REASON,reason));var options={placement:"left",trigger:"manual",autoHideDelay:5e3,title:function(){return translatedReason}};_$btnGoLive.twipsy(options).twipsy("show")}}function _setupGoLiveButton(){_$btnGoLive||(_$btnGoLive=$("#toolbar-go-live")),LiveDevImpl.on("statusChange",function statusChange(event,status,reason){_setLabel(_$btnGoLive,null,_status[status+1].style,_status[status+1].tooltip),_showStatusChangeReason(reason),config.autoconnect&&window.sessionStorage.setItem("live.enabled",3===status)}),_setLabel(_$btnGoLive,null,_status[1].style,_status[1].tooltip)}function _setupGoLiveMenu(){LiveDevImpl.on("statusChange",function statusChange(event,status){CommandManager.get(Commands.FILE_LIVE_FILE_PREVIEW).setChecked(status===LiveDevImpl.STATUS_ACTIVE),CommandManager.get(Commands.FILE_LIVE_HIGHLIGHT).setEnabled(status===LiveDevImpl.STATUS_ACTIVE)})}function _updateHighlightCheckmark(){CommandManager.get(Commands.FILE_LIVE_HIGHLIGHT).setChecked(config.highlight)}function _handlePreviewHighlightCommand(){config.highlight=!config.highlight,_updateHighlightCheckmark(),config.highlight?LiveDevImpl.showHighlight():LiveDevImpl.hideHighlight(),PreferencesManager.setViewState("livedev.highlight",config.highlight)}function _setImplementation(multibrowser){multibrowser?(LiveDevImpl=MultiBrowserLiveDev,_status=[{tooltip:Strings.LIVE_DEV_STATUS_TIP_NOT_CONNECTED,style:"warning"},{tooltip:Strings.LIVE_DEV_STATUS_TIP_NOT_CONNECTED,style:""},{tooltip:Strings.LIVE_DEV_STATUS_TIP_PROGRESS1,style:"info"},{tooltip:Strings.LIVE_DEV_STATUS_TIP_CONNECTED,style:"success"},{tooltip:Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC,style:"out-of-sync"},{tooltip:Strings.LIVE_DEV_STATUS_TIP_SYNC_ERROR,style:"sync-error"},{tooltip:Strings.LIVE_DEV_STATUS_TIP_PROGRESS1,style:"info"},{tooltip:Strings.LIVE_DEV_STATUS_TIP_PROGRESS1,style:"info"}]):(LiveDevImpl=LiveDevelopment,_status=[{tooltip:Strings.LIVE_DEV_STATUS_TIP_NOT_CONNECTED,style:"warning"},{tooltip:Strings.LIVE_DEV_STATUS_TIP_NOT_CONNECTED,style:""},{tooltip:Strings.LIVE_DEV_STATUS_TIP_PROGRESS1,style:"info"},{tooltip:Strings.LIVE_DEV_STATUS_TIP_PROGRESS2,style:"info"},{tooltip:Strings.LIVE_DEV_STATUS_TIP_CONNECTED,style:"success"},{tooltip:Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC,style:"out-of-sync"},{tooltip:Strings.LIVE_DEV_STATUS_TIP_SYNC_ERROR,style:"sync-error"}]),_setupGoLiveButton(),_setupGoLiveMenu(),_toggleLivePreviewMultiBrowser(multibrowser)}function _setupDebugHelpers(){window.ld=LiveDevelopment,window.i=Inspector,window.report=function report(params){window.params=params,console.info(params)}}function _handleReloadLivePreviewCommand(){LiveDevelopment.status>=LiveDevelopment.STATUS_ACTIVE&&LiveDevelopment.reload()}AppInit.appReady(function(){params.parse(),config.remoteHighlight=prefs.get("remoteHighlight"),Inspector.init(config),LiveDevelopment.init(config),MultiBrowserLiveDev.init(config),_loadStyles(),_updateHighlightCheckmark(),_setImplementation(prefs.get(PREF_MULTIBROWSER)),config.debug&&_setupDebugHelpers(),config.autoconnect&&"true"===window.sessionStorage.getItem("live.enabled")&&DocumentManager.getCurrentDocument()&&_handleGoLiveCommand(),$(window).focus(function(){Inspector.connected()&&config.highlight&&LiveDevelopment.redrawHighlight()}),multiBrowserPref.on("change",function(){LiveDevImpl&&LiveDevImpl.status>=LiveDevImpl.STATUS_ACTIVE?LiveDevImpl.close().done(function(){LiveDevImpl.off("statusChange"),_setImplementation(prefs.get(PREF_MULTIBROWSER))}):_setImplementation(prefs.get(PREF_MULTIBROWSER))}),remoteHighlightPref.on("change",function(){config.remoteHighlight=prefs.get("remoteHighlight"),LiveDevImpl&&LiveDevImpl.status>=LiveDevImpl.STATUS_ACTIVE&&LiveDevImpl.agents.remote.call("updateConfig",JSON.stringify(config))})}),PreferencesManager.stateManager.definePreference("livedev.highlight","boolean",!0).on("change",function(){config.highlight=PreferencesManager.getViewState("livedev.highlight"),_updateHighlightCheckmark()}),config.highlight=PreferencesManager.getViewState("livedev.highlight"),CommandManager.register(Strings.CMD_LIVE_HIGHLIGHT,Commands.FILE_LIVE_HIGHLIGHT,_handlePreviewHighlightCommand),CommandManager.register(Strings.CMD_RELOAD_LIVE_PREVIEW,Commands.CMD_RELOAD_LIVE_PREVIEW,_handleReloadLivePreviewCommand),CommandManager.register(Strings.CMD_TOGGLE_LIVE_PREVIEW_MB_MODE,Commands.TOGGLE_LIVE_PREVIEW_MB_MODE,_toggleLivePreviewMultiBrowser),CommandManager.get(Commands.FILE_LIVE_HIGHLIGHT).setEnabled(!1)});
//# sourceMappingURL=main.js.map
