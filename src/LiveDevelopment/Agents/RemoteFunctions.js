function RemoteFunctions(config,remoteWSPort){var experimental;experimental=!!config&&config.experimental;var lastKeepAliveTime=Date.now(),req,timeout,animateHighlight=function(time){req&&(window.cancelAnimationFrame(req),window.clearTimeout(timeout)),req=window.requestAnimationFrame(redrawHighlights),timeout=setTimeout(function(){window.cancelAnimationFrame(req),req=null},1e3*time)},_editHandler,HIGHLIGHT_CLASSNAME="__brackets-ld-highlight",KEEP_ALIVE_TIMEOUT=3e3,_currentEditor,_currentMenu,_localHighlight,_remoteHighlight;function _validEvent(event){return"Mac"===window.navigator.platform.substr(0,3)?event.metaKey:event.ctrlKey}function _typeColor(type,highlight){switch(type){case"html":return highlight?"#eec":"#ffe";case"css":return highlight?"#cee":"#eff";case"js":return highlight?"#ccf":"#eef";default:return highlight?"#ddd":"#eee"}}function _screenOffset(element){var elemBounds=element.getBoundingClientRect(),body=window.document.body,offsetTop,offsetLeft;if("static"===window.getComputedStyle(body).position)offsetLeft=elemBounds.left+window.pageXOffset,offsetTop=elemBounds.top+window.pageYOffset;else{var bodyBounds=body.getBoundingClientRect();offsetLeft=elemBounds.left-bodyBounds.left,offsetTop=elemBounds.top-bodyBounds.top}return{left:offsetLeft,top:offsetTop}}function _trigger(element,name,value,autoRemove){var key="data-ld-"+name;null!=value?(element.setAttribute(key,value),autoRemove&&window.setTimeout(element.removeAttribute.bind(element,key))):element.removeAttribute(key)}function isInViewport(element){var rect=element.getBoundingClientRect(),html=window.document.documentElement;return rect.top>=0&&rect.left>=0&&rect.bottom<=(window.innerHeight||html.clientHeight)&&rect.right<=(window.innerWidth||html.clientWidth)}function getDocumentOffsetTop(element){return element.offsetTop+(element.offsetParent?getDocumentOffsetTop(element.offsetParent):0)}function Menu(element){this.element=element,_trigger(this.element,"showgoto",1,!0),window.setTimeout(window.remoteShowGoto),this.remove=this.remove.bind(this)}function Editor(element){this.onBlur=this.onBlur.bind(this),this.onKeyPress=this.onKeyPress.bind(this),this.element=element,this.element.setAttribute("contenteditable","true"),this.element.focus(),this.element.addEventListener("blur",this.onBlur),this.element.addEventListener("keypress",this.onKeyPress),this.revertText=this.element.innerHTML,_trigger(this.element,"edit",1)}function Highlight(color,trigger){this.color=color,this.trigger=!!trigger,this.elements=[],this.selector=""}function _toggleEditor(element){_currentEditor=new Editor(element)}function _toggleMenu(element){_currentMenu&&_currentMenu.remove(),_currentMenu=new Menu(element)}Menu.prototype={onClick:function(url,event){event.preventDefault(),_trigger(this.element,"goto",url,!0),this.remove()},createBody:function(){if(!this.body){var offset=_screenOffset(this.element),x=offset.left,y=offset.top+this.element.offsetHeight;this.body=window.document.createElement("div"),this.body.style.setProperty("z-index",2147483647),this.body.style.setProperty("position","absolute"),this.body.style.setProperty("left",x+"px"),this.body.style.setProperty("top",y+"px"),this.body.style.setProperty("font-size","11pt"),this.body.style.setProperty("background","#fff"),this.body.style.setProperty("border","1px solid #888"),this.body.style.setProperty("-webkit-box-shadow","2px 2px 6px 0px #ccc"),this.body.style.setProperty("border-radius","6px"),this.body.style.setProperty("padding","6px")}},addItem:function(target){var item=window.document.createElement("div");if(item.style.setProperty("padding","2px 6px"),this.body.childNodes.length>0&&item.style.setProperty("border-top","1px solid #ccc"),item.style.setProperty("cursor","pointer"),item.style.setProperty("background",_typeColor(target.type)),item.innerHTML=target.name,item.addEventListener("click",this.onClick.bind(this,target.url)),target.file){var file=window.document.createElement("i");file.style.setProperty("float","right"),file.style.setProperty("margin-left","12px"),file.innerHTML=" "+target.file,item.appendChild(file)}this.body.appendChild(item)},show:function(){this.body||(this.body=this.createBody()),this.body.parentNode||window.document.body.appendChild(this.body),window.document.addEventListener("click",this.remove)},remove:function(){this.body&&this.body.parentNode&&window.document.body.removeChild(this.body),window.document.removeEventListener("click",this.remove)}},Editor.prototype={onBlur:function(event){this.element.removeAttribute("contenteditable"),this.element.removeEventListener("blur",this.onBlur),this.element.removeEventListener("keypress",this.onKeyPress),_trigger(this.element,"edit",0,!0)},onKeyPress:function(event){switch(event.which){case 13:this.element.blur();break;case 27:this.element.innerHTML=this.revertText,this.element.blur()}}},Highlight.prototype={_elementExists:function(element){var i;for(i in this.elements)if(this.elements[i]===element)return!0;return!1},_makeHighlightDiv:function(element,doAnimation){var elementBounds=element.getBoundingClientRect(),highlight=window.document.createElement("div"),elementStyling=window.getComputedStyle(element),transitionDuration=parseFloat(elementStyling.getPropertyValue("transition-duration")),animationDuration=parseFloat(elementStyling.getPropertyValue("animation-duration"));if(transitionDuration&&animateHighlight(transitionDuration),animationDuration&&animateHighlight(animationDuration),0!==elementBounds.width||0!==elementBounds.height){var realElBorder={right:elementStyling.getPropertyValue("border-right-width"),left:elementStyling.getPropertyValue("border-left-width"),top:elementStyling.getPropertyValue("border-top-width"),bottom:elementStyling.getPropertyValue("border-bottom-width")},borderBox="border-box"===elementStyling.boxSizing,innerWidth=parseFloat(elementStyling.width),innerHeight=parseFloat(elementStyling.height),outerHeight=innerHeight,outerWidth=innerWidth;borderBox||(innerWidth+=parseFloat(elementStyling.paddingLeft)+parseFloat(elementStyling.paddingRight),innerHeight+=parseFloat(elementStyling.paddingTop)+parseFloat(elementStyling.paddingBottom),outerWidth=innerWidth+parseFloat(realElBorder.right)+parseFloat(realElBorder.left),outerHeight=innerHeight+parseFloat(realElBorder.bottom)+parseFloat(realElBorder.top));var visualisations={horizontal:"left, right",vertical:"top, bottom"},drawPaddingRect=function(side){var elStyling={};return visualisations.horizontal.indexOf(side)>=0?(elStyling.width=elementStyling.getPropertyValue("padding-"+side),elStyling.height=innerHeight+"px",elStyling.top=0,borderBox&&(elStyling.height=innerHeight-parseFloat(realElBorder.top)-parseFloat(realElBorder.bottom)+"px")):(elStyling.height=elementStyling.getPropertyValue("padding-"+side),elStyling.width=innerWidth+"px",elStyling.left=0,borderBox&&(elStyling.width=innerWidth-parseFloat(realElBorder.left)-parseFloat(realElBorder.right)+"px")),elStyling[side]=0,elStyling.position="absolute",elStyling},drawMarginRect=function(side){var elStyling={},margin=[];return margin.right=parseFloat(elementStyling.getPropertyValue("margin-right")),margin.top=parseFloat(elementStyling.getPropertyValue("margin-top")),margin.bottom=parseFloat(elementStyling.getPropertyValue("margin-bottom")),margin.left=parseFloat(elementStyling.getPropertyValue("margin-left")),visualisations.horizontal.indexOf(side)>=0?(elStyling.width=elementStyling.getPropertyValue("margin-"+side),elStyling.height=outerHeight+margin.top+margin.bottom+"px",elStyling.top="-"+(margin.top+parseFloat(realElBorder.top))+"px"):(elStyling.height=elementStyling.getPropertyValue("margin-"+side),elStyling.width=outerWidth+"px",elStyling.left="-"+realElBorder.left),elStyling[side]="-"+(margin[side]+parseFloat(realElBorder[side]))+"px",elStyling.position="absolute",elStyling},setVisibility=function(el){!config.remoteHighlight.showPaddingMargin||parseInt(el.height,10)<=0||parseInt(el.width,10)<=0?el.display="none":el.display="block"},mainBoxStyles=config.remoteHighlight.stylesToSet,paddingVisualisations=[drawPaddingRect("top"),drawPaddingRect("right"),drawPaddingRect("bottom"),drawPaddingRect("left")],marginVisualisations,setupVisualisations=function(arr,config){var i;for(i=0;i<arr.length;i++){setVisibility(arr[i]),arr[i].transform="none";var el=window.document.createElement("div"),styles;_setStyleValues(Object.assign({},config,arr[i]),el.style),highlight.appendChild(el)}};setupVisualisations([drawMarginRect("top"),drawMarginRect("right"),drawMarginRect("bottom"),drawMarginRect("left")],config.remoteHighlight.marginStyling),setupVisualisations(paddingVisualisations,config.remoteHighlight.paddingStyling),highlight.className=HIGHLIGHT_CLASSNAME;var offset=_screenOffset(element),el=element,offsetLeft=0,offsetTop=0;do{offsetLeft+=el.offsetLeft,offsetTop+=el.offsetTop,el=el.offsetParent}while(el);var stylesToSet={left:offsetLeft+"px",top:offsetTop+"px",width:innerWidth+"px",height:innerHeight+"px","z-index":2e6,margin:0,padding:0,position:"absolute","pointer-events":"none","box-shadow":"0 0 1px #fff","box-sizing":elementStyling.getPropertyValue("box-sizing"),"border-right":elementStyling.getPropertyValue("border-right"),"border-left":elementStyling.getPropertyValue("border-left"),"border-top":elementStyling.getPropertyValue("border-top"),"border-bottom":elementStyling.getPropertyValue("border-bottom"),transform:elementStyling.getPropertyValue("transform"),"transform-origin":elementStyling.getPropertyValue("transform-origin"),"border-color":config.remoteHighlight.borderColor},mergedStyles=Object.assign({},stylesToSet,config.remoteHighlight.stylesToSet),animateStartValues=config.remoteHighlight.animateStartValue,animateEndValues=config.remoteHighlight.animateEndValue,transitionValues={"transition-property":"opacity, background-color, transform","transition-duration":"300ms, 2.3s"};_setStyleValues(mergedStyles,highlight.style),_setStyleValues(doAnimation?animateStartValues:animateEndValues,highlight.style),doAnimation&&(_setStyleValues(transitionValues,highlight.style),window.setTimeout(function(){_setStyleValues(animateEndValues,highlight.style)},20)),window.document.body.appendChild(highlight)}function _setStyleValues(styleValues,obj){var prop;for(prop in styleValues)obj.setProperty(prop,styleValues[prop])}},add:function(element,doAnimation){if(!this._elementExists(element)&&element!==window.document){if(this.trigger&&_trigger(element,"highlight",1),(!window.event||window.event instanceof MessageEvent)&&!isInViewport(element)){var top=getDocumentOffsetTop(element);top&&(top-=window.innerHeight/2,window.scrollTo(0,top))}this.elements.push(element),this._makeHighlightDiv(element,doAnimation)}},clear:function(){var i,highlights=window.document.querySelectorAll("."+HIGHLIGHT_CLASSNAME),body=window.document.body;for(i=0;i<highlights.length;i++)body.removeChild(highlights[i]);if(this.trigger)for(i=0;i<this.elements.length;i++)_trigger(this.elements[i],"highlight",0);this.elements=[]},redraw:function(){var i,highlighted;for(highlighted=this.selector?window.document.querySelectorAll(this.selector):this.elements.slice(0),this.clear(),i=0;i<highlighted.length;i++)this.add(highlighted[i],!1)}};var _setup=!1;function onMouseOver(event){_validEvent(event)&&_localHighlight.add(event.target,!0)}function onMouseOut(event){_validEvent(event)&&_localHighlight.clear()}function onMouseMove(event){onMouseOver(event),window.document.removeEventListener("mousemove",onMouseMove)}function onClick(event){_validEvent(event)&&(event.preventDefault(),event.stopPropagation(),event.altKey?_toggleEditor(event.target):_toggleMenu(event.target))}function onKeyUp(event){_setup&&!_validEvent(event)&&(window.document.removeEventListener("keyup",onKeyUp),window.document.removeEventListener("mouseover",onMouseOver),window.document.removeEventListener("mouseout",onMouseOut),window.document.removeEventListener("mousemove",onMouseMove),window.document.removeEventListener("click",onClick),_localHighlight.clear(),_localHighlight=void 0,_setup=!1)}function onKeyDown(event){!_setup&&_validEvent(event)&&(window.document.addEventListener("keyup",onKeyUp),window.document.addEventListener("mouseover",onMouseOver),window.document.addEventListener("mouseout",onMouseOut),window.document.addEventListener("mousemove",onMouseMove),window.document.addEventListener("click",onClick),_localHighlight=new Highlight("#ecc",!0),_setup=!0)}function keepAlive(){lastKeepAliveTime=Date.now()}function showGoto(targets){if(_currentMenu){var i;for(i in _currentMenu.createBody(),targets)_currentMenu.addItem(targets[i]);_currentMenu.show()}}function hideHighlight(){_remoteHighlight&&(_remoteHighlight.clear(),_remoteHighlight=null)}function highlight(node,clear){_remoteHighlight||(_remoteHighlight=new Highlight("#cfc")),clear&&_remoteHighlight.clear(),_remoteHighlight.add(node,!0)}function highlightRule(rule){hideHighlight();var i,nodes=window.document.querySelectorAll(rule);for(i=0;i<nodes.length;i++)highlight(nodes[i]);_remoteHighlight.selector=rule}function redrawHighlights(){_remoteHighlight&&_remoteHighlight.redraw()}function _scrollHandler(e){e.target===window.document?redrawHighlights():(_remoteHighlight||_localHighlight)&&window.setTimeout(redrawHighlights,0)}window.addEventListener("resize",redrawHighlights),window.addEventListener("scroll",_scrollHandler,!0);var aliveTest=window.setInterval(function(){Date.now()>lastKeepAliveTime+3e3&&(hideHighlight(),window.removeEventListener("resize",redrawHighlights),window.removeEventListener("scroll",_scrollHandler,!0),window.clearInterval(aliveTest))},1e3);function DOMEditHandler(htmlDocument){this.htmlDocument=htmlDocument,this.rememberedNodes=null,this.entityParseParent=htmlDocument.createElement("div")}function _isRawTextNode(node){return node.nodeType===Node.ELEMENT_NODE&&/script|style|noscript|noframes|noembed|iframe|xmp/i.test(node.tagName)}function applyDOMEdits(edits){_editHandler.apply(edits)}function _domElementToJSON(elem){var json={tag:elem.tagName.toLowerCase(),attributes:{},children:[]},i,len,node,value;for(len=elem.attributes.length,i=0;i<len;i++)value="data-brackets-id"===(node=elem.attributes.item(i)).name?parseInt(node.value,10):node.value,json.attributes[node.name]=value;for(len=elem.childNodes.length,i=0;i<len;i++)(node=elem.childNodes.item(i)).nodeType===Node.ELEMENT_NODE&&node.className!==HIGHLIGHT_CLASSNAME?json.children.push(_domElementToJSON(node)):node.nodeType===Node.TEXT_NODE&&json.children.push({content:node.nodeValue});return json}function getSimpleDOM(){return JSON.stringify(_domElementToJSON(window.document.documentElement))}function updateConfig(newConfig){return config=JSON.parse(newConfig),JSON.stringify(config)}DOMEditHandler.prototype._queryBracketsID=function(id){if(!id)return null;if(this.rememberedNodes&&this.rememberedNodes[id])return this.rememberedNodes[id];var results=this.htmlDocument.querySelectorAll("[data-brackets-id='"+id+"']");return results&&results[0]},DOMEditHandler.prototype._insertChildNode=function(targetElement,childElement,edit){var before=this._queryBracketsID(edit.beforeID),after=this._queryBracketsID(edit.afterID);edit.firstChild?before=targetElement.firstChild:edit.lastChild&&(after=targetElement.lastChild),before?targetElement.insertBefore(childElement,before):after&&after!==targetElement.lastChild?targetElement.insertBefore(childElement,after.nextSibling):targetElement.appendChild(childElement)},DOMEditHandler.prototype._parseEntities=function(text){var result;return this.entityParseParent.innerHTML=text,result=this.entityParseParent.textContent,this.entityParseParent.textContent="",result},DOMEditHandler.prototype._textReplace=function(targetElement,edit){function prevIgnoringHighlights(node){do{node=node.previousSibling}while(node&&node.className===HIGHLIGHT_CLASSNAME);return node}function nextIgnoringHighlights(node){do{node=node.nextSibling}while(node&&node.className===HIGHLIGHT_CLASSNAME);return node}function lastChildIgnoringHighlights(node){return(node=node.childNodes.length?node.childNodes.item(node.childNodes.length-1):null)&&node.className===HIGHLIGHT_CLASSNAME&&(node=prevIgnoringHighlights(node)),node}for(var start=edit.afterID?this._queryBracketsID(edit.afterID):null,startMissing=edit.afterID&&!start,end=edit.beforeID?this._queryBracketsID(edit.beforeID):null,endMissing=edit.beforeID&&!end,moveNext=start&&nextIgnoringHighlights(start),current=moveNext||end&&prevIgnoringHighlights(end)||lastChildIgnoringHighlights(targetElement),next,textNode=void 0!==edit.content?this.htmlDocument.createTextNode(_isRawTextNode(targetElement)?edit.content:this._parseEntities(edit.content)):null,lastRemovedWasText,isText;current&&current!==end&&(isText=current.nodeType===Node.TEXT_NODE,next=moveNext?nextIgnoringHighlights(current):prevIgnoringHighlights(current),!(current.nodeType===Node.ELEMENT_NODE||(startMissing||endMissing)&&isText&&lastRemovedWasText));)lastRemovedWasText=isText,current.remove?current.remove():current.parentNode&&current.parentNode.removeChild&&current.parentNode.removeChild(current),current=next;textNode&&(start&&start.nextSibling?targetElement.insertBefore(textNode,start.nextSibling):end?targetElement.insertBefore(textNode,end):targetElement.appendChild(textNode))},DOMEditHandler.prototype.apply=function(edits){var targetID,targetElement,childElement,self=this;this.rememberedNodes={},edits.forEach(function(edit){var editIsSpecialTag="elementInsert"===edit.type&&("html"===edit.tag||"head"===edit.tag||"body"===edit.tag);if("rememberNodes"!==edit.type)if(targetID=edit.type.match(/textReplace|textDelete|textInsert|elementInsert|elementMove/)?edit.parentID:edit.tagID,(targetElement=self._queryBracketsID(targetID))||editIsSpecialTag)switch(edit.type){case"attrChange":case"attrAdd":targetElement.setAttribute(edit.attribute,self._parseEntities(edit.value));break;case"attrDelete":targetElement.removeAttribute(edit.attribute);break;case"elementDelete":targetElement.remove?targetElement.remove():targetElement.parentNode&&targetElement.parentNode.removeChild&&targetElement.parentNode.removeChild(targetElement);break;case"elementInsert":childElement=null,editIsSpecialTag&&((childElement=self.htmlDocument["html"===edit.tag?"documentElement":edit.tag])||(editIsSpecialTag=!1)),editIsSpecialTag||(childElement=self.htmlDocument.createElement(edit.tag)),Object.keys(edit.attributes).forEach(function(attr){childElement.setAttribute(attr,self._parseEntities(edit.attributes[attr]))}),childElement.setAttribute("data-brackets-id",edit.tagID),editIsSpecialTag||self._insertChildNode(targetElement,childElement,edit);break;case"elementMove":childElement=self._queryBracketsID(edit.tagID),self._insertChildNode(targetElement,childElement,edit);break;case"textInsert":var textElement=self.htmlDocument.createTextNode(_isRawTextNode(targetElement)?edit.content:self._parseEntities(edit.content));self._insertChildNode(targetElement,textElement,edit);break;case"textReplace":case"textDelete":self._textReplace(targetElement,edit)}else console.error("data-brackets-id="+targetID+" not found");else edit.tagIDs.forEach(function(tagID){var node=self._queryBracketsID(tagID);self.rememberedNodes[tagID]=node,node.remove?node.remove():node.parentNode&&node.parentNode.removeChild&&node.parentNode.removeChild(node)})}),this.rememberedNodes={},redrawHighlights()},_editHandler=new DOMEditHandler(window.document),experimental&&window.document.addEventListener("keydown",onKeyDown);var _ws=null;function onDocumentClick(event){var element=event.target,currentDataId,newDataId;_ws&&element&&element.hasAttribute("data-brackets-id")&&_ws.send(JSON.stringify({type:"message",message:element.getAttribute("data-brackets-id")}))}function createWebSocket(){(_ws=new WebSocket("ws://localhost:"+remoteWSPort)).onopen=function(){window.document.addEventListener("click",onDocumentClick)},_ws.onmessage=function(evt){},_ws.onclose=function(){window.document.removeEventListener("click",onDocumentClick)}}return remoteWSPort&&createWebSocket(),{DOMEditHandler:DOMEditHandler,keepAlive:keepAlive,showGoto:showGoto,hideHighlight:hideHighlight,highlight:highlight,highlightRule:highlightRule,redrawHighlights:redrawHighlights,applyDOMEdits:applyDOMEdits,getSimpleDOM:getSimpleDOM,updateConfig:updateConfig}}
//# sourceMappingURL=RemoteFunctions.js.map
