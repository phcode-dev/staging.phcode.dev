define(function GotoAgent(require,exports,module){require("utils/Global");var Inspector=require("LiveDevelopment/Inspector/Inspector"),DOMAgent=require("LiveDevelopment/Agents/DOMAgent"),ScriptAgent=require("LiveDevelopment/Agents/ScriptAgent"),RemoteAgent=require("LiveDevelopment/Agents/RemoteAgent"),EditorManager=require("editor/EditorManager"),CommandManager=require("command/CommandManager"),Commands=require("command/Commands");function _urlWithoutQueryString(url){var index=url.search(/[#\?]/);return index>=0&&(url=url.substr(0,index)),url}function _fileFromURL(url){var comp=url.split("/");return comp[comp.length-1]}function _makeHTMLTarget(targets,node){if(node.location){var url=DOMAgent.url,location=node.location;node.canHaveChildren()&&(location+=node.length),url+=":"+location;var name="&lt;"+node.name+"&gt;",file=_fileFromURL(url);targets.push({type:"html",url:url,name:name,file:file})}}function _makeCSSTarget(targets,rule){if(rule.sourceURL){var url=rule.sourceURL;url+=":"+rule.style.range.start;var name=rule.selectorList.text,file=_fileFromURL(url);targets.push({type:"css",url:url,name:name,file:file})}}function _makeJSTarget(targets,callFrame){var script=ScriptAgent.scriptWithId(callFrame.location.scriptId);if(script&&script.url){var url=script.url;url+=":"+callFrame.location.lineNumber+","+callFrame.location.columnNumber;var name=callFrame.functionName;""===name&&(name="anonymous function");var file=_fileFromURL(url);targets.push({type:"js",url:url,name:name,file:file})}}function _onRemoteShowGoto(event,res){var node=DOMAgent.nodeWithId(res.nodeId);Inspector.CSS.getMatchedStylesForNode(node.nodeId,function onMatchedStyles(res){var i,targets=[];for(i in _makeHTMLTarget(targets,node),node.trace)_makeJSTarget(targets,node.trace[i]);for(i in node.events){var trace;_makeJSTarget(targets,node.events[i].callFrames[0])}for(i in res.matchedCSSRules.reverse())_makeCSSTarget(targets,res.matchedCSSRules[i].rule);RemoteAgent.call("showGoto",targets)})}function openLocation(location,noFlash){var editor=EditorManager.getCurrentFullEditor(),codeMirror=editor._codeMirror;"number"==typeof location&&(location=codeMirror.posFromIndex(location)),codeMirror.setCursor(location),editor.focus(),noFlash||(codeMirror.addLineClass(location.line,"wrap","flash"),window.setTimeout(function(){codeMirror.removeLineClass(location.line,"wrap","flash")},1e3))}function open(url,location,noFlash){console.assert("file://"===url.substr(0,7),"Cannot open non-file URLs");var result=new $.Deferred,path=(url=_urlWithoutQueryString(url)).slice("win"===brackets.platform?8:7);path=decodeURI(path);var promise=CommandManager.execute(Commands.FILE_OPEN,{fullPath:path});return promise.done(function onDone(doc){location&&openLocation(location,noFlash),result.resolve()}),promise.fail(function onErr(err){console.error(err),result.reject(err)}),result.promise()}function _onRemoteGoto(event,res){var location,url=res.value,matches=/^(.*):([^:]+)$/.exec(url);matches&&(url=matches[1],location=1===(location=matches[2].split(",")).length?parseInt(location[0],10):{line:parseInt(location[0],10),ch:parseInt(location[1],10)}),open(url,location)}function load(){RemoteAgent.on("showgoto.GotoAgent",_onRemoteShowGoto).on("goto.GotoAgent",_onRemoteGoto)}function unload(){RemoteAgent.off(".GotoAgent")}exports.openLocation=openLocation,exports.open=open,exports.load=load,exports.unload=unload});
//# sourceMappingURL=GotoAgent.js.map
