define(function EditAgent(require,exports,module){var Inspector=require("LiveDevelopment/Inspector/Inspector"),DOMAgent=require("LiveDevelopment/Agents/DOMAgent"),RemoteAgent=require("LiveDevelopment/Agents/RemoteAgent"),GotoAgent=require("LiveDevelopment/Agents/GotoAgent"),EditorManager=require("editor/EditorManager"),_editedNode;function _findChangedCharacters(oldValue,value){if(oldValue!==value){var length=oldValue.length,index=0,i;for(i=0;i<length&&value[i]===oldValue[i];i++);for(index+=i,value=value.substr(i),length-=i,i=0;i<length&&value[value.length-1-i]===oldValue[oldValue.length-1-i];i++);return{from:index,to:index+(length-=i),text:value=value.substr(0,value.length-i)}}}function _onCharacterDataModified(event,res){if(_editedNode.nodeId===res.nodeId){GotoAgent.open(DOMAgent.url);var editor=EditorManager.getCurrentFullEditor(),codeMirror=editor._codeMirror,change=_findChangedCharacters(_editedNode.value,res.characterData);if(change){var from=codeMirror.posFromIndex(_editedNode.location+change.from),to=codeMirror.posFromIndex(_editedNode.location+change.to);exports.isEditing=!0,editor.document.replaceRange(change.text,from,to),exports.isEditing=!1;var newPos=codeMirror.posFromIndex(_editedNode.location+change.from+change.text.length);editor.setCursorPos(newPos.line,newPos.ch)}}}function _onRemoteEdit(event,res){if("0"!==res.value){var node=DOMAgent.nodeWithId(res.nodeId);(node=node.children[0]).location&&(_editedNode=node,Inspector.DOM.on("characterDataModified.EditAgent",_onCharacterDataModified))}else Inspector.DOM.off(".EditAgent")}function load(){RemoteAgent.on("edit.EditAgent",_onRemoteEdit)}function unload(){RemoteAgent.off(".EditAgent")}exports.load=load,exports.unload=unload});
//# sourceMappingURL=EditAgent.js.map
