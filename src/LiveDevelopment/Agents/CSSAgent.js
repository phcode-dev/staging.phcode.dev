define(function CSSAgent(require,exports,module){var _=require("thirdparty/lodash"),Inspector=require("LiveDevelopment/Inspector/Inspector"),EventDispatcher=require("utils/EventDispatcher"),PathUtils=require("thirdparty/path-utils/path-utils"),_styleSheetDetails={},_getAllStyleSheetsNotFound;function _canonicalize(url){return PathUtils.parseUrl(url).hrefNoSearch}function _onFrameNavigated(event,res){res.frame.parentId||(_styleSheetDetails={})}function styleForURL(url){var styleSheetId,styles={};for(styleSheetId in url=_canonicalize(url),_styleSheetDetails)_styleSheetDetails[styleSheetId].canonicalizedURL===url&&(styles[styleSheetId]=_styleSheetDetails[styleSheetId]);return styles}function reloadCSSForDocument(doc,newContent){var styles=styleForURL(doc.url),styleSheetId,deferreds=[];for(styleSheetId in void 0===newContent&&(newContent=doc.getText()),styles)deferreds.push(Inspector.CSS.setStyleSheetText(styles[styleSheetId].styleSheetId,newContent));return deferreds.length?$.when.apply($,deferreds):(console.error("Style Sheet for document not loaded: "+doc.url),(new $.Deferred).reject().promise())}function clearCSSForDocument(doc){return reloadCSSForDocument(doc,"")}function _styleSheetAdded(event,res){var url=_canonicalize(res.header.sourceURL),existing=styleForURL(res.header.sourceURL),styleSheetId=res.header.styleSheetId,duplicate;(duplicate=_.some(existing,function(styleSheet){return styleSheet&&styleSheet.styleSheetId===styleSheetId}))||(_styleSheetDetails[styleSheetId]=res.header,_styleSheetDetails[styleSheetId].canonicalizedURL=url,exports.trigger("styleSheetAdded",url,res.header))}function _styleSheetRemoved(event,res){var header=_styleSheetDetails[res.styleSheetId];delete _styleSheetDetails[res.styleSheetId],exports.trigger("styleSheetRemoved",header.canonicalizedURL,header)}function _onFrameStoppedLoading(event,res){var regexChromeUA,userAgent,uaMatch;if(void 0===_getAllStyleSheetsNotFound&&(regexChromeUA=/Chrome\/(\d+)\./,(uaMatch=(userAgent=Inspector.getUserAgent()).match(regexChromeUA))&&parseInt(uaMatch[1],10)>=34))return _getAllStyleSheetsNotFound=!0,void Inspector.Page.off("frameStoppedLoading.CSSAgent",_onFrameStoppedLoading);Inspector.send("CSS","getAllStyleSheets").done(function(res){res.headers.forEach(function(header){_getAllStyleSheetsNotFound=!1,_styleSheetAdded(null,{header:header})})}).fail(function(err){_getAllStyleSheetsNotFound=-32601===err.code,Inspector.Page.off("frameStoppedLoading.CSSAgent",_onFrameStoppedLoading)})}function enable(){return Inspector.CSS.enable()}function load(){Inspector.Page.on("frameNavigated.CSSAgent",_onFrameNavigated),Inspector.CSS.on("styleSheetAdded.CSSAgent",_styleSheetAdded),Inspector.CSS.on("styleSheetRemoved.CSSAgent",_styleSheetRemoved),_getAllStyleSheetsNotFound||Inspector.Page.on("frameStoppedLoading.CSSAgent",_onFrameStoppedLoading)}function unload(){Inspector.Page.off(".CSSAgent"),Inspector.CSS.off(".CSSAgent")}EventDispatcher.makeEventDispatcher(exports),exports.enable=enable,exports.styleForURL=styleForURL,exports.reloadCSSForDocument=reloadCSSForDocument,exports.clearCSSForDocument=clearCSSForDocument,exports.load=load,exports.unload=unload});
//# sourceMappingURL=CSSAgent.js.map
