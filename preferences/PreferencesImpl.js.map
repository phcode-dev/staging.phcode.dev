{"version":3,"sources":["preferences/PreferencesImpl.js"],"names":["define","require","exports","module","PreferencesBase","Async","FileSystem","SETTINGS_FILENAME","STATE_FILENAME","userPrefFile","path","normalize","brackets","app","getApplicationSupportDirectory","_prefManagerReadyDeferred","$","Deferred","userScopeCorrupt","isUserScopeCorrupt","_addScopePromises","manager","PreferencesSystem","pauseChangeEvents","projectStorage","FileStorage","undefined","projectScope","Scope","projectPathLayer","PathLayer","projectLanguageLayer","LanguageLayer","addLayer","userStorage","userScope","userLanguageLayer","userScopeLoading","addScope","push","fail","err","MemoryStorage","before","name","always","waitForAll","resolve","stateManager","userStateFile","alwaysIndex","smUserScope","stateProjectLayer","ProjectLayer","smUserScopeLoading","_reloadUserPrefs","rootDir","prefsDir","indexOf","fullPath","fileChanged","managerReady","promise","reloadUserPrefs"],"mappings":"AA2BAA,OAAO,SAAUC,QAASC,QAASC,QAG/B,IAAIC,gBAAkBH,QAAQ,qBAC1BI,MAAkBJ,QAAQ,eAC1BK,WAAkBL,QAAQ,yBAG1BM,kBAAoB,gBACpBC,eAAoB,aAGpBC,aAAeC,KAAKC,UAAUC,SAASC,IAAIC,iCAAmC,kBAO9EC,0BAA4B,IAAIC,EAAEC,SAKlCC,kBAAmB,EAEvB,SAASC,qBACL,OAAOD,iBAQX,IAAIE,kBAAoB,GAEpBC,QAAU,IAAIjB,gBAAgBkB,kBAClCD,QAAQE,oBAGR,IAAIC,eAA0B,IAAIpB,gBAAgBqB,iBAAYC,GAAW,GACrEC,aAA0B,IAAIvB,gBAAgBwB,MAAMJ,gBACpDK,iBAA0B,IAAIzB,gBAAgB0B,UAC9CC,qBAA0B,IAAI3B,gBAAgB4B,cAElDL,aAAaM,SAASJ,kBACtBF,aAAaM,SAASF,sBAGtB,IAAIG,YAA0B,IAAI9B,gBAAgBqB,YAAYhB,cAAc,GACxE0B,UAA0B,IAAI/B,gBAAgBwB,MAAMM,aACpDE,kBAA0B,IAAIhC,gBAAgB4B,cAElDG,UAAUF,SAASG,mBAEnB,IAAIC,iBAAmBhB,QAAQiB,SAAS,OAAQH,WAEhDf,kBAAkBmB,KAAKF,kBAGvBA,iBACKG,KAAK,SAAUC,KACZrB,kBAAkBmB,KAAKlB,QAAQiB,SAAS,OAAQ,IAAIlC,gBAAgBsC,cAAiB,CACjFC,OAAQ,aAGRF,IAAIG,MAAqB,iBAAbH,IAAIG,OAChB1B,kBAAmB,KAG1B2B,OAAO,WACJzB,kBAAkBmB,KAAKlB,QAAQiB,SAAS,UAAWX,aAAc,CAC7DgB,OAAQ,UAIZvB,kBAAkBmB,KAAKlB,QAAQiB,SAAS,UAAW,IAAIlC,gBAAgBsC,gBAEvErC,MAAMyC,WAAW1B,mBACZyB,OAAO,WACJ9B,0BAA0BgC,cAO1C,IAAIC,aAAe,IAAI5C,gBAAgBkB,kBACnC2B,cAAgBvC,KAAKC,UAAUC,SAASC,IAAIC,iCAAmC,eACnFR,WAAW4C,YAAYD,eACvB,IAAIE,YAAc,IAAI/C,gBAAgBwB,MAAM,IAAIxB,gBAAgBqB,YAAYwB,eAAe,GAAM,IAC7FG,kBAAoB,IAAIhD,gBAAgBiD,aAC5CF,YAAYlB,SAASmB,mBACrB,IAAIE,mBAAqBN,aAAaV,SAAS,OAAQa,aAKvD,SAASI,iBAAiBC,SACtB,IAAIC,SACuC,IAD5B/C,KAAKC,UAAUC,SAASC,IAAIC,iCAAmC,KACjE4C,QAAQF,QAAQG,YACzBtC,QAAQuC,YAAYnD,cACpBuC,aAAaY,YAAYX,gBAKjC/C,QAAQmB,QAAsBA,QAC9BnB,QAAQsB,eAAsBA,eAC9BtB,QAAQ2B,iBAAsBA,iBAC9B3B,QAAQmC,iBAAsBA,iBAC9BnC,QAAQ8C,aAAsBA,aAC9B9C,QAAQkD,kBAAsBA,kBAC9BlD,QAAQoD,mBAAsBA,mBAC9BpD,QAAQO,aAAsBA,aAC9BP,QAAQiB,mBAAsBA,mBAC9BjB,QAAQ2D,aAAsB9C,0BAA0B+C,UACxD5D,QAAQ6D,gBAAsBR,iBAC9BrD,QAAQM,eA9GgB,aA+GxBN,QAAQK,kBAhHgB","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n * Original work Copyright (c) 2014 - 2021 Adobe Systems Incorporated. All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/*globals path*/\n\n/**\n * Generates the fully configured preferences systems used throughout Brackets. This is intended\n * to be essentially private implementation that can be overridden for tests.\n */\ndefine(function (require, exports, module) {\n\n\n    var PreferencesBase = require(\"./PreferencesBase\"),\n        Async           = require(\"utils/Async\"),\n        FileSystem      = require(\"filesystem/FileSystem\"),\n\n        // The SETTINGS_FILENAME is used with a preceding \".\" within user projects\n        SETTINGS_FILENAME = \"brackets.json\",\n        STATE_FILENAME    = \"state.json\",\n\n        // User-level preferences\n        userPrefFile = path.normalize(brackets.app.getApplicationSupportDirectory() + \"/\" + SETTINGS_FILENAME);\n\n    /**\n     * A deferred object which is used to indicate PreferenceManager readiness during the start-up.\n     * @private\n     * @type {$.Deferred}\n     */\n    var _prefManagerReadyDeferred = new $.Deferred();\n\n    /**\n     * A boolean property indicating if the user scope configuration file is malformed.\n     */\n    var userScopeCorrupt = false;\n\n    function isUserScopeCorrupt() {\n        return userScopeCorrupt;\n    }\n\n    /**\n     * Promises to add scopes. Used at init time only.\n     * @private\n     * @type {Array.<$.Promise>}\n     */\n    var _addScopePromises = [];\n\n    var manager = new PreferencesBase.PreferencesSystem();\n    manager.pauseChangeEvents();\n\n    // Create a Project scope\n    var projectStorage          = new PreferencesBase.FileStorage(undefined, true),\n        projectScope            = new PreferencesBase.Scope(projectStorage),\n        projectPathLayer        = new PreferencesBase.PathLayer(),\n        projectLanguageLayer    = new PreferencesBase.LanguageLayer();\n\n    projectScope.addLayer(projectPathLayer);\n    projectScope.addLayer(projectLanguageLayer);\n\n    // Create a User scope\n    var userStorage             = new PreferencesBase.FileStorage(userPrefFile, true),\n        userScope               = new PreferencesBase.Scope(userStorage),\n        userLanguageLayer       = new PreferencesBase.LanguageLayer();\n\n    userScope.addLayer(userLanguageLayer);\n\n    var userScopeLoading = manager.addScope(\"user\", userScope);\n\n    _addScopePromises.push(userScopeLoading);\n\n    // Set up the .brackets.json file handling\n    userScopeLoading\n        .fail(function (err) {\n            _addScopePromises.push(manager.addScope(\"user\", new PreferencesBase.MemoryStorage(), {\n                before: \"default\"\n            }));\n\n            if (err.name && err.name === \"ParsingError\") {\n                userScopeCorrupt = true;\n            }\n        })\n        .always(function () {\n            _addScopePromises.push(manager.addScope(\"project\", projectScope, {\n                before: \"user\"\n            }));\n\n            // Session Scope is for storing prefs in memory only but with the highest precedence.\n            _addScopePromises.push(manager.addScope(\"session\", new PreferencesBase.MemoryStorage()));\n\n            Async.waitForAll(_addScopePromises)\n                .always(function () {\n                    _prefManagerReadyDeferred.resolve();\n                });\n        });\n\n\n    // \"State\" is stored like preferences but it is not generally intended to be user-editable.\n    // It's for more internal, implicit things like window size, working set, etc.\n    var stateManager = new PreferencesBase.PreferencesSystem();\n    var userStateFile = path.normalize(brackets.app.getApplicationSupportDirectory() + \"/\" + STATE_FILENAME);\n    FileSystem.alwaysIndex(userStateFile);\n    var smUserScope = new PreferencesBase.Scope(new PreferencesBase.FileStorage(userStateFile, true, true));\n    var stateProjectLayer = new PreferencesBase.ProjectLayer();\n    smUserScope.addLayer(stateProjectLayer);\n    var smUserScopeLoading = stateManager.addScope(\"user\", smUserScope);\n\n\n    // Listen for times where we might be unwatching a root that contains one of the user-level prefs files,\n    // and force a re-read of the file in order to ensure we can write to it later (see #7300).\n    function _reloadUserPrefs(rootDir) {\n        var prefsDir = path.normalize(brackets.app.getApplicationSupportDirectory() + \"/\");\n        if (prefsDir.indexOf(rootDir.fullPath) === 0) {\n            manager.fileChanged(userPrefFile);\n            stateManager.fileChanged(userStateFile);\n        }\n    }\n\n    // Semi-Public API. Use this at your own risk. The public API is in PreferencesManager.\n    exports.manager             = manager;\n    exports.projectStorage      = projectStorage;\n    exports.projectPathLayer    = projectPathLayer;\n    exports.userScopeLoading    = userScopeLoading;\n    exports.stateManager        = stateManager;\n    exports.stateProjectLayer   = stateProjectLayer;\n    exports.smUserScopeLoading  = smUserScopeLoading;\n    exports.userPrefFile        = userPrefFile;\n    exports.isUserScopeCorrupt  = isUserScopeCorrupt;\n    exports.managerReady        = _prefManagerReadyDeferred.promise();\n    exports.reloadUserPrefs     = _reloadUserPrefs;\n    exports.STATE_FILENAME      = STATE_FILENAME;\n    exports.SETTINGS_FILENAME   = SETTINGS_FILENAME;\n});\n"],"file":"PreferencesImpl.js"}